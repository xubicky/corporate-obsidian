<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTRA Runbook</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS for Excel Processing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- ExcelJS for Excel Export with Formatting -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

    <!-- jsPDF for PDF Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
            /* Fallback gradient if image fails to load */
            background-color: #1e3a5f;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .animate-scale-in {
            animation: scaleIn 0.2s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.15s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Glassmorphism Effects */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }

        .glass-sidebar {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 4px 0 24px 0 rgba(31, 38, 135, 0.1);
        }

        /* Custom Scrollbar - Glassmorphism Style */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
            background-clip: padding-box;
        }

        /* Select Reset for Status Pill */
        .status-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            text-align-last: center;
        }

        /* Floating Animation */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        /* Entrance Animations */
        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-slide-up {
            animation: slideUpFade 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Success Checkmark Animation */
        @keyframes scaleBounce {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-scale-bounce {
            animation: scaleBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Modern Shimmer for Text/Cards */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .shimmer-text {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.9) 50%, rgba(255, 255, 255, 0.4) 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shimmer 2.5s infinite linear;
        }

        /* Success Ring Pulse */
        @keyframes ringPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .animate-ring-pulse {
            animation: ringPulse 2s infinite;
        }
    </style>
</head>

<body class="text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <!-- React Window for Virtualization -->
    <script src="https://unpkg.com/react-window@1.8.10/dist/index.umd.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback, memo, useReducer } = React;
        const { FixedSizeList, VariableSizeList } = window.ReactWindow || {};

        // Throttle utility for scroll performance
        const throttle = (func, limit) => {
            let inThrottle;
            return function (...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        };

        // Debounce utility for resize events
        const debounce = (func, wait) => {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        // --- ICONS ---
        const Icons = {
            FileSpreadsheet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>,
            BarChart3: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v18h18" /><path d="M18 17V9" /><path d="M13 17V5" /><path d="M8 17v-3" /></svg>,
            Clock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>,
            Table: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 3v18" /><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M3 9h18" /><path d="M3 15h18" /></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>,
            Filter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>,
            ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m15 18-6-6 6-6" /></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6" /></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6" /></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></svg>,
            Edit2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18" /><path d="m6 6 18 18" /></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            GanttChart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v18h18" /><path d="M8 14v4" /><path d="M13 10v8" /><path d="M18 6v12" /><rect x="3" y="8" width="8" height="4" rx="1" /><rect x="10" y="3" width="8" height="4" rx="1" /></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M10 9H8" /><path d="M16 13H8" /><path d="M16 17H8" /></svg>,
            MousePointer: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z" /><path d="m13 13 6 6" /></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>,
            Undo: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 7v6h6" /><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" /></svg>,
            Redo: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 7v6h-6" /><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 3.7" /></svg>,
            RotateCcw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></svg>,
            MessageSquare: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></svg>,
            Send: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></svg>,
            Brain: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" /><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" /></svg>,
            Mic: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" x2="12" y1="19" y2="23" /><line x1="8" x2="16" y1="23" y2="23" /></svg>,
            // Indicator Icons
            Diamond: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 2L2 12l10 10 10-10L12 2z" /></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></svg>,
            MessageCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" /></svg>,
            Flag: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" x2="4" y1="22" y2="15" stroke="currentColor" strokeWidth="2" fill="none" /></svg>,
            // Additional Indicator Icons
            Shield: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></svg>,
            Zap: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></svg>,
            ShoppingCart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="9" cy="21" r="1" /><circle cx="20" cy="21" r="1" /><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" /></svg>,
            DollarSign: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="1" x2="12" y2="23" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></svg>,
            Target: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></svg>,
            Globe: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><line x1="2" y1="12" x2="22" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></svg>
        };

        // --- INDICATOR HELPERS ---
        // Check if a value is truthy (handles "Yes", "Y", "TRUE", true, 1, "1", "X", etc.)
        const isIndicatorTrue = (value) => {
            if (!value) return false;
            if (typeof value === 'boolean') return value;
            if (typeof value === 'number') return value !== 0;
            const str = String(value).toLowerCase().trim();
            return ['yes', 'y', 'true', '1', 'x', '✓', '✔'].includes(str);
        };

        // Get indicator badges for a task
        const getTaskIndicators = (task) => {
            return {
                isMilestone: isIndicatorTrue(task['Milestone']),
                isKeyMilestone: isIndicatorTrue(task['Key Milestone']),
                isDiscussion: isIndicatorTrue(task['Discussion'])
            };
        };

        // Indicator Badge Component for Overview/Table
        const IndicatorBadges = ({ task, size = 'sm' }) => {
            const { isMilestone, isKeyMilestone, isDiscussion } = getTaskIndicators(task);
            const hasAny = isMilestone || isKeyMilestone || isDiscussion;
            if (!hasAny) return null;

            const iconSize = size === 'sm' ? 'w-3.5 h-3.5' : size === 'xs' ? 'w-3 h-3' : 'w-4 h-4';

            return (
                <div className="flex items-center gap-1 shrink-0">
                    {isKeyMilestone && (
                        <span className="text-amber-400 drop-shadow-[0_0_3px_rgba(251,191,36,0.5)]" title="Key Milestone">
                            <Icons.Star className={iconSize} />
                        </span>
                    )}
                    {isMilestone && !isKeyMilestone && (
                        <span className="text-purple-400" title="Milestone">
                            <Icons.Diamond className={iconSize} />
                        </span>
                    )}
                    {isDiscussion && (
                        <span className="text-orange-400" title="Discussion Required">
                            <Icons.MessageCircle className={iconSize} />
                        </span>
                    )}
                </div>
            );
        };

        const MultiSelectDropdown = ({ label, options, selected, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);

            return (
                <div
                    className="border-b border-white/10 last:border-0"
                    onMouseEnter={() => setIsOpen(true)}
                    onMouseLeave={() => setIsOpen(false)}
                >
                    <div className="w-full flex items-center justify-between p-3 hover:bg-white/10 transition-colors rounded-lg cursor-pointer group">
                        <span className="font-semibold text-xs text-white uppercase tracking-wider group-hover:text-cyan-200 transition-colors">{label}</span>
                        <div className="flex items-center space-x-2">
                            {selected.length > 0 && <span className="bg-purple-400/30 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold border border-purple-300/30 shadow-[0_0_10px_rgba(192,132,252,0.3)]">{selected.length}</span>}
                            <Icons.ChevronDown className={`w-4 h-4 text-white/50 group-hover:text-white transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] ${isOpen ? 'rotate-180 text-cyan-400' : ''}`} />
                        </div>
                    </div>

                    <div
                        className={`overflow-hidden transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] ${isOpen ? 'max-h-[400px] opacity-100 translate-y-0' : 'max-h-0 opacity-0 -translate-y-2'}`}
                    >
                        <div className="max-h-64 overflow-y-auto custom-scrollbar p-2 bg-white/5 border-t border-white/10 rounded-lg mb-2 mx-1 shadow-inner">
                            {options.map(opt => (
                                <label key={opt} className="flex items-center space-x-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg mb-0.5 transition-all hover:pl-2.5 shrink-0">
                                    <input
                                        type="checkbox"
                                        className="rounded text-cyan-500 focus:ring-cyan-400 h-3.5 w-3.5 border-white/30 bg-white/20"
                                        checked={selected.includes(opt)}
                                        onChange={() => onChange(opt)}
                                    />
                                    <span className={`text-xs truncate transition-colors ${selected.includes(opt) ? 'text-cyan-200 font-medium' : 'text-white/80'}`}>{opt}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- SUBCOMPONENT: AUTOCOMPLETE INPUT ---
        const AutocompleteInput = ({ label, value, onChange, suggestions, placeholder }) => {
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [filteredSuggestions, setFilteredSuggestions] = useState(suggestions);
            const inputRef = useRef(null);

            useEffect(() => {
                if (value) {
                    const filtered = suggestions.filter(s =>
                        s.toLowerCase().includes(value.toLowerCase())
                    );
                    setFilteredSuggestions(filtered);
                } else {
                    setFilteredSuggestions(suggestions);
                }
            }, [value, suggestions]);

            const handleSelect = (suggestion) => {
                onChange(suggestion);
                setShowSuggestions(false);
            };

            return (
                <div className="relative">
                    <label className="label">{label}</label>
                    <input
                        ref={inputRef}
                        className="input"
                        value={value || ''}
                        onChange={(e) => onChange(e.target.value)}
                        onFocus={() => setShowSuggestions(true)}
                        onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
                        placeholder={placeholder || `Type or select ${label.toLowerCase()}...`}
                    />
                    {showSuggestions && filteredSuggestions.length > 0 && (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-48 overflow-y-auto custom-scrollbar">
                            {filteredSuggestions.map((suggestion, idx) => (
                                <div
                                    key={idx}
                                    className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm text-slate-700 border-b border-slate-100 last:border-0"
                                    onMouseDown={() => handleSelect(suggestion)}
                                >
                                    {suggestion}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- CALENDAR TASK ITEM (with Rich Tooltip like Gantt) ---
        const CalendarTaskItem = memo(({
            task,
            calendarMode,
            getStatusColor,
            highlightedTaskId,
            draggedTask,
            onDragStart,
            onMouseDown,
            onMouseUp,
            onDoubleClick,
            formatDate
        }) => {
            const [isHovered, setIsHovered] = useState(false);
            const [tooltipPos, setTooltipPos] = useState({ top: 0, left: 0, showBelow: false });
            const itemRef = useRef(null);

            const start = task["Begin Date"] || task["Start Date"];
            const end = task["End Date"];

            // Calculate status color for tooltip badge
            let statusBadgeClass = 'bg-slate-500';
            const s = String(task.Status || '').toLowerCase();
            if (s.includes('complete')) statusBadgeClass = 'bg-emerald-500';
            else if (s.includes('progress')) statusBadgeClass = 'bg-blue-500';
            else if (s.includes('risk') || s.includes('delay')) statusBadgeClass = 'bg-red-500';

            const deps = task.Dependency ? String(task.Dependency).split(',').map(d => d.trim()).filter(Boolean) : [];

            // Update tooltip position when hovered - determine above/below immediately
            const handleMouseEnter = () => {
                if (itemRef.current) {
                    const rect = itemRef.current.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;

                    // If task is in upper half of viewport, show tooltip below; otherwise show above
                    const showBelow = rect.top < viewportHeight / 2;

                    setTooltipPos({
                        top: showBelow
                            ? rect.bottom + window.scrollY + 8
                            : rect.top + window.scrollY - 8,
                        left: rect.left + (rect.width / 2) + window.scrollX,
                        showBelow
                    });
                }
                setIsHovered(true);
            };

            // Tooltip content
            const tooltipContent = useMemo(() => (
                <div
                    className="bg-slate-900/95 backdrop-blur-lg text-white text-xs rounded-xl p-4 shadow-2xl border border-white/20"
                    style={{ width: 'max-content', minWidth: '260px', maxWidth: '360px' }}
                >
                    <div
                        className="font-bold text-sm mb-3 text-white/95 border-b border-white/10 pb-2 flex items-center gap-2"
                        style={{ wordBreak: 'break-word', whiteSpace: 'normal', overflowWrap: 'break-word' }}
                    >
                        <IndicatorBadges task={task} size="md" />
                        <span>{task["Task Description"]}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 text-[11px]">
                        {task["Task Number"] && (
                            <>
                                <div className="text-slate-400">Task #:</div>
                                <div className="font-medium">{task["Task Number"]}</div>
                            </>
                        )}

                        <div className="text-slate-400">Start:</div>
                        <div className="font-medium">{start instanceof Date ? start.toLocaleDateString() : (start || 'N/A')}</div>

                        <div className="text-slate-400">End:</div>
                        <div className="font-medium">{end instanceof Date ? end.toLocaleDateString() : (end || 'N/A')}</div>

                        <div className="text-slate-400">Status:</div>
                        <div className={`font-bold uppercase text-[10px] px-2 py-0.5 rounded-full w-fit ${statusBadgeClass}`}>
                            {task.Status || 'Not Started'}
                        </div>

                        {task.Lead && (
                            <>
                                <div className="text-slate-400">Owner:</div>
                                <div className="font-medium flex items-center">
                                    <span className="w-5 h-5 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-[9px] font-bold mr-1.5">
                                        {String(task.Lead).charAt(0).toUpperCase()}
                                    </span>
                                    {task.Lead}
                                </div>
                            </>
                        )}

                        {task.Program && (
                            <>
                                <div className="text-slate-400">Program:</div>
                                <div className="font-medium">{task.Program}</div>
                            </>
                        )}

                        {deps.length > 0 && (
                            <>
                                <div className="text-slate-400">Dependencies:</div>
                                <div className="font-medium flex flex-wrap gap-1">
                                    {deps.map((d, i) => (
                                        <span key={i} className="bg-cyan-500/20 text-cyan-300 px-1.5 py-0.5 rounded text-[10px]">#{d}</span>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>

                    {task.Notes && (
                        <div className="mt-2 pt-2 border-t border-white/10">
                            <div className="text-slate-400 mb-1 flex items-center gap-1">
                                <Icons.FileText className="w-3 h-3" /> <span className="uppercase tracking-wider text-[10px]">Notes</span>
                            </div>
                            <div className="text-slate-300 italic bg-white/5 p-2 rounded-lg border border-white/5 whitespace-normal leading-relaxed">
                                {task.Notes}
                            </div>
                        </div>
                    )}

                    <div className="mt-3 pt-2 border-t border-white/10 text-[10px] text-slate-400 flex items-center justify-between gap-2">
                        <span>Drag: Move</span>
                        <span className="text-slate-600">•</span>
                        <span>Hold 2s: Edit</span>
                        <span className="text-slate-600">•</span>
                        <span>Dbl-click: Status</span>
                    </div>
                </div>
            ), [task, start, end, statusBadgeClass, deps]);

            return (
                <div
                    ref={itemRef}
                    className="relative"
                    onMouseEnter={handleMouseEnter}
                    onMouseLeave={() => { setIsHovered(false); onMouseUp(); }}
                >
                    {(() => {
                        const { isMilestone, isKeyMilestone, isDiscussion } = getTaskIndicators(task);
                        let indicatorClass = '';
                        if (isKeyMilestone) indicatorClass = 'ring-2 ring-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.5)] z-10';
                        else if (isMilestone) indicatorClass = 'ring-2 ring-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.4)]';
                        if (isDiscussion) indicatorClass += ' border-dashed border-2 border-orange-500';

                        return (
                            <div
                                draggable
                                onDragStart={(e) => onDragStart(e, task)}
                                onMouseDown={() => onMouseDown(task)}
                                onMouseUp={onMouseUp}
                                onTouchStart={() => onMouseDown(task)}
                                onTouchEnd={onMouseUp}
                                onDoubleClick={(e) => { e.stopPropagation(); onDoubleClick(task); }}
                                className={`rounded-md border cursor-move hover:shadow-md truncate transition-all flex items-center gap-0.5 ${getStatusColor(task.Status)}
                                    ${highlightedTaskId === task._id ? 'ring-2 ring-yellow-400 shadow-lg' : ''}
                                    ${draggedTask && draggedTask._id === task._id ? 'opacity-50' : ''}
                                    ${calendarMode === 'single' ? 'text-xs px-1.5 py-1 font-medium' : 'text-[8px] p-0.5'}
                                    ${(task.isBold || isMilestone || isKeyMilestone) ? 'font-bold border-slate-400' : ''}
                                    ${indicatorClass}
                                `}
                            >
                                {isKeyMilestone && <span className="text-amber-400 shrink-0"><Icons.Star className="w-3 h-3" /></span>}
                                {isMilestone && !isKeyMilestone && <span className="text-purple-400 shrink-0"><Icons.Diamond className="w-2.5 h-2.5" /></span>}
                                {isDiscussion && <span className="text-orange-400 shrink-0"><Icons.MessageCircle className="w-2.5 h-2.5" /></span>}
                                <span className="truncate">{task["Task Description"]}</span>
                            </div>
                        );
                    })()}

                    {/* Rich Tooltip - rendered via Portal to escape overflow clipping */}
                    {isHovered && ReactDOM.createPortal(
                        <div
                            className="fixed pointer-events-none"
                            style={{
                                top: tooltipPos.top,
                                left: tooltipPos.left,
                                transform: tooltipPos.showBelow ? 'translate(-50%, 0)' : 'translate(-50%, -100%)',
                                zIndex: 99999
                            }}
                        >
                            {tooltipContent}
                        </div>,
                        document.body
                    )}
                </div>
            );
        });

        // --- CALENDAR MULTI-DAY BAR (with Rich Tooltip) ---
        const CalendarMultiDayBar = memo(({
            bar,
            barPosition,
            roundLeft,
            roundRight,
            isFirstSegment,
            calendarMode,
            getStatusColor,
            highlightedTaskId,
            draggedTask,
            onDragStart,
            onMouseDown,
            onMouseUp,
            onDoubleClick
        }) => {
            const [isHovered, setIsHovered] = useState(false);
            const [tooltipPos, setTooltipPos] = useState({ top: 0, left: 0, showBelow: false });
            const barRef = useRef(null);

            const task = bar.task;
            const start = task["Begin Date"] || task["Start Date"];
            const end = task["End Date"];

            // Calculate status color for tooltip badge
            let statusBadgeClass = 'bg-slate-500';
            const s = String(task.Status || '').toLowerCase();
            if (s.includes('complete')) statusBadgeClass = 'bg-emerald-500';
            else if (s.includes('progress')) statusBadgeClass = 'bg-blue-500';
            else if (s.includes('risk') || s.includes('delay')) statusBadgeClass = 'bg-red-500';

            const deps = task.Dependency ? String(task.Dependency).split(',').map(d => d.trim()).filter(Boolean) : [];

            const handleMouseEnter = () => {
                if (barRef.current) {
                    const rect = barRef.current.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const showBelow = rect.top < viewportHeight / 2;

                    setTooltipPos({
                        top: showBelow
                            ? rect.bottom + window.scrollY + 8
                            : rect.top + window.scrollY - 8,
                        left: rect.left + (rect.width / 2) + window.scrollX,
                        showBelow
                    });
                }
                setIsHovered(true);
            };

            // Tooltip content
            const tooltipContent = useMemo(() => (
                <div
                    className="bg-slate-900/95 backdrop-blur-lg text-white text-xs rounded-xl p-4 shadow-2xl border border-white/20"
                    style={{ width: 'max-content', minWidth: '260px', maxWidth: '360px' }}
                >
                    <div
                        className="font-bold text-sm mb-3 text-white/95 border-b border-white/10 pb-2 flex items-center gap-2"
                        style={{ wordBreak: 'break-word', whiteSpace: 'normal', overflowWrap: 'break-word' }}
                    >
                        <IndicatorBadges task={task} size="md" />
                        <span>{task["Task Description"]}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 text-[11px]">
                        {task["Task Number"] && (
                            <>
                                <div className="text-slate-400">Task #:</div>
                                <div className="font-medium">{task["Task Number"]}</div>
                            </>
                        )}

                        <div className="text-slate-400">Start:</div>
                        <div className="font-medium">{start instanceof Date ? start.toLocaleDateString() : (start || 'N/A')}</div>

                        <div className="text-slate-400">End:</div>
                        <div className="font-medium">{end instanceof Date ? end.toLocaleDateString() : (end || 'N/A')}</div>

                        <div className="text-slate-400">Duration:</div>
                        <div className="font-medium">{bar.totalDays} days</div>

                        <div className="text-slate-400">Status:</div>
                        <div className={`font-bold uppercase text-[10px] px-2 py-0.5 rounded-full w-fit ${statusBadgeClass}`}>
                            {task.Status || 'Not Started'}
                        </div>

                        {task.Lead && (
                            <>
                                <div className="text-slate-400">Owner:</div>
                                <div className="font-medium flex items-center">
                                    <span className="w-5 h-5 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-[9px] font-bold mr-1.5">
                                        {String(task.Lead).charAt(0).toUpperCase()}
                                    </span>
                                    {task.Lead}
                                </div>
                            </>
                        )}

                        {task.Program && (
                            <>
                                <div className="text-slate-400">Program:</div>
                                <div className="font-medium">{task.Program}</div>
                            </>
                        )}

                        {deps.length > 0 && (
                            <>
                                <div className="text-slate-400">Dependencies:</div>
                                <div className="font-medium flex flex-wrap gap-1">
                                    {deps.map((d, i) => (
                                        <span key={i} className="bg-cyan-500/20 text-cyan-300 px-1.5 py-0.5 rounded text-[10px]">#{d}</span>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>

                    {task.Notes && (
                        <div className="mt-2 pt-2 border-t border-white/10">
                            <div className="text-slate-400 mb-1 flex items-center gap-1">
                                <Icons.FileText className="w-3 h-3" /> <span className="uppercase tracking-wider text-[10px]">Notes</span>
                            </div>
                            <div className="text-slate-300 italic bg-white/5 p-2 rounded-lg border border-white/5 whitespace-normal leading-relaxed">
                                {task.Notes}
                            </div>
                        </div>
                    )}

                    <div className="mt-3 pt-2 border-t border-white/10 text-[10px] text-slate-400 flex items-center justify-between gap-2">
                        <span>Drag: Move</span>
                        <span className="text-slate-600">•</span>
                        <span>Hold 2s: Edit</span>
                        <span className="text-slate-600">•</span>
                        <span>Dbl-click: Status</span>
                    </div>
                </div>
            ), [task, start, end, bar.totalDays, statusBadgeClass, deps]);

            return (
                <>
                    {(() => {
                        const { isMilestone, isKeyMilestone, isDiscussion } = getTaskIndicators(task);
                        let indicatorClass = '';
                        if (isKeyMilestone) indicatorClass = 'ring-2 ring-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.5)] z-10';
                        else if (isMilestone) indicatorClass = 'ring-2 ring-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.4)]';
                        if (isDiscussion) indicatorClass += ' border-dashed border-2 border-orange-500';

                        return (
                            <div
                                ref={barRef}
                                draggable
                                onDragStart={(e) => onDragStart(e, task)}
                                onMouseDown={() => onMouseDown(task)}
                                onMouseUp={onMouseUp}
                                onMouseEnter={handleMouseEnter}
                                onMouseLeave={() => { setIsHovered(false); onMouseUp(); }}
                                onTouchStart={() => onMouseDown(task)}
                                onTouchEnd={onMouseUp}
                                onDoubleClick={(e) => { e.stopPropagation(); onDoubleClick(task); }}
                                className={`cursor-move hover:shadow-lg hover:brightness-105 transition-all overflow-hidden flex items-center
                                    ${getStatusColor(task.Status)}
                                    ${highlightedTaskId === task._id ? 'ring-2 ring-yellow-400 shadow-lg' : ''}
                                    ${draggedTask && draggedTask._id === task._id ? 'opacity-50' : ''}
                                    ${calendarMode === 'single' ? 'text-xs font-medium' : 'text-[9px]'}
                                    ${(task.isBold || isMilestone || isKeyMilestone) ? 'font-bold' : ''}
                                    ${indicatorClass}
                                `}
                                style={barPosition}
                            >
                                {isFirstSegment && (
                                    <span className="truncate whitespace-nowrap flex items-center gap-0.5">
                                        {isKeyMilestone && <span className="text-amber-400 shrink-0"><Icons.Star className="w-3 h-3" /></span>}
                                        {isMilestone && !isKeyMilestone && <span className="text-purple-400 shrink-0"><Icons.Diamond className="w-2.5 h-2.5" /></span>}
                                        {isDiscussion && <span className="text-orange-400 shrink-0"><Icons.MessageCircle className="w-2.5 h-2.5" /></span>}
                                        <span className="truncate">{task["Task Description"]}</span>
                                        <span className={`ml-1 opacity-70 ${calendarMode === 'single' ? 'text-[10px]' : 'text-[8px]'}`}>
                                            ({bar.totalDays}d)
                                        </span>
                                    </span>
                                )}
                                {!isFirstSegment && (
                                    <span className="truncate whitespace-nowrap opacity-70">
                                        ‹ {task["Task Description"]}
                                    </span>
                                )}
                            </div>
                        );
                    })()}

                    {/* Rich Tooltip - rendered via Portal */}
                    {isHovered && ReactDOM.createPortal(
                        <div
                            className="fixed pointer-events-none"
                            style={{
                                top: tooltipPos.top,
                                left: tooltipPos.left,
                                transform: tooltipPos.showBelow ? 'translate(-50%, 0)' : 'translate(-50%, -100%)',
                                zIndex: 99999
                            }}
                        >
                            {tooltipContent}
                        </div>,
                        document.body
                    )}
                </>
            );
        });

        // --- ENHANCED GANTT TASK ROW (with Drag, Resize, Tooltip) ---
        const GanttTaskRow = memo(({
            task,
            idx,
            visibleRowIndex,
            totalVisibleRows,
            leftColWidth,
            colWidth,
            rowHeight,
            getPos,
            minDate,
            onMouseDown,
            onMouseUp,
            onDoubleClick,
            onDateChange,
            onEdit
        }) => {
            const [isHovered, setIsHovered] = useState(false);
            const [isDragging, setIsDragging] = useState(false);
            const [isResizing, setIsResizing] = useState(null); // 'start' | 'end' | null
            const barRef = useRef(null);

            const start = task["Begin Date"] || task["Start Date"] || (task["End Date"] ? new Date(task["End Date"].getTime() - 86400000) : null);
            const end = task["End Date"];

            const startPos = getPos(start);
            const endPos = getPos(end);
            const width = (endPos - startPos) + colWidth;

            let statusColor = 'bg-slate-500';
            let statusGradient = 'from-slate-500 to-slate-600';
            const s = String(task.Status || '').toLowerCase();
            if (s.includes('complete')) { statusColor = 'bg-emerald-500'; statusGradient = 'from-emerald-400 to-emerald-600'; }
            else if (s.includes('progress')) { statusColor = 'bg-blue-500'; statusGradient = 'from-blue-400 to-blue-600'; }
            else if (s.includes('risk') || s.includes('delay')) { statusColor = 'bg-red-500'; statusGradient = 'from-red-400 to-red-600'; }
            else if (s.includes('not start')) { statusColor = 'bg-slate-600'; statusGradient = 'from-slate-500 to-slate-700'; }

            // Get task indicators
            const { isMilestone, isKeyMilestone, isDiscussion } = getTaskIndicators(task);

            // Apply indicator-based bar styling
            let indicatorBarClass = '';
            let indicatorBorderStyle = '';
            if (isKeyMilestone) {
                indicatorBarClass = 'ring-2 ring-amber-400/50 shadow-[0_0_12px_rgba(251,191,36,0.4)]';
            } else if (isMilestone) {
                indicatorBarClass = 'ring-1 ring-purple-400/50 shadow-[0_0_8px_rgba(168,85,247,0.3)]';
            }
            if (isDiscussion) {
                indicatorBorderStyle = 'border-dashed border-orange-400/70';
            }

            // Calculate days from position
            const posToDate = useCallback((posX) => {
                const dayOffset = Math.round(posX / colWidth);
                const newDate = new Date(minDate);
                newDate.setDate(newDate.getDate() + dayOffset);
                return newDate;
            }, [colWidth, minDate]);

            // Handle drag start (but not if clicking on resize handles) with long-press for edit
            const handleDragStart = (e) => {
                // Check if click is in resize handle zone (first/last 16px of bar)
                if (barRef.current) {
                    const rect = barRef.current.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const barWidth = rect.width;

                    // If clicking within 16px of left or right edge, don't start drag (resize will handle it)
                    if (clickX < 16 || clickX > barWidth - 16) {
                        return; // Let resize handler deal with it
                    }
                }

                e.preventDefault();
                e.stopPropagation();

                const startClientX = e.clientX;
                const startClientY = e.clientY;
                let animationFrameId = null;
                let lastDeltaX = 0;
                let hasMoved = false;
                let longPressTimer = null;

                // Start long-press timer for edit (2 seconds)
                longPressTimer = setTimeout(() => {
                    if (!hasMoved && onEdit) {
                        // Long press detected - open edit window
                        cleanup();
                        onEdit(task);
                    }
                }, 2000);

                const handleMouseMove = (moveEvent) => {
                    const deltaX = moveEvent.clientX - startClientX;
                    const deltaY = moveEvent.clientY - startClientY;

                    // If moved more than 5px, consider it a drag (cancel long-press)
                    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                        if (!hasMoved) {
                            hasMoved = true;
                            setIsDragging(true);
                            // Cancel long-press timer since user is dragging
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }

                        lastDeltaX = deltaX;

                        // Use requestAnimationFrame for smooth visual feedback
                        if (animationFrameId) cancelAnimationFrame(animationFrameId);
                        animationFrameId = requestAnimationFrame(() => {
                            if (barRef.current) {
                                barRef.current.style.transform = `translateX(${lastDeltaX}px)`;
                                barRef.current.style.opacity = '0.8';
                            }
                        });
                    }
                };

                const cleanup = () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                const handleMouseUp = () => {
                    cleanup();

                    // Only process drag if user actually moved
                    if (hasMoved) {
                        const daysDelta = Math.round(lastDeltaX / colWidth);

                        if (daysDelta !== 0 && onDateChange) {
                            const newStart = new Date(start);
                            newStart.setDate(newStart.getDate() + daysDelta);
                            const newEnd = new Date(end);
                            newEnd.setDate(newEnd.getDate() + daysDelta);
                            onDateChange(task._id, newStart, newEnd);
                        }

                        // Reset visual state
                        if (barRef.current) {
                            barRef.current.style.transform = '';
                            barRef.current.style.opacity = '';
                        }

                        setIsDragging(false);
                    }
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            };

            // Handle resize (start or end edge)
            const handleResizeStart = (e, edge) => {
                e.preventDefault();
                e.stopPropagation();
                setIsResizing(edge);

                const startClientX = e.clientX;
                let animationFrameId = null;
                let lastDeltaX = 0;

                const handleMouseMove = (moveEvent) => {
                    lastDeltaX = moveEvent.clientX - startClientX;

                    // Use requestAnimationFrame for smooth visual feedback
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    animationFrameId = requestAnimationFrame(() => {
                        if (barRef.current) {
                            if (edge === 'start') {
                                const newWidth = width - lastDeltaX;
                                if (newWidth > colWidth) {
                                    barRef.current.style.marginLeft = `${lastDeltaX}px`;
                                    barRef.current.style.width = `${newWidth}px`;
                                }
                            } else {
                                const newWidth = width + lastDeltaX;
                                if (newWidth > colWidth) {
                                    barRef.current.style.width = `${newWidth}px`;
                                }
                            }
                        }
                    });
                };

                const handleMouseUp = () => {
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);

                    const daysDelta = Math.round(lastDeltaX / colWidth);

                    if (daysDelta !== 0 && onDateChange) {
                        if (edge === 'start') {
                            const newStart = new Date(start);
                            newStart.setDate(newStart.getDate() + daysDelta);
                            if (newStart < end) {
                                onDateChange(task._id, newStart, end);
                            }
                        } else {
                            const newEnd = new Date(end);
                            newEnd.setDate(newEnd.getDate() + daysDelta);
                            if (newEnd > start) {
                                onDateChange(task._id, start, newEnd);
                            }
                        }
                    }

                    // Reset visual state
                    if (barRef.current) {
                        barRef.current.style.marginLeft = '';
                        barRef.current.style.width = '';
                    }

                    setIsResizing(null);
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            };

            // Rich tooltip content - Auto-sizing with proper constraints
            const tooltipContent = useMemo(() => {
                const deps = task.Dependency ? String(task.Dependency).split(',').map(d => d.trim()).filter(Boolean) : [];
                const taskName = task["Task Description"] || '';

                return (
                    <div
                        className="bg-slate-900/95 backdrop-blur-lg text-white text-xs rounded-xl p-4 shadow-2xl border border-white/20"
                        style={{
                            width: 'max-content',
                            minWidth: '280px',
                            maxWidth: '400px'
                        }}
                    >
                        <div
                            className="font-bold text-sm mb-3 text-white/95 border-b border-white/10 pb-2 flex items-center gap-2"
                            style={{
                                wordBreak: 'break-word',
                                whiteSpace: 'normal',
                                overflowWrap: 'break-word'
                            }}
                        >
                            <IndicatorBadges task={task} size="md" />
                            <span>{taskName}</span>
                        </div>
                        <div className="grid grid-cols-2 gap-2 text-[11px]">
                            <div className="text-slate-400">Task #:</div>
                            <div className="font-medium">{task["Task Number"]}</div>

                            <div className="text-slate-400">Start:</div>
                            <div className="font-medium">{start?.toLocaleDateString()}</div>

                            <div className="text-slate-400">End:</div>
                            <div className="font-medium">{end?.toLocaleDateString()}</div>

                            <div className="text-slate-400">Status:</div>
                            <div className={`font-bold uppercase text-[10px] px-2 py-0.5 rounded-full w-fit ${statusColor}`}>{task.Status || 'Not Started'}</div>

                            {task.Lead && (
                                <>
                                    <div className="text-slate-400">Owner:</div>
                                    <div className="font-medium flex items-center">
                                        <span className="w-5 h-5 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-[9px] font-bold mr-1.5">
                                            {String(task.Lead).charAt(0).toUpperCase()}
                                        </span>
                                        {task.Lead}
                                    </div>
                                </>
                            )}

                            {task.Program && (
                                <>
                                    <div className="text-slate-400">Program:</div>
                                    <div className="font-medium">{task.Program}</div>
                                </>
                            )}

                            {deps.length > 0 && (
                                <>
                                    <div className="text-slate-400">Dependencies:</div>
                                    <div className="font-medium flex flex-wrap gap-1">
                                        {deps.map((d, i) => (
                                            <span key={i} className="bg-cyan-500/20 text-cyan-300 px-1.5 py-0.5 rounded text-[10px]">#{d}</span>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>

                        {task.Notes && (
                            <div className="mt-2 pt-2 border-t border-white/10">
                                <div className="text-slate-400 mb-1 flex items-center gap-1">
                                    <Icons.FileText className="w-3 h-3" /> <span className="uppercase tracking-wider text-[10px]">Notes</span>
                                </div>
                                <div className="text-slate-300 italic bg-white/5 p-2 rounded-lg border border-white/5 whitespace-normal leading-relaxed">
                                    {task.Notes}
                                </div>
                            </div>
                        )}

                        <div className="mt-3 pt-2 border-t border-white/10 text-[10px] text-slate-400 flex items-center justify-between gap-2">
                            <span>Drag: Move</span>
                            <span className="text-slate-600">•</span>
                            <span>Edges: Resize</span>
                            <span className="text-slate-600">•</span>
                            <span>Hold 2s: Edit</span>
                            <span className="text-slate-600">•</span>
                            <span>Dbl-click: Status</span>
                        </div>
                    </div>
                );
            }, [task, start, end, statusColor]);

            return (
                <div
                    className="flex h-12 border-b border-white/5 hover:bg-white/5 transition-colors group relative overflow-visible"
                    style={{ height: rowHeight, zIndex: isHovered ? 100 : 10 }}
                >
                    {/* Sticky Left Column Cell */}
                    <div
                        className="sticky left-0 z-20 bg-slate-900 border-r border-white/10 flex items-center px-3 text-sm text-slate-300 truncate group-hover:bg-slate-800 transition-colors"
                        style={{ width: leftColWidth, minWidth: leftColWidth }}
                    >
                        <IndicatorBadges task={task} size="xs" />
                        <div className="flex flex-col truncate w-full ml-1">
                            <span className={`truncate ${(isMilestone || isKeyMilestone) ? 'font-bold text-white' : 'font-medium text-white/90'}`} title={task["Task Description"]}>{task["Task Description"]}</span>
                            <span className="text-[10px] text-slate-500">{task["Task Number"]}</span>
                        </div>
                    </div>

                    {/* Timeline Cell - overflow visible for tooltip */}
                    <div className="relative flex-1 overflow-visible" onDragOver={(e) => e.preventDefault()}>
                        {/* Task Bar */}
                        {startPos >= 0 && (
                            <div
                                ref={barRef}
                                className={`absolute top-2 rounded-lg shadow-lg border flex items-center justify-between text-xs ${(isMilestone || isKeyMilestone) ? 'font-bold' : 'font-medium'} text-white whitespace-nowrap overflow-visible cursor-grab hover:shadow-xl transition-all z-10 bg-gradient-to-r ${statusGradient} ${isDragging ? 'cursor-grabbing shadow-2xl scale-[1.02]' : ''} ${isResizing ? 'ring-2 ring-cyan-400' : ''} ${indicatorBarClass} ${indicatorBorderStyle || 'border-white/20'} ${isKeyMilestone ? 'h-9' : 'h-8'}`}
                                style={{ left: startPos, width: width, minWidth: colWidth }}
                                onMouseEnter={() => setIsHovered(true)}
                                onMouseLeave={() => setIsHovered(false)}
                                onMouseDown={handleDragStart}
                                onDoubleClick={(e) => { e.stopPropagation(); onDoubleClick(task); }}
                            >
                                {/* Left Resize Handle */}
                                <div
                                    className={`absolute left-0 top-0 bottom-0 w-4 cursor-ew-resize rounded-l-lg transition-all flex items-center justify-center ${isHovered || isResizing === 'start' ? 'bg-white/40' : 'bg-transparent'} ${isResizing === 'start' ? 'bg-cyan-400/50' : ''}`}
                                    onMouseDown={(e) => handleResizeStart(e, 'start')}
                                >
                                    {(isHovered || isResizing === 'start') && (
                                        <div className="flex flex-col gap-0.5">
                                            <div className="w-0.5 h-2 bg-white/70 rounded-full"></div>
                                            <div className="w-0.5 h-2 bg-white/70 rounded-full"></div>
                                        </div>
                                    )}
                                </div>

                                {/* Task Label */}
                                <div className="flex-1 truncate px-4 pointer-events-none">
                                    {width > 50 && task["Task Description"]}
                                </div>

                                {/* Right Resize Handle */}
                                <div
                                    className={`absolute right-0 top-0 bottom-0 w-4 cursor-ew-resize rounded-r-lg transition-all flex items-center justify-center ${isHovered || isResizing === 'end' ? 'bg-white/40' : 'bg-transparent'} ${isResizing === 'end' ? 'bg-cyan-400/50' : ''}`}
                                    onMouseDown={(e) => handleResizeStart(e, 'end')}
                                >
                                    {(isHovered || isResizing === 'end') && (
                                        <div className="flex flex-col gap-0.5">
                                            <div className="w-0.5 h-2 bg-white/70 rounded-full"></div>
                                            <div className="w-0.5 h-2 bg-white/70 rounded-full"></div>
                                        </div>
                                    )}
                                </div>

                                {/* Tooltip - Stable Hybrid Positioning */}
                                {isHovered && !isDragging && !isResizing && (() => {
                                    const showBelow = visibleRowIndex < totalVisibleRows / 2;
                                    // Removed 'animate-fade-in' to prevent transform conflicts causing jumps
                                    // Using standard opacity transition
                                    let className = `absolute transition-opacity duration-200 pointer-events-none ${showBelow ? 'top-full mt-2' : 'bottom-full mb-2'}`;
                                    const tooltipWidth = 280;

                                    // Default styles
                                    let style = {
                                        zIndex: 9999,
                                        width: tooltipWidth
                                    };

                                    const barRect = barRef.current?.getBoundingClientRect();

                                    if (barRect) {
                                        const viewportWidth = window.innerWidth;
                                        const sidebarEdge = (leftColWidth || 300) + 24;
                                        const visibleAreaWidth = viewportWidth - sidebarEdge - 24;

                                        // Check if task is "long" (extending beyond visible viewport area)
                                        const isLongTask = barRect.width > visibleAreaWidth;

                                        if (isLongTask) {
                                            // LONG TASK: Center tooltip on the VISIBLE portion of the bar
                                            const activeLeft = Math.max(barRect.left, sidebarEdge);
                                            const activeRight = Math.min(barRect.right, viewportWidth - 24);

                                            if (activeLeft < activeRight) {
                                                const visibleCenterAbs = (activeLeft + activeRight) / 2;
                                                const relativeLeft = visibleCenterAbs - barRect.left;

                                                style.left = `${relativeLeft}px`;
                                                style.marginLeft = -(tooltipWidth / 2); // Center using fixed margin
                                            } else {
                                                // Bar not visible? Default to center
                                                className += ' left-1/2';
                                                style.marginLeft = -(tooltipWidth / 2);
                                            }
                                        } else {
                                            // SHORT TASK: Standard Centered Behavior
                                            className += ' left-1/2';
                                            style.marginLeft = -(tooltipWidth / 2);
                                        }
                                    } else {
                                        // Fallback
                                        className += ' left-1/2';
                                        style.marginLeft = -(tooltipWidth / 2);
                                    }

                                    return (
                                        <div className={className} style={style}>
                                            {tooltipContent}
                                        </div>
                                    );
                                })()}
                            </div>
                        )}
                    </div>
                </div>
            );
        }, (prevProps, nextProps) => {
            // Custom comparison for memoization - only re-render if task data changes
            return prevProps.task._id === nextProps.task._id &&
                prevProps.task.Status === nextProps.task.Status &&
                prevProps.task["End Date"] === nextProps.task["End Date"] &&
                prevProps.task["Begin Date"] === nextProps.task["Begin Date"] &&
                prevProps.task["Task Description"] === nextProps.task["Task Description"] &&
                prevProps.leftColWidth === nextProps.leftColWidth &&
                prevProps.colWidth === nextProps.colWidth;
        });

        // --- SUBCOMPONENT: GANTT VIEW (Optimized with Virtualization) ---
        const GanttView = memo(({ tasks, onEdit, onStatusChange, onDateChange }) => {
            const [zoom, setZoom] = useState('day');
            const [leftColWidth, setLeftColWidth] = useState(256);
            const [isResizing, setIsResizing] = useState(false);
            const [scrollTop, setScrollTop] = useState(0);
            const [containerHeight, setContainerHeight] = useState(600);
            const containerRef = useRef(null);
            const resizeStartRef = useRef(0);
            const startWidthRef = useRef(0);
            const longPressTimerRef = useRef(null);

            // Virtualization settings
            const OVERSCAN = 5; // Render extra rows above/below viewport
            const rowHeight = 48;
            const colWidth = zoom === 'day' ? 50 : 30;

            // Throttled scroll handler for performance
            const handleScroll = useCallback(throttle((e) => {
                setScrollTop(e.target.scrollTop);
            }, 16), []); // ~60fps

            // Track container resize
            useEffect(() => {
                const updateHeight = debounce(() => {
                    if (containerRef.current) {
                        setContainerHeight(containerRef.current.clientHeight);
                    }
                }, 100);

                updateHeight();
                window.addEventListener('resize', updateHeight);
                return () => window.removeEventListener('resize', updateHeight);
            }, []);

            // Resizing Logic (memoized handlers)
            const startResize = useCallback((e) => {
                e.preventDefault();
                setIsResizing(true);
                resizeStartRef.current = e.clientX;
                startWidthRef.current = leftColWidth;

                const handleMouseMove = (e) => {
                    const diff = e.clientX - resizeStartRef.current;
                    const newWidth = Math.max(150, Math.min(600, startWidthRef.current + diff));
                    setLeftColWidth(newWidth);
                };

                const handleMouseUp = () => {
                    setIsResizing(false);
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            }, [leftColWidth]);

            // 1. Calculate Timeline Range - Use FIXED origin to prevent shifting
            // The origin is cached on first load and only extended if absolutely necessary
            const originDateRef = useRef(null);

            const { minDate, maxDate, totalDays } = useMemo(() => {
                if (!tasks.length) return { minDate: new Date(), maxDate: new Date(), totalDays: 0 };

                // Find actual task bounds
                let taskMin = new Date(8640000000000000);
                let taskMax = new Date(-8640000000000000);

                tasks.forEach(t => {
                    const start = t["Begin Date"] || t["Start Date"] || (t["End Date"] ? new Date(t["End Date"].getTime() - 86400000) : null);
                    const end = t["End Date"];
                    if (start && start < taskMin) taskMin = start;
                    if (end && end > taskMax) taskMax = end;
                });

                if (taskMin > taskMax) {
                    taskMin = new Date();
                    taskMax = new Date(new Date().setDate(taskMin.getDate() + 30));
                }

                // On first load, set the origin and keep it stable
                if (!originDateRef.current) {
                    const origin = new Date(taskMin);
                    origin.setDate(origin.getDate() - 30); // 30 days buffer before first task
                    origin.setHours(0, 0, 0, 0);
                    originDateRef.current = origin;
                }

                // Use the cached origin - only extend if task goes before it
                let min = new Date(originDateRef.current);
                const taskMinWithBuffer = new Date(taskMin);
                taskMinWithBuffer.setDate(taskMinWithBuffer.getDate() - 7);

                if (taskMinWithBuffer < min) {
                    // Task moved before origin - extend origin
                    min = new Date(taskMinWithBuffer);
                    min.setHours(0, 0, 0, 0);
                    originDateRef.current = min;
                }

                // Max always covers all tasks + buffer
                let max = new Date(taskMax);
                max.setDate(max.getDate() + 30);

                const diffTime = Math.abs(max - min);
                const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return { minDate: min, maxDate: max, totalDays };
            }, [tasks]);

            // Note: originDateRef keeps timeline stable, no scroll adjustment needed

            // 3. Memoized getPos helper
            const getPos = useCallback((date) => {
                if (!date) return -1;
                const diff = Math.floor((date - minDate) / (1000 * 60 * 60 * 24));
                return diff * colWidth;
            }, [minDate, colWidth]);

            // Scroll to Today (Memoized)
            const scrollToToday = useCallback(() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const pos = getPos(today);
                if (containerRef.current && pos >= 0) {
                    containerRef.current.scrollTo({ left: pos - (containerRef.current.clientWidth / 2) + leftColWidth, behavior: 'smooth' });
                }
            }, [getPos, leftColWidth]);

            // Auto-scroll to first task on initial load
            const hasScrolledRef = useRef(false);
            useEffect(() => {
                if (hasScrolledRef.current || !containerRef.current || !tasks.length) return;

                // Find the earliest task date
                let firstTaskDate = null;
                tasks.forEach(t => {
                    const start = t["Begin Date"] || t["Start Date"] || t["End Date"];
                    if (start && (!firstTaskDate || start < firstTaskDate)) {
                        firstTaskDate = start;
                    }
                });

                if (firstTaskDate) {
                    const pos = getPos(firstTaskDate);
                    if (pos >= 0) {
                        // Scroll so first task is visible with some padding
                        containerRef.current.scrollTo({ left: Math.max(0, pos - 100), behavior: 'auto' });
                        hasScrolledRef.current = true;
                    }
                }
            }, [tasks, getPos]);

            // 4. Generate Header Days & Months (Memoized)
            const { headerDays, headerMonths } = useMemo(() => {
                const days = [];
                const months = [];
                let currentMonthLabel = null;
                let currentMonthWidth = 0;

                for (let i = 0; i <= totalDays; i++) {
                    const d = new Date(minDate);
                    d.setDate(d.getDate() + i);
                    days.push(d);

                    const monthLabel = d.toLocaleString('default', { month: 'long', year: 'numeric' });
                    if (monthLabel !== currentMonthLabel) {
                        if (currentMonthLabel) {
                            months.push({ label: currentMonthLabel, width: currentMonthWidth, id: `${currentMonthLabel}-${i}` });
                        }
                        currentMonthLabel = monthLabel;
                        currentMonthWidth = colWidth;
                    } else {
                        currentMonthWidth += colWidth;
                    }
                }
                if (currentMonthLabel) {
                    months.push({ label: currentMonthLabel, width: currentMonthWidth, id: `${currentMonthLabel}-last` });
                }

                return { headerDays: days, headerMonths: months };
            }, [minDate, totalDays, colWidth]);

            // 5. Calculate Dependencies (SVG Lines) - Memoized
            const dependencyLines = useMemo(() => {
                const lines = [];
                const taskMap = {};

                tasks.forEach((t, idx) => {
                    const tNum = String(t["Task Number"] || '').trim();
                    if (tNum) {
                        const hasDates = t["Begin Date"] || t["Start Date"] || t["End Date"];
                        if (!taskMap[tNum] || (hasDates && !taskMap[tNum].hasDates)) {
                            taskMap[tNum] = { ...t, _index: idx, hasDates };
                        }
                    }
                });

                tasks.forEach((task, idx) => {
                    const deps = String(task.Dependency || '').split(',').map(d => d.trim()).filter(Boolean);

                    deps.forEach(depId => {
                        if (taskMap[depId]) {
                            const parent = taskMap[depId];
                            const pStart = parent["Begin Date"] || parent["Start Date"] || (parent["End Date"] ? new Date(parent["End Date"].getTime() - 86400000) : null);
                            const pEnd = parent["End Date"];
                            const pStartPos = getPos(pStart);
                            const pEndPos = getPos(pEnd);

                            if (pStartPos < 0) return;

                            const pWidth = (pEndPos - pStartPos) + colWidth;
                            const cStart = task["Begin Date"] || task["Start Date"] || (task["End Date"] ? new Date(task["End Date"].getTime() - 86400000) : null);
                            const cStartPos = getPos(cStart);

                            if (cStartPos < 0) return;

                            const startX = pStartPos + pWidth + leftColWidth;
                            const startY = (parent._index * rowHeight) + (rowHeight / 2);
                            const endX = cStartPos + leftColWidth;
                            const endY = (idx * rowHeight) + (rowHeight / 2);

                            const dist = Math.abs(endX - startX);
                            const controlOffset = Math.min(dist * 0.5, 80);

                            lines.push(
                                <path
                                    key={`${parent._id}-${task._id}-${depId}`}
                                    d={`M ${startX} ${startY} C ${startX + controlOffset} ${startY}, ${endX - controlOffset} ${endY}, ${endX} ${endY}`}
                                    fill="none"
                                    stroke="rgba(255, 255, 255, 0.5)"
                                    strokeWidth="1.5"
                                    markerEnd="url(#arrowhead)"
                                    className="hover:stroke-cyan-400 hover:stroke-[2px] transition-colors duration-300"
                                />
                            );
                        }
                    });
                });
                return lines;
            }, [tasks, getPos, colWidth, rowHeight, leftColWidth]);

            // Calculate visible range for virtualization
            const visibleRange = useMemo(() => {
                const headerOffset = 80; // Height of header rows
                const adjustedScrollTop = Math.max(0, scrollTop - headerOffset);
                const startIndex = Math.max(0, Math.floor(adjustedScrollTop / rowHeight) - OVERSCAN);
                const visibleCount = Math.ceil(containerHeight / rowHeight) + (2 * OVERSCAN);
                const endIndex = Math.min(tasks.length, startIndex + visibleCount);
                return { startIndex, endIndex };
            }, [scrollTop, containerHeight, tasks.length, rowHeight]);

            // Task Interaction Handlers (Memoized)
            const handleTaskMouseDown = useCallback((task) => {
                longPressTimerRef.current = setTimeout(() => {
                    onEdit(task);
                }, 2000);
            }, [onEdit]);

            const handleTaskMouseUp = useCallback(() => {
                if (longPressTimerRef.current) {
                    clearTimeout(longPressTimerRef.current);
                    longPressTimerRef.current = null;
                }
            }, []);

            const handleTaskDoubleClick = useCallback((task) => {
                const currentStatus = String(task.Status || 'Not Started').toLowerCase();
                let nextStatus = 'Not Started';
                if (currentStatus.includes('not started')) nextStatus = 'In Progress';
                else if (currentStatus.includes('progress')) nextStatus = 'Completed';
                else if (currentStatus.includes('complete')) nextStatus = 'Not Started';

                // Match casing to existing statuses in the tasks array
                const matchedStatus = tasks.find(t =>
                    t.Status && t.Status.toLowerCase() === nextStatus.toLowerCase()
                );
                if (matchedStatus) {
                    nextStatus = matchedStatus.Status;
                }

                if (onStatusChange) {
                    onStatusChange(task._id, nextStatus);
                }
            }, [onStatusChange, tasks]);

            // Handle date changes from drag/resize operations
            const handleGanttDateChange = useCallback((taskId, newStart, newEnd) => {
                if (onDateChange) {
                    onDateChange(taskId, newStart, newEnd);
                }
            }, [onDateChange]);

            // Calculate Today line position
            const todayPos = useMemo(() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return getPos(today);
            }, [getPos]);

            // Pre-calculate visible tasks
            const visibleTasks = useMemo(() => {
                return tasks.slice(visibleRange.startIndex, visibleRange.endIndex);
            }, [tasks, visibleRange]);

            const totalHeight = tasks.length * rowHeight;

            return (
                <div className={`h-full flex flex-col bg-slate-900/40 backdrop-blur-xl rounded-2xl border border-white/10 shadow-2xl overflow-hidden relative ${isResizing ? 'cursor-col-resize select-none' : ''}`}>
                    {/* Toolbar */}
                    <div className="h-14 flex items-center justify-between px-6 border-b border-white/10 bg-white/5 shrink-0">
                        <div className="flex items-center space-x-4">
                            <h2 className="text-white font-bold flex items-center space-x-2">
                                <Icons.GanttChart className="w-5 h-5 text-cyan-400" />
                                <span>Gantt Timeline</span>
                                <span className="text-xs text-slate-400 font-normal">({tasks.length} tasks)</span>
                            </h2>
                            <button onClick={scrollToToday} className="flex items-center space-x-1 px-3 py-1 bg-blue-500/20 text-blue-400 hover:text-white hover:bg-blue-500 rounded-md text-xs font-bold transition-all border border-blue-500/30 hover:border-blue-500">
                                <Icons.Clock className="w-3 h-3" />
                                <span>Today</span>
                            </button>
                        </div>

                        {/* Legend & Tips */}
                        <div className="hidden md:flex items-center space-x-3 text-[10px] font-medium text-slate-400 bg-black/20 px-3 py-1.5 rounded-full border border-white/5">
                            <div className="flex items-center gap-1 text-amber-400" title="Key Milestone">
                                <Icons.Star className="w-3 h-3" />
                                <span>Key</span>
                            </div>
                            <div className="flex items-center gap-1 text-purple-400" title="Milestone">
                                <Icons.Diamond className="w-3 h-3" />
                                <span>Milestone</span>
                            </div>
                            <div className="flex items-center gap-1 text-orange-400" title="Discussion">
                                <Icons.MessageCircle className="w-3 h-3" />
                                <span>Discussion</span>
                            </div>
                            <span className="w-px h-3 bg-slate-600"></span>
                            <span className="flex items-center">Drag: Move</span>
                            <span className="w-1 h-1 rounded-full bg-slate-600"></span>
                            <span className="flex items-center">Edges: Resize</span>
                            <span className="w-1 h-1 rounded-full bg-slate-600"></span>
                            <span className="flex items-center">Hold 2s: Edit</span>
                            <span className="w-1 h-1 rounded-full bg-slate-600"></span>
                            <span className="flex items-center">Dbl-click: Status</span>
                        </div>

                        <div className="flex bg-black/20 rounded-lg p-1">
                            <button onClick={() => setZoom('day')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${zoom === 'day' ? 'bg-white/20 text-white' : 'text-slate-400 hover:text-white'}`}>Day</button>
                            <button onClick={() => setZoom('week')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${zoom === 'week' ? 'bg-white/20 text-white' : 'text-slate-400 hover:text-white'}`}>Week</button>
                        </div>
                    </div>

                    {/* Scrollable Container with throttled scroll */}
                    <div
                        className="flex-1 overflow-auto custom-scrollbar relative"
                        ref={containerRef}
                        onScroll={handleScroll}
                    >
                        <div className="relative min-w-max">
                            {/* Header Container */}
                            <div className="sticky top-0 z-20 bg-slate-900 shadow-lg">
                                {/* Row 1: Months */}
                                <div className="flex border-b border-white/10 h-8">
                                    <div className="sticky left-0 z-30 bg-slate-900 border-r border-white/10 shrink-0" style={{ width: leftColWidth, minWidth: leftColWidth }}></div>
                                    <div className="flex">
                                        {headerMonths.map((m, i) => (
                                            <div key={m.id || i} className="flex items-center justify-center text-xs font-bold text-slate-300 border-r border-white/10 bg-slate-800/50" style={{ width: m.width }}>
                                                {m.label}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {/* Row 2: Days */}
                                <div className="flex border-b border-white/10 h-12">
                                    <div
                                        className="sticky left-0 z-30 bg-slate-900 border-r border-white/10 flex items-center px-4 font-bold text-xs text-slate-400 uppercase tracking-wider shadow-xl relative group shrink-0"
                                        style={{ width: leftColWidth, minWidth: leftColWidth }}
                                    >
                                        Task Name
                                        <div
                                            className="absolute right-0 top-0 bottom-0 w-1 cursor-col-resize hover:bg-blue-500 transition-colors z-40"
                                            onMouseDown={startResize}
                                        ></div>
                                    </div>
                                    <div className="flex">
                                        {headerDays.map((d, i) => (
                                            <div
                                                key={d.getTime()}
                                                className="flex-shrink-0 border-r border-white/5 flex flex-col items-center justify-center text-slate-400"
                                                style={{ width: colWidth }}
                                            >
                                                <span className="text-[10px] font-bold">{d.getDate()}</span>
                                                <span className="text-[9px] opacity-50">{d.toLocaleString('default', { weekday: 'narrow' })}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Body - Virtualized */}
                            <div className="relative overflow-visible" style={{ height: totalHeight }}>
                                {/* Background Grid - Single render */}
                                <div className="absolute inset-0 flex pointer-events-none z-0" style={{ height: totalHeight, left: leftColWidth }}>
                                    {headerDays.map((d, i) => (
                                        <div key={`grid-${d.getTime()}`} className="flex-shrink-0 border-r border-white/5 h-full" style={{ width: colWidth }}></div>
                                    ))}
                                </div>

                                {/* SVG Layer for Dependencies */}
                                <svg className="absolute inset-0 pointer-events-none z-0" style={{ width: '100%', height: totalHeight }}>
                                    <defs>
                                        <marker id="arrowhead" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                                            <polygon points="0 0, 6 2, 0 4" fill="rgba(255,255,255,0.3)" />
                                        </marker>
                                    </defs>
                                    {dependencyLines}
                                </svg>

                                {/* TODAY LINE - Vertical indicator */}
                                {todayPos >= 0 && (
                                    <div
                                        className="absolute top-0 bottom-0 w-[2px] bg-gradient-to-b from-red-500 via-red-400 to-red-500 z-30 pointer-events-none shadow-lg"
                                        style={{ left: leftColWidth + todayPos + (colWidth / 2), height: totalHeight }}
                                    >
                                        {/* Today label */}
                                        <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg whitespace-nowrap">
                                            Today
                                        </div>
                                        {/* Pulse effect at top */}
                                        <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-3 h-3 bg-red-500 rounded-full animate-pulse shadow-lg" />
                                    </div>
                                )}

                                {/* Virtualized Task Rows - Only render visible rows */}
                                <div
                                    className="absolute left-0 right-0 overflow-visible"
                                    style={{ top: visibleRange.startIndex * rowHeight }}
                                >
                                    {visibleTasks.map((task, i) => (
                                        <GanttTaskRow
                                            key={task._id}
                                            task={task}
                                            idx={visibleRange.startIndex + i}
                                            visibleRowIndex={i}
                                            totalVisibleRows={visibleTasks.length}
                                            leftColWidth={leftColWidth}
                                            colWidth={colWidth}
                                            rowHeight={rowHeight}
                                            getPos={getPos}
                                            minDate={minDate}
                                            onMouseDown={handleTaskMouseDown}
                                            onMouseUp={handleTaskMouseUp}
                                            onDoubleClick={handleTaskDoubleClick}
                                            onDateChange={handleGanttDateChange}
                                            onEdit={onEdit}
                                        />
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        });

        // --- MINI DATE PICKER (Glassmorphic) ---
        const MiniDatePicker = ({ selectedDate, onSelect, onClose, position }) => {
            const [currentMonth, setCurrentMonth] = useState(() => {
                const d = selectedDate ? new Date(selectedDate) : new Date();
                return new Date(d.getFullYear(), d.getMonth(), 1);
            });

            const stopPropagation = (e) => {
                e.stopPropagation();
                e.preventDefault();
            };

            const days = useMemo(() => {
                const y = currentMonth.getFullYear();
                const m = currentMonth.getMonth();
                const firstDay = new Date(y, m, 1);
                const lastDay = new Date(y, m + 1, 0);

                const daysArr = [];
                for (let i = 0; i < firstDay.getDay(); i++) daysArr.push(null);
                for (let i = 1; i <= lastDay.getDate(); i++) daysArr.push(new Date(y, m, i));

                return daysArr;
            }, [currentMonth]);

            const handlePrevMonth = (e) => {
                e.stopPropagation();
                setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
            };

            const handleNextMonth = (e) => {
                e.stopPropagation();
                setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
            };

            const handleDayClick = (date, e) => {
                e.stopPropagation();
                // Set to noon to avoid timezone shift
                const newDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
                onSelect(newDate);
                onClose();
            };

            // Smart positioning
            const style = {
                top: position.top,
                left: position.left,
                zIndex: 99999
            };

            if (window.innerHeight - position.top < 320) {
                style.top = 'auto';
                style.bottom = window.innerHeight - position.top + 30; // 30px buffer
            }

            return ReactDOM.createPortal(
                <>
                    <div className="fixed inset-0 z-[99998]" onClick={(e) => { e.stopPropagation(); onClose(); }}></div>
                    <div
                        className="fixed bg-slate-900/95 backdrop-blur-xl border border-white/20 rounded-xl shadow-2xl p-4 w-64 animate-scale-in"
                        style={style}
                        onClick={stopPropagation}
                    >
                        <div className="flex items-center justify-between mb-4">
                            <button onClick={handlePrevMonth} className="p-1 hover:bg-white/10 rounded-full text-white transition-colors">
                                <Icons.ChevronLeft className="w-4 h-4" />
                            </button>
                            <span className="font-bold text-white text-sm">
                                {currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}
                            </span>
                            <button onClick={handleNextMonth} className="p-1 hover:bg-white/10 rounded-full text-white transition-colors">
                                <Icons.ChevronRight className="w-4 h-4" />
                            </button>
                        </div>
                        <div className="grid grid-cols-7 mb-2">
                            {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(d => (
                                <div key={d} className="text-center text-[10px] font-bold text-slate-400 uppercase">{d}</div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7 gap-1">
                            {days.map((d, i) => {
                                if (!d) return <div key={i}></div>;
                                const isSelected = selectedDate && d.toDateString() === new Date(selectedDate).toDateString();
                                const isToday = d.toDateString() === new Date().toDateString();
                                return (
                                    <button
                                        key={i}
                                        onClick={(e) => handleDayClick(d, e)}
                                        className={`
                                            h-7 w-7 rounded-full flex items-center justify-center text-xs font-medium transition-all
                                            ${isSelected ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/50 scale-110' : 'text-slate-200 hover:bg-white/10'}
                                            ${isToday && !isSelected ? 'border border-blue-400 text-blue-300' : ''}
                                        `}
                                    >
                                        {d.getDate()}
                                    </button>
                                );
                            })}
                        </div>
                        <div className="mt-3 pt-3 border-t border-white/10 flex justify-center">
                            <button
                                onClick={(e) => { e.stopPropagation(); onSelect(null); onClose(); }} // Clear date
                                className="text-[10px] text-red-400 hover:text-red-300 font-medium opacity-70 hover:opacity-100 transition-opacity"
                            >
                                Clear Date
                            </button>
                        </div>
                    </div>
                </>,
                document.body
            );
        };

        // --- MEMOIZED TABLE ROW COMPONENT (Performance Optimization for Dashboard) ---
        const TaskTableRow = memo(({
            row,
            isLongPress,
            isHighlighted,
            hoveredForBold,
            getStatusColor,
            isTaskPastDue,
            formatDate,
            onMouseDown,
            onMouseUp,
            onMouseLeave,
            onEdit,
            onDelete,
            onStatusUpdate,
            onDateUpdate,
            onBoldHover,
            onBoldLeave,
            onToggleIndicator,
            anomalies,
            rowRef,
            sidebarOpen = true
        }) => {
            const [showNotes, setShowNotes] = useState(false);
            const [notesPos, setNotesPos] = useState({ top: 0, left: 0 });
            const [showCalendar, setShowCalendar] = useState(false);
            const [calendarPos, setCalendarPos] = useState({ top: 0, left: 0 });
            const [showAnomalyTooltip, setShowAnomalyTooltip] = useState(false);
            const [anomalyPos, setAnomalyPos] = useState({ top: 0, left: 0 });
            const [isHoveringAnomaly, setIsHoveringAnomaly] = useState(false);
            const [showIndicatorMenu, setShowIndicatorMenu] = useState(false);

            // Get current indicator states
            const { isMilestone, isKeyMilestone, isDiscussion } = getTaskIndicators(row);

            const handleAnomalyEnter = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                setAnomalyPos({
                    top: rect.bottom + window.scrollY + 5,
                    left: rect.left + window.scrollX
                });
                setShowAnomalyTooltip(true);
                setIsHoveringAnomaly(true);
            };

            const handleNotesEnter = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                setNotesPos({
                    top: rect.bottom + window.scrollY + 8,
                    left: rect.left + window.scrollX - 10 // Adjustment to align better
                });
                setShowNotes(true);
            };

            return (
                <tr
                    ref={rowRef}
                    className={`hover:bg-blue-50/50 group transition-colors
                        ${isLongPress ? 'bg-blue-50 ring-2 ring-blue-400' : ''}
                        ${isHighlighted ? 'bg-yellow-50 ring-2 ring-yellow-400' : ''}
                        ${anomalies && anomalies.length > 0 ? 'bg-red-100/40 ring-1 ring-red-500/30 shadow-[inset_3px_0_0_rgba(239,68,68,1)]' : ''}
                    `}
                    onMouseDown={onMouseDown}
                    onMouseUp={onMouseUp}
                    onMouseLeave={() => { onMouseLeave(); setShowNotes(false); }}
                    onTouchStart={onMouseDown}
                    onTouchEnd={onMouseUp}
                    style={{ cursor: isLongPress ? 'wait' : 'default' }}
                >
                    <td className="px-3 py-3 text-center">
                        <button onClick={onEdit} className="text-slate-300 hover:text-blue-600 transition-colors"><Icons.Edit2 className="w-4 h-4" /></button>
                    </td>
                    <td className="px-6 py-3 font-mono text-xs text-slate-500">{row["Task Number"]}</td>
                    <td className="px-6 py-3 font-medium text-slate-800">{row.Program}</td>
                    <td className="px-6 py-3 text-slate-500 text-xs">{row["Task Type"]}</td>
                    <td
                        className={`px-6 py-3 relative group/task ${(isMilestone || isKeyMilestone) ? 'font-bold text-slate-900' : ''} ${sidebarOpen ? 'max-w-xs' : 'max-w-lg'}`}
                        onMouseEnter={onBoldHover}
                        onMouseLeave={(e) => { onBoldLeave(); setShowIndicatorMenu(false); }}
                    >
                        <div className="flex items-center w-full">
                            <IndicatorBadges task={row} size="sm" />
                            {row.Notes && (
                                <span
                                    className="ml-1 mr-2 shrink-0 text-amber-500 hover:text-amber-600 cursor-help transition-colors"
                                    onMouseEnter={handleNotesEnter}
                                    onMouseLeave={() => setShowNotes(false)}
                                >
                                    <Icons.FileText className="w-3.5 h-3.5" />
                                </span>
                            )}
                            <span className="truncate block" title={row["Task Description"]}>
                                {row["Task Description"]}
                            </span>
                            {anomalies && anomalies.length > 0 && (
                                <>
                                    <div
                                        className="ml-2 group/anomaly relative cursor-help"
                                        onMouseEnter={handleAnomalyEnter}
                                        onMouseLeave={() => { setShowAnomalyTooltip(false); setIsHoveringAnomaly(false); }}
                                    >
                                        <Icons.AlertCircle className="w-4 h-4 text-red-500 animate-pulse" />
                                    </div>
                                    {showAnomalyTooltip && ReactDOM.createPortal(
                                        <div
                                            className="fixed z-[9999] bg-slate-900/95 backdrop-blur-md text-white text-xs p-3 rounded-lg shadow-xl shadow-red-900/20 border border-red-500/30 max-w-xs pointer-events-none animate-scale-in"
                                            style={{ top: anomalyPos.top, left: anomalyPos.left }}
                                        >
                                            <div className="font-bold text-red-400 mb-2 uppercase tracking-wider flex items-center gap-1 border-b border-red-500/20 pb-1">
                                                <Icons.AlertCircle className="w-3 h-3" /> Anomalies Detected
                                            </div>
                                            <ul className="list-disc pl-4 space-y-1 text-slate-300">
                                                {anomalies.map((issue, idx) => (
                                                    <li key={idx}>{issue}</li>
                                                ))}
                                            </ul>
                                        </div>,
                                        document.body
                                    )}
                                </>
                            )}
                        </div>
                        {/* Indicator Toggle Menu */}
                        {hoveredForBold && !isHoveringAnomaly && (
                            <div
                                className="absolute right-2 top-1/2 -translate-y-1/2 z-20"
                                onMouseEnter={() => setShowIndicatorMenu(true)}
                                onMouseLeave={() => setShowIndicatorMenu(false)}
                            >
                                <button
                                    onClick={(e) => { e.stopPropagation(); setShowIndicatorMenu(!showIndicatorMenu); }}
                                    className="bg-slate-800 text-white text-[10px] px-2 py-1 rounded shadow-lg animate-scale-in hover:bg-slate-700 font-medium whitespace-nowrap flex items-center gap-1"
                                >
                                    <Icons.Flag className="w-3 h-3" />
                                    Mark
                                </button>
                                {showIndicatorMenu && (
                                    <div className="absolute right-0 top-full pt-1">
                                        <div className="bg-slate-800 rounded-lg shadow-xl border border-white/10 py-1 min-w-[140px] animate-scale-in">
                                            <button
                                                onClick={(e) => { e.stopPropagation(); onToggleIndicator('Key Milestone'); }}
                                                className={`w-full px-3 py-1.5 text-left text-[11px] flex items-center gap-2 hover:bg-white/10 transition-colors ${isKeyMilestone ? 'text-amber-400' : 'text-white/80'}`}
                                            >
                                                <Icons.Star className="w-3 h-3" />
                                                <span>Key Milestone</span>
                                                {isKeyMilestone && <span className="ml-auto">✓</span>}
                                            </button>
                                            <button
                                                onClick={(e) => { e.stopPropagation(); onToggleIndicator('Milestone'); }}
                                                className={`w-full px-3 py-1.5 text-left text-[11px] flex items-center gap-2 hover:bg-white/10 transition-colors ${isMilestone ? 'text-purple-400' : 'text-white/80'}`}
                                            >
                                                <Icons.Diamond className="w-3 h-3" />
                                                <span>Milestone</span>
                                                {isMilestone && <span className="ml-auto">✓</span>}
                                            </button>
                                            <button
                                                onClick={(e) => { e.stopPropagation(); onToggleIndicator('Discussion'); }}
                                                className={`w-full px-3 py-1.5 text-left text-[11px] flex items-center gap-2 hover:bg-white/10 transition-colors ${isDiscussion ? 'text-orange-400' : 'text-white/80'}`}
                                            >
                                                <Icons.MessageCircle className="w-3 h-3" />
                                                <span>Discussion</span>
                                                {isDiscussion && <span className="ml-auto">✓</span>}
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {showNotes && ReactDOM.createPortal(
                            <div
                                className="fixed z-[9999] bg-slate-900/95 backdrop-blur-md text-white text-xs p-3 rounded-lg shadow-xl shadow-black/20 border border-white/10 max-w-xs pointer-events-none animate-fade-in"
                                style={{ top: notesPos.top, left: notesPos.left }}
                            >
                                <div className="font-bold text-slate-400 mb-1 text-[10px] uppercase tracking-wider flex items-center gap-1">
                                    <Icons.FileText className="w-3 h-3" /> Note
                                </div>
                                <div className="italic leading-relaxed">{row.Notes}</div>
                            </div>,
                            document.body
                        )}
                    </td>
                    <td className="px-6 py-3 text-slate-600 text-xs">{row.Lead}</td>
                    <td
                        className="px-6 py-3 font-mono text-xs text-slate-500 cursor-pointer hover:bg-slate-100 transition-colors group/date relative"
                        onClick={(e) => {
                            e.stopPropagation();
                            const rect = e.currentTarget.getBoundingClientRect();
                            setCalendarPos({
                                top: rect.bottom + window.scrollY + 4,
                                left: rect.left + window.scrollX - 80 // Shift left slightly to center align with col
                            });
                            setShowCalendar(true);
                        }}
                    >
                        <div className="flex items-center gap-2">
                            <span>{formatDate(row["End Date"])}</span>
                            <Icons.Edit2 className="w-3 h-3 opacity-0 group-hover/date:opacity-50 transition-opacity" />
                        </div>
                        {showCalendar && (
                            <MiniDatePicker
                                selectedDate={row["End Date"]}
                                position={calendarPos}
                                onClose={() => setShowCalendar(false)}
                                onSelect={(date) => {
                                    if (onDateUpdate) onDateUpdate(row._id, date);
                                }}
                            />
                        )}
                    </td>
                    <td className="px-6 py-3">
                        <select
                            value={row.Status || 'Not Started'}
                            onChange={onStatusUpdate}
                            onMouseDown={(e) => e.stopPropagation()}
                            className={`w-full text-[11px] font-bold uppercase tracking-wide border-0 rounded-md px-2 py-1.5 cursor-pointer outline-none status-select ${getStatusColor(row.Status)} ${isTaskPastDue(row) ? 'ring-2 ring-red-600' : 'ring-1 ring-inset ring-black/5 focus:ring-2 focus:ring-blue-500'}`}
                        >
                            {/* Include current status as option in case it has unique casing */}
                            {row.Status && !['Not Started', 'In Progress', 'Completed', 'Delayed', 'Cancelled', 'Skipped'].includes(row.Status) && (
                                <option value={row.Status}>{row.Status}</option>
                            )}
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Delayed">Delayed</option>
                            <option value="Overdue">Overdue</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="Skipped">Skipped</option>
                        </select>
                    </td>
                    <td className="px-3 py-3 text-center">
                        <button onClick={onDelete} className="text-slate-300 hover:text-red-600 transition-colors opacity-0 group-hover:opacity-100"><Icons.Trash2 className="w-4 h-4" /></button>
                    </td>
                </tr>
            );
        }, (prevProps, nextProps) => {
            // Custom comparison - only re-render if these specific props change
            return prevProps.row._id === nextProps.row._id &&
                prevProps.row.Status === nextProps.row.Status &&
                prevProps.row["End Date"] === nextProps.row["End Date"] &&
                prevProps.row["Task Description"] === nextProps.row["Task Description"] &&
                prevProps.row.isBold === nextProps.row.isBold &&
                prevProps.row['Milestone'] === nextProps.row['Milestone'] &&
                prevProps.row['Key Milestone'] === nextProps.row['Key Milestone'] &&
                prevProps.row['Discussion'] === nextProps.row['Discussion'] &&
                prevProps.isLongPress === nextProps.isLongPress &&
                prevProps.isHighlighted === nextProps.isHighlighted &&
                prevProps.hoveredForBold === nextProps.hoveredForBold;
        });

        // --- CONFIG ---
        const STORAGE_KEY = 'runbook_dashboard_session_v1';
        const MAX_HISTORY = 50; // Limit memory usage

        // --- HOOK: UNDO/REDO (Optimized with History Cap) ---
        const useUndoRedo = (initialState) => {
            const [state, dispatch] = useReducer((state, action) => {
                switch (action.type) {
                    case 'SET': {
                        const newState = typeof action.payload === 'function'
                            ? action.payload(state.present)
                            : action.payload;

                        // Shallow comparison
                        if (newState === state.present) return state;

                        // Cap history to prevent memory issues
                        const newPast = [...state.past, state.present];
                        if (newPast.length > MAX_HISTORY) {
                            newPast.shift(); // Remove oldest state
                        }

                        return {
                            past: newPast,
                            present: newState,
                            future: [],
                            original: state.original
                        };
                    }
                    case 'UNDO': {
                        if (state.past.length === 0) return state;
                        const newPresent = state.past[state.past.length - 1];
                        const newPast = state.past.slice(0, state.past.length - 1);
                        return {
                            past: newPast,
                            present: newPresent,
                            future: [state.present, ...state.future],
                            original: state.original
                        };
                    }
                    case 'REDO': {
                        if (state.future.length === 0) return state;
                        const newPresent = state.future[0];
                        const newFuture = state.future.slice(1);
                        return {
                            past: [...state.past, state.present],
                            present: newPresent,
                            future: newFuture,
                            original: state.original
                        };
                    }
                    case 'RESET': {
                        return {
                            past: [],
                            present: action.payload,
                            future: [],
                            original: action.payload // Set new baseline for revert
                        };
                    }
                    case 'REVERT': {
                        return {
                            past: [],
                            present: state.original, // Always revert to baseline
                            future: [],
                            original: state.original
                        };
                    }
                    default: return state;
                }
            }, {
                past: [],
                present: initialState,
                future: [],
                original: initialState
            });

            const setData = useCallback((payload) => dispatch({ type: 'SET', payload }), []);
            const undo = useCallback(() => dispatch({ type: 'UNDO' }), []);
            const redo = useCallback(() => dispatch({ type: 'REDO' }), []);
            const resetData = useCallback((payload) => dispatch({ type: 'RESET', payload }), []);
            const revert = useCallback(() => dispatch({ type: 'REVERT' }), []);

            return [state.present, setData, undo, redo, state.past.length > 0, state.future.length > 0, resetData, revert];
        };

        // --- PDF GENERATION UTILITY ---
        const generateReportPDF = (summary, risks, stats) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString();

            // Header
            doc.setFillColor(30, 58, 95); // #1e3a5f
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Weekly Status Report", 20, 20);
            doc.setFontSize(10);
            doc.setTextColor(200, 220, 255);
            doc.text(`Generated: ${today}`, 20, 30);

            // AI Executive Summary
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 95);
            doc.text("Executive Summary", 20, 55);

            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60);

            // Text Wrap calculation
            const splitText = doc.splitTextToSize(summary, pageWidth - 40);
            doc.text(splitText, 20, 65);

            let lastY = 65 + (splitText.length * 5) + 10;

            // Stats Overview
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 95);
            doc.text("Program Overview", 20, lastY);
            lastY += 10;

            doc.autoTable({
                startY: lastY,
                head: [['Program', 'Total', 'Completed', 'Completion %']],
                body: stats.map(s => [s.program, s.total, s.completed, s.rate + '%']),
                headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                theme: 'grid'
            });

            lastY = doc.lastAutoTable.finalY + 15;

            // Risks Table
            if (risks.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(200, 50, 50); // Red title
                doc.text("Critical Attention Areas (Overdue / At Risk)", 20, lastY);
                lastY += 10;

                doc.autoTable({
                    startY: lastY,
                    head: [['Task #', 'Description', 'Lead', 'Due Date', 'Status']],
                    body: risks.map(r => [
                        r.id,
                        r.desc.length > 40 ? r.desc.substring(0, 40) + '...' : r.desc, // Truncate desc
                        r.lead,
                        r.due,
                        r.status
                    ]),
                    headStyles: { fillColor: [200, 50, 50], textColor: 255, fontStyle: 'bold' },
                    bodyStyles: { fontSize: 8 },
                    theme: 'striped'
                });
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Confidential - Internal Use Only', 20, doc.internal.pageSize.getHeight() - 10);
                doc.text('Page ' + i + ' of ' + pageCount, pageWidth - 30, doc.internal.pageSize.getHeight() - 10);
            }

            doc.save(`Status_Report_${today.replace(/\//g, '-')}.pdf`);
        };

        // --- SUBCOMPONENT: AI ASSISTANT ---
        const AIAssistant = ({ data, contextStats, onScanAnomalies, onAIAction }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const scrollRef = useRef(null);
            const recognitionRef = useRef(null);

            // Refs for latest data access (avoids stale closures)
            const dataRef = useRef(data);
            const statsRef = useRef(contextStats);
            useEffect(() => {
                dataRef.current = data;
                statsRef.current = contextStats;
            }, [data, contextStats]);

            const OPENROUTER_API_KEY = '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';

            // Voice Recognition Setup
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    recognition.interimResults = true;

                    recognition.onresult = (event) => {
                        let interim = '';
                        let final = '';

                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                final += event.results[i][0].transcript;
                            } else {
                                interim += event.results[i][0].transcript;
                            }
                        }

                        if (final) {
                            setInput(final);
                            setIsListening(false);
                            sendMessage(final, true);
                        } else if (interim) {
                            setInput(interim);
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error', event.error);
                        setIsListening(false);
                    };

                    recognition.onend = () => {
                        setIsListening(false);
                    };

                    recognitionRef.current = recognition;
                }
            }, [sendMessage]);

            const toggleListening = () => {
                if (isListening) {
                    recognitionRef.current?.stop();
                    setIsListening(false);
                } else {
                    recognitionRef.current?.start();
                    setIsListening(true);
                }
            };

            // Auto-scroll to bottom of chat
            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [messages]);

            const sendMessage = useCallback(async (text, isVoice = false) => {
                if (!text.trim() || isLoading) return;

                if (text === "Scan for Anomalies" && onScanAnomalies) {
                    setShowSuggestions(false);
                    setMessages(prev => [...prev, { role: 'user', content: text }]);
                    setTimeout(() => {
                        setMessages(prev => [...prev, { role: 'assistant', content: "I've scanned the runbook. Any detected anomalies have been highlighted." }]);
                        onScanAnomalies();
                    }, 500);
                    return;
                }

                const userMsg = { role: 'user', content: isVoice ? `${text} 🎙️` : text };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setIsLoading(true);

                try {
                    // Use refs to get latest data
                    const currentData = dataRef.current || [];
                    const currentStats = statsRef.current || {};

                    const simplifiedData = currentData.slice(0, 100).map(d => ({
                        ID: d["Task Number"] || d._id,
                        Task: d["Task Description"],
                        Status: d.Status,
                        End: d["End Date"] ? new Date(d["End Date"]).toISOString().split('T')[0] : 'N/A',
                        Lead: d.Lead,
                        Program: d.Program,
                        Milestone: d.Milestone,
                        KeyMilestone: d['Key Milestone']
                    }));

                    const systemPrompt = `You are Runbook AI, an expert project manager.
You have access to tools to modify the runbook.
If the user's intent is to create, update, or delete a task, you MUST return a valid JSON object with the following structure:
{
  "type": "tool_call",
  "action": "create_task" | "update_task",
  "payload": {
    "Program": "string",
    "Task Description": "string",
    "Lead": "string",
    "Status": "string",
    "End Date": "YYYY-MM-DD",
    "Milestone": "TRUE/FALSE",
    "Key Milestone": "TRUE/FALSE",
    "id": "string (only for update)"
  }
}
For "update_task", try to find the best matching task ID from the provided data based on the user's description (fuzzy match allowed).
- If the user says "mark task X as complete", set "Status" to "Completed".
- Include the "id" in the payload.

If the user asks a general question, return a normal text response (Markdown supported).

Current Data (first 100 tasks): ${JSON.stringify(simplifiedData)}
Stats: ${JSON.stringify(currentStats)}
...`;

                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.href,
                            'X-Title': 'ASTRA Runbook'
                        },
                        body: JSON.stringify({
                            model: "openai/gpt-4o-mini",
                            messages: [
                                { role: "system", content: systemPrompt },
                                ...messages,
                                { role: "user", content: text }
                            ],
                            response_format: { type: "json_object" }
                        })
                    });

                    if (!response.ok) throw new Error('API Error');

                    const json = await response.json();
                    const aiContent = json.choices[0].message.content;

                    try {
                        const parsed = JSON.parse(aiContent);
                        if (parsed.type === "tool_call" && onAIAction) {
                            onAIAction(parsed.action, parsed.payload);
                            setMessages(prev => [...prev, { role: 'assistant', content: `✅ Action executed: ${parsed.action.replace('_', ' ')}` }]);
                        } else {
                            setMessages(prev => [...prev, { role: 'assistant', content: aiContent }]);
                        }
                    } catch (e) {
                        setMessages(prev => [...prev, { role: 'assistant', content: aiContent }]);
                    }

                } catch (error) {
                    console.error('AI Error:', error);
                    setMessages(prev => [...prev, { role: 'assistant', content: "Sorry, I encountered an error. Please try again." }]);
                } finally {
                    setIsLoading(false);
                }
            }, [isLoading, messages, onScanAnomalies, onAIAction]);

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(input);
                }
            };

            const suggestions = [
                "Summarize project status",
                "Generate Weekly Report",
                "Scan for Anomalies"
            ];

            const generateWeeklyReport = async () => {
                if (isLoading) return;
                setIsLoading(true);
                setShowSuggestions(false);
                setMessages(prev => [...prev, { role: 'user', content: 'Generate Weekly Status Report' }]);

                try {
                    // 1. Analyze Data
                    const risks = [];
                    const programStats = {};
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // Group and Filter
                    data.forEach(t => {
                        const prog = t.Program || 'Unassigned';
                        if (!programStats[prog]) programStats[prog] = { total: 0, completed: 0 };

                        programStats[prog].total++;
                        const status = String(t.Status || '').toLowerCase();
                        if (status.includes('complete')) programStats[prog].completed++;

                        // Risk Check
                        const end = t["End Date"] ? new Date(t["End Date"]) : null;
                        const isOverdue = end && end < today && !status.includes('complete');
                        const isAtRisk = status.includes('risk') || status.includes('delay') || status.includes('fail');

                        if (isOverdue || isAtRisk) {
                            risks.push({
                                id: t["Task Number"] || '',
                                desc: t["Task Description"] || '',
                                lead: t.Lead || 'Unassigned',
                                due: t["End Date"] ? new Date(t["End Date"]).toLocaleDateString() : 'N/A',
                                status: t.Status || 'Unknown'
                            });
                        }
                    });

                    // Format Stats Array
                    const statsArray = Object.entries(programStats).map(([prog, s]) => ({
                        program: prog,
                        total: s.total,
                        completed: s.completed,
                        rate: s.total ? Math.round((s.completed / s.total) * 100) : 0
                    })).sort((a, b) => b.total - a.total).slice(0, 10); // Top 10 by volume

                    // 2. Generate Prompt
                    const prompt = `Generate a professional Weekly Status Update email body (pure text, no markdown).
Context:
- Report Date: ${today.toLocaleDateString()}
- Overall Completion: ${contextStats.completionRate}%
- Active Programs: ${statsArray.map(s => s.program).join(', ')}
- High Priority Risks/Overdue: ${risks.length} items (e.g. ${risks.slice(0, 3).map(r => r.desc).join(', ')})

Structure:
1. One paragraph Executive Summary summarizing progress.
2. One paragraph highlighting key risks and blockers.
3. One sentence on next steps.`;

                    // 3. Call AI
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.href,
                            'X-Title': 'ASTRA Runbook'
                        },
                        body: JSON.stringify({
                            model: "openai/gpt-4o-mini",
                            messages: [
                                { role: "system", content: "You are a Senior Project Manager." },
                                { role: "user", content: prompt }
                            ]
                        })
                    });

                    if (!response.ok) throw new Error('AI generation failed');
                    const json = await response.json();
                    const aiText = json.choices[0].message.content;

                    // 4. Generate PDF
                    generateReportPDF(aiText, risks, statsArray);

                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: "I've generated the Weekly Status Report. The PDF has been downloaded automatically.\n\nHere is the summary:\n\n" + aiText
                    }]);

                } catch (error) {
                    console.error(error);
                    setMessages(prev => [...prev, { role: 'assistant', content: "Failed to generate report. Please try again." }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-full bg-slate-900/50">
                    <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4" ref={scrollRef}>
                        {messages.length === 0 && (
                            <div className="mt-8 text-center opacity-70">
                                <div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-purple-500/20">
                                    <Icons.Brain className="w-6 h-6 text-white" />
                                </div>
                                <h3 className="text-white font-semibold mb-1">Astra Assist</h3>
                                <p className="text-xs text-cyan-200/60 mb-6">Ask me anything about your runbook.</p>
                                <button
                                    onClick={onScanAnomalies}
                                    className="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-300 rounded-lg text-xs font-semibold border border-red-500/30 transition-all flex items-center mx-auto gap-2 group/scan"
                                >
                                    <Icons.AlertCircle className="w-3 h-3 group-hover/scan:animate-pulse" />
                                    Scan for Anomalies
                                </button>
                                <button
                                    onClick={generateWeeklyReport}
                                    disabled={isLoading}
                                    className="mt-3 px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 rounded-lg text-xs font-semibold border border-blue-500/30 transition-all flex items-center mx-auto gap-2 group/report"
                                >
                                    {isLoading ? <div className="w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin"></div> : <Icons.FileText className="w-3 h-3 group-hover/report:scale-110 transition-transform" />}
                                    Generate Weekly Report
                                </button>
                            </div>
                        )}

                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div
                                    className={`max-w-[85%] rounded-2xl p-3 text-sm leading-relaxed ${m.role === 'user'
                                        ? 'bg-blue-600 text-white rounded-br-none shadow-lg shadow-blue-500/10'
                                        : 'bg-white/10 text-slate-200 rounded-bl-none border border-white/5'
                                        }`}
                                >
                                    <div className="whitespace-pre-wrap">{m.content}</div>
                                </div>
                            </div>
                        ))}

                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="bg-white/10 rounded-2xl p-3 rounded-bl-none flex items-center space-x-2">
                                    <div className="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: '0s' }}></div>
                                    <div className="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                    <div className="w-2 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: '0.4s' }}></div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="p-3 bg-black/20 border-t border-white/10 relative">
                        {/* Upwards Suggestions Menu */}
                        {showSuggestions && (
                            <div className="absolute bottom-full left-0 w-full p-2 mb-2 bg-slate-800/90 backdrop-blur-md border border-white/10 rounded-t-xl shadow-xl z-10 animate-fadeInUp">
                                <div className="flex items-center justify-between px-2 mb-2 border-b border-white/10 pb-1">
                                    <span className="text-[10px] uppercase font-bold text-cyan-400">Quick Actions</span>
                                    <button onClick={() => setShowSuggestions(false)} className="text-white/50 hover:text-white"><Icons.X className="w-3 h-3" /></button>
                                </div>
                                <div className="grid grid-cols-1 gap-1 max-h-48 overflow-y-auto custom-scrollbar">
                                    {suggestions.map((s, i) => (
                                        <button
                                            key={i}
                                            onClick={() => {
                                                if (s === "Generate Weekly Report") {
                                                    generateWeeklyReport();
                                                } else {
                                                    sendMessage(s);
                                                }
                                                setShowSuggestions(false);
                                            }}
                                            className="text-left px-3 py-2 text-xs text-slate-200 hover:bg-white/10 hover:text-white rounded-lg transition-colors flex items-center group"
                                        >
                                            <Icons.Sparkles className="w-3 h-3 mr-2 text-purple-400 group-hover:text-purple-300 opacity-70" />
                                            {s}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="relative flex items-center gap-2">
                            <button
                                onClick={() => setShowSuggestions(!showSuggestions)}
                                className={`flex items-center justify-center w-[46px] h-[46px] rounded-xl border transition-all shrink-0 ${showSuggestions ? 'bg-purple-500 border-purple-500 text-white shadow-lg shadow-purple-500/30' : 'bg-white/5 border-white/10 text-white/50 hover:bg-white/10 hover:text-white'}`}
                                title="Astra Assist Suggestions"
                            >
                                <Icons.Brain className="w-5 h-5" />
                            </button>

                            <button
                                onClick={toggleListening}
                                className={`flex items-center justify-center w-[46px] h-[46px] rounded-xl border transition-all shrink-0 ${isListening ? 'bg-red-500 border-red-500 text-white shadow-lg shadow-red-500/30 animate-pulse' : 'bg-white/5 border-white/10 text-white/50 hover:bg-white/10 hover:text-white'}`}
                                title={isListening ? "Listening..." : "Voice Command"}
                            >
                                <Icons.Mic className="w-5 h-5" />
                            </button>

                            <div className="relative flex-1">
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                    placeholder="Message Astra Assist..."
                                    className="w-full bg-black/20 text-white text-sm placeholder-white/30 rounded-xl pl-3 pr-10 py-3 border border-white/10 focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 resize-none custom-scrollbar"
                                    rows="1"
                                    style={{ minHeight: '44px', maxHeight: '120px' }}
                                />
                                <button
                                    onClick={() => sendMessage(input)}
                                    className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-cyan-500 hover:bg-cyan-400 text-white rounded-lg transition-colors shadow-lg shadow-cyan-500/20 flex items-center justify-center"
                                    style={{ height: '32px', width: '32px' }}
                                    disabled={isLoading || !input.trim()}
                                >
                                    <Icons.Send className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                        <div className="text-[10px] text-white/20 text-center mt-2 flex items-center justify-center gap-1">
                            Powered by GPT-4o Mini
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            // State
            const [data, setData, undo, redo, canUndo, canRedo, resetData, revert] = useUndoRedo([]);
            const [headers, setHeaders] = useState([]);
            const [view, setView] = useState('dashboard');
            const [sidebarTab, setSidebarTab] = useState('filters'); // 'filters' | 'assist'
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);

            // Anomaly Detection State
            const [anomalies, setAnomalies] = useState(new Map());

            // Auto-Save State
            const [lastSavedTime, setLastSavedTime] = useState(null);

            // Stats Collapse State
            const [statsCollapsed, setStatsCollapsed] = useState(false);

            // --- AUTO-SAVE LOGIC ---
            const hasCheckedRestore = useRef(false);

            // 1. Check for saved session on mount (No Popup)
            useEffect(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        const savedDate = new Date(parsed.timestamp);
                        const now = new Date();
                        const daysDiff = (now - savedDate) / (1000 * 60 * 60 * 24);

                        if (daysDiff < 7) {
                            setLastSavedTime(savedDate);
                        } else {
                            localStorage.removeItem(STORAGE_KEY);
                        }
                    }
                } catch (e) {
                    console.error("Failed to check saved session", e);
                }
            }, []);

            // 2. Save on Change (Debounced 1s)
            useEffect(() => {
                // Only save if user has performed an action (history exists)
                // This prevents overwriting the previous session immediately upon load/open
                if (!canUndo || data.length === 0) return;

                const timer = setTimeout(() => {
                    try {
                        const session = {
                            timestamp: new Date().toISOString(),
                            headers: headers,
                            data: data
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
                        setLastSavedTime(new Date());
                    } catch (e) {
                        console.error("Auto-save failed (likely quota exceeded)", e);
                    }
                }, 1000);

                return () => clearTimeout(timer);
            }, [data, headers, canUndo]);

            // 3. Manual Recovery
            const recoverSession = () => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        const savedDate = new Date(parsed.timestamp);

                        // If data is already loaded, confirm overwrite
                        if (isDataLoaded && !confirm(`Overwrite current workspace with saved session from ${savedDate.toLocaleString()}?`)) {
                            return;
                        }

                        const restoredData = parsed.data.map(row => ({
                            ...row,
                            "Begin Date": row["Begin Date"] ? new Date(row["Begin Date"]) : null,
                            "Start Date": row["Start Date"] ? new Date(row["Start Date"]) : null,
                            "End Date": row["End Date"] ? new Date(row["End Date"]) : null,
                        }));

                        if (parsed.headers) setHeaders(parsed.headers);
                        resetData(restoredData);
                        setLastSavedTime(savedDate);
                        setIsDataLoaded(true);
                        showNotification("Session restored successfully");
                    }
                } catch (e) {
                    console.error("Failed to restore session", e);
                    showNotification("Failed to restore session", "error");
                }
            };

            // 3. Manual Clear
            const clearSavedSession = () => {
                if (confirm("Are you sure you want to delete the saved session backup? This will not affect the current screen.")) {
                    localStorage.removeItem(STORAGE_KEY);
                    setLastSavedTime(null);
                    showNotification("Saved session cleared from browser storage");
                }
            };

            // Store original file for export
            const [originalFileBuffer, setOriginalFileBuffer] = useState(null);
            const [originalFileName, setOriginalFileName] = useState('');


            // Filters
            const [searchTerm, setSearchTerm] = useState('');
            const [activeFilters, setActiveFilters] = useState({});
            const [headerFilters, setHeaderFilters] = useState({ ID: '', Task: '' });
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [smartFilterMode, setSmartFilterMode] = useState(false);
            const [smartFilterQuery, setSmartFilterQuery] = useState('');
            const [smartFilterLoading, setSmartFilterLoading] = useState(false);
            const [aiDateFilter, setAiDateFilter] = useState(null); // { type: 'due_within_days' | 'overdue', value: number | boolean, label: string }
            const [autoFilterEnabled, setAutoFilterEnabled] = useState(true);
            const [persistedIds, setPersistedIds] = useState(new Set());
            const [dueDateSort, setDueDateSort] = useState('asc'); // 'asc' = earliest first, 'desc' = latest first, null = no sort

            // Calendar
            const [currentDate, setCurrentDate] = useState(new Date(2025, 10, 1)); // Default Nov 2025
            const [calendarMode, setCalendarMode] = useState('single'); // 'single' | 'multi'
            const [highlightedTaskId, setHighlightedTaskId] = useState(null);
            const [draggedTask, setDraggedTask] = useState(null);

            // Enhanced Calendar View Options
            const [calendarViewStyle, setCalendarViewStyle] = useState('grid'); // 'grid' | 'heatmap' | 'swimlanes'
            const [swimlaneGroupBy, setSwimlaneGroupBy] = useState('Program'); // 'Program' | 'Lead'
            const [showMultiDayBars, setShowMultiDayBars] = useState(true); // Show multi-day task bars

            // AI Features Toggle
            const [aiEnabled, setAiEnabled] = useState(false);

            const toggleAI = () => {
                if (aiEnabled) {
                    setAiEnabled(false);
                    showNotification("AI Features Disabled");
                    if (sidebarTab === 'assist') setSidebarTab('filters');
                } else {
                    const password = prompt("Enter Administrator Password to Enable AI:");
                    if (password === "ewst") {
                        if (confirm("⚠️ WARNING: AI is under development and can make mistakes. Use with caution.\n\nDo you want to proceed?")) {
                            setAiEnabled(true);
                            showNotification("AI Features Enabled", "success");
                        }
                    } else if (password !== null) {
                        alert("Incorrect Password");
                    }
                }
            };

            // Editing
            const [editingRowId, setEditingRowId] = useState(null);
            const [editFormData, setEditFormData] = useState({});
            const [notification, setNotification] = useState(null);

            // Long-press state
            const longPressTimer = useRef(null);
            const [longPressTaskId, setLongPressTaskId] = useState(null);

            // Refs for scrolling to current date
            const tableRowRefs = useRef({});

            // Load filters from localStorage on mount
            useEffect(() => {
                try {
                    const savedFilters = localStorage.getItem('runbook_filters');
                    const savedSearch = localStorage.getItem('runbook_search');
                    if (savedFilters) {
                        setActiveFilters(JSON.parse(savedFilters));
                    }
                    if (savedSearch) {
                        setSearchTerm(savedSearch);
                    }
                } catch (e) {
                    console.warn('Could not load saved filters:', e);
                }
            }, []);

            // Save filters to localStorage when they change
            useEffect(() => {
                if (isDataLoaded) {
                    try {
                        localStorage.setItem('runbook_filters', JSON.stringify(activeFilters));
                        localStorage.setItem('runbook_search', searchTerm);
                    } catch (e) {
                        console.warn('Could not save filters:', e);
                    }
                }
            }, [activeFilters, searchTerm, isDataLoaded]);

            // Keyboard Shortcuts for Undo/Redo
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            if (canRedo) redo();
                        } else {
                            if (canUndo) undo();
                        }
                    }
                    else if ((e.metaKey || e.ctrlKey) && (e.key === 'y')) {
                        e.preventDefault();
                        if (canRedo) redo();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [undo, redo, canUndo, canRedo]);

            // --- HELPERS ---
            const showNotification = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // AI Smart Filter Processing
            const OPENROUTER_API_KEY = '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';

            const processSmartFilter = async (query) => {
                if (!query.trim()) return;
                setSmartFilterLoading(true);

                try {
                    // Build context about available filter fields and their values
                    const filterFieldsSummary = Object.entries(filterOptions).map(([key, values]) =>
                        `${key}: [${values.slice(0, 15).join(', ')}${values.length > 15 ? '...' : ''}]`
                    ).join('\n');

                    const systemPrompt = `You are a filter parser for a project management runbook. Convert natural language queries to JSON filter objects.

Available filter fields and their possible values:
${filterFieldsSummary}

Additional date-based filters:
- "due_within_days": number (filter tasks with End Date within N days from today)
- "overdue": boolean (filter tasks past their End Date)
- "search_term": string (text search across all fields)
- "dependency_contains": string (filter tasks whose Dependency field contains this text)

Return ONLY a valid JSON object with the filter instructions. Use the exact field names as keys.
For multi-value filters (like Status, Lead), use arrays.
Example response for "Show me delayed tasks for CNB":
{"Status": ["Delayed", "At Risk"], "Program": ["CNB"]}

Example response for "Tasks due in the next 15 days":
{"due_within_days": 15}

Example response for "Anything dependent on GRS-105":
{"dependency_contains": "GRS-105"}

If you cannot parse the query, return: {"error": "Could not parse query"}`;

                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.href,
                            'X-Title': 'ASTRA Runbook'
                        },
                        body: JSON.stringify({
                            model: "openai/gpt-4o-mini",
                            messages: [
                                { role: "system", content: systemPrompt },
                                { role: "user", content: query }
                            ]
                        })
                    });

                    if (!response.ok) throw new Error('API Error');

                    const json = await response.json();
                    let filterResult = json.choices[0].message.content.trim();

                    // Extract JSON from response (handle markdown code blocks)
                    const jsonMatch = filterResult.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) filterResult = jsonMatch[1];

                    const parsedFilters = JSON.parse(filterResult);

                    if (parsedFilters.error) {
                        showNotification(parsedFilters.error, 'error');
                        return;
                    }

                    // Apply the filters
                    const newActiveFilters = {};

                    // Handle standard filter fields
                    const validFilterFields = ['Program', 'Task Type', 'Lead', 'Status', 'Milestone (Y/N)', 'R&C', 'STEG', 'At Risk', 'Retail CR Focus', 'Finance Focus', 'MR Focus', 'Carib Focus'];
                    validFilterFields.forEach(field => {
                        if (parsedFilters[field]) {
                            newActiveFilters[field] = Array.isArray(parsedFilters[field]) ? parsedFilters[field] : [parsedFilters[field]];
                        }
                    });

                    setActiveFilters(newActiveFilters);

                    // Handle search_term
                    if (parsedFilters.search_term) {
                        setSearchTerm(parsedFilters.search_term);
                    }

                    // Handle dependency_contains (use search for now)
                    if (parsedFilters.dependency_contains) {
                        setSearchTerm(parsedFilters.dependency_contains);
                    }

                    // Handle due_within_days - set AI date filter
                    if (parsedFilters.due_within_days) {
                        const days = parsedFilters.due_within_days;
                        setAiDateFilter({
                            type: 'due_within_days',
                            value: days,
                            label: `Due within ${days} days`
                        });
                    }

                    // Handle overdue
                    if (parsedFilters.overdue === true) {
                        setAiDateFilter({
                            type: 'overdue',
                            value: true,
                            label: 'Overdue tasks only'
                        });
                    }

                    showNotification('Smart filter applied!', 'success');
                    setHighlightedTaskId(null);

                } catch (error) {
                    console.error('Smart Filter Error:', error);
                    showNotification('Failed to parse query. Try a simpler phrase.', 'error');
                } finally {
                    setSmartFilterLoading(false);
                }
            };

            // Calendar Interaction Handlers
            const calendarLongPressTimerRef = useRef(null);

            const handleCalendarTaskMouseDown = (task) => {
                calendarLongPressTimerRef.current = setTimeout(() => {
                    setEditingRowId(task._id);
                    setEditFormData(task);
                }, 2000);
            };

            const handleCalendarTaskMouseUp = () => {
                if (calendarLongPressTimerRef.current) {
                    clearTimeout(calendarLongPressTimerRef.current);
                    calendarLongPressTimerRef.current = null;
                }
            };

            const handleCalendarTaskDoubleClick = (task) => {
                const currentStatus = String(task.Status || 'Not Started').toLowerCase();
                let nextStatus = 'Not Started';
                if (currentStatus.includes('not started')) nextStatus = 'In Progress';
                else if (currentStatus.includes('progress')) nextStatus = 'Completed';
                else if (currentStatus.includes('complete')) nextStatus = 'Not Started';

                // Match casing to existing statuses in the data
                nextStatus = matchStatusCasing(nextStatus, data);
                handleStatusUpdate(task._id, nextStatus);
            };

            // --- ANOMALY DETECTION ---
            const checkAnomalies = useCallback(() => {
                const newAnomalies = new Map();
                const allTaskNumbers = new Set(data.map(d => String(d["Task Number"] || '').trim()));

                let count = 0;
                data.forEach(task => {
                    const issues = [];
                    const start = task["Begin Date"] || task["Start Date"];
                    const end = task["End Date"];

                    // 1. End Date < Begin Date
                    if (start && end && new Date(end) < new Date(start)) {
                        issues.push("End Date is before Start Date");
                    }

                    // 2. Missing dependencies
                    if (task.Dependency) {
                        const deps = String(task.Dependency).split(',').map(d => d.trim()).filter(Boolean);
                        deps.forEach(depId => {
                            if (!allTaskNumbers.has(depId)) {
                                issues.push(`Missing dependency: ${depId}`);
                            }
                        });
                    }

                    // 3. Conflicting statuses
                    const status = String(task.Status || '').toLowerCase();
                    if (status.includes('complete') && !task["End Date"]) {
                        issues.push("Completed task missing End Date");
                    }
                    // Status 'Completed' but End Date in future (e.g. > 7 days ahead) - optional warning
                    // if (status.includes('complete') && end && new Date(end) > new Date(Date.now() + 7 * 86400000)) {
                    //    issues.push("Marked complete but End Date is far in future");
                    // }

                    // 4. Unusually long task durations
                    if (start && end) {
                        const s = new Date(start);
                        const e = new Date(end);
                        const duration = (e - s) / (1000 * 60 * 60 * 24);
                        if (duration > 90) {
                            issues.push(`Unusually long duration: ${Math.round(duration)} days`);
                        }
                    }

                    // 5. Tasks due on weekends
                    if (end) {
                        const e = new Date(end);
                        const day = e.getDay();
                        if (day === 0 || day === 6) {
                            issues.push(`Due on a weekend (${day === 0 ? 'Sunday' : 'Saturday'})`);
                        }
                    }

                    if (issues.length > 0) {
                        newAnomalies.set(task._id, issues);
                        count++;
                    }
                });

                setAnomalies(newAnomalies);
                setAnomalies(newAnomalies);
                if (count > 0) {
                    showNotification(`Found ${count} tasks with data anomalies`, 'error');
                } else {
                    showNotification("No anomalies found!", 'success');
                }
            }, [data]);

            // Auto-scan for anomalies when data loads
            useEffect(() => {
                if (isDataLoaded && data.length > 0) {
                    // Optional: Uncomment to auto-scan on load
                    // checkAnomalies();
                }
            }, [isDataLoaded, data, checkAnomalies]);

            // Memoized date parser for performance
            const dateCache = useRef(new Map());
            const parseDate = (dateVal) => {
                if (!dateVal) return null;

                // Check cache first
                const cacheKey = String(dateVal);
                if (dateCache.current.has(cacheKey)) {
                    return dateCache.current.get(cacheKey);
                }

                let result;
                if (typeof dateVal === 'number') {
                    // Excel serial date -> UTC Date
                    const utcDate = new Date(Math.round((dateVal - 25569) * 86400 * 1000));
                    // Create Local Date at NOON (12:00) to avoid midnight timezone shifts
                    result = new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate(), 12, 0, 0);
                } else {
                    const d = new Date(dateVal);
                    if (!isNaN(d.getTime())) {
                        result = d;
                        // If string is YYYY-MM-DD, it parses as UTC Midnight.
                        // We convert this to Local NOON to match our standard.
                        if (typeof dateVal === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateVal)) {
                            result = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), 12, 0, 0);
                        }
                    } else {
                        result = null;
                    }
                }

                // Cache the result
                dateCache.current.set(cacheKey, result);
                return result;
            };

            const formatDate = (dateObj) => {
                if (!dateObj) return '';
                try {
                    // Use local time components to match the Local Midnight standard
                    const y = dateObj.getFullYear();
                    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const d = String(dateObj.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                } catch (e) { return ''; }
            };

            // Parse a YYYY-MM-DD string as LOCAL midnight (not UTC)
            // This fixes the timezone issue where new Date("2024-01-15") is parsed as
            // UTC midnight, which becomes Jan 14th 7pm in US Eastern time
            const parseLocalDate = (dateStr) => {
                if (!dateStr) return null;
                if (dateStr instanceof Date) return dateStr;
                try {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
                        const day = parseInt(parts[2], 10);
                        return new Date(year, month, day); // Local midnight
                    }
                    return new Date(dateStr);
                } catch (e) {
                    return null;
                }
            };

            // Match status casing to existing values in the data
            // This ensures "In Progress" matches "In progress" if that's what exists
            const matchStatusCasing = useCallback((targetStatus, dataArray) => {
                if (!targetStatus || !dataArray || dataArray.length === 0) return targetStatus;
                const targetLower = targetStatus.toLowerCase();

                // Find an existing status that matches (case-insensitive)
                for (const row of dataArray) {
                    const existingStatus = row.Status;
                    if (existingStatus && typeof existingStatus === 'string') {
                        if (existingStatus.toLowerCase() === targetLower) {
                            return existingStatus; // Return the existing casing
                        }
                    }
                }

                // No match found, return the original
                return targetStatus;
            }, []);

            const getStatusColor = useCallback((status) => {
                if (!status) return 'bg-gray-100 text-gray-800 border-gray-200';
                const s = String(status).toLowerCase();
                if (s.includes('complete') || s.includes('done')) return 'bg-emerald-100 text-emerald-800 border-emerald-200';
                if (s.includes('progress')) return 'bg-blue-100 text-blue-800 border-blue-200';
                if (s.includes('risk') || s.includes('delay') || s.includes('fail') || s.includes('overdue')) return 'bg-red-100 text-red-800 border-red-200';
                if (s.includes('not start')) return 'bg-slate-100 text-slate-600 border-slate-200';
                return 'bg-indigo-50 text-indigo-700 border-indigo-200';
            }, []);

            const isTaskPastDue = useCallback((task) => {
                if (!task["End Date"]) return false;
                const status = String(task.Status || '').toLowerCase();
                if (status.includes('complete') || status.includes('skipped') || status.includes('cancelled')) return false;

                // Ensure date is comparable
                const dueDate = task["End Date"] instanceof Date ? task["End Date"] : parseLocalDate(task["End Date"]);
                if (!dueDate) return false;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return dueDate < today;
            }, []);

            // Enhanced Calendar Helper Functions

            // Get heatmap intensity based on task count
            const getHeatmapIntensity = useCallback((taskCount, maxTasks) => {
                if (taskCount === 0) return 'bg-white';
                const intensity = Math.min(taskCount / Math.max(maxTasks, 1), 1);
                if (intensity <= 0.2) return 'bg-blue-50';
                if (intensity <= 0.4) return 'bg-blue-100';
                if (intensity <= 0.6) return 'bg-blue-200';
                if (intensity <= 0.8) return 'bg-blue-300';
                return 'bg-blue-400';
            }, []);

            // Get status-based heatmap color for overlays
            const getStatusHeatmapColor = useCallback((tasks) => {
                if (!tasks || tasks.length === 0) return 'bg-white';

                // Calculate status distribution
                let completed = 0, inProgress = 0, atRisk = 0, notStarted = 0;
                tasks.forEach(t => {
                    const s = String(t.Status || '').toLowerCase();
                    if (s.includes('complete')) completed++;
                    else if (s.includes('progress')) inProgress++;
                    else if (s.includes('risk') || s.includes('delay')) atRisk++;
                    else notStarted++;
                });

                const total = tasks.length;
                if (atRisk / total > 0.3) return 'bg-gradient-to-br from-red-50 to-red-100 border-red-200';
                if (completed / total > 0.7) return 'bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200';
                if (inProgress / total > 0.5) return 'bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200';
                return 'bg-white';
            }, []);

            // Get multi-day task spans for a given month
            const getMultiDayTasks = useCallback((monthData, allTasks) => {
                const multiDayBars = [];
                const monthDate = monthData.date;
                const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);

                allTasks.forEach(task => {
                    const startDate = task["Begin Date"] || task["Start Date"];
                    const endDate = task["End Date"];

                    // Check if task has valid dates and spans multiple days
                    if (startDate instanceof Date && endDate instanceof Date) {
                        const taskStart = new Date(startDate);
                        const taskEnd = new Date(endDate);
                        taskStart.setHours(0, 0, 0, 0);
                        taskEnd.setHours(0, 0, 0, 0);

                        const daysDiff = Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24));

                        // Only include multi-day tasks (more than 1 day)
                        if (daysDiff > 0) {
                            // Check if task overlaps with this month
                            if (taskEnd >= monthStart && taskStart <= monthEnd) {
                                // Calculate visible portion within the month
                                const visibleStart = taskStart < monthStart ? monthStart : taskStart;
                                const visibleEnd = taskEnd > monthEnd ? monthEnd : taskEnd;

                                // Get day positions
                                const startDay = visibleStart.getDate();
                                const endDay = visibleEnd.getDate();
                                const startDayOfWeek = new Date(monthDate.getFullYear(), monthDate.getMonth(), startDay).getDay();
                                const startWeek = Math.floor((startDay + new Date(monthDate.getFullYear(), monthDate.getMonth(), 1).getDay() - 1) / 7);

                                const continuesFromPrev = taskStart < monthStart;
                                const continuesToNext = taskEnd > monthEnd;

                                multiDayBars.push({
                                    task,
                                    startDay,
                                    endDay,
                                    startDayOfWeek,
                                    startWeek,
                                    span: endDay - startDay + 1,
                                    totalDays: daysDiff + 1,
                                    continuesFromPrev,
                                    continuesToNext
                                });
                            }
                        }
                    }
                });

                return multiDayBars;
            }, []);

            // Get swimlane groups for tasks
            const getSwimlaneGroups = useCallback((tasks, groupBy) => {
                const groups = {};
                tasks.forEach(task => {
                    const key = task[groupBy] || 'Other';
                    if (!groups[key]) {
                        groups[key] = [];
                    }
                    groups[key].push(task);
                });

                // Sort groups by name
                const sortedKeys = Object.keys(groups).sort();
                return sortedKeys.map(key => ({
                    name: key,
                    tasks: groups[key],
                    color: getGroupColor(key)
                }));
            }, []);

            // Get unique color for each group
            const getGroupColor = (groupName) => {
                const colors = [
                    'from-blue-500 to-blue-600',
                    'from-emerald-500 to-emerald-600',
                    'from-violet-500 to-violet-600',
                    'from-amber-500 to-amber-600',
                    'from-rose-500 to-rose-600',
                    'from-cyan-500 to-cyan-600',
                    'from-indigo-500 to-indigo-600',
                    'from-teal-500 to-teal-600',
                    'from-pink-500 to-pink-600',
                    'from-orange-500 to-orange-600'
                ];
                let hash = 0;
                for (let i = 0; i < groupName.length; i++) {
                    hash = ((hash << 5) - hash) + groupName.charCodeAt(i);
                    hash = hash & hash;
                }
                return colors[Math.abs(hash) % colors.length];
            };

            // Get status bar gradient color
            const getStatusBarColor = useCallback((status) => {
                const s = String(status || '').toLowerCase();
                if (s.includes('complete') || s.includes('done')) return 'from-emerald-400 to-emerald-600';
                if (s.includes('progress')) return 'from-blue-400 to-blue-600';
                if (s.includes('risk') || s.includes('delay')) return 'from-red-400 to-red-600';
                if (s.includes('not start')) return 'from-slate-400 to-slate-500';
                return 'from-indigo-400 to-indigo-600';
            }, []);

            // Bold Toggle Logic
            const [hoveredTaskForBold, setHoveredTaskForBold] = useState(null);
            const boldTimerRef = useRef(null);

            const handleTaskMouseEnter = useCallback((taskId) => {
                boldTimerRef.current = setTimeout(() => {
                    setHoveredTaskForBold(taskId);
                }, 1000);
            }, []);

            const handleTaskMouseLeave = useCallback(() => {
                if (boldTimerRef.current) clearTimeout(boldTimerRef.current);
                setHoveredTaskForBold(null);
            }, []);

            const toggleTaskBold = useCallback((taskId) => {
                setData(prev => prev.map(row => {
                    if (row._id === taskId) {
                        return { ...row, isBold: !row.isBold };
                    }
                    return row;
                }));
            }, []);

            // Toggle task indicators (Milestone, Key Milestone, Discussion)
            const toggleTaskIndicator = useCallback((taskId, indicatorField) => {
                setData(prev => prev.map(row => {
                    if (row._id === taskId) {
                        const currentValue = isIndicatorTrue(row[indicatorField]);
                        return { ...row, [indicatorField]: currentValue ? '' : 'Y' };
                    }
                    return row;
                }));
            }, []);

            // --- HANDLERS ---

            // Load State for Animations
            const [loadState, setLoadState] = useState('idle'); // 'idle' | 'parsing' | 'success' | 'complete'

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setLoadState('parsing');
                setIsLoading(true);
                setLoadingProgress(10);

                try {
                    // Read the file buffer for export preservation
                    const arrayBuffer = await file.arrayBuffer();
                    setLoadingProgress(40);

                    // Store original file data for export
                    setOriginalFileBuffer(arrayBuffer);
                    setOriginalFileName(file.name);

                    // Check cache first for ultra-fast loading
                    const cacheKey = `runbook_v4_cache_${file.name}_${file.size}`;
                    const cachedData = localStorage.getItem(cacheKey);

                    let processedData = [];
                    let headers = [];

                    if (cachedData) {
                        try {
                            const parsed = JSON.parse(cachedData);
                            processedData = parsed.data.map(row => ({
                                ...row,
                                "Begin Date": row["Begin Date"] ? new Date(row["Begin Date"]) : null,
                                "Start Date": row["Start Date"] ? new Date(row["Start Date"]) : null,
                                "End Date": row["End Date"] ? new Date(row["End Date"]) : null,
                            }));
                            headers = parsed.headers;
                            setLoadingProgress(90);
                        } catch (e) {
                            console.warn("Cache parse error", e);
                        }
                    }

                    // If no cache or cache failed, parse fresh using SheetJS (fast)
                    if (processedData.length === 0) {
                        setLoadingProgress(50);

                        // Parse Excel with SheetJS - use first sheet only
                        const wb = XLSX.read(arrayBuffer, { type: 'array', cellDates: true });
                        const sheetName = wb.SheetNames[0];
                        const ws = wb.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(ws, { defval: "" });

                        if (jsonData.length === 0) throw new Error("Empty Sheet");

                        setLoadingProgress(70);

                        // Extract headers
                        headers = Object.keys(jsonData[0]);

                        // Pre-process dates and normalize data
                        processedData = jsonData.map((row, idx) => {
                            const newRow = { _id: idx + 1, ...row };
                            if (newRow["Begin Date"]) newRow["Begin Date"] = new Date(newRow["Begin Date"]);
                            if (newRow["Start Date"]) newRow["Start Date"] = new Date(newRow["Start Date"]);
                            if (newRow["End Date"]) newRow["End Date"] = new Date(newRow["End Date"]);

                            // Status normalization
                            if (!newRow["Status"]) {
                                const today = new Date();
                                const end = newRow["End Date"];
                                if (end && end < today) newRow["Status"] = "Overdue";
                                else newRow["Status"] = "Not Started";
                            }
                            return newRow;
                        });
                        setLoadingProgress(90);
                    }

                    // Set data
                    setHeaders(headers);
                    resetData(processedData);
                    setLoadingProgress(100);

                    // TRIGGER SUCCESS STATE & ANIMATION
                    setLoadState('success');

                    // Delay switching to dashboard to show success animation
                    setTimeout(() => {
                        setIsDataLoaded(true);
                        setIsLoading(false);
                        setLoadState('complete');
                        setTimeout(() => setLoadingProgress(0), 500);
                    }, 1500);

                    // Cache data for next time (non-blocking)
                    setTimeout(() => {
                        try {
                            // Clean up old cache entries
                            Object.keys(localStorage).forEach(key => {
                                if (key.startsWith('runbook_v') && key.includes('_cache_') && key !== cacheKey) {
                                    localStorage.removeItem(key);
                                }
                            });
                            localStorage.setItem(cacheKey, JSON.stringify({
                                headers,
                                data: processedData
                            }));
                        } catch (e) {
                            console.warn('Could not cache data:', e);
                        }
                    }, 0);

                } catch (err) {
                    console.error(err);
                    showNotification("Failed to parse file. Please use a valid .xlsx or .csv.", "error");
                    setIsLoading(false);
                    setLoadState('idle');
                    setLoadingProgress(0);
                }
            };

            const handleFileDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFileUpload({ target: { files: [file] } });
                }
            };

            const handleFileDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
            };

            const handleExportHTML = () => {
                if (!isDataLoaded) {
                    showNotification("❌ No data loaded to export", "error");
                    return;
                }

                try {
                    showNotification("🔄 Generating standalone HTML file...");

                    // Get current filter description
                    const filterDesc = Object.entries(activeFilters)
                        .filter(([key, vals]) => vals && vals.length > 0)
                        .map(([key, vals]) => `${key}: ${vals.join(', ')}`)
                        .join(' | ');

                    const title = filterDesc
                        ? `ASTRA Runbook - Filtered (${filterDesc})`
                        : 'ASTRA Runbook - All Data';

                    // Read current document to get all the HTML structure
                    const currentHTML = document.documentElement.outerHTML;

                    // Create the hardcoded data JavaScript
                    const hardcodedData = `
        // HARDCODED DATA - Generated from filtered view
        const HARDCODED_DATA = ${JSON.stringify(filteredData, null, 2)};
        const HARDCODED_HEADERS = ${JSON.stringify(headers, null, 2)};
        const EXPORT_DATE = "${new Date().toISOString()}";
        const FILTER_INFO = "${filterDesc || 'No filters applied'}";

        // Rehydrate dates
        HARDCODED_DATA.forEach(row => {
            if (row["Begin Date"]) row["Begin Date"] = new Date(row["Begin Date"]);
            if (row["Start Date"]) row["Start Date"] = new Date(row["Start Date"]);
            if (row["End Date"]) row["End Date"] = new Date(row["End Date"]);
        });
    `;

                    // Modify the HTML to use hardcoded data
                    let exportHTML = currentHTML;

                    // Update title
                    exportHTML = exportHTML.replace(/<title>.*?<\/title>/, `<title>${title}</title>`);

                    // Replace the React component initialization
                    // Find where data state is initialized and replace with hardcoded data
                    exportHTML = exportHTML.replace(
                        /const \[data, setData, undo, redo, canUndo, canRedo, resetData, revert\] = useUndoRedo\(\[\]\);/,
                        `const [data, setData, undo, redo, canUndo, canRedo, resetData, revert] = useUndoRedo(HARDCODED_DATA);`
                    );

                    exportHTML = exportHTML.replace(
                        /const \[headers, setHeaders\] = useState\(\[\]\);/,
                        `const [headers, setHeaders] = useState(HARDCODED_HEADERS);`
                    );

                    exportHTML = exportHTML.replace(
                        /const \[isDataLoaded, setIsDataLoaded\] = useState\(false\);/,
                        `const [isDataLoaded, setIsDataLoaded] = useState(true);`
                    );

                    // Add the hardcoded data before the main script
                    exportHTML = exportHTML.replace(
                        /<script type="text\/babel">/,
                        `<script type="text/babel">\n${hardcodedData}\n`
                    );

                    // Add a banner at the top to indicate this is a filtered export
                    const banner = filterDesc ? `
                    <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(90deg, #10b981, #059669); color: white; padding: 8px 16px; text-align: center; z-index: 10000; font-family: 'Inter', sans-serif; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        📊 Exported View - Filters: ${filterDesc} | Generated: ${new Date().toLocaleString()}
                    </div>
                    <div style="height: 40px;"></div>` : '';

                    exportHTML = exportHTML.replace('<body>', `<body>${banner}`);

                    // Remove file upload section by adding CSS to hide it
                    exportHTML = exportHTML.replace(
                        '</style>',
                        `
        .file-upload-section { display: none !important; }
        </style>`
                    );

                    // Create and download the file
                    const blob = new Blob([exportHTML], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    // Generate filename safe string from filters
                    const getSafeString = (str) => String(str).replace(/[^a-zA-Z0-9]/g, '');

                    const filterFilenamePart = Object.entries(activeFilters)
                        .filter(([key, vals]) => vals && vals.length > 0)
                        .map(([key, vals]) => {
                            return vals.map(v => getSafeString(v)).join('-');
                        })
                        .join('_');

                    const dateStr = new Date().toISOString().split('T')[0];

                    const filename = filterFilenamePart
                        ? `${filterFilenamePart}_${dateStr}.html`
                        : `Runbook_All_${dateStr}.html`;

                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showNotification(`✅ Successfully exported ${filteredData.length} tasks to ${filename}`);
                } catch (error) {
                    console.error('Export error:', error);
                    showNotification("❌ Failed to export HTML file", "error");
                }
            };

            const handleExport = async () => {
                if (!originalFileBuffer) {
                    showNotification("❌ No original file found. Please re-upload your Excel file.", "error");
                    return;
                }

                try {
                    showNotification("🔄 Exporting updated data...");

                    // Load the original workbook with ExcelJS
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(originalFileBuffer);

                    // Use the first worksheet
                    const worksheet = workbook.worksheets[0];
                    if (!worksheet) {
                        showNotification("❌ No worksheet found in the file", "error");
                        return;
                    }

                    // Get the header row to map columns
                    const headerRow = worksheet.getRow(1);
                    const columnMap = {};
                    headerRow.eachCell((cell, colNumber) => {
                        columnMap[cell.value] = colNumber;
                    });

                    const dataRowCount = data.length;
                    const originalRowCount = worksheet.rowCount;

                    // Update existing rows with new data
                    data.forEach((dataRow, index) => {
                        const excelRowNumber = index + 2; // +2 because Excel is 1-indexed and row 1 is header
                        const row = worksheet.getRow(excelRowNumber);

                        // Update each cell with new data
                        headers.forEach(header => {
                            const colNumber = columnMap[header];
                            if (colNumber) {
                                const cell = row.getCell(colNumber);
                                let value = dataRow[header];

                                // Handle dates properly
                                if (header === "End Date" || header === "Start Date" || header === "Begin Date") {
                                    if (value instanceof Date && !isNaN(value.getTime())) {
                                        cell.value = value;
                                    } else {
                                        cell.value = null;
                                    }
                                } else if (typeof value === 'number') {
                                    cell.value = value;
                                } else if (value === '' || value === undefined) {
                                    cell.value = null;
                                } else {
                                    cell.value = value;
                                }

                                // Apply Bold formatting for Task Description if needed
                                if (header === "Task Description" && dataRow.isBold) {
                                    const currentFont = cell.font || {};
                                    cell.font = { ...currentFont, bold: true };
                                }
                            }
                        });

                        row.commit();
                    });

                    // Clear extra rows if we have fewer than original
                    if (dataRowCount + 2 <= originalRowCount) {
                        for (let i = dataRowCount + 2; i <= originalRowCount; i++) {
                            const row = worksheet.getRow(i);
                            row.eachCell((cell) => {
                                cell.value = null;
                            });
                            row.commit();
                        }
                    }

                    // Generate the Excel file
                    const buffer = await workbook.xlsx.writeBuffer();

                    // Create download link
                    const blob = new Blob([buffer], {
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;

                    // Use original filename with _Updated suffix
                    const baseName = originalFileName.replace(/\.(xlsx|xls)$/i, '');
                    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    link.download = `${baseName}_Updated_${timestamp}.xlsx`;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);

                    showNotification(`✅ Exported successfully!`);
                } catch (error) {
                    console.error("Export error:", error);
                    showNotification(`❌ Export failed: ${error.message}`, "error");
                }
            };

            const handleAddNew = () => {
                setHighlightedTaskId(null);
                setEditFormData({
                    "Program": "",
                    "Task Type": "",
                    "Task Description": "",
                    "Lead": "",
                    "Status": "Not Started",
                    "Dependency": "",
                    "Begin Date": new Date(),
                    "End Date": new Date()
                });
                setEditingRowId('new');
            };

            const handleDeleteRow = useCallback((id) => {
                if (confirm("Are you sure you want to delete this task?")) {
                    setHighlightedTaskId(null);
                    setData(prev => prev.filter(r => r._id !== id));
                    showNotification("Task deleted.");
                }
            }, []);

            const handleStatusUpdate = useCallback((id, newStatus) => {
                setHighlightedTaskId(null);
                setData(prev => prev.map(row => row._id === id ? { ...row, Status: newStatus } : row));
                showNotification("Status updated.", "success");
            }, []);

            const handleDateUpdate = useCallback((id, newDate) => {
                setHighlightedTaskId(null);
                setData(prev => prev.map(row => {
                    if (row._id === id) {
                        return { ...row, "End Date": newDate };
                    }
                    return row;
                }));
                showNotification(`Due date updated to ${formatDate(newDate)}`, "success");
            }, []);

            const toggleFilter = useCallback((key, val) => {
                setHighlightedTaskId(null);
                setActiveFilters(prev => {
                    const current = prev[key] || [];
                    const updated = current.includes(val)
                        ? current.filter(item => item !== val)
                        : [...current, val];
                    return { ...prev, [key]: updated };
                });
            }, []);

            const handleSaveRow = () => {
                if (editingRowId === 'new') {
                    const newId = data.length > 0 ? Math.max(...data.map(d => d._id)) + 1 : 1;

                    // Calculate next Task Number
                    let nextTaskNumber = 1;
                    if (data.length > 0) {
                        const taskNumbers = data
                            .map(d => Number(d["Task Number"]))
                            .filter(n => !isNaN(n));
                        if (taskNumbers.length > 0) {
                            nextTaskNumber = Math.max(...taskNumbers) + 1;
                        }
                    }

                    const newRow = {
                        _id: newId,
                        "Task Number": nextTaskNumber,
                        ...editFormData,
                        "Begin Date": editFormData["Begin Date"] ? parseLocalDate(editFormData["Begin Date"]) : null,
                        "Start Date": editFormData["Begin Date"] ? parseLocalDate(editFormData["Begin Date"]) : null, // Mirror begin date
                        "End Date": editFormData["End Date"] ? parseLocalDate(editFormData["End Date"]) : null
                    };

                    // Add to bottom of list
                    setData([...data, newRow]);
                    showNotification(`New task added #${nextTaskNumber}`);
                } else {
                    const newData = data.map(row => {
                        if (row._id === editingRowId) {
                            let updatedRow = { ...row, ...editFormData };
                            if (editFormData["End Date"] && typeof editFormData["End Date"] === 'string') {
                                updatedRow["End Date"] = parseLocalDate(editFormData["End Date"]);
                            }
                            if (editFormData["Begin Date"] && typeof editFormData["Begin Date"] === 'string') {
                                updatedRow["Begin Date"] = parseLocalDate(editFormData["Begin Date"]);
                                updatedRow["Start Date"] = parseLocalDate(editFormData["Begin Date"]);
                            }
                            return updatedRow;
                        }
                        return row;
                    });
                    setData(newData);
                    showNotification("Task updated.");
                }
                setEditingRowId(null);
                setEditFormData({});
            };

            // Drag and Drop handlers
            const handleDragStart = (e, task) => {
                // Cancel long press timer if dragging starts
                if (longPressTimer.current) {
                    clearTimeout(longPressTimer.current);
                    longPressTimer.current = null;
                }
                if (calendarLongPressTimerRef.current) {
                    clearTimeout(calendarLongPressTimerRef.current);
                    calendarLongPressTimerRef.current = null;
                }

                setDraggedTask(task);
                e.dataTransfer.effectAllowed = 'move';

                // Create a custom drag image for consistent single-day look
                try {
                    const ghost = document.createElement('div');
                    // Use inline styles to ensure appearance since Tailwind might not apply immediately to detached nodes in some contexts
                    ghost.style.backgroundColor = '#2563eb'; // blue-600
                    ghost.style.color = 'white';
                    ghost.style.fontSize = '12px';
                    ghost.style.fontWeight = 'bold';
                    ghost.style.padding = '4px 8px';
                    ghost.style.borderRadius = '6px';
                    ghost.style.width = '140px';
                    ghost.style.height = '28px';
                    ghost.style.whiteSpace = 'nowrap';
                    ghost.style.overflow = 'hidden';
                    ghost.style.textOverflow = 'ellipsis';
                    ghost.style.position = 'absolute';
                    ghost.style.top = '-1000px';
                    ghost.style.zIndex = '9999';
                    ghost.style.border = '1px solid rgba(255,255,255,0.3)';
                    ghost.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';

                    ghost.textContent = task["Task Description"] || 'Moving Task...';

                    document.body.appendChild(ghost);

                    // setDragImage requires the element to be visible
                    e.dataTransfer.setDragImage(ghost, 10, 10); // Offset slightly so cursor isn't covering text

                    // Cleanup after drag starts
                    setTimeout(() => {
                        if (ghost.parentNode) document.body.removeChild(ghost);
                    }, 0);
                } catch (err) {
                    // Fallback to default behavior if fails
                    console.warn("Custom drag image failed", err);
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, targetDate) => {
                e.preventDefault();
                if (!draggedTask || !targetDate) return;

                // 1. Normalize Drop Target (New Start Date) to Noon
                const newStart = new Date(targetDate);
                newStart.setHours(12, 0, 0, 0);

                // 2. Get Original Dates (Normalized to Noon)
                const originalEnd = draggedTask["End Date"] ? new Date(draggedTask["End Date"]) : null;
                let originalStart = draggedTask["Begin Date"] ? new Date(draggedTask["Begin Date"]) :
                    (draggedTask["Start Date"] ? new Date(draggedTask["Start Date"]) : null);

                // If it was a single day task (or missing start), treat start as same as end
                if (!originalStart && originalEnd) {
                    originalStart = new Date(originalEnd);
                }

                if (!originalStart || !originalEnd) {
                    showNotification("Cannot determine task duration", "error");
                    return;
                }

                originalStart.setHours(12, 0, 0, 0);
                originalEnd.setHours(12, 0, 0, 0);

                // 3. Calculate Duration
                const durationMs = originalEnd.getTime() - originalStart.getTime();

                // 4. Calculate New End Date
                const newEnd = new Date(newStart.getTime() + durationMs);
                newEnd.setHours(12, 0, 0, 0);

                // 5. Update Data
                setData(prev => prev.map(row => {
                    if (row._id === draggedTask._id) {
                        const updatedRow = { ...row };

                        // Update End Date
                        updatedRow["End Date"] = newEnd;

                        // Update Start/Begin date if it existed (preserving key preference)
                        if (row["Begin Date"]) {
                            updatedRow["Begin Date"] = newStart;
                        } else if (row["Start Date"]) {
                            updatedRow["Start Date"] = newStart;
                        } else {
                            // If neither start key existed but we had an end date (implied single day),
                            // we generally leave it as is if duration was 0.
                            // But if user extended it, we might need a start date.
                            // For safety in this "move" operation, if it was single day, we just updated End Date.
                            // If it was effectively a startless task, setting explicit start might be good but sticking to schema is safer.
                            // However, consistently setting Begin Date is better for future operations.
                            if (durationMs > 0) {
                                // If multi-day now (or was), ensure we have a start date
                                updatedRow["Begin Date"] = newStart;
                            }
                        }

                        return updatedRow;
                    }
                    return row;
                }));

                showNotification(`Task rescheduled to ${formatDate(newStart)}`);
                setDraggedTask(null);
            };

            // Long-press handlers
            const handleMouseDown = (taskId, task) => {
                setHighlightedTaskId(null); // Clear highlight on interaction
                setLongPressTaskId(taskId);
                longPressTimer.current = setTimeout(() => {
                    // Navigate to calendar view
                    const taskDate = task["End Date"];
                    if (taskDate instanceof Date) {
                        setCurrentDate(new Date(taskDate.getFullYear(), taskDate.getMonth(), 1));
                    }
                    setView('calendar');
                    setHighlightedTaskId(taskId);

                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        setHighlightedTaskId(null);
                    }, 3000);

                    showNotification("Navigated to task in calendar");
                    setLongPressTaskId(null);
                }, 3000);
            };

            const handleMouseUp = useCallback(() => {
                if (longPressTimer.current) {
                    clearTimeout(longPressTimer.current);
                    longPressTimer.current = null;
                }
                setLongPressTaskId(null);
            }, []);

            const handleMouseLeave = useCallback(() => {
                if (longPressTimer.current) {
                    clearTimeout(longPressTimer.current);
                    longPressTimer.current = null;
                }
                setLongPressTaskId(null);
            }, []);

            // Navigate to current date
            // Navigate to current date
            const goToCurrentDate = () => {
                const today = new Date();
                const todayStr = formatDate(today);

                // If we're in dashboard view, scroll to the current date in the table
                if (view === 'dashboard') {
                    // Find the first task with today's date or the closest future date
                    const sortedData = [...filteredData].sort((a, b) => {
                        const dateA = a["End Date"];
                        const dateB = b["End Date"];
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateA - dateB;
                    });

                    // Find the first task on or after today
                    const targetTask = sortedData.find(task => {
                        const taskDate = task["End Date"];
                        if (!taskDate) return false;
                        return formatDate(taskDate) >= todayStr;
                    });

                    if (targetTask && tableRowRefs.current[targetTask._id]) {
                        tableRowRefs.current[targetTask._id].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });

                        // Highlight the row until next action
                        setHighlightedTaskId(targetTask._id);

                        showNotification(`Scrolled to ${formatDate(targetTask["End Date"])}`);
                    } else {
                        showNotification("No tasks found on or after today", "error");
                    }
                } else {
                    // For other views, navigate to calendar
                    setCurrentDate(new Date(today.getFullYear(), today.getMonth(), 1));
                    setView('calendar');
                    showNotification("Navigated to current month");
                }
            };




            // --- COMPUTED ---
            // --- COMPUTED ---
            const filterOptions = useMemo(() => {
                if (!data.length) return {};
                const opts = {};
                // All Excel columns except Task Number and Task Description
                const filterFields = ['Program', 'Task Type', 'Lead', 'Contributor', 'Contributors', 'Contributor(s)', 'Dependency', 'Status', 'Discussion', 'Key Milestone', 'Milestone', 'R&C', 'STEG', 'At Risk', 'Retail CR Focus', 'Finance Focus', 'MR Focus', 'Carib Focus'];

                filterFields.forEach(targetField => {
                    // Find actual header that matches (case-insensitive)
                    const actualHeader = headers.find(h => h.trim().toLowerCase() === targetField.toLowerCase());

                    if (actualHeader) {
                        // Filter data to determine available options for this field
                        // We filter by Search Term AND all *other* Active Filters
                        const validRows = data.filter(row => {
                            // 1. Apply Search Term
                            if (searchTerm) {
                                const matchesSearch = Object.values(row).some(val =>
                                    String(val).toLowerCase().includes(searchTerm.toLowerCase())
                                );
                                if (!matchesSearch) return false;
                            }

                            // 2. Apply all OTHER active filters
                            for (const [key, selectedVals] of Object.entries(activeFilters)) {
                                if (key === actualHeader) continue; // Skip the field we are generating options for
                                if (selectedVals && selectedVals.length > 0) {
                                    if (!selectedVals.includes(row[key])) return false;
                                }
                            }
                            return true;
                        });

                        opts[actualHeader] = [...new Set(validRows.map(d => d[actualHeader]).filter(Boolean))].sort();
                    }
                });
                return opts;
            }, [data, headers, activeFilters, searchTerm]);

            // Get top 10 most used values for autocomplete suggestions
            const topSuggestions = useMemo(() => {
                if (!data.length) return {};
                const suggestions = {};

                // All Excel columns except Task Number and Task Description
                const fields = ['Program', 'Task Type', 'Lead', 'Contributor', 'Contributors', 'Contributor(s)', 'Dependency', 'Status', 'Discussion', 'Key Milestone', 'Milestone', 'R&C', 'STEG', 'At Risk', 'Retail CR Focus', 'Finance Focus', 'MR Focus', 'Carib Focus'];
                fields.forEach(targetField => {
                    // Find actual header that matches (case-insensitive)
                    const actualHeader = headers.find(h => h.trim().toLowerCase() === targetField.toLowerCase());

                    if (actualHeader) {
                        // Count occurrences of each value
                        const counts = {};
                        data.forEach(row => {
                            const value = row[actualHeader];
                            if (value && String(value).trim()) {
                                counts[value] = (counts[value] || 0) + 1;
                            }
                        });

                        // Sort by count (descending) and take top 10
                        suggestions[actualHeader] = Object.entries(counts)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10)
                            .map(([value]) => value);
                    }
                });

                return suggestions;
            }, [data, headers]);

            const strictMatches = useMemo(() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                return data.filter(row => {
                    // Header Filters (ID)
                    if (headerFilters.ID) {
                        const val = String(row["Task Number"] || row._id || '').toLowerCase();
                        if (!val.includes(headerFilters.ID.toLowerCase())) return false;
                    }

                    // Text search filter
                    const matchesSearch = Object.values(row).some(val =>
                        String(val).toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    if (!matchesSearch) return false;

                    // Apply active filters
                    for (const [key, selectedValues] of Object.entries(activeFilters)) {
                        if (!selectedValues || selectedValues.length === 0) continue;

                        const rowValue = row[key];
                        // If row has no value but filter is active, exclude it
                        if (!rowValue) return false;

                        if (!selectedValues.includes(rowValue)) {
                            return false;
                        }
                    }

                    // AI Date Filter (Natural Language)
                    if (aiDateFilter) {
                        const endDate = parseLocalDate(row["End Date"]);

                        if (aiDateFilter.start && aiDateFilter.end) {
                            if (!endDate) return false;
                            if (endDate < aiDateFilter.start || endDate > aiDateFilter.end) return false;
                        }

                        if (aiDateFilter.type === 'overdue') {
                            if (!endDate) return false;
                            const status = String(row.Status).toLowerCase();
                            if (endDate >= today || status.includes('complete')) return false;
                        }
                    }

                    return true;
                });
            }, [data, searchTerm, activeFilters, aiDateFilter, headerFilters]);

            // Snapshot visible items when filters change - only when auto-filter is ON
            useEffect(() => {
                if (autoFilterEnabled) {
                    setPersistedIds(new Set(strictMatches.map(d => d._id)));
                }
            }, [searchTerm, activeFilters, aiDateFilter, headerFilters, autoFilterEnabled]);

            // Final displayed data
            const filteredData = useMemo(() => {
                let result;
                if (autoFilterEnabled) {
                    result = [...strictMatches];
                } else {
                    // Union of strictMatches and persistedIds found in data
                    const strictSet = new Set(strictMatches.map(d => d._id));
                    const persistedInStrict = new Set([...strictSet, ...persistedIds]);
                    result = data.filter(d => persistedInStrict.has(d._id));
                }

                // Apply due date sorting
                if (dueDateSort) {
                    result.sort((a, b) => {
                        const dateA = a["End Date"];
                        const dateB = b["End Date"];
                        // Handle null/undefined dates - push them to the end
                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        const comparison = new Date(dateA).getTime() - new Date(dateB).getTime();
                        return dueDateSort === 'asc' ? comparison : -comparison;
                    });
                }

                return result;
            }, [strictMatches, persistedIds, autoFilterEnabled, data, dueDateSort]);

            // Scroll to first task (for Total Tasks click)
            const scrollToFirstTask = useCallback(() => {
                if (filteredData.length > 0) {
                    const firstTask = filteredData[0];
                    if (tableRowRefs.current[firstTask._id]) {
                        tableRowRefs.current[firstTask._id].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                        setHighlightedTaskId(firstTask._id);
                        showNotification(`Viewing first task: ${firstTask["Task Description"]?.slice(0, 40) || 'Task'}...`);
                    }
                } else {
                    showNotification("No tasks found", "error");
                }
            }, [filteredData]);

            // Scroll to first in-progress task
            const scrollToFirstInProgress = useCallback(() => {
                const inProgressTask = filteredData.find(task => {
                    const status = String(task.Status || '').toLowerCase();
                    // Matches "In Progress", "In progress", "Running", etc if standardized
                    return status.includes('progress');
                });

                if (inProgressTask) {
                    const rowEl = tableRowRefs.current[inProgressTask._id];
                    if (rowEl) {
                        rowEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setHighlightedTaskId(inProgressTask._id);
                        showNotification(`Found In Progress (${inProgressTask.Status}): ID ${inProgressTask["Task Number"]}`);
                    } else {
                        // This implies the task is in data but didn't render?
                        console.warn("Task found but row ref missing", inProgressTask._id);
                        showNotification("Task found but not visible in table", "error");
                    }
                } else {
                    showNotification("No in-progress tasks visible", "error");
                }
            }, [filteredData]);

            // Scroll to first past-due task
            const scrollToFirstPastDue = useCallback(() => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Helper to ensure robust date parsing inline
                const getTaskDate = (d) => {
                    if (!d) return null;
                    if (d instanceof Date) return d;
                    try {
                        const s = String(d);
                        const parts = s.split('-');
                        if (parts.length === 3) {
                            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        }
                        return new Date(d);
                    } catch (e) { return null; }
                };

                const pastDueTask = filteredData.find(task => {
                    const status = String(task.Status || '').toLowerCase();
                    if (status.includes('complete') || status.includes('skipped') || status.includes('cancelled')) return false;

                    const endDate = getTaskDate(task["End Date"]);
                    if (!endDate) return false;

                    return endDate < today;
                });

                if (pastDueTask) {
                    const rowEl = tableRowRefs.current[pastDueTask._id];
                    if (rowEl) {
                        rowEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setHighlightedTaskId(pastDueTask._id);
                        showNotification(`Found Past Due (${pastDueTask.Status}): ID ${pastDueTask["Task Number"]}`);
                    } else {
                        console.warn("Task found but row ref missing", pastDueTask._id);
                        showNotification(`Task ${pastDueTask["Task Number"]} found but not rendered`, "error");
                    }
                } else {
                    showNotification("No past-due tasks visible", "error");
                }
            }, [filteredData]);

            const stats = useMemo(() => {
                const total = filteredData.length;
                const completed = filteredData.filter(d => String(d.Status).toLowerCase().includes('complete')).length;
                const inProgress = filteredData.filter(d => String(d.Status).toLowerCase().includes('progress')).length;

                // Past Due Logic: End Date < Today AND Status != Completed/Skipped/Cancelled
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const atRisk = filteredData.filter(d => {
                    const status = String(d.Status || '').toLowerCase();
                    if (status.includes('complete') || status.includes('skipped') || status.includes('cancelled')) return false;

                    // Ensure safe date parsing
                    const endDate = d["End Date"] instanceof Date ? d["End Date"] : parseLocalDate(d["End Date"]);
                    if (!endDate) return false;

                    return endDate < today;
                }).length;

                const completionRate = total ? Math.round((completed / total) * 100) : 0;
                return { total, completed, inProgress, atRisk, completionRate };
            }, [filteredData]);

            // Get unique status values from the data, preserving original casing
            // This ensures dropdown options match what's in the Excel file
            const uniqueStatuses = useMemo(() => {
                const statusSet = new Map(); // Use Map to preserve first occurrence casing
                const defaultStatuses = ['Not Started', 'In Progress', 'Completed', 'Delayed', 'Overdue', 'Cancelled', 'Skipped'];

                // Add default statuses first (will be overwritten if data has different casing)
                defaultStatuses.forEach(s => {
                    statusSet.set(s.toLowerCase(), s);
                });

                // Override with actual values from data (preserves their casing)
                data.forEach(row => {
                    if (row.Status && typeof row.Status === 'string') {
                        statusSet.set(row.Status.toLowerCase(), row.Status);
                    }
                });

                return Array.from(statusSet.values());
            }, [data]);

            const calendarMonths = useMemo(() => {
                const months = [];
                // Determine which months to show
                // Single: Show current month
                // Multi: Show current + next 2 months (3 total side-by-side)
                const baseDate = new Date(currentDate);
                const monthsOffsets = calendarMode === 'single' ? [0] : [0, 1, 2];

                let globalMaxTasks = 0;

                monthsOffsets.forEach(offset => {
                    const year = baseDate.getFullYear();
                    const month = baseDate.getMonth() + offset;
                    // Create a date object for this month (handles year wrapping automatically)
                    const thisMonthDate = new Date(year, month, 1);
                    const currentYear = thisMonthDate.getFullYear();
                    const currentMonth = thisMonthDate.getMonth();

                    const firstDay = new Date(currentYear, currentMonth, 1);
                    const lastDay = new Date(currentYear, currentMonth + 1, 0);
                    const days = [];

                    for (let i = 0; i < firstDay.getDay(); i++) days.push({ day: null, id: `pad-${currentMonth}-${i}` });

                    for (let i = 1; i <= lastDay.getDate(); i++) {
                        const date = new Date(currentYear, currentMonth, i);
                        const dayTasks = filteredData.filter(task => {
                            const d = task["End Date"];
                            return d instanceof Date && d.getDate() === i && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                        });
                        globalMaxTasks = Math.max(globalMaxTasks, dayTasks.length);
                        days.push({ date, day: i, tasks: dayTasks, id: `day-${currentMonth}-${i}` });
                    }

                    // Calculate multi-day task bars for this month
                    const multiDayBars = [];
                    const monthStart = new Date(currentYear, currentMonth, 1);
                    const monthEnd = new Date(currentYear, currentMonth + 1, 0);

                    filteredData.forEach(task => {
                        const startDate = task["Begin Date"] || task["Start Date"];
                        const endDate = task["End Date"];

                        if (startDate instanceof Date && endDate instanceof Date) {
                            const taskStart = new Date(startDate);
                            const taskEnd = new Date(endDate);
                            taskStart.setHours(0, 0, 0, 0);
                            taskEnd.setHours(0, 0, 0, 0);

                            const daysDiff = Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24));

                            // Only include multi-day tasks (more than 1 day)
                            if (daysDiff > 0 && taskEnd >= monthStart && taskStart <= monthEnd) {
                                const visibleStart = taskStart < monthStart ? monthStart : taskStart;
                                const visibleEnd = taskEnd > monthEnd ? monthEnd : taskEnd;

                                const startDay = visibleStart.getDate();
                                const endDay = visibleEnd.getDate();

                                // Calculate grid position
                                const startDayOfWeek = new Date(currentYear, currentMonth, startDay).getDay();
                                const firstDayOfWeek = firstDay.getDay();
                                const startGridPos = startDay + firstDayOfWeek - 1;
                                const startWeek = Math.floor(startGridPos / 7);

                                multiDayBars.push({
                                    task,
                                    startDay,
                                    endDay,
                                    startDayOfWeek,
                                    startWeek,
                                    span: endDay - startDay + 1,
                                    totalDays: daysDiff + 1,
                                    continuesFromPrev: taskStart < monthStart,
                                    continuesToNext: taskEnd > monthEnd
                                });
                            }
                        }
                    });

                    months.push({
                        date: thisMonthDate,
                        title: thisMonthDate.toLocaleString('default', { month: 'long', year: 'numeric' }),
                        days: days,
                        multiDayBars: multiDayBars,
                        maxTasks: 0 // Will be set after loop
                    });
                });

                // Set global max tasks for heatmap
                months.forEach(m => m.maxTasks = globalMaxTasks);

                return months;
            }, [currentDate, filteredData, calendarMode]);


            // --- UI RENDER ---
            // --- UI RENDER ---
            if (!isDataLoaded) {
                return (
                    <div className="min-h-screen relative flex flex-col items-center justify-center p-4 overflow-hidden bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-[#0051A5] via-[#004085] to-[#002a5c]">
                        {/* Background Image - will show if available, otherwise opacity 0 makes gradient visible */}
                        <div
                            className="absolute inset-0 z-0 bg-cover bg-center bg-no-repeat transition-opacity duration-1000"
                            style={{ backgroundImage: 'url(background.jpg)' }}
                        ></div>
                        {/* Overlay for readability */}
                        <div className="absolute inset-0 z-0 bg-black/20 backdrop-blur-[2px]"></div>

                        <div className="relative z-10 flex flex-col items-center max-w-lg w-full">
                            {/* Apple Liquid Glass Card - Animated Entry */}
                            <div className="w-full bg-white/10 backdrop-blur-xl border border-white/20 rounded-[30px] p-10 shadow-2xl relative overflow-hidden group animate-slide-up">
                                {/* Liquid Gradient Effect */}
                                <div className="absolute -top-24 -left-24 w-48 h-48 bg-blue-500/30 rounded-full blur-3xl group-hover:bg-blue-400/40 transition-all duration-1000 animate-pulse"></div>
                                <div className="absolute -bottom-24 -right-24 w-48 h-48 bg-purple-500/30 rounded-full blur-3xl group-hover:bg-purple-400/40 transition-all duration-1000 animate-pulse delay-150"></div>

                                <div className="relative z-10 flex flex-col items-center text-center">

                                    {/* STATE: SUCCESS */}
                                    {loadState === 'success' ? (
                                        <div className="flex flex-col items-center justify-center space-y-6 py-8">
                                            <div className="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center shadow-lg shadow-green-500/40 animate-scale-bounce relative">
                                                <div className="absolute inset-0 bg-green-500 rounded-full animate-ring-pulse"></div>
                                                <Icons.CheckCircle className="w-12 h-12 text-white" />
                                            </div>
                                            <div>
                                                <h2 className="text-3xl font-bold text-white mb-2 tracking-tight">Loading Complete</h2>
                                                <p className="text-blue-100/80 text-lg font-light">Launching Dashboard...</p>
                                            </div>
                                        </div>
                                    ) : (
                                        /* STATE: IDLE or PARSING */
                                        <>
                                            <div className="w-20 h-20 bg-gradient-to-br from-white/20 to-white/5 rounded-2xl flex items-center justify-center mb-6 shadow-lg border border-white/10 backdrop-blur-md float-animation">
                                                <Icons.FileSpreadsheet className="w-10 h-10 text-white drop-shadow-md" />
                                            </div>

                                            <h1 className="text-3xl font-bold text-white mb-2 tracking-tight">ASTRA Runbook</h1>
                                            <p className="text-blue-100/80 mb-8 font-light">Upload your Consolidated Runbook (Excel or CSV) to visualize tasks.</p>

                                            <label
                                                className={`flex flex-col items-center justify-center w-full h-40 border-2 border-white/20 border-dashed rounded-2xl cursor-pointer bg-white/5 hover:bg-white/10 transition-all duration-300 group/drop relative overflow-hidden ${isLoading ? 'pointer-events-none' : ''}`}
                                                onDrop={handleFileDrop}
                                                onDragOver={handleFileDragOver}
                                            >
                                                <div className="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-purple-500/10 opacity-0 group-hover/drop:opacity-100 transition-opacity duration-300"></div>
                                                <div className="relative z-10 flex flex-col items-center justify-center pt-5 pb-6 w-full px-8">
                                                    {isLoading ? (
                                                        <div className="flex flex-col items-center w-full space-y-4">
                                                            <div className="flex items-center space-x-3 mb-1">
                                                                <div className="animate-spin rounded-full h-5 w-5 border-2 border-white/30 border-t-white"></div>
                                                                <span className="text-sm font-medium text-white shimmer-text">Analyzing Runbook Data...</span>
                                                            </div>

                                                            {/* Custom Slim Progress Bar */}
                                                            <div className="w-full bg-white/10 rounded-full h-1.5 overflow-hidden backdrop-blur-sm">
                                                                <div
                                                                    className="bg-gradient-to-r from-blue-400 to-purple-400 h-full transition-all duration-300 shadow-[0_0_10px_rgba(255,255,255,0.5)]"
                                                                    style={{ width: `${loadingProgress}%` }}
                                                                ></div>
                                                            </div>
                                                            <span className="text-xs font-medium text-white/50">{loadingProgress}% Complete</span>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <Icons.Upload className="w-10 h-10 mb-3 text-white/70 group-hover/drop:text-white group-hover/drop:scale-110 transition-all duration-300 drop-shadow-md" />
                                                            <p className="text-sm text-white/80"><span className="font-semibold text-white">Click to upload</span> or drag file</p>
                                                            <p className="text-xs text-white/50 mt-1">Supports .xlsx, .csv</p>
                                                        </>
                                                    )}
                                                </div>
                                                <input type="file" className="hidden" accept=".csv, .xlsx" onChange={handleFileUpload} disabled={isLoading} />
                                            </label>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen w-screen p-8 flex items-center justify-center overflow-hidden bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-[#0051A5] via-[#004085] to-[#002a5c] relative">
                    {/* Background Image - consistent with upload screen */}
                    <div
                        className="absolute inset-0 z-0 bg-cover bg-center bg-no-repeat transition-opacity duration-1000"
                        style={{ backgroundImage: 'url(background.jpg)' }}
                    ></div>
                    {/* Overlay for readability - slight adjustment for main app content */}
                    <div className="absolute inset-0 z-0 bg-black/20 backdrop-blur-[2px]"></div>

                    <div className="w-full h-full flex text-slate-800 font-sans overflow-hidden rounded-[32px] shadow-2xl ring-1 ring-white/20 relative backdrop-blur-sm z-10">
                        {/* Background Overlay for better text readability if needed */}
                        <div className="absolute inset-0 bg-slate-900/30 -z-10"></div>
                        {/* LEFT PANEL - GLASS SIDEBAR */}
                        <aside className={`glass-sidebar flex flex-col z-30 transition-all duration-300 ${sidebarOpen ? 'w-72 translate-x-0' : 'w-0 -translate-x-full opacity-0 pointer-events-none'} relative overflow-hidden`}>
                            {/* Logo & Brand Area */}
                            <div className="p-6 flex items-center space-x-4 border-b border-white/10 shrink-0">
                                <div className="p-2.5 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl shadow-lg shadow-blue-500/20">
                                    <Icons.FileSpreadsheet className="w-6 h-6 text-white" />
                                </div>
                                <div className={`${!sidebarOpen && 'hidden'}`}>
                                    <h1 className="text-xl font-bold text-white tracking-tight drop-shadow-md">ASTRA</h1>
                                    <p className="text-[10px] text-cyan-200 font-bold tracking-[0.2em] uppercase">Runbook Manager</p>
                                </div>
                            </div>

                            {/* Sidebar Tabs */}
                            <div className="flex border-b border-white/10 shrink-0">
                                <button
                                    onClick={() => setSidebarTab('filters')}
                                    className={`flex-1 py-3 text-xs font-semibold uppercase tracking-wider transition-colors border-b-2 ${sidebarTab === 'filters' ? 'border-cyan-400 text-cyan-400 bg-white/5' : 'border-transparent text-white/50 hover:text-white hover:bg-white/5'}`}
                                >
                                    Filters
                                </button>
                                {aiEnabled && (
                                    <button
                                        onClick={() => setSidebarTab('assist')}
                                        className={`flex-1 py-3 text-xs font-semibold uppercase tracking-wider transition-colors border-b-2 ${sidebarTab === 'assist' ? 'border-purple-400 text-purple-400 bg-white/5' : 'border-transparent text-white/50 hover:text-white hover:bg-white/5'}`}
                                    >
                                        Astra Assist
                                    </button>
                                )}
                            </div>

                            {/* Filters Section */}
                            <div className={`flex-1 overflow-hidden flex flex-col ${sidebarTab === 'filters' ? 'block' : 'hidden'}`}>
                                <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
                                    {/* Smart Filter Toggle + Search */}
                                    <div className="space-y-2">
                                        {/* Mode Toggle */}
                                        {aiEnabled && (
                                            <div className="flex items-center justify-between">
                                                <span className="text-[10px] uppercase font-bold text-cyan-100/50">Search Mode</span>
                                                <button
                                                    onClick={() => setSmartFilterMode(!smartFilterMode)}
                                                    className={`flex items-center gap-1.5 px-2 py-1 rounded-lg text-[10px] font-semibold transition-all ${smartFilterMode ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30' : 'bg-white/5 text-white/50 border border-white/10 hover:bg-white/10'}`}
                                                >
                                                    <Icons.Sparkles className="w-3 h-3" />
                                                    {smartFilterMode ? 'AI Smart' : 'Regular'}
                                                </button>
                                            </div>
                                        )}

                                        {/* Input Field */}
                                        <div className="relative group">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                {smartFilterMode ? (
                                                    <Icons.Brain className={`h-4 w-4 ${smartFilterLoading ? 'animate-pulse text-purple-400' : 'text-purple-400/50 group-focus-within:text-purple-400'} transition-colors`} />
                                                ) : (
                                                    <Icons.Search className="h-4 w-4 text-cyan-100/50 group-focus-within:text-cyan-400 transition-colors" />
                                                )}
                                            </div>
                                            {smartFilterMode ? (
                                                <>
                                                    <input
                                                        type="text"
                                                        placeholder='e.g. "Tasks for CNB due in 15 days"'
                                                        value={smartFilterQuery}
                                                        onChange={(e) => setSmartFilterQuery(e.target.value)}
                                                        onKeyDown={(e) => { if (e.key === 'Enter') processSmartFilter(smartFilterQuery); }}
                                                        className="block w-full pl-10 pr-10 py-2.5 bg-purple-500/5 border border-purple-500/20 rounded-xl leading-5 text-cyan-50 placeholder-purple-200/30 focus:outline-none focus:bg-purple-500/10 focus:ring-1 focus:ring-purple-400/50 focus:border-purple-400/50 sm:text-sm transition-all shadow-inner"
                                                        disabled={smartFilterLoading}
                                                    />
                                                    <button
                                                        onClick={() => processSmartFilter(smartFilterQuery)}
                                                        disabled={smartFilterLoading || !smartFilterQuery.trim()}
                                                        className="absolute inset-y-0 right-0 pr-3 flex items-center"
                                                    >
                                                        {smartFilterLoading ? (
                                                            <div className="w-4 h-4 border-2 border-purple-400/30 border-t-purple-400 rounded-full animate-spin"></div>
                                                        ) : (
                                                            <Icons.Send className="h-4 w-4 text-purple-400/50 hover:text-purple-400 transition-colors cursor-pointer" />
                                                        )}
                                                    </button>
                                                </>
                                            ) : (
                                                <input
                                                    type="text"
                                                    placeholder="Search tasks..."
                                                    value={searchTerm}
                                                    onChange={(e) => { setHighlightedTaskId(null); setSearchTerm(e.target.value); }}
                                                    className="block w-full pl-10 pr-3 py-2.5 bg-white/5 border border-white/10 rounded-xl leading-5 text-cyan-50 placeholder-cyan-100/30 focus:outline-none focus:bg-white/10 focus:ring-1 focus:ring-cyan-400/50 focus:border-cyan-400/50 sm:text-sm transition-all shadow-inner"
                                                />
                                            )}
                                        </div>

                                        {/* Smart Filter Examples */}
                                        {smartFilterMode && (
                                            <div className="text-[10px] text-purple-300/50 leading-relaxed">
                                                Try: "Overdue tasks", "OSFI items due this week", "Show all delayed"
                                            </div>
                                        )}
                                    </div>

                                    {/* Filter List */}
                                    <div>
                                        <div className="flex items-center justify-between mb-2 px-1">
                                            <h3 className="text-xs font-bold text-cyan-100/70 uppercase tracking-wider flex items-center">
                                                <Icons.Filter className="w-3 h-3 mr-1.5" /> Filters
                                            </h3>
                                            {(Object.keys(activeFilters).some(k => activeFilters[k].length) || searchTerm || aiDateFilter) && (
                                                <button
                                                    onClick={() => { setHighlightedTaskId(null); setActiveFilters({}); setSearchTerm(''); setAiDateFilter(null); setSmartFilterQuery(''); }}
                                                    className="text-[10px] bg-white/10 hover:bg-white/20 text-white px-2 py-0.5 rounded-md transition-colors mr-2"
                                                >
                                                    Reset
                                                </button>
                                            )}
                                            <button
                                                onClick={() => setAutoFilterEnabled(!autoFilterEnabled)}
                                                className={`flex items-center gap-1.5 px-2 py-0.5 rounded-md text-[10px] transition-colors border ${autoFilterEnabled ? 'bg-blue-500/20 text-blue-300 border-blue-500/30' : 'bg-white/5 text-white/50 border-white/10'}`}
                                                title={autoFilterEnabled ? "Tasks auto-hide when edited" : "Tasks stay visible when edited"}
                                            >
                                                <div className={`w-1.5 h-1.5 rounded-full ${autoFilterEnabled ? 'bg-blue-400' : 'bg-slate-500'}`} />
                                                Auto
                                            </button>
                                        </div>


                                        {aiDateFilter && (
                                            <div className="flex items-center gap-2 px-3 py-2 bg-purple-500/10 border border-purple-500/20 rounded-lg">
                                                <Icons.Sparkles className="w-3 h-3 text-purple-400" />
                                                <span className="text-xs text-purple-300 flex-1">{aiDateFilter.label}</span>
                                                <button
                                                    onClick={() => setAiDateFilter(null)}
                                                    className="text-purple-400/50 hover:text-purple-300"
                                                >
                                                    <Icons.X className="w-3 h-3" />
                                                </button>
                                            </div>
                                        )}
                                        <div className="space-y-1">
                                            {Object.keys(filterOptions).map(key => (
                                                <MultiSelectDropdown
                                                    key={key}
                                                    label={key}
                                                    options={filterOptions[key]}
                                                    selected={activeFilters[key] || []}
                                                    onChange={(val) => toggleFilter(key, val)}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* AI Assistant Section */}
                            <div className={`flex-1 overflow-hidden ${sidebarTab === 'assist' ? 'block' : 'hidden'}`}>
                                <AIAssistant
                                    data={filteredData}
                                    contextStats={stats}
                                    onScanAnomalies={checkAnomalies}
                                    onAIAction={(action, payload) => {
                                        if (action === 'create_task') {
                                            const newId = data.length > 0 ? Math.max(...data.map(d => d._id)) + 1 : 1;
                                            const newRow = {
                                                _id: newId,
                                                "Program": payload["Program"] || "General",
                                                "Task Description": payload["Task Description"] || "New AI Task",
                                                "Status": payload["Status"] || "Not Started",
                                                "Lead": payload["Lead"] || "AI",
                                                "Milestone": payload["Milestone"] || "FALSE",
                                                "Key Milestone": payload["Key Milestone"] || "FALSE",
                                                "Begin Date": new Date(),
                                                "End Date": payload["End Date"] ? new Date(payload["End Date"]) : new Date(new Date().setDate(new Date().getDate() + 7)),
                                                "Dependency": ""
                                            };
                                            setData(prev => [newRow, ...prev]);
                                            showNotification("AI created a new task");
                                        } else if (action === 'update_task') {
                                            if (payload.id) {
                                                const targetId = parseInt(payload.id);
                                                setData(prev => prev.map(t => {
                                                    if (t._id === targetId || String(t["Task Number"]) === String(payload.id)) {
                                                        return {
                                                            ...t,
                                                            "Status": payload["Status"] || t["Status"],
                                                            "Task Description": payload["Task Description"] || t["Task Description"],
                                                            "Program": payload["Program"] || t["Program"],
                                                            "Lead": payload["Lead"] || t["Lead"],
                                                            "Milestone": payload["Milestone"] || t["Milestone"],
                                                            "Key Milestone": payload["Key Milestone"] || t["Key Milestone"],
                                                            "End Date": payload["End Date"] ? new Date(payload["End Date"]) : t["End Date"]
                                                        };
                                                    }
                                                    return t;
                                                }));
                                                showNotification("AI updated the task");
                                            } else {
                                                showNotification("AI could not find ID to update", "error");
                                            }
                                        }
                                    }}
                                />
                            </div>

                            {/* User Profile / Bottom Sidebar (Mock) */}
                            <div className="p-4 border-t border-white/10 bg-black/20">
                                <div className="flex items-center space-x-3">
                                    <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-pink-500 to-violet-500 border border-white/20 shadow-inner"></div>
                                    <div className="flex-1 min-w-0">
                                        <p className="text-sm font-medium text-white truncate">CEST Analytics</p>
                                    </div>
                                </div>
                            </div>
                        </aside>

                        {/* RIGHT PANEL - MAIN CONTENT */}
                        <main className="flex-1 flex flex-col min-w-0 relative bg-slate-50/5">

                            {/* TOP GLASS HEADER */}
                            <header className="h-20 glass border-b border-white/10 px-8 flex items-center justify-between shrink-0 z-20">
                                {/* Toggle Sidebar (Mobile/Desktop) */}
                                <div className="flex items-center">
                                    <button
                                        onClick={() => setSidebarOpen(!sidebarOpen)}
                                        className="p-2 mr-4 text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
                                    >
                                        {sidebarOpen ? <Icons.ChevronLeft className="w-5 h-5" /> : <Icons.Filter className="w-5 h-5" />}
                                    </button>

                                    {/* View Switcher Pills */}
                                    <div className="flex bg-black/20 p-1 rounded-xl border border-white/5 backdrop-blur-md">
                                        {[
                                            { id: 'dashboard', label: 'Overview', icon: Icons.BarChart3 },
                                            { id: 'gantt', label: 'Gantt', icon: Icons.GanttChart },
                                            { id: 'calendar', label: 'Calendar', icon: Icons.Clock }
                                        ].map(v => (
                                            <button
                                                key={v.id}
                                                onClick={() => { setHighlightedTaskId(null); setView(v.id); }}
                                                className={`
                                                flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200
                                                ${view === v.id
                                                        ? 'bg-white/10 text-white shadow-lg border border-white/10'
                                                        : 'text-cyan-100/60 hover:text-white hover:bg-white/5'
                                                    }
                                            `}
                                            >
                                                <v.icon className={`w-4 h-4 ${view === v.id ? 'text-cyan-400' : ''}`} />
                                                <span>{v.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Action Buttons */}
                                <div className="flex items-center space-x-4">
                                    {/* AI Toggle */}
                                    <button
                                        onClick={toggleAI}
                                        className={`flex items-center space-x-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all border ${aiEnabled ? 'bg-purple-500/20 text-purple-300 border-purple-500/30 shadow-lg shadow-purple-500/10' : 'bg-white/5 text-white/30 border-white/5 hover:bg-white/10 hover:text-white/50'}`}
                                        title={aiEnabled ? "AI Features Enabled" : "Enable AI Features (Admin)"}
                                    >
                                        <Icons.Brain className={`w-3.5 h-3.5 ${aiEnabled ? 'animate-pulse' : ''}`} />
                                        <span>{aiEnabled ? "AI ON" : "AI OFF"}</span>
                                    </button>

                                    <div className="flex bg-black/20 p-1 rounded-xl border border-white/5 backdrop-blur-md mx-2">
                                        <button
                                            onClick={undo}
                                            disabled={!canUndo}
                                            className={`p-2 rounded-lg transition-all ${canUndo ? 'text-white hover:bg-white/10' : 'text-white/20 cursor-not-allowed'}`}
                                            title="Undo (Ctrl+Z)"
                                        >
                                            <Icons.Undo className="w-4 h-4" />
                                        </button>
                                        <button
                                            onClick={redo}
                                            disabled={!canRedo}
                                            className={`p-2 rounded-lg transition-all ${canRedo ? 'text-white hover:bg-white/10' : 'text-white/20 cursor-not-allowed'}`}
                                            title="Redo (Ctrl+Y)"
                                        >
                                            <Icons.Redo className="w-4 h-4" />
                                        </button>
                                        <button
                                            onClick={() => { if (confirm("Reset all changes?")) revert(); }}
                                            disabled={!canUndo}
                                            className={`p-2 rounded-lg transition-all ${canUndo ? 'text-white hover:bg-white/10' : 'text-white/20 cursor-not-allowed'}`}
                                            title="Reset History"
                                        >
                                            <Icons.RotateCcw className="w-4 h-4" />
                                        </button>
                                        {lastSavedTime && (
                                            <div className="flex items-center ml-1 border-l border-white/10 pl-1 space-x-1">
                                                <button
                                                    onClick={recoverSession}
                                                    className="p-2 rounded-lg transition-all text-emerald-400 hover:text-emerald-300 hover:bg-emerald-400/10"
                                                    title={`Found unsaved session from ${lastSavedTime.toLocaleTimeString()}. Click to recover.`}
                                                >
                                                    <Icons.Download className="w-4 h-4" />
                                                </button>
                                                <button
                                                    onClick={clearSavedSession}
                                                    className="p-2 rounded-lg transition-all text-slate-400 hover:text-red-400 hover:bg-red-400/10"
                                                    title="Delete saved backup"
                                                >
                                                    <Icons.Trash2 className="w-3 h-3" />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    <button
                                        onClick={handleAddNew}
                                        className="group flex items-center space-x-2 px-5 py-2.5 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white text-sm font-semibold rounded-xl shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 transition-all transform hover:-translate-y-0.5"
                                    >
                                        <Icons.Plus className="w-4 h-4 group-hover:rotate-90 transition-transform" />
                                        <span>New Task</span>
                                    </button>
                                    <button
                                        onClick={handleExportHTML}
                                        disabled={!isDataLoaded}
                                        className="flex items-center space-x-2 px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed text-white text-sm font-medium rounded-xl transition-all shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40"
                                    >
                                        <Icons.FileText className="w-4 h-4" />
                                        <span>Export Filtered View</span>
                                    </button>
                                    <button
                                        onClick={handleExport}
                                        className="flex items-center space-x-2 px-5 py-2.5 bg-white/5 hover:bg-white/10 border border-white/10 text-cyan-100 text-sm font-medium rounded-xl transition-all hover:border-white/30"
                                    >
                                        <Icons.Download className="w-4 h-4" />
                                        <span>Export Excel</span>
                                    </button>
                                </div>
                            </header>

                            {/* CONTENT AREA */}
                            <div className="flex-1 overflow-hidden relative">
                                {/* Notifications */}
                                {notification && (
                                    <div className={`absolute top-4 right-4 px-4 py-3 rounded-2xl shadow-2xl z-50 flex items-center space-x-3 animate-scale-in bg-white border ${notification.type === 'error' ? 'border-red-200' : 'border-emerald-200'}`}>
                                        {notification.type === 'error' ? <Icons.AlertCircle className="w-5 h-5 text-red-600" /> : <Icons.CheckCircle className="w-5 h-5 text-emerald-600" />}
                                        <span className="text-sm font-bold text-slate-800">{notification.msg}</span>
                                    </div>
                                )}

                                {/* VIEW: DASHBOARD */}
                                {view === 'dashboard' && (
                                    <div className={`h-full flex flex-col transition-all duration-300 ${statsCollapsed ? 'p-4' : 'p-8'}`}>
                                        {/* Collapsible Stats Header */}
                                        <div className="shrink-0 mb-4">
                                            <button
                                                onClick={() => setStatsCollapsed(!statsCollapsed)}
                                                className="flex items-center gap-2 text-xs font-semibold text-slate-500 hover:text-blue-600 transition-colors group mb-2"
                                            >
                                                <Icons.ChevronDown className={`w-4 h-4 transition-transform duration-300 ${statsCollapsed ? '-rotate-90' : 'rotate-0'}`} />
                                                <span>{statsCollapsed ? 'Show Statistics' : 'Hide Statistics'}</span>
                                                {statsCollapsed && (
                                                    <span className="ml-2 flex items-center gap-3 text-[10px] font-medium text-slate-400">
                                                        <span className="flex items-center gap-1"><Icons.FileSpreadsheet className="w-3 h-3" />{stats.total}</span>
                                                        <span className="flex items-center gap-1"><Icons.CheckCircle className="w-3 h-3 text-emerald-500" />{stats.completionRate}%</span>
                                                        <span className="flex items-center gap-1"><Icons.Clock className="w-3 h-3 text-indigo-500" />{stats.inProgress}</span>
                                                        <span className="flex items-center gap-1"><Icons.AlertCircle className="w-3 h-3 text-red-500" />{stats.atRisk}</span>
                                                    </span>
                                                )}
                                            </button>
                                            <div
                                                className={`grid grid-cols-1 md:grid-cols-4 gap-6 transition-all duration-300 ease-in-out overflow-hidden ${statsCollapsed ? 'max-h-0 opacity-0 mb-0' : 'max-h-48 opacity-100'}`}
                                            >
                                                <StatCard label="Total Tasks" value={stats.total} icon={Icons.FileSpreadsheet} color="blue" onClick={scrollToFirstTask} />
                                                <StatCard label="Completion" value={`${stats.completionRate}%`} icon={Icons.CheckCircle} color="emerald" />
                                                <StatCard label="In Progress" value={stats.inProgress} icon={Icons.Clock} color="indigo" onClick={scrollToFirstInProgress} />
                                                <StatCard label="Past Due" value={stats.atRisk} icon={Icons.AlertCircle} color="red" onClick={scrollToFirstPastDue} />
                                            </div>
                                        </div>

                                        <div className={`rounded-2xl border shadow-2xl overflow-hidden flex flex-col flex-1 min-h-0 bg-white/80 transition-all duration-300 ${statsCollapsed ? 'border-slate-200' : 'glass-strong border-white/10'}`}>
                                            {/* Tasks Overview Header - Hidden when stats collapsed */}
                                            {!statsCollapsed && (
                                                <div className="px-6 py-4 border-b border-slate-200/50 bg-white/50 backdrop-blur-sm sticky top-0 z-10 flex justify-between items-center">
                                                    <div className="flex items-center space-x-2">
                                                        <div className="w-1 h-5 bg-blue-500 rounded-full"></div>
                                                        <h2 className="font-bold text-slate-800 text-lg">Tasks Overview</h2>
                                                    </div>
                                                    <div className="flex items-center space-x-3">
                                                        <div className="hidden md:flex items-center space-x-3 text-[10px] text-slate-500 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200">
                                                            <div className="flex items-center gap-1 text-amber-500" title="Key Milestone">
                                                                <Icons.Star className="w-3 h-3" />
                                                                <span className="text-slate-600">Key</span>
                                                            </div>
                                                            <div className="flex items-center gap-1 text-purple-500" title="Milestone">
                                                                <Icons.Diamond className="w-3 h-3" />
                                                                <span className="text-slate-600">Milestone</span>
                                                            </div>
                                                            <div className="flex items-center gap-1 text-orange-500" title="Discussion">
                                                                <Icons.MessageCircle className="w-3 h-3" />
                                                                <span className="text-slate-600">Discussion</span>
                                                            </div>
                                                            <span className="border-l border-slate-300 pl-2 text-slate-400 flex items-center gap-1">
                                                                <Icons.MousePointer className="w-2.5 h-2.5" />
                                                                Hover → Mark
                                                            </span>
                                                        </div>
                                                        <button
                                                            onClick={goToCurrentDate}
                                                            className="flex items-center space-x-2 px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-bold rounded-lg transition-colors border border-blue-200"
                                                        >
                                                            <Icons.Clock className="w-3.5 h-3.5" />
                                                            <span>Today</span>
                                                        </button>
                                                        <span className="text-xs text-slate-400 font-medium bg-slate-100 px-2 py-1 rounded-md">{filteredData.length} tasks</span>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="overflow-auto flex-1 custom-scrollbar">
                                                <table className="w-full text-left text-sm text-slate-600">
                                                    <thead className="bg-slate-50/80 border-b border-slate-200 sticky top-0 backdrop-blur-sm z-10">
                                                        <tr>
                                                            <th className="px-6 py-3 w-10"></th>

                                                            {/* ID: Static Compact Header */}
                                                            <th className="px-2 py-3 w-14 font-semibold text-slate-500 uppercase text-xs tracking-wider text-center align-middle">ID</th>

                                                            <th className="px-6 py-3 font-semibold text-slate-500 uppercase text-xs tracking-wider align-middle">Program</th>

                                                            {/* TYPE: Select acts as header */}
                                                            <th className="px-6 py-3 align-middle">
                                                                <div className="relative flex items-center group">
                                                                    <select
                                                                        value={activeFilters['Task Type']?.[0] || ''}
                                                                        onChange={(e) => {
                                                                            const val = e.target.value;
                                                                            const newFilters = { ...activeFilters };
                                                                            if (val) newFilters['Task Type'] = [val];
                                                                            else delete newFilters['Task Type'];
                                                                            setActiveFilters(newFilters);
                                                                        }}
                                                                        className="appearance-none bg-transparent border-none p-0 pr-4 text-xs font-semibold text-slate-500 uppercase tracking-wider focus:ring-0 cursor-pointer w-full truncate"
                                                                    >
                                                                        <option value="">Type</option>
                                                                        {(filterOptions['Task Type'] || []).map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                                    </select>
                                                                    <Icons.ChevronDown className="w-3 h-3 text-slate-400 absolute right-0 pointer-events-none group-hover:text-blue-500" />
                                                                </div>
                                                            </th>

                                                            {/* TASK: Label + Input (Linked to Global Search) */}
                                                            <th className={`px-6 py-3 align-middle ${!sidebarOpen ? 'w-1/2' : ''}`}>
                                                                <div className="flex items-center gap-3">
                                                                    <span>TASK</span>
                                                                    <div className="relative flex-1 group">
                                                                        <input
                                                                            type="text"
                                                                            placeholder="Search..."
                                                                            value={searchTerm}
                                                                            onChange={(e) => setSearchTerm(e.target.value)}
                                                                            className="w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 p-0 text-xs text-slate-600 font-normal placeholder-slate-300/0 group-hover:placeholder-slate-300 focus:placeholder-slate-300 focus:ring-0 transition-all"
                                                                        />
                                                                        {!searchTerm && <Icons.Search className="w-3 h-3 text-slate-300 absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none group-hover:opacity-0" />}
                                                                    </div>
                                                                </div>
                                                            </th>

                                                            {/* LEAD: Select acts as header */}
                                                            <th className="px-6 py-3 align-middle">
                                                                <div className="relative flex items-center group">
                                                                    <select
                                                                        value={activeFilters['Lead']?.[0] || ''}
                                                                        onChange={(e) => {
                                                                            const val = e.target.value;
                                                                            const newFilters = { ...activeFilters };
                                                                            if (val) newFilters['Lead'] = [val];
                                                                            else delete newFilters['Lead'];
                                                                            setActiveFilters(newFilters);
                                                                        }}
                                                                        className="appearance-none bg-transparent border-none p-0 pr-4 text-xs font-semibold text-slate-500 uppercase tracking-wider focus:ring-0 cursor-pointer w-full truncate"
                                                                    >
                                                                        <option value="">Lead</option>
                                                                        {(filterOptions['Lead'] || []).map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                                    </select>
                                                                    <Icons.ChevronDown className="w-3 h-3 text-slate-400 absolute right-0 pointer-events-none group-hover:text-blue-500" />
                                                                </div>
                                                            </th>

                                                            <th
                                                                className="px-6 py-3 font-semibold text-slate-500 uppercase text-xs tracking-wider align-middle cursor-pointer hover:text-blue-600 hover:bg-blue-50/50 transition-colors select-none"
                                                                onClick={() => setDueDateSort(prev => prev === 'asc' ? 'desc' : 'asc')}
                                                                title={dueDateSort === 'asc' ? 'Sorted: Earliest first (click for latest first)' : 'Sorted: Latest first (click for earliest first)'}
                                                            >
                                                                <div className="flex items-center gap-1">
                                                                    <span>Due</span>
                                                                    {dueDateSort === 'asc' ? (
                                                                        <Icons.ArrowUp className="w-3 h-3 text-blue-500" />
                                                                    ) : (
                                                                        <Icons.ArrowDown className="w-3 h-3 text-blue-500" />
                                                                    )}
                                                                </div>
                                                            </th>

                                                            {/* STATUS: Select acts as header */}
                                                            <th className="px-6 py-3 w-40 align-middle">
                                                                <div className="relative flex items-center group">
                                                                    <select
                                                                        value={activeFilters['Status']?.[0] || ''}
                                                                        onChange={(e) => {
                                                                            const val = e.target.value;
                                                                            const newFilters = { ...activeFilters };
                                                                            if (val) newFilters['Status'] = [val];
                                                                            else delete newFilters['Status'];
                                                                            setActiveFilters(newFilters);
                                                                        }}
                                                                        className="appearance-none bg-transparent border-none p-0 pr-4 text-xs font-semibold text-slate-500 uppercase tracking-wider focus:ring-0 cursor-pointer w-full truncate"
                                                                    >
                                                                        <option value="">Status</option>
                                                                        {(filterOptions['Status'] || []).map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                                    </select>
                                                                    <Icons.ChevronDown className="w-3 h-3 text-slate-400 absolute right-0 pointer-events-none group-hover:text-blue-500" />
                                                                </div>
                                                            </th>

                                                            <th className="px-6 py-3 w-10"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {filteredData.map((row, i) => (
                                                            <TaskTableRow
                                                                key={row._id}
                                                                row={row}
                                                                anomalies={anomalies.get(row._id)}
                                                                isLongPress={longPressTaskId === row._id}
                                                                isHighlighted={highlightedTaskId === row._id}
                                                                hoveredForBold={hoveredTaskForBold === row._id}
                                                                getStatusColor={getStatusColor}
                                                                isTaskPastDue={isTaskPastDue}
                                                                formatDate={formatDate}
                                                                rowRef={el => tableRowRefs.current[row._id] = el}
                                                                onMouseDown={() => handleMouseDown(row._id, row)}
                                                                onMouseUp={handleMouseUp}
                                                                onMouseLeave={handleMouseLeave}
                                                                onEdit={(e) => { e.stopPropagation(); setHighlightedTaskId(null); setEditingRowId(row._id); setEditFormData(row); }}
                                                                onDelete={(e) => { e.stopPropagation(); handleDeleteRow(row._id); }}
                                                                onStatusUpdate={(e) => { e.stopPropagation(); handleStatusUpdate(row._id, e.target.value); }}
                                                                onDateUpdate={handleDateUpdate}
                                                                onBoldHover={() => handleTaskMouseEnter(row._id)}
                                                                onBoldLeave={handleTaskMouseLeave}
                                                                onToggleIndicator={(field) => toggleTaskIndicator(row._id, field)}
                                                                sidebarOpen={sidebarOpen}
                                                            />
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* VIEW: CALENDAR */}
                                {view === 'calendar' && (
                                    <div className="flex flex-col h-[calc(100%-3rem)] bg-white/80 backdrop-blur-sm m-6 rounded-2xl shadow-xl border border-white/20 overflow-hidden">
                                        <div className="px-6 py-4 bg-white/50 border-b border-slate-200 flex justify-between items-center sticky top-0 z-20">
                                            <div className="flex items-center space-x-4">
                                                <div className="flex bg-slate-100 rounded-lg p-1">
                                                    <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="p-1.5 hover:bg-white rounded-md shadow-sm text-slate-600 transition-all"><Icons.ChevronLeft className="w-4 h-4" /></button>
                                                    <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="p-1.5 hover:bg-white rounded-md shadow-sm text-slate-600 transition-all"><Icons.ChevronRight className="w-4 h-4" /></button>
                                                </div>
                                                <button
                                                    onClick={() => setCurrentDate(new Date())}
                                                    className="px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-bold rounded-lg transition-colors border border-blue-200 shadow-sm flex items-center gap-1"
                                                >
                                                    <Icons.Clock className="w-3.5 h-3.5" />
                                                    <span>Today</span>
                                                </button>
                                                <h2 className="text-xl font-bold text-slate-800">
                                                    {calendarMode === 'single'
                                                        ? currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })
                                                        : `${calendarMonths[0].title} - ${calendarMonths[2].title}`
                                                    }
                                                </h2>
                                                <div className="flex bg-slate-100 rounded-lg p-1 ml-4">
                                                    <button
                                                        onClick={() => setCalendarMode('single')}
                                                        className={`px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md transition-all ${calendarMode === 'single' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                                                    >
                                                        Single
                                                    </button>
                                                    <button
                                                        onClick={() => setCalendarMode('multi')}
                                                        className={`px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md transition-all ${calendarMode === 'multi' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                                                    >
                                                        Multi
                                                    </button>
                                                </div>
                                                <div className="flex bg-slate-100 rounded-lg p-1 ml-4">
                                                    <button
                                                        onClick={() => setShowMultiDayBars(true)}
                                                        className={`px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md transition-all ${showMultiDayBars ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                                                    >
                                                        Bars
                                                    </button>
                                                    <button
                                                        onClick={() => setShowMultiDayBars(false)}
                                                        className={`px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-md transition-all ${!showMultiDayBars ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                                                    >
                                                        Due Date
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="hidden md:flex items-center space-x-3 text-[10px] text-slate-500 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200">
                                                <div className="flex items-center gap-1 text-amber-500" title="Key Milestone">
                                                    <Icons.Star className="w-3 h-3" />
                                                    <span className="text-slate-600">Key</span>
                                                </div>
                                                <div className="flex items-center gap-1 text-purple-500" title="Milestone">
                                                    <Icons.Diamond className="w-3 h-3" />
                                                    <span className="text-slate-600">Milestone</span>
                                                </div>
                                                <div className="flex items-center gap-1 text-orange-500" title="Discussion">
                                                    <Icons.MessageCircle className="w-3 h-3" />
                                                    <span className="text-slate-600">Discussion</span>
                                                </div>
                                            </div>
                                            <div className="text-xs text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 font-medium flex items-center space-x-3">
                                                <span className="flex items-center font-bold"><Icons.Info className="w-3 h-3 mr-1" /> Tips:</span>
                                                <span>Drag to reschedule</span>
                                                <span className="text-blue-300">•</span>
                                                <span>Double-click: Status</span>
                                                <span className="text-blue-300">•</span>
                                                <span>Hold 2s: Edit</span>
                                            </div>
                                        </div>
                                        <div className={`p-6 flex-1 overflow-y-auto custom-scrollbar ${calendarMode === 'multi' ? 'overflow-x-auto' : ''}`}>
                                            <div className={`grid gap-6 h-full ${calendarMode === 'single' ? 'grid-cols-1' : 'grid-cols-3 min-w-[1000px]'}`}>
                                                {calendarMonths.map((monthData, idx) => (
                                                    <div key={idx} className="flex flex-col h-full">
                                                        {calendarMode === 'multi' && (
                                                            <h3 className="text-center font-bold text-slate-700 mb-3">{monthData.title}</h3>
                                                        )}
                                                        <div className={`grid grid-cols-7 mb-2 text-center font-bold text-slate-400 uppercase tracking-widest ${calendarMode === 'single' ? 'text-xs' : 'text-[10px]'}`}>
                                                            {(calendarMode === 'single'
                                                                ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                                                                : ['S', 'M', 'T', 'W', 'T', 'F', 'S']
                                                            ).map(d => <div key={d}>{d}</div>)}
                                                        </div>
                                                        <div className="relative flex-1" style={{ isolation: 'isolate' }}>
                                                            {(() => {
                                                                // Pre-calculate slots for all multi-day bars by week
                                                                const barsByWeek = {};
                                                                const firstDayOfWeek = new Date(monthData.date.getFullYear(), monthData.date.getMonth(), 1).getDay();
                                                                const numWeeks = Math.ceil(monthData.days.length / 7);

                                                                if (showMultiDayBars) {
                                                                    monthData.multiDayBars.forEach((bar, barIdx) => {
                                                                        const startGridPos = bar.startDay + firstDayOfWeek - 1;
                                                                        const endGridPos = bar.endDay + firstDayOfWeek - 1;

                                                                        for (let pos = startGridPos; pos <= endGridPos;) {
                                                                            const weekNum = Math.floor(pos / 7);
                                                                            const weekStart = weekNum * 7;
                                                                            const weekEnd = weekStart + 6;

                                                                            const segmentStart = Math.max(pos, weekStart);
                                                                            const segmentEnd = Math.min(endGridPos, weekEnd);

                                                                            if (!barsByWeek[weekNum]) barsByWeek[weekNum] = [];

                                                                            let slot = 0;
                                                                            const usedSlots = barsByWeek[weekNum]
                                                                                .filter(s => !(s.segmentEnd < segmentStart || s.segmentStart > segmentEnd))
                                                                                .map(s => s.slot);
                                                                            while (usedSlots.includes(slot)) slot++;

                                                                            barsByWeek[weekNum].push({
                                                                                bar,
                                                                                barIdx,
                                                                                segmentStart,
                                                                                segmentEnd,
                                                                                slot,
                                                                                isFirstSegment: pos === startGridPos,
                                                                                isLastSegment: segmentEnd === endGridPos,
                                                                                continuesLeft: bar.continuesFromPrev && pos === startGridPos,
                                                                                continuesRight: bar.continuesToNext && segmentEnd === endGridPos
                                                                            });

                                                                            pos = weekEnd + 1;
                                                                        }
                                                                    });
                                                                }

                                                                // Calculate max slots per week
                                                                const barHeight = calendarMode === 'single' ? 20 : 14;
                                                                const barGap = 4;
                                                                const dateNumberHeight = calendarMode === 'single' ? 26 : 20; // Height for date number + padding
                                                                const baseRowHeight = calendarMode === 'single' ? 110 : 70;
                                                                const singleTasksMinHeight = 30; // Minimum space for single-day tasks

                                                                const maxSlotsPerWeek = {};
                                                                for (let w = 0; w < numWeeks; w++) {
                                                                    const weekBars = barsByWeek[w] || [];
                                                                    maxSlotsPerWeek[w] = weekBars.length > 0 ? Math.max(...weekBars.map(b => b.slot)) + 1 : 0;
                                                                }

                                                                // Calculate explicit row heights
                                                                // Formula: dateNumber + (slots * (barHeight + gap)) + barHeight (for last bar) + buffer + singleTasks
                                                                const rowHeights = [];
                                                                for (let w = 0; w < numWeeks; w++) {
                                                                    const slotsNeeded = maxSlotsPerWeek[w] || 0;

                                                                    // Calculate max single-day tasks in this week to ensure they fit
                                                                    let maxSingleTasks = 0;
                                                                    for (let d = 0; d < 7; d++) {
                                                                        const dayIdx = w * 7 + d;
                                                                        if (dayIdx < monthData.days.length) {
                                                                            const day = monthData.days[dayIdx];
                                                                            const singleTasks = day.tasks ? day.tasks.filter(t => {
                                                                                if (!showMultiDayBars) return true; // Count all tasks if not showing bars

                                                                                const startDate = t["Begin Date"] || t["Start Date"];
                                                                                const endDate = t["End Date"];
                                                                                if (!(startDate instanceof Date) || !(endDate instanceof Date)) return true;
                                                                                const start = new Date(startDate);
                                                                                const end = new Date(endDate);
                                                                                start.setHours(0, 0, 0, 0);
                                                                                end.setHours(0, 0, 0, 0);
                                                                                return start.getTime() === end.getTime();
                                                                            }) : [];
                                                                            maxSingleTasks = Math.max(maxSingleTasks, singleTasks.length);
                                                                        }
                                                                    }

                                                                    // Estimate height needed for single tasks (approx 32px per task including gap)
                                                                    const singleTaskVals = maxSingleTasks * 32;
                                                                    const requiredSingleTaskSpace = Math.max(singleTasksMinHeight, singleTaskVals);

                                                                    // Each bar needs barHeight, plus barGap between them
                                                                    // Total bar area = slotsNeeded * barHeight + (slotsNeeded - 1) * barGap + padding
                                                                    const barsAreaHeight = slotsNeeded > 0 ? (slotsNeeded * (barHeight + barGap)) + 20 : 0;

                                                                    const heightForBars = dateNumberHeight + barsAreaHeight + requiredSingleTaskSpace + 10;
                                                                    rowHeights.push(Math.max(baseRowHeight, heightForBars));
                                                                }

                                                                // Calculate cumulative row tops (for absolute positioning)
                                                                // Start at 1 to account for grid border
                                                                const rowTops = [1];
                                                                for (let w = 0; w < numWeeks; w++) {
                                                                    // Add 1px for the gap between rows (gap-px)
                                                                    rowTops.push(rowTops[w] + rowHeights[w] + 1);
                                                                }

                                                                return (
                                                                    <>
                                                                        {/* Main Calendar Grid with explicit row heights */}
                                                                        <div
                                                                            className="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-xl overflow-visible shadow-sm"
                                                                            style={{
                                                                                position: 'relative',
                                                                                gridTemplateRows: rowHeights.map(h => `${h}px`).join(' ')
                                                                            }}
                                                                        >
                                                                            {monthData.days.map((d, dayIdx) => {
                                                                                const weekRow = Math.floor(dayIdx / 7);
                                                                                const slotsInThisWeek = maxSlotsPerWeek[weekRow] || 0;

                                                                                // Get single-day tasks
                                                                                const isToday = d.date && new Date().toDateString() === d.date.toDateString();
                                                                                const singleDayTasks = d.tasks ? d.tasks.filter(t => {
                                                                                    if (!showMultiDayBars) return true; // Show all tasks on due date (d.tasks contains tasks ending on this day)

                                                                                    const startDate = t["Begin Date"] || t["Start Date"];
                                                                                    const endDate = t["End Date"];
                                                                                    if (!(startDate instanceof Date) || !(endDate instanceof Date)) return true;
                                                                                    const start = new Date(startDate);
                                                                                    const end = new Date(endDate);
                                                                                    start.setHours(0, 0, 0, 0);
                                                                                    end.setHours(0, 0, 0, 0);
                                                                                    return start.getTime() === end.getTime();
                                                                                }) : [];

                                                                                return (
                                                                                    <div
                                                                                        key={d.id}
                                                                                        data-day={d.day}
                                                                                        data-week={weekRow}
                                                                                        className={`p-1 flex flex-col ${!d.day ? 'bg-slate-50/50' : (isToday ? 'bg-blue-50 ring-2 ring-blue-400 ring-inset z-10 shadow-[inner_0_0_12px_rgba(59,130,246,0.15)]' : 'bg-white')} ${draggedTask ? 'transition-colors' : ''}`}
                                                                                        onDragOver={d.date ? handleDragOver : undefined}
                                                                                        onDrop={d.date ? (e) => handleDrop(e, d.date) : undefined}
                                                                                    >
                                                                                        {d.day && (
                                                                                            <>
                                                                                                <span className={`font-bold mb-1 ${isToday ? 'text-blue-600' : 'text-slate-400'} ${calendarMode === 'single' ? 'text-xs' : 'text-[10px]'}`}>{d.day}</span>

                                                                                                {/* Spacer for multi-day bars - height matches the overlay bar area */}
                                                                                                {slotsInThisWeek > 0 && (
                                                                                                    <div style={{
                                                                                                        height: `${slotsInThisWeek * (barHeight + barGap) + 8}px`,
                                                                                                        minHeight: `${slotsInThisWeek * (barHeight + barGap) + 8}px`
                                                                                                    }} />
                                                                                                )}

                                                                                                {/* Single-day tasks */}
                                                                                                <div className={`flex-1 overflow-y-auto custom-scrollbar ${calendarMode === 'single' ? 'space-y-1' : 'space-y-0.5'}`}>
                                                                                                    {singleDayTasks.map(t => (
                                                                                                        <CalendarTaskItem
                                                                                                            key={t._id}
                                                                                                            task={t}
                                                                                                            calendarMode={calendarMode}
                                                                                                            getStatusColor={getStatusColor}
                                                                                                            highlightedTaskId={highlightedTaskId}
                                                                                                            draggedTask={draggedTask}
                                                                                                            onDragStart={handleDragStart}
                                                                                                            onMouseDown={handleCalendarTaskMouseDown}
                                                                                                            onMouseUp={handleCalendarTaskMouseUp}
                                                                                                            onDoubleClick={handleCalendarTaskDoubleClick}
                                                                                                        />
                                                                                                    ))}
                                                                                                </div>
                                                                                            </>
                                                                                        )}
                                                                                    </div>
                                                                                );
                                                                            })}
                                                                        </div>

                                                                        {/* Multi-day bar overlay - positioned to match explicit grid rows */}
                                                                        {Object.entries(barsByWeek).flatMap(([weekNum, segments]) =>
                                                                            segments.map(({ bar, barIdx, segmentStart, segmentEnd, slot, isFirstSegment, isLastSegment, continuesLeft, continuesRight }) => {
                                                                                const colStart = (segmentStart % 7);
                                                                                const colSpan = segmentEnd - segmentStart + 1;
                                                                                const weekRow = parseInt(weekNum);

                                                                                // Calculate border radius
                                                                                let borderRadius = '';
                                                                                const roundLeft = isFirstSegment && !continuesLeft;
                                                                                const roundRight = isLastSegment && !continuesRight;
                                                                                if (roundLeft && roundRight) borderRadius = '6px';
                                                                                else if (roundLeft) borderRadius = '6px 0 0 6px';
                                                                                else if (roundRight) borderRadius = '0 6px 6px 0';
                                                                                else borderRadius = '0';

                                                                                // Use cumulative row tops for precise positioning
                                                                                const topPosition = rowTops[weekRow] + dateNumberHeight + slot * (barHeight + barGap);

                                                                                const barPosition = {
                                                                                    position: 'absolute',
                                                                                    left: `calc(${colStart} * (100% / 7) + 4px)`,
                                                                                    width: `calc(${colSpan} * (100% / 7) - 8px)`,
                                                                                    top: `${topPosition}px`,
                                                                                    height: `${barHeight}px`,
                                                                                    borderRadius: borderRadius,
                                                                                    zIndex: 20,
                                                                                    display: 'flex',
                                                                                    alignItems: 'center',
                                                                                    paddingLeft: roundLeft ? '6px' : '4px',
                                                                                    paddingRight: roundRight ? '6px' : '4px',
                                                                                    boxShadow: '0 1px 3px rgba(0,0,0,0.12)'
                                                                                };

                                                                                return (
                                                                                    <CalendarMultiDayBar
                                                                                        key={`multibar-${bar.task._id}-${weekNum}-${segmentStart}`}
                                                                                        bar={bar}
                                                                                        barPosition={barPosition}
                                                                                        roundLeft={roundLeft}
                                                                                        roundRight={roundRight}
                                                                                        isFirstSegment={isFirstSegment}
                                                                                        calendarMode={calendarMode}
                                                                                        getStatusColor={getStatusColor}
                                                                                        highlightedTaskId={highlightedTaskId}
                                                                                        draggedTask={draggedTask}
                                                                                        onDragStart={handleDragStart}
                                                                                        onMouseDown={handleCalendarTaskMouseDown}
                                                                                        onMouseUp={handleCalendarTaskMouseUp}
                                                                                        onDoubleClick={handleCalendarTaskDoubleClick}
                                                                                    />
                                                                                );
                                                                            })
                                                                        )}
                                                                    </>
                                                                );
                                                            })()}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}



                                {/* VIEW: GANTT */}
                                {view === 'gantt' && (
                                    <div className="h-full p-6 overflow-hidden">
                                        <GanttView
                                            tasks={filteredData}
                                            onEdit={(task) => { setEditingRowId(task._id); setEditFormData(task); }}
                                            onStatusChange={handleStatusUpdate}
                                            onDateChange={(taskId, newStart, newEnd) => {
                                                setData(prev => prev.map(row => {
                                                    if (row._id === taskId) {
                                                        const updated = { ...row };
                                                        if (newStart) {
                                                            updated["Begin Date"] = newStart;
                                                            updated["Start Date"] = newStart;
                                                        }
                                                        if (newEnd) {
                                                            updated["End Date"] = newEnd;
                                                        }
                                                        return updated;
                                                    }
                                                    return row;
                                                }));
                                                showNotification("Task dates updated");
                                            }}
                                        />
                                    </div>
                                )}
                            </div>
                        </main>

                        {/* EDIT MODAL */}
                        {editingRowId !== null && (
                            <div className="absolute inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col animate-scale-in border border-white/20">
                                    <div className="px-6 py-4 border-b border-slate-100 flex justify-between bg-slate-50/80 backdrop-blur-sm items-center">
                                        <h3 className="font-bold text-lg text-slate-800 flex items-center">
                                            <div className="w-1 h-5 bg-blue-500 rounded-full mr-3"></div>
                                            {editingRowId === 'new' ? 'Add New Task' : 'Edit Task'}
                                        </h3>
                                        <button onClick={() => setEditingRowId(null)} className="p-1 hover:bg-slate-200 rounded-full transition-colors"><Icons.X className="w-5 h-5 text-slate-400 hover:text-slate-600" /></button>
                                    </div>
                                    <div className="p-8 overflow-y-auto space-y-6">
                                        {/* Core Fields */}
                                        <div className="grid grid-cols-2 gap-6">
                                            <AutocompleteInput
                                                label="Program"
                                                value={editFormData.Program}
                                                onChange={(val) => setEditFormData({ ...editFormData, Program: val })}
                                                suggestions={topSuggestions['Program'] || []}
                                            />
                                            <AutocompleteInput
                                                label="Task Type"
                                                value={editFormData["Task Type"]}
                                                onChange={(val) => setEditFormData({ ...editFormData, "Task Type": val })}
                                                suggestions={topSuggestions['Task Type'] || []}
                                            />
                                        </div>
                                        <div className="grid grid-cols-2 gap-6">
                                            <AutocompleteInput
                                                label="Lead"
                                                value={editFormData.Lead}
                                                onChange={(val) => setEditFormData({ ...editFormData, Lead: val })}
                                                suggestions={topSuggestions['Lead'] || []}
                                            />
                                            <AutocompleteInput
                                                label="Contributor"
                                                value={(() => {
                                                    const header = headers.find(h => {
                                                        const lower = h.trim().toLowerCase();
                                                        return lower === 'contributor' || lower === 'contributors' || lower === 'contributor(s)';
                                                    });
                                                    return header ? (editFormData[header] || '') : (editFormData.Contributor || editFormData.Contributors || editFormData['Contributor(s)'] || '');
                                                })()}
                                                onChange={(val) => {
                                                    const header = headers.find(h => {
                                                        const lower = h.trim().toLowerCase();
                                                        return lower === 'contributor' || lower === 'contributors' || lower === 'contributor(s)';
                                                    }) || 'Contributors';
                                                    setEditFormData({ ...editFormData, [header]: val });
                                                }}
                                                suggestions={(() => {
                                                    const header = headers.find(h => {
                                                        const lower = h.trim().toLowerCase();
                                                        return lower === 'contributor' || lower === 'contributors' || lower === 'contributor(s)';
                                                    });
                                                    return header ? (topSuggestions[header] || []) : [];
                                                })()}
                                            />
                                        </div>
                                        <div>
                                            <label className="label">Task Description</label>
                                            <textarea
                                                className="input bg-slate-50 min-h-[80px]"
                                                rows={3}
                                                value={editFormData["Task Description"] || ''}
                                                onChange={e => setEditFormData({ ...editFormData, "Task Description": e.target.value })}
                                                placeholder="Enter task description..."
                                            />
                                        </div>
                                        <div>
                                            <label className="label">Dependency (Task Numbers, comma separated)</label>
                                            <input
                                                type="text"
                                                className="input bg-slate-50"
                                                value={editFormData.Dependency || ''}
                                                onChange={e => setEditFormData({ ...editFormData, Dependency: e.target.value })}
                                                placeholder="e.g. 123, 124"
                                            />
                                        </div>
                                        <div className="grid grid-cols-3 gap-6">
                                            <div>
                                                <label className="label">Begin Date</label>
                                                <input
                                                    type="date"
                                                    className="input bg-slate-50"
                                                    value={(() => {
                                                        const d = editFormData["Begin Date"];
                                                        if (!d) return '';
                                                        // If already a string in YYYY-MM-DD format, use it directly
                                                        if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                                                        // If it's a Date object, format it using local components
                                                        if (d instanceof Date) return formatDate(d);
                                                        // Otherwise, parse and format
                                                        const parsed = parseLocalDate(d);
                                                        return parsed ? formatDate(parsed) : '';
                                                    })()}
                                                    onChange={e => setEditFormData({ ...editFormData, "Begin Date": e.target.value })}
                                                />
                                            </div>
                                            <div>
                                                <label className="label">End Date</label>
                                                <input
                                                    type="date"
                                                    className="input bg-slate-50"
                                                    value={(() => {
                                                        const d = editFormData["End Date"];
                                                        if (!d) return '';
                                                        // If already a string in YYYY-MM-DD format, use it directly
                                                        if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                                                        // If it's a Date object, format it using local components
                                                        if (d instanceof Date) return formatDate(d);
                                                        // Otherwise, parse and format
                                                        const parsed = parseLocalDate(d);
                                                        return parsed ? formatDate(parsed) : '';
                                                    })()}
                                                    onChange={e => setEditFormData({ ...editFormData, "End Date": e.target.value })}
                                                />
                                            </div>
                                            <div>
                                                <label className="label">Status</label>
                                                <select
                                                    className="input bg-slate-50"
                                                    value={editFormData.Status || ''}
                                                    onChange={e => setEditFormData({ ...editFormData, Status: e.target.value })}
                                                >
                                                    {uniqueStatuses.map(status => (
                                                        <option key={status} value={status}>{status}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="label">Notes</label>
                                            <textarea
                                                className="input bg-slate-50"
                                                rows={2}
                                                value={editFormData.Notes || ''}
                                                onChange={e => setEditFormData({ ...editFormData, Notes: e.target.value })}
                                            />
                                        </div>

                                        {/* All Indicators */}
                                        <div className="pt-2 border-t border-slate-100">
                                            <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                                <Icons.Flag className="w-3 h-3" /> Indicators & Tags
                                            </h4>
                                            <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                                {[
                                                    { field: 'Discussion', icon: 'MessageCircle', color: 'text-orange-500' },
                                                    { field: 'Key Milestone', icon: 'Star', color: 'text-amber-500' },
                                                    { field: 'Milestone', icon: 'Diamond', color: 'text-purple-500' },
                                                    { field: 'R&C', icon: null },
                                                    { field: 'STEG', icon: null },
                                                    { field: 'At Risk', icon: null },
                                                    { field: 'Retail CR Focus', icon: null },
                                                    { field: 'Finance Focus', icon: null },
                                                    { field: 'MR Focus', icon: null },
                                                    { field: 'Carib Focus', icon: null }
                                                ].map(({ field, icon, color }) => (
                                                    <div key={field} className="flex items-center gap-2 bg-slate-50 rounded-lg px-3 py-2 hover:bg-slate-100 transition-colors">
                                                        <input
                                                            type="checkbox"
                                                            id={`edit-${field}`}
                                                            checked={isIndicatorTrue(editFormData[field])}
                                                            onChange={(e) => setEditFormData({ ...editFormData, [field]: e.target.checked ? 'Y' : '' })}
                                                            className="w-4 h-4 rounded border-slate-300 text-blue-500 focus:ring-blue-500"
                                                        />
                                                        <label htmlFor={`edit-${field}`} className="text-sm text-slate-700 flex items-center gap-1 cursor-pointer select-none">
                                                            {icon && Icons[icon] && React.createElement(Icons[icon], { className: `w-3.5 h-3.5 ${color}` })}
                                                            <span className="truncate">{field}</span>
                                                        </label>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="px-6 py-4 border-t border-slate-100 bg-slate-50 flex items-center justify-between">
                                        <div>
                                            {editingRowId !== 'new' && (
                                                <button
                                                    onClick={() => {
                                                        if (confirm('Are you sure you want to delete this task?')) {
                                                            handleDeleteRow(editingRowId);
                                                            setEditingRowId(null);
                                                        }
                                                    }}
                                                    className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors font-medium text-sm border border-red-100"
                                                >
                                                    <Icons.Trash2 className="w-4 h-4" />
                                                    <span>Delete</span>
                                                </button>
                                            )}
                                        </div>
                                        <div className="flex items-center space-x-3">
                                            <button onClick={() => setEditingRowId(null)} className="btn-secondary">Cancel</button>
                                            <button onClick={() => handleSaveRow()} className="btn-primary shadow-lg shadow-blue-500/30">Save Changes</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- SUBCOMPONENTS & STYLES ---
        const StatCard = ({ label, value, icon: Icon, color, onClick }) => (
            <div
                className={`glass-strong p-5 rounded-2xl border border-white/30 shadow-xl hover:shadow-2xl transition-all hover:scale-105 ${onClick ? 'cursor-pointer' : ''}`}
                onClick={onClick}
            >
                <p className="text-slate-600 text-sm font-medium">{label}</p>
                <div className="flex items-end justify-between mt-2">
                    <span className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">{value}</span>
                    <div className="p-2 bg-gradient-to-br from-purple-400 to-blue-500 rounded-xl shadow-lg"><Icon className="w-5 h-5 text-white" /></div>
                </div>
            </div>
        );

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>
        .label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            outline: none;
        }

        .input:focus {
            ring: 2px solid #3b82f6;
            border-color: #3b82f6;
        }

        .btn-primary {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            background-color: #2563eb;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-secondary {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
            border-radius: 0.5rem;
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
        }
    </style>
</body>

</html>