<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTRA Studio - Scenario Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Plotly.js for CET1 Capital Analysis Charts -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF.js for PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="background_data.js"></script> <!-- Pre-loaded background data for PDF export -->

    <style>
        :root {
            /* Mixboard / Modern Banking Palette */
            --primary: #2563EB;
            /* Vibrant Blue */
            --primary-dark: #1E40AF;
            --primary-light: #60A5FA;
            --accent: #F59E0B;
            /* Warm Amber for highlights */

            /* Canvas & Surface */
            --bg-canvas: #F8FAFC;
            --bg-surface: #FFFFFF;
            --bg-surface-glass: rgba(255, 255, 255, 0.85);

            /* Text & UI */
            --text-main: #0F172A;
            --text-secondary: #475569;
            --text-muted: #94A3B8;
            --border-subtle: #E2E8F0;

            /* Shadows (The 'Lift') */
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --shadow-float: 0 20px 40px -5px rgba(0, 0, 0, 0.1);

            /* Categories (Pastels) */
            --cat-macro: #EFF6FF;
            --text-macro: #1D4ED8;
            --cat-geo: #FEF2F2;
            --text-geo: #B91C1C;
            --cat-cyber: #EEF2FF;
            --text-cyber: #4338CA;
            --cat-market: #ECFDF5;
            --text-market: #047857;
            --cat-env: #FFFBEB;
            --text-env: #B45309;
            --cat-social: #FAF5FF;
            --text-social: #7E22CE;
            --cat-reg: #F3F4F6;
            --text-reg: #374151;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            /* Infinite Canvas Look - Dot Grid */
            background-color: var(--bg-canvas);
            background-image: radial-gradient(#CBD5E1 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            color: var(--text-main);
            display: flex;
            padding: 24px;
            gap: 24px;
            /* Space between dock and canvas */
        }

        /* Removed old .glass-background to expose the canvas */
        .glass-background {
            display: none;
        }

        /* ========================================
           LEFT DOCK (Floating Nav)
           ======================================== */
        .nav-rail {
            width: 76px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 12px;
            z-index: 50;
            background: var(--bg-surface);
            border-radius: 40px;
            /* Pill/Capsule Shape */
            box-shadow: var(--shadow-float);
            height: fit-content;
            align-self: center;
            /* Vertically centered */
            border: 1px solid var(--border-subtle);
        }

        .nav-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #2563EB 0%, #4F46E5 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .nav-item {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Bouncy spring */
            font-size: 22px;
            background: transparent;
        }

        .nav-item:hover {
            color: var(--primary);
            background: #EFF6FF;
            transform: scale(1.1);
        }

        .nav-item.active {
            color: white;
            background: var(--primary);
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25);
        }

        /* Navigation Group for CET1 Slide-Down */
        .cet1-nav-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            /* Allow height to grow */
            height: auto;
        }

        .cet1-nav-submenu {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;

            /* Hidden state defaults */
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-top: 0;

            /* Smooth expansion animation */
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 100%;
        }

        .cet1-nav-group:hover .cet1-nav-submenu {
            max-height: 140px;
            /* Fits 2 icons + gap */
            opacity: 1;
            margin-top: 12px;
        }

        .nav-spacer {
            flex: 1;
        }

        /* Executive Report Styles */
        /* Executive Report Styles */
        /* Executive Report Styles - RBC Redesign (Light Theme) */
        .exec-grid-container {
            display: flex;
            align-items: stretch;
            gap: 24px;
            padding: 24px 40px;
            max-width: 1600px;
            margin: 0 auto;
            font-family: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .exec-logo {
            font-size: 32px;
            font-weight: 800;
            color: #003168;
            /* RBC Navy */
            letter-spacing: -1px;
            text-shadow: none;
            /* Removed shadow for clean look */
            margin-bottom: 24px;
            padding-left: 24px;
            padding-top: 24px;
        }

        .exec-card {
            background: #FFFFFF;
            /* Pure White */
            border-radius: 16px;
            /* Slightly tighter radius */
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            /* Soft shadow */
            display: flex;
            flex-direction: column;
            border: 1px solid #E2E8F0;
            /* Subtle light border */
            transition: all 0.3s ease;
            position: relative;
            color: #334155;
            /* Slate Text */
        }

        .exec-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #F1F5F9;
            padding-bottom: 16px;
        }

        .exec-card-title {
            font-size: 20px;
            /* Larger title */
            font-weight: 700;
            color: #003168;
            /* RBC Navy */
            letter-spacing: -0.01em;
        }

        /* See all elements removed */
        .exec-see-all {
            display: none !important;
        }

        .exec-card:hover {
            box-shadow: 0 12px 32px rgba(0, 49, 104, 0.08);
            /* Navy tinted shadow */
            transform: translateY(-2px);
            border-color: #CBD5E1;
        }

        .exec-empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F8FAFC;
            border-radius: 12px;
            border: 2px dashed #CBD5E1;
            margin-top: 10px;
            min-height: 150px;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748B;
        }

        .exec-empty-state:hover {
            background: #F1F5F9;
            border-color: #94A3B8;
            color: #003168;
        }

        /* Scenario Description Editable Wrapper */
        .scenario-desc-wrapper {
            position: relative;
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .scenario-desc-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-4px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            background: rgba(0, 49, 104, 0.9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0, 49, 104, 0.25);
            z-index: 10;
        }

        .scenario-desc-edit-btn:hover {
            background: rgba(0, 49, 104, 1);
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 49, 104, 0.35);
        }

        .scenario-desc-wrapper.show-edit-btn .scenario-desc-edit-btn {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Scenario Description Edit Modal */
        .scenario-edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .scenario-edit-modal.active {
            display: flex;
        }

        .scenario-edit-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .scenario-edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #E2E8F0;
        }

        .scenario-edit-modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: #003168;
            margin: 0;
        }

        .scenario-edit-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748B;
            transition: color 0.2s;
            padding: 4px 8px;
        }

        .scenario-edit-modal-close:hover {
            color: #003168;
        }

        .scenario-edit-modal-body {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }

        .scenario-edit-textarea {
            width: 100%;
            min-height: 250px;
            padding: 16px;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            color: #334155;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .scenario-edit-textarea:focus {
            outline: none;
            border-color: #003168;
            box-shadow: 0 0 0 3px rgba(0, 49, 104, 0.1);
        }

        .scenario-edit-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid #E2E8F0;
            background: #F8FAFC;
            border-radius: 0 0 16px 16px;
        }

        .scenario-edit-btn-cancel {
            padding: 10px 20px;
            border: 1px solid #CBD5E1;
            background: white;
            color: #64748B;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-edit-btn-cancel:hover {
            background: #F1F5F9;
            border-color: #94A3B8;
        }

        .scenario-edit-btn-save {
            padding: 10px 24px;
            border: none;
            background: #003168;
            color: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-edit-btn-save:hover {
            background: #004080;
            transform: translateY(-1px);
        }

        .scenario-edit-note {
            font-size: 11px;
            color: #94A3B8;
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Executive Report Background - Light RBC Grey-Blue Gradient */
        .exec-glass-bg {
            background:
                linear-gradient(155deg, transparent 0%, transparent 60%, rgba(200, 215, 230, 0.5) 70%, rgba(220, 230, 240, 0.4) 85%, transparent 100%),
                linear-gradient(135deg, #E8EDF2 0%, #DCE3EA 30%, #D0DAE4 60%, #E4EAF0 100%) !important;
            position: relative;
        }

        #executiveReportPanel {
            position: relative !important;
            inset: auto !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
            margin: 0 !important;
            max-width: none !important;
            border-radius: 24px !important;
            padding: 24px 40px 40px 40px !important;
            overflow-y: auto !important;
        }

        /* Subtle Vignette Overlay - REMOVED */
        .exec-glass-bg::before {
            display: none !important;
        }

        /* Ensure grid content is above overlay */
        .exec-glass-bg .exec-grid-container {
            position: relative;
            z-index: 2;
        }

        .exec-glass-bg .exec-logo {
            position: relative;
            z-index: 2;
        }

        .exec-footer {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Picker Modal */
        .exec-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .exec-picker-content {
            background: white;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-xl);
            animation: modalFadeIn 0.2s ease-out;
        }

        .exec-picker-item {
            padding: 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exec-picker-item:hover {
            background: #EFF6FF;
            border-color: var(--primary);
        }

        /* ========================================
           MAIN VIEWPORT (The Canvas Window)
           ======================================== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow: hidden;
            /* No background - let the canvas show */
            background: transparent;
            box-shadow: none;
            border-radius: 0;
            margin: 0;
            padding: 0;
            position: relative;
            z-index: 10;
        }

        /* Top Header Bar */
        .header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            /* No background, just floating text */
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .header-title p {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-subtle);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* Content Panels Container */
        .content-panels {
            flex: 1;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 24px;
            overflow: hidden;
            /* Padding for shadows to breathe */
            padding-bottom: 20px;
        }

        /* ========================================
           CENTER PANEL - THE BOARD
           ======================================== */
        .center-panel {
            flex: 1;
            min-width: 0;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 32px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: floatIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .panel-header {
            padding: 24px 32px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.4);
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.01em;
        }

        /* Floating Search Pill */
        .search-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            /* Pill */
            padding: 12px 20px;
            flex: 1;
            max-width: 480px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .search-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            transform: translateY(-2px);
        }

        .search-icon {
            color: var(--text-muted);
            font-size: 18px;
        }

        .search-input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 15px;
            color: var(--text-main);
            background: transparent;
        }

        .search-input::placeholder {
            color: var(--text-light);
        }

        .search-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .drivers-area {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
        }

        .category-label {
            font-size: 12px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
            margin-top: 32px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-label::after {
            content: '';
            height: 1px;
            flex: 1;
            background: #E2E8F0;
        }

        .drivers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Driver Card - The Sticky Detail */
        .driver-card {
            background: white;
            border: 1px solid transparent;
            /* No border initially */
            border-radius: 20px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02), 0 1px 0 rgba(0, 0, 0, 0.02);
        }

        .driver-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-float);
            z-index: 10;
        }

        /* Delete button for driver cards */
        .driver-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 100;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .driver-card.show-delete .driver-delete-btn {
            display: flex;
            animation: fadeInDelete 0.3s ease forwards;
        }

        @keyframes fadeInDelete {
            to {
                opacity: 1;
            }
        }

        .driver-delete-btn:hover {
            background: rgba(185, 28, 28, 1);
            transform: scale(1.1);
        }

        .driver-card.selected {
            background: #EFF6FF;
            border: 2px solid var(--primary);
            box-shadow: var(--shadow-md);
        }

        .driver-tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .driver-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .driver-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Driver Sources */
        .driver-sources {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .sources-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sources-label::before {
            content: 'ðŸ“°';
            font-size: 11px;
        }

        .source-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .source-item {
            font-size: 11px;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: start;
            gap: 6px;
            transition: all 0.2s ease;
            padding: 2px 0;
        }

        .source-item:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .source-item::before {
            content: 'â†’';
            flex-shrink: 0;
            opacity: 0.5;
        }

        .source-item-text {
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* ========================================
           RIGHT PANEL - THE BASKET
           ======================================== */
        .right-panel {
            width: 360px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 32px;
            box-shadow: var(--shadow-float);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: floatIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.1s backwards;
        }

        .basket-header {
            padding: 24px 28px;
            background: transparent;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .basket-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .basket-list {
            flex: 1;
            /* Fill remaining space */
            padding: 20px;
            gap: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .basket-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-muted);
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .basket-empty-icon {
            font-size: 56px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .basket-empty p {
            font-size: 14px;
            line-height: 1.6;
            max-width: 220px;
            font-weight: 500;
        }

        .basket-item {
            background: white;
            border: 1px solid transparent;
            border-radius: 16px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .basket-item:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .basket-item-info {
            gap: 16px;
        }

        .basket-item-title {
            font-size: 14px;
            font-weight: 600;
        }

        .generate-btn {
            width: 85%;
            /* Smaller width */
            display: block;
            margin: 0 auto;
            /* Centered */
            background: linear-gradient(135deg, var(--primary) 0%, #4F46E5 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 100px;
            /* Pill shape */
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .basket-footer {
            padding: 24px 28px 36px 28px;
            /* Increased bottom padding to 36px */
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.4);
        }

        .generate-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }

        .generate-btn:disabled {
            background: #CBD5E1;
            color: #94A3B8;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        /* ========================================
           MODAL STYLES
           ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: white;
            width: 600px;
            max-width: 90%;
            border-radius: 24px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        /* ========================================
           MODAL STYLES (Mixboard Dialogs)
           ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.25);
            /* Lighter, cleaner overlay */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            /* Limit height to 90% of viewport */
            border-radius: 32px;
            /* Deep rounded corners */
            box-shadow: var(--shadow-float);
            overflow-y: auto;
            /* Make content scrollable */
            animation: modalSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            /* Ensure header stays at top */
        }

        @keyframes modalSlide {
            from {
                transform: translateY(40px) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            /* Keep header visible when scrolling */
            top: 0;
            background: rgba(255, 255, 255, 0.98);
            /* Ensure header has solid background */
            z-index: 10;
            backdrop-filter: blur(8px);
            flex-shrink: 0;
            /* Prevent header from shrinking */
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-main);
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
            background: white;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #F1F5F9;
            color: var(--text-main);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 32px;
            flex: 1;
            /* Allow body to grow and scroll */
            overflow-y: auto;
            /* Make body scrollable if content is too long */
        }

        .modal-tag {
            display: inline-flex;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-desc {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Chat Container */
        .chat-container {
            margin-top: 28px;
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            overflow: hidden;
            background: #F8FAFC;
        }

        .chat-history {
            height: 240px;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: var(--shadow-sm);
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.ai {
            align-self: flex-start;
            background: white;
            color: var(--text-main);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-bottom-left-radius: 4px;
        }

        .chat-input-area {
            padding: 16px;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            padding: 12px 20px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .chat-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .chat-send:hover {
            transform: scale(1.1) rotate(-10deg);
            background: var(--primary-dark);
        }

        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: flex-end;
            background: #F8FAFC;
        }

        .modal-action-btn {
            padding: 14px 32px;
            border-radius: 100px;
            /* Pill */
            border: none;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        /* HEADER & UTILITY CONTROLS (Mixboard Style) */
        .pill-select {
            appearance: none;
            padding: 10px 32px 10px 16px;
            font-size: 13px;
            border-radius: 100px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-surface) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748B' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") no-repeat right 12px center;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            color: var(--text-main);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            outline: none;
        }

        .pill-select:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
            background: var(--bg-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-sm);
            color: var(--text-secondary);
        }

        .icon-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: var(--shadow-md);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .icon-btn.primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .icon-btn.primary:hover {
            background: var(--primary-dark);
        }

        .header-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Loader Overlay match */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #E2E8F0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            margin-top: 20px;
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ========================================
           REPORT OVERLAY
           ======================================== */
        .report-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            display: none;
            justify-content: center;
            align-items: flex-start;
            z-index: 150;
            overflow-y: auto;
            padding: 40px 20px;
            backdrop-filter: blur(8px);
        }

        .report-container {
            background: white;
            width: 1200px;
            /* Increased width for side-by-side layout */
            max-width: 95%;
            height: 90vh;
            /* Fixed height for layout */
            border-radius: 24px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .report-content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .report-main {
            flex: 2;
            overflow-y: auto;
            border-right: 1px solid #E2E8F0;
            display: flex;
            flex-direction: column;
        }

        .report-sidebar {
            flex: 1;
            background: #F8FAFC;
            display: flex;
            flex-direction: column;
            min-width: 350px;
            max-width: 400px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            border-left: 1px solid #E2E8F0;
        }

        .report-sidebar.collapsed {
            min-width: 60px;
            max-width: 60px;
        }

        .report-sidebar.collapsed .report-chat-history,
        .report-sidebar.collapsed .report-chat-input-area,
        .report-sidebar.collapsed .report-chat-header span {
            display: none;
        }

        .report-sidebar.collapsed .report-chat-header {
            justify-content: center;
            padding: 20px 0;
        }

        .report-chat-header {
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
            background: white;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            white-space: nowrap;
        }

        .sidebar-toggle-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .sidebar-toggle-btn:hover {
            background: #F1F5F9;
            color: var(--primary);
        }

        .report-sidebar.collapsed .sidebar-toggle-btn {
            transform: rotate(180deg);
        }

        .report-chat-history {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .report-chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #E2E8F0;
            display: flex;
            gap: 10px;
        }

        .report-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 36px;
        }

        .report-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .report-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .report-body {
            padding: 36px;
        }

        .report-section {
            margin-bottom: 32px;
        }

        .report-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 2px;
        }

        .section-content {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 16px;
            padding: 24px;
            line-height: 1.8;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .drivers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .driver-pill {
            padding: 8px 14px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .macro-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .macro-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        .macro-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .macro-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-main);
        }

        .macro-value.negative {
            color: #DC2626;
        }

        .macro-value.positive {
            color: #059669;
        }

        .macro-delta {
            font-size: 11px;
            margin-top: 6px;
            color: var(--text-muted);
        }

        .report-footer {
            padding: 24px 36px;
            background: #F8FAFC;
            border-top: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-disclaimer {
            font-size: 12px;
            color: var(--text-muted);
        }

        .report-actions {
            display: flex;
            gap: 12px;
        }

        .btn-secondary {
            background: white;
            border: 1px solid #E2E8F0;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #F1F5F9;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.12);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* ========================================
           HEAT MAP STYLES
           ======================================== */
        .heatmap-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            /* Horizontal layout */
            gap: 24px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            align-items: flex-start;
            /* Align top */
        }

        .heatmap-wrapper {
            flex: 1;
            display: flex;
            position: relative;
            min-height: 600px;
            flex-direction: row;
            /* Horizontal layout for Axes + Grid */
        }

        /* Update Legend to be a sidebar */
        .heatmap-legend {
            position: relative;
            /* Not absolute anymore */
            top: auto;
            right: auto;
            width: 240px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: none;
            border: 1px solid var(--border-subtle);
            z-index: 10;
        }

        .heatmap-y-axis {
            width: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px 0;
            position: relative;
        }

        .heatmap-y-label {
            /* writing-mode removed for better html2canvas support */
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            white-space: nowrap;
            width: max-content;
        }

        .heatmap-y-markers {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding-right: 8px;
            text-align: right;
            min-width: 50px;
        }

        .heatmap-y-marker {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            text-align: right;
        }

        .heatmap-grid-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .heatmap-grid {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg,
                    rgba(16, 185, 129, 0.03) 0%,
                    rgba(245, 158, 11, 0.05) 50%,
                    rgba(239, 68, 68, 0.08) 100%);
            border: 2px solid var(--border-subtle);
            border-radius: 16px;
            overflow: visible;
            min-height: 500px;
            /* Add padding to prevent drivers from going behind legend */
            padding: 20px 220px 20px 20px;
        }

        /* Gradient zones overlay */
        .heatmap-grid::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                linear-gradient(to right, rgba(16, 185, 129, 0.1) 0%, transparent 40%),
                linear-gradient(to top, rgba(16, 185, 129, 0.1) 0%, transparent 40%),
                linear-gradient(to left, rgba(239, 68, 68, 0.1) 0%, transparent 40%),
                linear-gradient(to bottom, rgba(239, 68, 68, 0.1) 0%, transparent 40%);
            pointer-events: none;
            border-radius: 14px;
        }

        /* Grid lines */
        .heatmap-grid::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(to right, rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
            background-size: 10% 10%;
            pointer-events: none;
            border-radius: 14px;
        }

        .heatmap-x-axis {
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 12px;
        }

        .heatmap-x-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }

        .heatmap-x-markers {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 10px;
            margin-bottom: 8px;
        }

        .heatmap-x-marker {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Heat Map Driver Card */
        .heatmap-driver {
            position: absolute;
            /* Card expands FROM the velocity circle which is the anchor */
            display: flex;
            flex-direction: column;
            width: 180px;
            padding: 10px 12px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            cursor: grab;
            transition: all 0.25s ease, width 0.25s ease, opacity 0.15s ease;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            overflow: visible;
            /* Default: expand down-right from top-left anchor */
            transform-origin: top left;
        }

        /* Compact view: Reset card styling to transparent */
        .heatmap-driver.compact-mode {
            background: transparent;
            backdrop-filter: none;
            border: none;
            box-shadow: none;
            padding: 0;
            width: auto;
        }

        /* Minimal view: Just the circle */
        .heatmap-driver.minimal-mode {
            background: transparent;
            backdrop-filter: none;
            border: none;
            box-shadow: none;
            padding: 0;
            width: auto;
        }

        /* Compact view: Show details on hover */
        .heatmap-driver.compact-mode:hover .compact-expand {
            display: block !important;
        }


        .heatmap-driver.compact-mode:hover .compact-pill {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        /* Minimal view: Show details on hover */
        .heatmap-driver.minimal-mode:hover .minimal-expand {
            display: block !important;
        }

        /* Velocity circle is the anchor - positioned at card's coordinates */
        .heatmap-driver-anchor {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .heatmap-driver-anchor.high {
            background: #EF4444;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
        }

        .heatmap-driver-anchor.medium {
            background: #F59E0B;
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
        }

        .heatmap-driver-anchor.low {
            background: #10B981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
        }

        .heatmap-driver-anchor svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        /* Card body - everything except the anchor circle */
        .heatmap-driver-body {
            transition: opacity 0.2s ease, max-height 0.25s ease;
        }

        /* DRAGGING STATE: Collapse to just the circle */
        .heatmap-driver.dragging {
            width: 24px !important;
            height: 24px !important;
            padding: 0 !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            z-index: 2000;
            cursor: grabbing;
        }

        .heatmap-driver.dragging .heatmap-driver-body {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .heatmap-driver.dragging .heatmap-driver-anchor {
            top: 0;
            left: 0;
            transform: scale(1.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
            cursor: grabbing;
        }

        /* Focus Mode: Dim other cards when one is hovered to resolve overlaps visually */
        .heatmap-grid:has(.heatmap-driver:hover) .heatmap-driver:not(:hover) {
            opacity: 0.2;
            filter: blur(1px);
            z-index: 1;
            /* Push to back */
        }

        /* HOVER STATE: Expand to show details */
        .heatmap-driver:not(.dragging):hover {
            z-index: 1000;
            width: 260px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
            border-color: rgba(59, 130, 246, 0.5);
            /* Ensure opacity stays 1 */
            opacity: 1 !important;
            filter: none !important;
        }

        /* Override for Minimal and Compact modes to prevent width jump */
        .heatmap-driver.minimal-mode:hover,
        .heatmap-driver.compact-mode:hover {
            width: auto !important;
            box-shadow: none !important;
            border: none !important;
            background: transparent !important;
        }


        /* Expansion content - hidden by default */
        .heatmap-driver-expand {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.25s ease, opacity 0.2s ease, margin 0.2s ease;
            margin-top: 0;
        }

        .heatmap-driver:not(.dragging):hover .heatmap-driver-expand {
            max-height: 150px;
            opacity: 1;
            margin-top: 8px;
        }

        /* Also expand when .expanded class is applied (from driver list hover) */
        .heatmap-driver.expanded {
            z-index: 1000;
            width: 260px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
            border-color: rgba(59, 130, 246, 0.5);
            opacity: 1 !important;
            filter: none !important;
        }

        .heatmap-driver.expanded .heatmap-driver-expand {
            max-height: 150px;
            opacity: 1;
            margin-top: 8px;
        }


        .heatmap-driver-expand-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .heatmap-driver-expand-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .heatmap-driver-expand-meta strong {
            color: white;
            margin-left: 2px;
        }

        /* 4-WAY SMART EXPANSION AND ANCHORING */
        .heatmap-driver {
            transform-origin: center;
            /* Let translate handle positioning */
        }

        /* RIGHT EDGE: Expand Left */
        .heatmap-driver.expand-left {
            transform: translateX(-100%);
        }

        .heatmap-driver.expand-left .heatmap-driver-anchor {
            left: auto;
            right: -10px;
        }

        /* BOTTOM EDGE: Expand Up */
        .heatmap-driver.expand-up {
            transform: translateY(-100%);
        }

        .heatmap-driver.expand-up .heatmap-driver-anchor {
            top: auto;
            bottom: -10px;
        }

        /* BOTTOM-RIGHT CORNER: Expand Up-Left */
        .heatmap-driver.expand-left.expand-up {
            transform: translate(-100%, -100%);
        }

        .heatmap-driver.expand-left.expand-up .heatmap-driver-anchor {
            top: auto;
            bottom: -10px;
            left: auto;
            right: -10px;
        }

        .heatmap-driver-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .heatmap-driver-title {
            font-size: 12px;
            font-weight: 700;
            color: white;
            line-height: 1.3;
            flex: 1;
        }

        .heatmap-driver-velocity {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .heatmap-driver-velocity.high {
            background: #EF4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }

        .heatmap-driver-velocity.medium {
            background: #F59E0B;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
        }

        .heatmap-driver-velocity.low {
            background: #10B981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }

        .heatmap-driver-velocity svg {
            width: 12px;
            height: 12px;
            fill: white;
        }

        .heatmap-driver-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .heatmap-driver-percentage {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 6px;
        }

        .heatmap-velocity-bar {
            height: 4px;
            border-radius: 2px;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .heatmap-velocity-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .heatmap-velocity-bar-fill.high {
            background: linear-gradient(90deg, #EF4444, #F87171);
        }

        .heatmap-velocity-bar-fill.medium {
            background: linear-gradient(90deg, #F59E0B, #FBBF24);
        }

        .heatmap-velocity-bar-fill.low {
            background: linear-gradient(90deg, #10B981, #34D399);
        }

        /* Global Heatmap Tooltip */
        #globalHeatmapTooltip {
            display: none;
            position: fixed;
            z-index: 10000;
            width: 280px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            /* Let mouse pass through so it doesn't flicker */
            opacity: 0;
            transition: opacity 0.15s ease;
            backdrop-filter: blur(10px);
        }

        #globalHeatmapTooltip .tooltip-title {
            font-size: 14px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        #globalHeatmapTooltip .tooltip-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        #globalHeatmapTooltip .tooltip-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Clickable velocity indicator */
        .heatmap-driver-velocity {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .heatmap-driver-velocity:hover {
            transform: scale(1.2);
        }




        .heatmap-driver-tooltip-title {
            font-size: 14px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .heatmap-driver-tooltip-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .heatmap-driver-tooltip-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 11px;
        }

        .heatmap-driver-tooltip-meta span {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Heat Map Legend */
        /* Heat Map Legend - REPLACED BY SIDEBAR STYLES ABOVE */
        /* .heatmap-legend styles removed from here to avoid duplication */

        .heatmap-legend-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .heatmap-legend-section {
            margin-bottom: 14px;
        }

        .heatmap-legend-section:last-child {
            margin-bottom: 0;
        }

        .heatmap-legend-subtitle {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .heatmap-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .heatmap-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .heatmap-legend-velocity {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Heat Map Basket Panel */
        .heatmap-basket {
            display: flex;
            flex-direction: column;
        }

        .heatmap-basket-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .heatmap-btn {
            width: 100%;
            padding: 14px 20px;
            border-radius: 100px;
            border: none;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .heatmap-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
        }

        .heatmap-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .heatmap-btn-secondary {
            background: white;
            color: var(--text-main);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-sm);
        }

        .heatmap-btn-secondary:hover {
            background: #F8FAFC;
            border-color: var(--primary-light);
        }

        /* Generate Heat Map button style */
        /* Generate Heat Map button style - Matching generate-btn but with Heat colors */
        .generate-heatmap-btn {
            width: 85%;
            display: block;
            margin: 0 auto;
            padding: 14px 24px;
            border-radius: 100px;
            border: none;
            background: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .generate-heatmap-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .generate-heatmap-btn:disabled {
            background: #CBD5E1;
            color: #94A3B8;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        /* Help toggle button */
        .help-toggle-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
            background: white;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .help-toggle-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Help panel */
        .heatmap-help-panel {
            background: #F0F7FF;
            border-bottom: 1px solid var(--border-subtle);
            padding: 14px 16px;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .heatmap-help-content {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .heatmap-help-content p {
            margin-bottom: 6px;
        }

        .heatmap-help-content p:last-child {
            margin-bottom: 0;
        }

        .heatmap-help-content strong {
            color: var(--text-main);
        }

        /* Heatmap Tool Buttons Animation */
        .tools-row {
            display: flex;
            align-items: center;
            gap: 4px;
            width: 100%;
            margin-bottom: 20px;
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .tool-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 4px;
            background: transparent;
            border: none;
            border-radius: 100px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            min-width: 0;
            box-shadow: none;
        }

        .tool-btn:hover {
            flex: 2;
            background: #F1F5F9;
            color: var(--primary);
            box-shadow: none;
            transform: none;
        }

        .tool-text {
            display: flex;
            align-items: center;
        }

        .tool-extra {
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: inline-block;
            white-space: nowrap;
        }

        .tool-btn:hover .tool-extra {
            max-width: 120px;
            opacity: 1;
            margin-left: 4px;
        }

        /* View Mode Selector Styles */
        .view-mode-group {
            display: flex;
            align-items: center;
            gap: 4px;
            width: 100%;
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            margin-top: 8px;
        }

        .view-mode-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 4px;
            background: transparent;
            border: none;
            border-radius: 100px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-mode-btn:hover {
            background: #F1F5F9;
            color: var(--primary);
        }

        .view-mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.2);
        }

        .view-mode-btn.active:hover {
            background: var(--primary);
            color: white;
        }

        .heatmap-legend-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .heatmap-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .heatmap-legend-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .heatmap-legend-item.legend-dimmed {
            opacity: 0.3;
        }

        .heatmap-legend-velocity {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* ========================================
           CET1 CAPITAL ANALYSIS STYLES (from Astra)
           ======================================== */

        /* --- Astra Side Panels --- */
        .astra-side-panel {
            position: fixed;
            left: 110px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            max-height: 80vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            box-shadow: var(--shadow-float);
            z-index: 45;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideInAstra 0.3s ease-out;
        }

        .astra-side-panel.open {
            display: flex;
        }

        @keyframes slideInAstra {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        .astra-side-panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #F8FAFC;
        }

        .astra-side-panel-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
        }

        .astra-side-panel-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .astra-side-panel-close:hover {
            background: #F1F5F9;
            color: var(--text-main);
        }

        .astra-side-panel-body {
            padding: 20px 24px;
            overflow-y: auto;
            flex: 1;
        }

        /* --- Metric Cards --- */
        .cet1-metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 16px;
        }

        .cet1-metric-card {
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .cet1-metric-card:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .cet1-metric-card.selected {
            background: #EFF6FF;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .cet1-metric-card.selected .metric-label {
            color: var(--primary-dark);
        }

        .cet1-metric-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .cet1-metric-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        /* --- Temperature Bar --- */
        .cet1-temperature-bar-container {
            height: 12px;
            background: linear-gradient(to right,
                    #EF4444 0%,
                    #F59E0B 30%,
                    #10B981 60%,
                    #3B82F6 100%);
            border-radius: 6px;
            margin: 70px 10px 40px 10px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .cet1-temp-bar-labels {
            display: flex;
            justify-content: space-between;
            margin: 0 -10px;
            padding: 0 10px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .cet1-temp-bar-marker {
            position: absolute;
            width: 4px;
            height: 24px;
            top: -6px;
            background: white;
            border: 2px solid white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s, z-index 0.2s;
            z-index: 10;
        }

        .cet1-temp-bar-marker:hover {
            transform: scale(1.2) translateY(-2px);
            z-index: 20;
        }

        .cet1-temp-bar-marker::after {
            content: attr(data-label);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            color: white;
            background: inherit;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 1;
            visibility: visible;
            transition: all 0.2s;
        }

        .cet1-temp-bar-marker[data-stagger="0"]::after {
            bottom: 24px;
        }

        .cet1-temp-bar-marker[data-stagger="1"]::after {
            top: 24px;
        }

        .cet1-temp-bar-marker[data-stagger="2"]::after {
            bottom: 50px;
            z-index: 25;
        }

        .cet1-temp-bar-marker.edge-left::after {
            left: 0;
            transform: translateX(0);
        }

        .cet1-temp-bar-marker.edge-right::after {
            left: auto;
            right: 0;
            transform: translateX(0);
        }

        /* --- View Toggle Tabs --- */
        .cet1-view-tabs {
            display: inline-flex;
            background: #F1F5F9;
            padding: 4px;
            border-radius: 12px;
            gap: 2px;
        }

        .cet1-view-tab {
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            border: none;
            background: transparent;
            cursor: pointer;
        }

        .cet1-view-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* --- CET1 Card Styles --- */
        .cet1-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-subtle);
            overflow: visible;
        }

        .cet1-chart-container {
            width: 100%;
            height: 500px;
            overflow: visible !important;
        }

        .cet1-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: none;
            padding-bottom: 0;
        }

        .cet1-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
        }

        /* --- CET1 Table Styling --- */
        .cet1-table-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            background: white;
            max-height: 500px;
            overflow-y: auto;
        }

        .cet1-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1000px;
        }

        .cet1-table th,
        .cet1-table td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid var(--border-subtle);
            white-space: nowrap;
        }

        .cet1-table thead th {
            position: sticky;
            top: 0;
            background: #F8FAFC;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            z-index: 10;
            box-shadow: 0 1px 0 var(--border-subtle);
        }

        .cet1-table th:first-child,
        .cet1-table td:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            text-align: left;
            font-weight: 600;
            color: var(--text-main);
            border-right: 1px solid var(--border-subtle);
            width: 200px;
            min-width: 200px;
        }

        .cet1-table thead th:first-child {
            z-index: 15;
            background: #F8FAFC;
        }

        .cet1-table tr:hover td {
            background: #F1F5F9;
        }

        .cet1-table tr:hover td:first-child {
            background: #F1F5F9;
        }

        .cet1-table .positive {
            color: #10B981;
        }

        .cet1-table .negative {
            color: #EF4444;
        }

        /* --- Component Override Modal --- */
        .cet1-override-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .cet1-override-modal.open {
            display: flex;
        }

        .cet1-override-modal-content {
            background: white;
            width: 900px;
            max-width: 95%;
            max-height: 85vh;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: cet1FloatIn 0.3s ease-out;
        }

        @keyframes cet1FloatIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .cet1-override-modal-header {
            padding: 20px 24px;
            background: #F8FAFC;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cet1-override-modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
        }

        .cet1-override-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .cet1-override-chart-container {
            height: 200px;
            margin-bottom: 20px;
            background: #F8FAFC;
            border-radius: 12px;
            padding: 12px;
        }

        .cet1-override-table-container {
            overflow-x: auto;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
        }

        .cet1-override-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .cet1-override-table th,
        .cet1-override-table td {
            padding: 10px 12px;
            text-align: center;
            border-bottom: 1px solid var(--border-subtle);
            min-width: 60px;
        }

        .cet1-override-table th {
            background: #F8FAFC;
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }

        .cet1-override-table input {
            width: 60px;
            padding: 6px 8px;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .cet1-override-table input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .cet1-override-table input.modified {
            background: #FEF3C7;
            border-color: #F59E0B;
        }

        .cet1-override-modal-footer {
            padding: 16px 24px;
            background: #F8FAFC;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .cet1-override-info {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #EFF6FF;
            border-radius: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .cet1-override-info strong {
            color: var(--text-main);
        }

        /* --- Component Override List --- */
        .cet1-component-override-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .cet1-component-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #F8FAFC;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cet1-component-item:hover {
            background: #EFF6FF;
            border-color: var(--primary);
        }

        .cet1-component-item.has-override {
            background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%);
            border-color: var(--primary);
        }

        .cet1-component-item .comp-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-main);
        }

        .cet1-component-item .comp-status {
            font-size: 11px;
            color: var(--text-muted);
        }

        .cet1-component-item.has-override .comp-status {
            color: var(--primary);
            font-weight: 600;
        }

        /* --- CET1 View Content Toggle --- */
        .cet1-view-content {
            display: none;
        }

        .cet1-view-content.active {
            display: block;
            animation: cet1FloatIn 0.3s;
        }

        /* --- Astra Button Styles --- */
        .astra-btn {
            border: none;
            border-radius: 100px;
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .astra-btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .astra-btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .astra-btn-secondary {
            background: white;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .astra-btn-secondary:hover {
            background: #F1F5F9;
            color: var(--text-main);
        }

        /* --- Severity Badges --- */
        .cet1-severity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .cet1-severity-badge.severity-very_severe,
        .cet1-severity-badge.severity-very-severe {
            background: #FEF2F2;
            color: #991B1B;
        }

        .cet1-severity-badge.severity-severe {
            background: #FFF7ED;
            color: #9A3412;
        }

        .cet1-severity-badge.severity-moderate {
            background: #EFF6FF;
            color: #1E40AF;
        }

        .cet1-severity-badge.severity-benchmark {
            background: #ECFDF5;
            color: #065F46;
        }

        /* --- Severity List Grid --- */
        .cet1-severity-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .cet1-severity-item {
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.2s;
            position: relative;
        }

        .cet1-severity-item:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
            z-index: 10;
        }

        .cet1-severity-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cet1-severity-label {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-main);
            line-height: 1.3;
        }

        .cet1-severity-select {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background-color: white;
            width: 100%;
            cursor: pointer;
        }

        /* --- AI Input Modal Styles --- */
        .cet1-ai-modal .modal-content {
            width: 1200px;
            max-width: 95vw;
        }

        .cet1-split-panel-left {
            flex: 1.3;
            background: #F8FAFC;
            border-right: 1px solid var(--border-subtle);
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .cet1-split-panel-right {
            flex: 0.8;
            display: flex;
            flex-direction: column;
            background: white;
            min-width: 350px;
        }

        .cet1-chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .cet1-chat-message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            max-width: 80%;
        }

        .cet1-chat-message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .cet1-chat-bubble {
            padding: 12px 16px;
            border-radius: 16px 16px 16px 4px;
            font-size: 14px;
            line-height: 1.5;
            background: #F1F5F9;
            color: var(--text-main);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .cet1-chat-bubble ol,
        .cet1-chat-bubble ul {
            padding-left: 24px;
            margin: 8px 0;
        }

        .cet1-chat-message.user .cet1-chat-bubble {
            background: var(--primary);
            color: white;
            border-radius: 16px 16px 4px 16px;
        }

        /* Custom Scenario Builder Styling - Ported from Astra.html */
        .scenario-result {
            background: #F8FAFC;
            border-radius: 16px;
            padding: 20px;
            margin-top: 16px;
            border: 1px solid var(--border-subtle);
            max-height: 750px;
            overflow-y: auto;
        }

        /* Form Control Styling for Chat Input */
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-main);
            background-color: var(--bg-surface);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            outline: 0;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .severity-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .severity-item {
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.2s;
            position: relative;
        }

        .severity-item:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
            z-index: 10;
        }

        .severity-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .severity-label {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-main);
            line-height: 1.3;
        }

        .severity-select {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background-color: white;
            width: 100%;
            cursor: pointer;
        }

        /* Tooltip-style reasoning - hidden by default, shown on hover */
        .severity-reasoning {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 11px;
            line-height: 1.4;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
            margin-bottom: 8px;
        }

        .severity-reasoning::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(15, 23, 42, 0.95);
        }

        .severity-item:hover .severity-reasoning {
            display: block;
        }

        .severity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .severity-badge.severity-very_severe,
        .severity-badge.severity-very-severe {
            background: #FEF2F2;
            color: #991B1B;
        }

        .severity-badge.severity-severe {
            background: #FFFBEB;
            color: #B45309;
        }

        .severity-badge.severity-moderate {
            background: #EFF6FF;
            color: #1D4ED8;
        }

        .severity-badge.severity-benchmark {
            background: #ECFDF5;
            color: #047857;
        }
    </style>
</head>

<body>
    <!-- Full-width Glass Background -->
    <div class="glass-background"></div>

    <!-- LEFT NAVIGATION RAIL -->
    <nav class="nav-rail">
        <div class="nav-logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
        </div>

        <div class="nav-item" title="Risk Drivers" onclick="showMarketplace()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
        </div>
        <div class="nav-item" title="Playground" onclick="showPlayground()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                </path>
            </svg>
        </div>

        <div class="nav-item" title="Heat Map" onclick="showHeatMap()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 20V10M12 20V4M6 20V14"></path>
            </svg>
        </div>

        <!-- CET1 Capital Analysis Group -->
        <div class="cet1-nav-group">
            <div class="nav-item" title="CET1 Capital Analysis" onclick="showCET1Analysis()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
            </div>

            <!-- Submenu items (Vertical Expand) -->
            <div class="cet1-nav-submenu">
                <div class="nav-item" id="navScenarioBuilder" title="Scenario Builder"
                    onclick="toggleAstraPanel('scenarioBuilderPanel')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </div>

                <div class="nav-item" id="navOverlayControls" title="Component Overrides"
                    onclick="toggleAstraPanel('overlayControlsPanel')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="4" y1="21" x2="4" y2="14"></line>
                        <line x1="4" y1="10" x2="4" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12" y2="3"></line>
                        <line x1="20" y1="21" x2="20" y2="16"></line>
                        <line x1="20" y1="12" x2="20" y2="3"></line>
                        <line x1="1" y1="14" x2="7" y2="14"></line>
                        <line x1="9" y1="8" x2="15" y2="8"></line>
                        <line x1="17" y1="16" x2="23" y2="16"></line>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Executive Report -->
        <div class="nav-item" title="Executive Report" onclick="showExecutiveReport()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
        </div>

        <div class="nav-item" title="Folder" onclick="showSavedScenarios()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
        </div>


        <div class="nav-item" title="Settings" onclick="showSettingsModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </svg>
        </div>

        <div class="nav-spacer"></div>
    </nav>

    <!-- MAIN CONTENT AREA -->
    <main class="main-area">

        <!-- Header Bar -->
        <header class="header-bar">
            <div class="header-title">
                <h1>ASTRA Studio</h1>
                <p>Scenario and Narrative Platform 1/15</p>
            </div>
            <div class="header-status" style="display: flex; align-items: center; gap: 12px;">
                <!-- Dossier Selector Only -->
                <div class="header-toolbar">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label
                            style="font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Dossier</label>
                        <select id="dossierSelector" onchange="loadSelectedDossier()" class="pill-select">
                            <option value="current">Current (Live)</option>
                        </select>
                    </div>
                </div>
                <div class="status-badge">
                    <span class="status-dot"></span>
                    <span id="connectionStatusText">Connected to Azure OpenAI</span>
                </div>
            </div>
        </header>

        <!-- Content Panels -->
        <div class="content-panels">

            <!-- CENTER: Driver Marketplace -->
            <section class="center-panel" id="marketplacePanel">
                <div class="panel-header">
                    <span class="panel-title">Risk Driver Marketplace</span>
                    <div class="search-container">
                        <span class="search-icon">ðŸ”</span>
                        <input type="text" id="aiInput" class="search-input" placeholder="Search drivers or ask AI..."
                            onkeypress="handleEnter(event)" oninput="filterDrivers(this.value)">
                        <button class="search-btn" onclick="createCustomDriver()">Search & Add</button>
                    </div>
                </div>
                <div class="drivers-area" id="driversContainer">
                    <!-- Drivers populate here -->
                </div>
            </section>

            <!-- CENTER: Playground View -->
            <section class="center-panel" id="playgroundPanel"
                style="display: none; background: #fafafa; flex-direction: column; position: relative;">
                <!-- Header -->
                <div class="panel-header">
                    <span class="panel-title">Playground</span>
                </div>

                <!-- Canvas Area -->
                <div id="playgroundCanvas"
                    style="flex: 1; overflow-y: auto; padding: 40px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px;">
                    <!-- Empty State -->
                    <div id="playgroundPlaceholder"
                        style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; text-align: center; opacity: 0.6;">
                        <div style="font-size: 48px; margin-bottom: 20px;">âœ¨</div>
                        <h2 style="font-size: 24px; color: #1f2937; margin-bottom: 12px; font-weight: 600;">Explore your
                            ideas</h2>
                        <p style="color: #6b7280; max-width: 400px; line-height: 1.5;">
                            Describe a risk scenario or upload a document to brainstorm creative risk drivers not
                            typically captured by the news.
                        </p>
                    </div>
                </div>

                <!-- Chat Bottom Bar -->
                <div
                    style="padding: 24px; background: white; border-top: 1px solid #e5e7eb; position: sticky; bottom: 0; z-index: 10;">
                    <div style="max-width: 800px; margin: 0 auto; position: relative;">
                        <!-- Hidden File Input -->
                        <input type="file" id="playgroundFileUpload" style="display: none;"
                            accept=".txt,.md,.csv,.json,.xml,.html,.pdf" onchange="handlePlaygroundFile(this)">

                        <!-- Plus Button (File Upload) -->
                        <button onclick="document.getElementById('playgroundFileUpload').click()" title="Upload File"
                            style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); background: white; color: #64748B; border: 1px solid #E2E8F0; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 2;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>

                        <!-- News Button -->
                        <button onclick="openNewsModal()" title="Scan News"
                            style="position: absolute; left: 56px; top: 50%; transform: translateY(-50%); background: white; color: #64748B; border: 1px solid #E2E8F0; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 2;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path
                                    d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2">
                                </path>
                                <path d="M18 14h-8"></path>
                                <path d="M15 18h-5"></path>
                                <path d="M10 6h8v4h-8V6Z"></path>
                            </svg>
                        </button>

                        <input type="text" id="playgroundChatInput"
                            style="width: 100%; padding: 16px 60px 16px 108px; border-radius: 99px; border: 1px solid #e2e8f0; font-size: 16px; outline: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.2s;"
                            placeholder="Describe your idea or refining request..."
                            onkeypress="handlePlaygroundEnter(event)">

                        <button onclick="submitPlaygroundChat()" id="playgroundSendBtn"
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #2563EB; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                    <div id="playgroundLoader"
                        style="display: none; justify-content: center; margin-top: 12px; color: #6b7280; font-size: 14px; align-items: center; gap: 8px;">
                        <span class="spinner"
                            style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite;"></span>
                        AI is brainstorming...
                    </div>
                </div>
            </section>

            <!-- CENTER: Saved Scenarios View (Hidden by default) -->
            <section class="center-panel" id="savedScenariosPanel" style="display: none;">
                <div class="panel-header">
                    <span class="panel-title">Folder</span>
                </div>
                <div class="drivers-area">
                    <div class="drivers-grid" id="savedScenariosGrid">
                        <!-- Saved scenarios populate here -->
                    </div>
                </div>
            </section>

            <!-- CENTER: Heat Map View (Hidden by default) -->
            <section class="center-panel" id="heatMapPanel"
                style="display: none; height: calc(100vh - 130px); overflow-y: auto;">
                <div class="panel-header">
                    <span class="panel-title">Risk Heat Map</span>
                    <div class="heatmap-instructions" style="font-size: 12px; color: var(--text-muted);">
                        Drag drivers to adjust their likelihood and materiality
                    </div>
                </div>
                <div class="heatmap-container">
                    <div class="heatmap-wrapper">
                        <!-- Global Heatmap Tooltip -->
                        <div id="globalHeatmapTooltip">
                            <div class="tooltip-title"></div>
                            <div class="tooltip-desc"></div>
                            <div class="tooltip-meta"></div>
                        </div>

                        <!-- Modals -->
                        <!-- Y-Axis -->
                        <div class="heatmap-y-axis">
                            <div class="heatmap-y-label">Impact to RBC</div>
                            <div class="heatmap-y-markers">
                                <span class="heatmap-y-marker">High</span>
                                <span class="heatmap-y-marker"></span>
                                <span class="heatmap-y-marker">Medium</span>
                                <span class="heatmap-y-marker"></span>
                                <span class="heatmap-y-marker">Low</span>
                            </div>
                        </div>
                        <!-- Grid Area -->
                        <div class="heatmap-grid-area">
                            <div class="heatmap-grid" id="heatmapGrid">
                                <!-- Drivers will be positioned here -->
                            </div>
                            <!-- X-Axis -->
                            <div class="heatmap-x-axis">
                                <div class="heatmap-x-markers">
                                    <span class="heatmap-x-marker">Low</span>
                                    <span class="heatmap-x-marker"></span>
                                    <span class="heatmap-x-marker">Medium</span>
                                    <span class="heatmap-x-marker"></span>
                                    <span class="heatmap-x-marker">High</span>
                                </div>
                                <span class="heatmap-x-label">Likelihood of Risk Materializing with Adverse Outcome to
                                    RBC</span>
                            </div>
                            <!-- Footnote -->
                            <div
                                style="text-align: center; font-size: 10px; color: var(--text-muted); margin-top: 12px; font-style: italic; opacity: 0.7;">
                                Velocity refers to the time elapsed between the materialization of a risk event and the
                                point of RC's impact.
                            </div>
                        </div>
                    </div>
                    <!-- Legend -->
                    <div class="heatmap-legend" id="heatmapLegend">
                        <div class="heatmap-legend-title">Legend</div>
                        <div class="heatmap-legend-section">
                            <div class="heatmap-legend-subtitle">Velocity</div>
                            <div id="velocityLegendItems" class="heatmap-legend-items">
                                <!-- Dynamic Velocity Legend -->
                            </div>
                        </div>
                        <div class="heatmap-legend-section">
                            <div class="heatmap-legend-subtitle">Categories</div>
                            <div id="categoryLegendItems">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                        <!-- Driver Legend: Only shown in minimal view -->
                        <div class="heatmap-legend-section" id="driverLegendSection" style="display: none;">
                            <div class="heatmap-legend-subtitle">Drivers</div>
                            <div id="driverLegendItems" style="display: flex; flex-direction: column; gap: 3px;">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CENTER: Executive Report Panel -->
            <section class="center-panel exec-glass-bg" id="executiveReportPanel"
                style="display: none; height: calc(100vh - 130px); overflow-y: auto; padding: 24px; max-width: 1400px; margin: 0 auto;">
                <!-- Astra Branding -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; position: relative; z-index: 1; padding-left: 24px;">
                    <h2
                        style="font-size: 32px; font-weight: 800; color: white; letter-spacing: -1px; text-shadow: 0 2px 20px rgba(0,0,0,0.3);">
                        Astra | Capital Pulse Brief
                    </h2>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="saveExecutiveReport()" style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 10px 20px;
                            background: rgba(96, 205, 255, 0.2);
                            backdrop-filter: blur(10px);
                            -webkit-backdrop-filter: blur(10px);
                            color: white;
                            border: 1px solid rgba(96, 205, 255, 0.4);
                            border-radius: 100px;
                            font-size: 13px;
                            font-weight: 600;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(96, 205, 255, 0.3)'; this.style.transform='translateY(-2px)';"
                            onmouseout="this.style.background='rgba(96, 205, 255, 0.2)'; this.style.transform='translateY(0)';">
                            <span>ðŸ’¾</span> Save Report
                        </button>
                        <button id="execExportBtn" onclick="exportExecutiveReportPDF()" style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 10px 20px;
                            background: rgba(255, 255, 255, 0.15);
                            backdrop-filter: blur(10px);
                            -webkit-backdrop-filter: blur(10px);
                            color: white;
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            border-radius: 100px;
                            font-size: 13px;
                            font-weight: 600;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'; this.style.transform='translateY(-2px)';"
                            onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='translateY(0)';">
                            <span>ðŸ“„</span> Export PDF
                        </button>
                    </div>
                </div>

                <div class="exec-grid-container" style="position: relative; z-index: 1;">

                    <!-- Left Column -->
                    <div style="flex: 2.1; display: flex; flex-direction: column; gap: 24px;">

                        <!-- Heat Map -->
                        <div class="exec-card" id="execHeatMapCard" style="min-height: 350px;">
                            <div
                                style="display: flex; justify-content: space-between; margin-bottom: 16px; align-items: center;">
                                <h3 style="font-size: 18px; font-weight: 600;">Heat Map</h3>
                            </div>
                            <div id="execHeatMapContent" class="exec-empty-state" onclick="execPickHeatMap()">
                                <div style="text-align: center; color: var(--text-muted);">
                                    <div style="font-size: 24px; margin-bottom: 8px;">+</div>
                                    <div>Add Heat Map</div>
                                </div>
                            </div>
                        </div>

                        <!-- Minimum Pre-MA CET1 Ratio -->
                        <div class="exec-card" id="execTempBarCard" style="min-height: 250px;">
                            <div
                                style="display: flex; justify-content: space-between; margin-bottom: 16px; align-items: center;">
                                <h3 style="font-size: 18px; font-weight: 600;">Minimum Pre-MA CET1 Ratio</h3>
                            </div>
                            <div id="execTempBarContent" class="exec-empty-state" onclick="execAutoLinkTempBar()">
                                <div style="text-align: center; color: var(--text-muted);">
                                    <div style="font-size: 24px; margin-bottom: 8px;">+</div>
                                    <div>Add CET1 Calculation</div>
                                </div>
                            </div>
                        </div>

                        <!-- CET1 Waterfall -->
                        <div class="exec-card" id="execWaterfallCard" style="min-height: 320px;">
                            <div
                                style="display: flex; justify-content: space-between; margin-bottom: 16px; align-items: center;">
                                <h3 style="font-size: 18px; font-weight: 600;">CET1 Waterfall</h3>
                            </div>
                            <div id="execWaterfallContent" class="exec-empty-state" onclick="execPickWaterfall()">
                                <div style="text-align: center; color: var(--text-muted);">
                                    <div style="font-size: 24px; margin-bottom: 8px;">ðŸ“Š</div>
                                    <div>Add CET1 Calculation</div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column -->
                    <div style="flex: 0.9; display: flex; flex-direction: column; gap: 24px;">

                        <!-- Scenario Description -->
                        <div class="exec-card" id="execScenarioDescCard" style="min-height: 580px;">
                            <div
                                style="display: flex; justify-content: space-between; margin-bottom: 16px; align-items: center;">
                                <h3 style="font-size: 18px; font-weight: 600;">Scenario Description</h3>
                            </div>
                            <div id="execScenarioDescContent" class="exec-empty-state" onclick="execPickScenario()"
                                style="flex: 1; margin-bottom: 24px; min-height: 200px;">
                                <div style="text-align: center; color: var(--text-muted);">
                                    <div style="font-size: 24px; margin-bottom: 8px;">+</div>
                                    <div>Add Scenario Narrative</div>
                                </div>
                            </div>

                            <!-- Macro Variables -->
                            <div style="border-top: 1px solid #E2E8F0; padding-top: 20px;">
                                <h4 style="font-size: 16px; font-weight: 700; color: #003168; margin-bottom: 16px;">Key
                                    Macro Shocks</h4>
                                <div id="execMacroContent" class="exec-empty-state" style="min-height: 120px;"
                                    onclick="event.stopPropagation(); execAutoLinkMacro()">
                                    <div style="text-align: center; color: var(--text-muted);">
                                        <div style="font-size: 24px; margin-bottom: 8px;">ðŸ“ˆ</div>
                                        <div>Add Macro Variables</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Future Content -->
                        <div class="exec-card" style="flex: 1; min-height: 250px;">
                            <div
                                style="display: flex; justify-content: space-between; margin-bottom: 16px; align-items: center;">
                                <h3 style="font-size: 18px; font-weight: 600;">Sector Analysis (future content)</h3>
                            </div>
                            <div class="exec-content-area">
                                <div class="exec-empty-state">
                                    <div style="text-align: center; color: var(--text-muted);">
                                        <div style="font-size: 24px; margin-bottom: 8px;">âœ¨</div>
                                        <div>Coming Soon</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>



                <!-- Footer removed per user request -->
            </section>

            <!-- CENTER: CET1 Capital Analysis Panel (Hidden by default) -->
            <section class="center-panel" id="cet1AnalysisPanel"
                style="display: none; height: calc(100vh - 130px); overflow-y: auto; padding: 24px; gap: 24px; flex-direction: column;">

                <!-- CET1 Trough Card -->
                <div class="cet1-card" id="cet1TroughCard">
                    <div class="cet1-card-header">
                        <div class="cet1-card-title">Projected CET1 Ratios (Trough)</div>
                        <div style="display:flex; gap:10px;">
                            <button class="astra-btn astra-btn-secondary" onclick="cet1ExportPDF()">Export
                                Report</button>
                            <button class="astra-btn astra-btn-primary" onclick="openCET1AIModal()">AI
                                Assistant</button>
                        </div>
                    </div>
                    <div class="cet1-metric-grid">
                        <div class="cet1-metric-card">
                            <div class="cet1-metric-label">Jump-Off (Q4/25)</div>
                            <div class="cet1-metric-value" id="cet1JumpOffValue">13.5%</div>
                        </div>
                        <div class="cet1-metric-card selected" id="cet1VsevereCard"
                            onclick="cet1SelectScenarioForDetails('very_severe')">
                            <div class="cet1-metric-label">Very Severe</div>
                            <div class="cet1-metric-value" id="cet1VsevereTrough">9.3%</div>
                        </div>
                        <div class="cet1-metric-card" id="cet1SevereCard"
                            onclick="cet1SelectScenarioForDetails('severe')">
                            <div class="cet1-metric-label">Severe</div>
                            <div class="cet1-metric-value" id="cet1SevereTrough">10.8%</div>
                        </div>
                        <div class="cet1-metric-card" id="cet1ModerateCard"
                            onclick="cet1SelectScenarioForDetails('moderate')">
                            <div class="cet1-metric-label">Moderate</div>
                            <div class="cet1-metric-value" id="cet1ModerateTrough">12.5%</div>
                        </div>
                        <div class="cet1-metric-card" id="cet1BenchmarkCard"
                            onclick="cet1SelectScenarioForDetails('benchmark')">
                            <div class="cet1-metric-label">Benchmark</div>
                            <div class="cet1-metric-value" id="cet1BenchmarkTrough">12.8%</div>
                        </div>
                        <div class="cet1-metric-card" id="cet1CustomCard"
                            onclick="cet1SelectScenarioForDetails('custom')">
                            <div class="cet1-metric-label" id="cet1CustomScenarioLabel">Custom</div>
                            <div class="cet1-metric-value" id="cet1CustomTrough">--</div>
                        </div>
                    </div>

                    <div class="cet1-temperature-bar-container" id="cet1TempBar" style="margin-top: 60px;"></div>
                    <div class="cet1-temp-bar-labels">
                        <span>0% (Min)</span>
                        <span>4.5% (CCB)</span>
                        <span>8.1% (DSB)</span>
                        <span>11.6%</span>
                        <span>15.0%</span>
                    </div>
                </div>

                <!-- Capital Projection Card -->
                <div class="cet1-card" id="cet1CapitalProjectionCard">
                    <div class="cet1-card-header">
                        <div class="cet1-card-title">Capital Projection</div>
                    </div>
                    <div class="cet1-chart-container" id="cet1Chart"></div>
                </div>

                <!-- Detailed Impact Analysis Card -->
                <div class="cet1-card">
                    <div class="cet1-card-header">
                        <div class="cet1-card-title">Detailed Impact Analysis</div>
                        <div class="cet1-view-tabs">
                            <button class="cet1-view-tab active"
                                onclick="cet1SwitchView('waterfall')">Waterfall</button>
                            <button class="cet1-view-tab"
                                onclick="cet1SwitchView('decomposition')">Decomposition</button>
                            <button class="cet1-view-tab" onclick="cet1SwitchView('dollarImpact')">$ Impact</button>
                            <button class="cet1-view-tab" onclick="cet1SwitchView('bpsImpact')">BPS Impact</button>
                        </div>
                    </div>

                    <div id="cet1Waterfall" class="cet1-view-content active">
                        <div class="cet1-chart-container" id="cet1WaterfallChart"></div>
                    </div>
                    <div id="cet1Decomposition" class="cet1-view-content">
                        <div style="display: flex; justify-content: flex-end; padding: 0 10px 5px 0;">
                            <button id="cet1DecompToggleBtn" onclick="cet1ToggleDecompositionMode()"
                                style="background: none; border: 1px solid var(--border-subtle); padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; color: var(--text-secondary);">
                                Show Quarterly
                            </button>
                        </div>
                        <div class="cet1-chart-container" id="cet1DecompositionChart"></div>
                    </div>
                    <div id="cet1DollarImpact" class="cet1-view-content">
                        <div class="cet1-table-container" id="cet1DollarTable"></div>
                    </div>
                    <div id="cet1BpsImpact" class="cet1-view-content">
                        <div class="cet1-table-container" id="cet1BpsTable"></div>
                    </div>
                </div>
            </section>

            <!-- RIGHT: Heat Map Basket Panel (Hidden by default) -->
            <aside class="right-panel heatmap-basket" id="heatmapBasketPanel"
                style="display: none; height: calc(100vh - 130px); position: relative; padding-bottom: 160px; box-sizing: border-box; overflow: hidden;">
                <div class="basket-header">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <div>
                            <h3>Heat Map Controls</h3>
                            <p class="basket-count">Plotting: <span id="heatmapCount">0</span> drivers</p>
                        </div>
                        <button class="help-toggle-btn" onclick="toggleHeatMapHelp()" title="Help">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Help Panel (Hidden by default) -->
                <div id="heatmapHelpPanel" class="heatmap-help-panel" style="display: none;">
                    <div class="heatmap-help-content">
                        <p><strong>ðŸ“ Positioning:</strong> AI has analyzed each driver's likelihood and materiality.
                        </p>
                        <p><strong>ðŸ”„ Adjust:</strong> Drag any driver card to change its position.</p>
                        <p><strong>ðŸ’¬ Interact:</strong> Click a driver to open its detail modal.</p>
                        <p><strong>â±ï¸ Velocity:</strong> Colored indicator shows risk timing.</p>
                    </div>
                </div>

                <!-- View Mode Selector -->
                <div class="heatmap-view-selector"
                    style="padding: 12px 16px; border-bottom: 1px solid var(--border-subtle);">
                    <label
                        style="font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">View
                        Mode</label>
                    <div class="view-mode-group">
                        <button onclick="setHeatMapViewMode('default')" id="viewModeDefault"
                            class="view-mode-btn active">
                            ðŸ“„ Default
                        </button>
                        <button onclick="setHeatMapViewMode('compact')" id="viewModeCompact" class="view-mode-btn">
                            ðŸ“‹ Compact
                        </button>
                        <button onclick="setHeatMapViewMode('minimal')" id="viewModeMinimal" class="view-mode-btn">
                            âš¡ Minimal
                        </button>
                    </div>
                </div>

                <!-- Driver List - Scrollable -->
                <div class="basket-list" id="heatmapDriverList"
                    style="flex: 1; overflow-y: auto; min-height: 0; padding: 12px 16px;">
                    <!-- Drivers will be populated here -->
                </div>

                <div class="basket-footer"
                    style="flex-direction: column; gap: 12px; padding: 16px; position: absolute; bottom: 0; left: 0; width: 100%; border-radius: 0 0 32px 32px; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-top: 1px solid var(--border-subtle);">
                    <div class="tools-row">
                        <button class="tool-btn" onclick="showMarketplace()">
                            <span>âœï¸</span>
                            <span class="tool-text">Edit<span class="tool-extra"> Risk Drivers</span></span>
                        </button>
                        <button class="tool-btn" onclick="saveHeatMap()">
                            <span>ðŸ’¾</span>
                            <span class="tool-text">Save<span class="tool-extra"> Heat Map</span></span>
                        </button>
                        <button class="tool-btn" onclick="openHeatmapExportModal()">
                            <span>ðŸ“¤</span>
                            <span class="tool-text">Export<span class="tool-extra"> Heat Map</span></span>
                        </button>
                    </div>
                    <button class="heatmap-btn heatmap-btn-primary" onclick="generateScenarioFromHeatMap()">
                        ðŸ“„ Generate Scenario Report
                    </button>
                </div>
            </aside>


            <!-- RIGHT: Scenario Basket -->
            <aside class="right-panel" id="basketPanel" ondragover="handleDragOver(event)" ondrop="handleDrop(event)"
                ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                <div class="basket-header">
                    <h3>Scenario Basket</h3>
                    <p class="basket-count">Selected: <span id="count">0</span> drivers</p>
                </div>
                <div class="basket-list" id="inventoryList">
                    <div id="emptyState" class="basket-empty">
                        <div class="basket-empty-icon">ðŸ›’</div>
                        <p>Your basket is empty.<br>Click drivers to add them.</p>
                    </div>
                </div>
                <div class="basket-footer">
                    <button id="generateHeatMapBtn" class="generate-heatmap-btn" disabled onclick="generateHeatMap()"
                        style="margin-bottom: 12px;">
                        ðŸ”¥ Generate Heat Map
                    </button>
                    <button id="generateBtn" class="generate-btn" disabled onclick="generateScenario()">
                        Generate Scenario Report
                    </button>
                </div>
            </aside>


        </div>
    </main>

    <!-- ASTRA: Scenario Builder Panel (fixed position) -->
    <div class="astra-side-panel" id="scenarioBuilderPanel">
        <div class="astra-side-panel-header">
            <h3>Scenario Builder</h3>
            <button class="astra-side-panel-close" onclick="closeAstraPanel('scenarioBuilderPanel')">âœ•</button>
        </div>
        <div class="astra-side-panel-body">
            <div style="margin-bottom: 20px;">
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">SCENARIO
                    NAME</label>
                <input type="text" id="cet1CustomScenarioName" value="My Custom Scenario"
                    style="display: block; width: 100%; background: #F8FAFC; padding: 12px 14px; font-size: 14px; border-radius: 12px; border: 1px solid var(--border-subtle); box-sizing: border-box;"
                    onchange="cet1UpdateCustomScenarioName()">
            </div>
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">COMPONENT
                    SEVERITIES</label>
                <div id="cet1ComponentBuilder" style="max-height: 350px; overflow-y: auto; padding-right: 4px;"></div>
            </div>
            <div style="padding-top: 12px; border-top: 1px solid var(--border-subtle); margin-top: 12px;">
                <button class="astra-btn astra-btn-primary" onclick="cet1SaveScenarioFromBuilder()"
                    style="width: 100%;">
                    ðŸ’¾ Save Scenario
                </button>
                <small
                    style="display: block; margin-top: 8px; color: var(--text-muted); font-size: 10px; text-align: center;">
                    Saves current configuration to Folder
                </small>
            </div>
        </div>
    </div>

    <!-- ASTRA: Component Overrides Panel -->
    <div class="astra-side-panel" id="overlayControlsPanel">
        <div class="astra-side-panel-header">
            <h3>Component Overrides</h3>
            <button class="astra-side-panel-close" onclick="closeAstraPanel('overlayControlsPanel')">âœ•</button>
        </div>
        <div class="astra-side-panel-body">
            <div style="margin-bottom: 16px;">
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">SCENARIO
                    TO OVERRIDE</label>
                <select id="cet1ScenarioToOverride"
                    style="display: block; width: 100%; background: #F8FAFC; padding: 12px 14px; font-size: 14px; border-radius: 12px; border: 1px solid var(--border-subtle); appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"
                    http://www.w3.org/2000/svg\" width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\"
                    stroke=\"%2364748B\" stroke-width=\"2\">
                    <polyline points=\"6,9 12,15 18,9\" /></svg>'); background-repeat: no-repeat; background-position:
                    right 14px center; cursor: pointer; box-sizing: border-box;"
                    onchange="cet1SelectScenarioToOverride(this.value)">
                    <option value="very_severe">Very Severe</option>
                    <option value="severe" selected>Severe</option>
                    <option value="moderate">Moderate</option>
                    <option value="benchmark">Benchmark</option>
                    <option value="custom">Custom</option>
                </select>
                <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 11px;">
                    Select which scenario the component overrides will be applied to
                </small>
            </div>
            <!-- Hidden scenarioDisplay for backwards compatibility -->
            <select id="cet1ScenarioDisplay" multiple style="display: none;">
                <option value="very_severe" selected>Very Severe</option>
                <option value="severe" selected>Severe</option>
                <option value="moderate" selected>Moderate</option>
                <option value="benchmark" selected>Benchmark</option>
                <option value="custom">Custom</option>
            </select>
            <!-- Direct Overlay Section -->
            <div
                style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.15);">
                <label
                    style="font-size: 11px; font-weight: 700; color: var(--primary-blue); text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
                    <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                        </svg>
                        DIRECT OVERLAY
                    </span>
                    <button class="astra-btn astra-btn-secondary" style="padding: 2px 8px; font-size: 10px;"
                        onclick="cet1ClearDirectOverlay()">Clear</button>
                </label>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; font-size: 11px; padding: 6px; background: white; border-radius: 4px; border: 1px solid #E2E8F0;">
                        <span style="color: var(--text-muted);">Status:</span>
                        <span id="cet1DirectOverlayStatus"
                            style="font-weight: 600; color: var(--text-dark);">None</span>
                    </div>

                    <button class="astra-btn astra-btn-secondary" style="width: 100%; font-size: 11px;"
                        onclick="cet1OpenDirectOverlayModal()">
                        <span id="cet1EditOverlayBtnText">Edit Overlay</span>
                    </button>
                </div>

                <small style="display: block; margin-top: 6px; color: var(--text-muted); font-size: 10px;">
                    Adjust Capital, RWA, or BPS for specific quarters
                </small>
            </div>
            <!-- Hidden legacy inputs for compatibility -->
            <input type="hidden" id="cet1OverlayType" value="none">
            <input type="hidden" id="cet1OverlayAmount" value="0">

            <div style="margin-top: 16px;">
                <label
                    style="display: flex; align-items: center; justify-content: space-between; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">
                    <span>COMPONENT OVERRIDES</span>
                    <button class="astra-btn astra-btn-secondary" style="padding: 4px 10px; font-size: 11px;"
                        onclick="cet1ClearAllOverrides()">Clear All</button>
                </label>
                <div class="cet1-component-override-list" id="cet1ComponentOverrideList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- ASTRA: Component Override Modal -->
    <div class="cet1-override-modal" id="cet1ComponentOverrideModal">
        <div class="cet1-override-modal-content">
            <div class="cet1-override-modal-header">
                <h3 id="cet1OverrideModalTitle">Edit Component: PCL Canada</h3>
                <button class="astra-side-panel-close" onclick="cet1CloseOverrideModal()">âœ•</button>
            </div>
            <div class="cet1-override-modal-body">
                <div class="cet1-override-info">
                    <div><strong>Base Scenario:</strong> <span id="cet1OverrideBaseScenario">Severe</span></div>
                    <div><strong>Component:</strong> <span id="cet1OverrideComponentName">PCL Canada</span></div>
                    <div><strong>Modified Quarters:</strong> <span id="cet1OverrideModifiedCount">0</span></div>
                </div>
                <div class="cet1-override-chart-container" id="cet1OverrideChart"></div>
                <div class="cet1-override-table-container">
                    <table class="cet1-override-table">
                        <thead>
                            <tr id="cet1OverrideTableHeader">
                                <!-- Q1-Q20 headers -->
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="cet1OverrideTableBaseRow">
                                <!-- Base values -->
                            </tr>
                            <tr id="cet1OverrideTableInputRow">
                                <!-- Input fields -->
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="cet1-override-modal-footer">
                <button class="astra-btn astra-btn-secondary" onclick="cet1ResetComponentOverride()">Reset to
                    Default</button>
                <button class="astra-btn astra-btn-primary" onclick="cet1ApplyComponentOverride()">Apply
                    Override</button>
            </div>
        </div>
    </div>

    <!-- ASTRA: Direct Overlay Modal -->
    <div class="cet1-override-modal" id="cet1DirectOverlayModal">
        <div class="cet1-override-modal-content" style="width: 900px; max-width: 95%;">
            <div class="cet1-override-modal-header">
                <h3>Direct Scenario Overlay</h3>
                <button class="astra-side-panel-close" onclick="cet1CloseDirectOverlayModal()">âœ•</button>
            </div>
            <div class="cet1-override-modal-body">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label
                        style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">OVERLAY
                        TYPE</label>
                    <select id="cet1ModalOverlayType" class="form-control"
                        style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-subtle); font-size: 14px; background-color: var(--bg-surface); color: var(--text-main); outline: none;"
                        onchange="cet1HandleModalOverlayTypeChange()">
                        <option value="none">None</option>
                        <option value="dollar">Capital ($M)</option>
                        <option value="rwa">RWA ($M)</option>
                        <option value="bps">Basis Points (bps)</option>
                    </select>
                    <small id="cet1ModalOverlayDescription"
                        style="display: block; margin-top: 5px; color: var(--text-muted);">
                        Select an overlay type
                    </small>
                </div>

                <!-- Chart Container for Visualization -->
                <div id="cet1ModalOverlayChart" style="width: 100%; height: 250px; margin-top: 15px; display: none;">
                </div>

                <div id="cet1ModalOverlayTableContainer" style="display: none; margin-top: 15px;">
                    <label>Quarterly Adjustments</label>
                    <div class="cet1-override-table-container">
                        <table class="cet1-override-table">
                            <thead>
                                <tr id="cet1ModalOverlayHeaders">
                                    <!-- Headers generated by JS -->
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="cet1ModalOverlayInputs">
                                    <!-- Inputs generated by JS -->
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="cet1-override-modal-footer">
                <button class="astra-btn astra-btn-secondary" onclick="cet1CloseDirectOverlayModal()">Cancel</button>
                <button class="astra-btn astra-btn-primary" onclick="cet1ApplyDirectOverlay()">Apply Overlay</button>
            </div>
        </div>
    </div>

    <!-- Scenario Description Edit Modal -->
    <div class="scenario-edit-modal" id="scenarioDescEditModal">
        <div class="scenario-edit-modal-content">
            <div class="scenario-edit-modal-header">
                <h3>âœï¸ Edit Scenario Description</h3>
                <button class="scenario-edit-modal-close" onclick="closeScenarioDescEditor()">Ã—</button>
            </div>
            <div class="scenario-edit-modal-body">
                <textarea class="scenario-edit-textarea" id="scenarioDescEditTextarea"
                    placeholder="Enter your scenario description..."></textarea>
                <div class="scenario-edit-note">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    This will override the AI-generated description. Changes are saved locally.
                </div>
            </div>
            <div class="scenario-edit-modal-footer">
                <button class="scenario-edit-btn-cancel" onclick="closeScenarioDescEditor()">Cancel</button>
                <button class="scenario-edit-btn-save" onclick="saveScenarioDescEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- ASTRA: AI Scenario Modal -->
    <div id="cet1InputScenarioModal" class="modal-overlay" style="z-index: 1000;">
        <div class="modal-content"
            style="width: 1200px; max-width: 95vw; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 style="margin:0; font-size:16px; font-weight:700;">Create Custom Scenario with AI</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button
                        style="background: none; border: 1px solid var(--border-subtle); border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer; color: var(--text-secondary); height: 32px;"
                        onclick="if(confirm('Start new scenario conversation? This will clear current progress.')) { cet1ResetConversation(); cet1InitializeDefaultSeverities(); }">
                        Start New
                    </button>
                    <button class="icon-btn" style="font-size: 20px;" onclick="closeCET1AIModal()">âœ•</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0; display: flex; overflow: hidden; height: calc(85vh - 60px);">
                <!-- Left Panel: Component Severity Grid -->
                <div class="cet1-split-panel-left" id="cet1ScenarioConfigPanel">
                    <!-- Will be populated by cet1InitializeDefaultSeverities() -->
                </div>

                <!-- Right Panel: AI Chat -->
                <div class="cet1-split-panel-right">
                    <div class="cet1-chat-container" id="cet1ChatContainer"
                        style="flex: 1; min-height: 0; padding: 20px;">
                        <div class="cet1-chat-message ai">
                            <div class="cet1-chat-bubble">
                                Hello! I'm ready to help you create a custom stress scenario. Describe your scenario or
                                upload a document, and I'll analyze the impact on RBC's 18 CET1 capital components.
                            </div>
                        </div>
                    </div>

                    <!-- Input Area fixed at bottom of right panel -->
                    <div class="input-area"
                        style="border-top: 1px solid var(--border-subtle); padding: 16px; background: white;">
                        <div id="cet1UploadedFileDisplay"></div>
                        <textarea id="cet1UserInput" class="form-control" placeholder="Describe your stress scenario..."
                            style="height:80px; resize:none; margin-bottom: 10px;"
                            onkeypress="if(event.key==='Enter' && !event.shiftKey) {event.preventDefault(); cet1SendMessage();}"></textarea>
                        <div style="display:flex; gap:8px; align-items: stretch; height: 38px;">
                            <label class="astra-btn astra-btn-secondary"
                                style="flex:1; display: flex; justify-content: center; align-items: center; margin: 0; padding: 0; font-size: 13px; text-transform: none;">
                                ðŸ“Ž Upload
                                <input type="file" id="cet1FileUpload" style="display:none"
                                    accept=".txt,.pdf,.doc,.docx" onchange="cet1HandleFileUpload(event)">
                            </label>

                            <button class="astra-btn astra-btn-primary"
                                style="flex:1; padding: 0; font-size: 13px; text-transform: none;"
                                onclick="cet1SendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOADER OVERLAY -->
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p class="loader-text" id="loaderText">Analyzing risk drivers...</p>
    </div>

    <!-- DRIVER DETAIL MODAL -->
    <div class="modal-overlay" id="driverModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Driver Details</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <span id="modalTag" class="modal-tag">Category</span>
                <p id="modalDesc" class="modal-desc">Description goes here...</p>

                <div class="chat-container">
                    <div class="chat-history" id="chatHistory">
                        <!-- Messages here -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" class="chat-input"
                            placeholder="Ask AI to refine this driver..." onkeypress="handleChatEnter(event)">
                        <button class="chat-send" onclick="sendChatMessage()">âž¤</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" id="deleteDriverBtn"
                    style="background: #EF4444; color: white; display: none;"
                    onclick="deleteCustomDriver(currentModalDriverId)">ðŸ—‘ï¸ Delete Driver</button>
                <button class="modal-action-btn" id="modalActionBtn" style="background: var(--primary); color: white;"
                    onclick="toggleDriverFromModal()">Add to Scenario</button>
            </div>
        </div>
    </div>

    <!-- REPORT OVERLAY -->
    <div class="report-overlay" id="reportOverlay">
        <div class="report-container">
            <div class="report-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div class="report-title" id="reportTitle">Scenario Analysis Report</div>
                        <div class="report-subtitle" id="reportSubtitle">Generated on December 6, 2025 | Based on 0 Risk
                            Drivers</div>
                    </div>
                    <div class="report-actions" style="display: flex; gap: 8px;">
                        <button class="btn-secondary" onclick="addMoreDriversToScenario()"
                            style="background: rgba(16, 185, 129, 0.9); color: white; border: none;">+ Add More
                            Drivers</button>
                        <button class="btn-secondary" onclick="closeReport()"
                            style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">Close</button>
                        <button class="btn-secondary" onclick="saveReport()"
                            style="background: white; color: var(--primary);">Save Scenario</button>
                        <button class="btn-secondary" onclick="exportScenarioPdf()" id="exportPdfBtn"
                            style="background: #2563EB; color: white; border: none;">ðŸ“„ Export PDF</button>
                        <button class="btn-secondary" onclick="sendToAstra()" id="sendToAstraBtn"
                            style="background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; border: none; font-weight: 600;">
                            ðŸš€ Analyze in Astra
                        </button>
                    </div>
                </div>
            </div>

            <div class="report-content-wrapper">
                <!-- Main Report Content -->
                <div class="report-main">
                    <div class="report-body">
                        <div class="report-section">
                            <div class="section-title">Selected Risk Drivers</div>
                            <div class="drivers-list" id="reportDriversList"></div>
                        </div>
                        <div class="report-section">
                            <div class="section-title">Global Economic Conditions</div>
                            <div class="section-content" id="globalConditions">Loading...</div>
                        </div>
                        <div class="report-section">
                            <div class="section-title">Canadian Economic Conditions</div>
                            <div class="section-content" id="canadianConditions">Loading...</div>
                        </div>
                        <div class="report-section">
                            <div class="section-title">Impact to RBC</div>
                            <div class="section-content" id="rbcImpact">Loading...</div>
                        </div>
                        <div class="report-section">
                            <div class="section-title">Core Macro Variable Projections</div>
                            <div class="macro-grid" id="macroProjections"></div>
                        </div>
                    </div>
                    <div class="report-footer">
                        <div class="report-disclaimer"></div>
                    </div>
                </div>

                <!-- AI Assistant Sidebar -->
                <div class="report-sidebar" id="reportSidebar">
                    <div class="report-chat-header">
                        <span id="reportSidebarTitle">âœ¨ Scenario Assistant</span>
                        <button class="sidebar-toggle-btn" onclick="toggleReportSidebar()" title="Toggle Sidebar">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="13 17 18 12 13 7"></polyline>
                                <polyline points="6 17 11 12 6 7"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="report-chat-history" id="reportChatHistory">
                        <div class="chat-message ai">
                            This scenario has been generated based on the selected risk drivers. I can help you refine
                            it:

                            <br><br><strong>ðŸ“Š Macro Projections:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li>"Make the scenario more severe" - I'll adjust all variables proportionally</li>
                                <li>"Dial back the severity by 30%" - I'll moderate all projections</li>
                                <li>"Increase unemployment to 9%" - I'll update related variables to maintain economic
                                    consistency</li>
                            </ul>

                            <strong>âœï¸ Narrative Refinements:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li>"Make the global section more concise"</li>
                                <li>"Add more detail on housing market impacts"</li>
                                <li>"Adjust the tone to be more technical"</li>
                            </ul>

                            When I adjust macro projections, I'll explain the economic rationale for each variable
                            change.
                        </div>
                    </div>
                    <div class="report-chat-input-area">
                        <input type="text" id="reportChatInput" class="chat-input"
                            placeholder="Refine narrative or ask questions..."
                            onkeypress="handleReportChatEnter(event)">
                        <button class="chat-send" onclick="sendReportChatMessage()">âž¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- HEATMAP EXPORT MODAL -->
    <div class="modal-overlay" id="heatmapExportModal" style="display: none;">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding-bottom: 32px;">
            <div class="modal-header">
                <h2>ðŸ“¤ Export Heat Map</h2>
                <button class="modal-close" onclick="closeHeatmapExportModal()">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 24px; display: flex; flex-direction: column; gap: 16px;">
                <p style="color: var(--text-secondary); margin-bottom: 8px;">Choose a format to download the Heat Map.
                </p>
                <button class="heatmap-btn" style="background: #2563EB; color: white; justify-content: center;"
                    onclick="exportHeatmap('jpg')">
                    ðŸ–¼ï¸ Export as JPG Image
                </button>
                <button class="heatmap-btn"
                    style="background: white; border: 1px solid #E2E8F0; color: #374151; justify-content: center;"
                    onclick="exportHeatmap('pdf')">
                    ðŸ“„ Export as PDF Document
                </button>
            </div>
        </div>
    </div>

    <!-- NEWS SCANNER MODAL -->
    <div class="modal-overlay" id="newsModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>ðŸ“° News Scanner - Axios Feeds</h2>
                <button class="modal-close" onclick="closeNewsModal()">Ã—</button>
            </div>
            <div class="modal-body"
                style="padding: 0; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Category Tabs -->
                <div
                    style="display: flex; gap: 8px; padding: 16px 24px; border-bottom: 1px solid #E2E8F0; flex-wrap: wrap;">
                    <button class="news-tab active" data-feed="politics" onclick="selectNewsFeed('politics')">ðŸ›ï¸
                        Politics</button>
                    <button class="news-tab" data-feed="world" onclick="selectNewsFeed('world')">ðŸŒ World</button>
                    <button class="news-tab" data-feed="business" onclick="selectNewsFeed('business')">ðŸ’¼
                        Business</button>
                    <button class="news-tab" data-feed="economy" onclick="selectNewsFeed('economy')">ðŸ“ˆ
                        Economy</button>
                    <button class="news-tab" data-feed="technology" onclick="selectNewsFeed('technology')">ðŸ’»
                        Technology</button>
                    <button class="news-tab" data-feed="main" onclick="selectNewsFeed('main')">ðŸ“‹ All News</button>
                </div>

                <!-- Loading State -->
                <div id="newsLoading" style="display: none; padding: 60px; text-align: center; color: #64748B;">
                    <div
                        style="width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;">
                    </div>
                    Fetching latest news...
                </div>

                <!-- News List -->
                <div id="newsList" style="flex: 1; overflow-y: auto; padding: 16px 24px;">
                    <div style="text-align: center; color: #64748B; padding: 40px;">
                        Select a category above to load news articles.
                    </div>
                </div>

                <!-- Selected Article Preview -->
                <div id="newsPreview"
                    style="display: none; padding: 20px 24px; border-top: 1px solid #E2E8F0; background: #F8FAFC;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #2563EB; font-weight: 600; margin-bottom: 4px;">
                                SELECTED ARTICLE</div>
                            <div id="newsPreviewTitle" style="font-size: 16px; font-weight: 600; color: #111827;">
                            </div>
                        </div>
                        <button onclick="generateRiskFromNews()"
                            style="background: #2563EB; color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 8px;">
                            âœ¨ Generate Risk Card
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .news-tab {
            padding: 8px 16px;
            border: 1px solid #E2E8F0;
            border-radius: 20px;
            background: white;
            color: #64748B;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .news-tab:hover {
            border-color: #2563EB;
            color: #2563EB;
        }

        .news-tab.active {
            background: #2563EB;
            color: white;
            border-color: #2563EB;
        }

        .news-item {
            padding: 16px;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .news-item:hover {
            border-color: #2563EB;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .news-item.selected {
            border-color: #2563EB;
            background: #EFF6FF;
        }

        .news-item-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .news-item-desc {
            font-size: 13px;
            color: #64748B;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-item-meta {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            font-size: 11px;
            color: #94A3B8;
        }
    </style>
    <!-- GENERATE DOSSIER MODAL -->
    <div class="modal-overlay" id="generateDossierModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ðŸ“… Generate Historical Dossier</h2>
                <button class="modal-close" onclick="closeGenerateDossierModal()">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <p style="margin-bottom: 16px; color: var(--text-muted);">
                    Generate a market intelligence dossier for a specific historical period.
                    Tavily will search for news and data as of the selected quarter.
                </p>

                <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <label
                            style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px;">Quarter</label>
                        <select id="dossierQuarter"
                            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); font-size: 14px;">
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4" selected>Q4 (Oct-Dec)</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label
                            style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px;">Year</label>
                        <select id="dossierYear"
                            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); font-size: 14px;">
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                        </select>
                    </div>
                </div>

                <div
                    style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 12px; color: #92400E;">
                        âš ï¸ <strong>Note:</strong> Historical searches may have limited results for older dates.
                        Best results for periods within the last 2 years.
                    </p>
                </div>

                <div id="dossierGenerationStatus" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner" style="margin: 0 auto 12px;"></div>
                    <p id="dossierGenerationText" style="color: var(--text-muted);">Generating dossier...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" style="background: var(--text-muted); color: white;"
                    onclick="closeGenerateDossierModal()">Cancel</button>
                <button class="modal-action-btn" id="generateDossierBtn" style="background: #059669; color: white;"
                    onclick="generateHistoricalDossier()">
                    ðŸ” Generate Dossier
                </button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settingsModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span class="modal-title">âš™ï¸ Settings</span>
                <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Dossier Management Section -->
                <div style="margin-bottom: 24px;">
                    <h3
                        style="font-size: 14px; font-weight: 700; color: #111827; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                        ðŸ“… Dossier Management</h3>
                    <p style="color: #6b7280; font-size: 13px; margin: 0 0 16px 0; line-height: 1.5;">
                        Generate, import, export, or refresh market dossiers.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button onclick="closeSettingsModal(); showGenerateDossierModal();"
                            style="padding: 10px 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                            ðŸ“… New Dossier
                        </button>
                        <button onclick="closeSettingsModal(); forceRefreshDrivers();"
                            style="padding: 10px 12px; background: linear-gradient(135deg, #64748B, #475569); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                            ðŸ”„ Refresh Drivers
                        </button>
                        <button onclick="closeSettingsModal(); exportCurrentDossier();"
                            style="padding: 10px 12px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                            ðŸ“¤ Export Dossier
                        </button>
                        <label
                            style="padding: 10px 12px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; text-align: center;">
                            ðŸ“¥ Import Dossier
                            <input type="file" accept=".json" onchange="closeSettingsModal(); importDossierFile(event);"
                                style="display: none;">
                        </label>
                    </div>
                    <button onclick="closeSettingsModal(); deleteSelectedDossier();"
                        style="width: 100%; margin-top: 8px; padding: 10px 12px; background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                        ðŸ—‘ï¸ Delete Current Dossier
                    </button>
                </div>

                <!-- Divider -->
                <div style="height: 1px; background: #e5e7eb; margin: 24px 0;"></div>



                <!-- Workspace Backup Section -->
                <div style="margin-bottom: 24px;">
                    <h3
                        style="font-size: 14px; font-weight: 700; color: #111827; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                        ðŸ’¾ Workspace Backup</h3>
                    <p style="color: #6b7280; font-size: 13px; margin: 0 0 16px 0; line-height: 1.5;">
                        Export your entire ASTRA workspace to a single file. Includes all saved scenarios, market
                        dossier, risk drivers, and custom drivers.
                    </p>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="exportWorkspace()"
                            style="flex: 1; padding: 12px 16px; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            ðŸ“¤ Export Workspace
                        </button>
                        <label
                            style="flex: 1; padding: 12px 16px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; text-align: center;">
                            ðŸ“¥ Import Workspace
                            <input type="file" accept=".json" onchange="importWorkspace(event)" style="display: none;">
                        </label>
                    </div>
                </div>

                <!-- Divider -->
                <div style="height: 1px; background: #e5e7eb; margin: 24px 0;"></div>

                <!-- Data Management Section -->
                <div>
                    <h3
                        style="font-size: 14px; font-weight: 700; color: #111827; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                        ðŸ—‚ï¸ Data Management</h3>
                    <p style="color: #6b7280; font-size: 13px; margin: 0 0 16px 0; line-height: 1.5;">
                        Clear cached data to force a fresh market scan on next load.
                    </p>
                    <button onclick="clearAllCaches()"
                        style="width: 100%; padding: 12px 16px; background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;">
                        ðŸ—‘ï¸ Clear All Cached Data
                    </button>
                </div>

                <!-- Divider -->
                <div style="height: 1px; background: #e5e7eb; margin: 24px 0;"></div>

                <!-- AI Configuration -->
                <div style="margin-bottom: 24px;">
                    <h3
                        style="font-size: 14px; font-weight: 700; color: #111827; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                        ðŸ¤– AI Configuration
                    </h3>
                    <p style="color: #6b7280; font-size: 13px; margin: 0 0 16px 0; line-height: 1.5;">
                        View and inspect the prompt templates used by the AI.
                    </p>
                    <button onclick="closeSettingsModal(); openAiPromptsModal();"
                        style="width: 100%; padding: 12px 16px; background: linear-gradient(135deg, #8B5CF6, #6D28D9); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        ðŸ‘ï¸ View AI Prompts
                    </button>
                </div>

                <!-- Divider -->
                <div style="height: 1px; background: #e5e7eb; margin: 24px 0;"></div>

                <!-- About Section -->
                <div style="text-align: center; color: #9ca3af; font-size: 11px;">
                    <p style="margin: 0;">ASTRA Scenario Platform v1.0</p>
                    <p style="margin: 4px 0 0 0;">CEST Analytics</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 0. CONFIGURATION ---
        // API keys no longer needed in frontend - handled by Flask backend
        const API_BASE_URL = window.location.protocol === 'file:' ? 'http://localhost:5001' : '';
        const AZURE_OPENAI_API_URL = `${API_BASE_URL}/api/chat`;  // Azure OpenAI via RBC GenAI Gateway
        const CACHE_KEY = 'astra_market_dossier';
        const DRIVERS_CACHE_KEY = 'astra_risk_drivers';
        const CUSTOM_DRIVERS_KEY = 'astra_custom_drivers';
        const SAVED_SCENARIOS_KEY = 'astra_saved_scenarios';
        const DOSSIERS_LIST_KEY = 'astra_dossiers_list';
        const CACHE_EXPIRY_DAYS = 7;

        // Current active dossier tracking
        let currentDossierId = 'current';
        let dossiersList = [];

        // Category color mapping
        const CATEGORY_COLORS = {
            'Macroeconomic': { tagColor: '#DBEAFE', textColor: '#1E40AF' },
            'Geopolitical': { tagColor: '#FEE2E2', textColor: '#991B1B' },
            'Cyber / Tech': { tagColor: '#E0E7FF', textColor: '#4338CA' },
            'Financial': { tagColor: '#D1FAE5', textColor: '#065F46' },
            'Environmental': { tagColor: '#FEF3C7', textColor: '#92400E' },
            'Social': { tagColor: '#F3E8FF', textColor: '#6B21A8' },
            'Regulatory': { tagColor: '#E5E7EB', textColor: '#374151' },
            'US Policy': { tagColor: '#FEE2E2', textColor: '#991B1B' },
            'AI & Cyber': { tagColor: '#E0E7FF', textColor: '#4338CA' },
            'Trade & Geopolitics': { tagColor: '#FEE2E2', textColor: '#991B1B' },
            'Climate': { tagColor: '#FEF3C7', textColor: '#92400E' },
            'Digital Assets': { tagColor: '#E0E7FF', textColor: '#4338CA' },
            'Banking': { tagColor: '#D1FAE5', textColor: '#065F46' },
            'Demographics': { tagColor: '#F3E8FF', textColor: '#6B21A8' },
            'Customized': { tagColor: '#CFFAFE', textColor: '#0E7490' }  // Teal/Cyan - unique color
        };

        // Dynamic date context calculation - same as Python script
        function getDynamicContext(targetYear = null, targetQuarter = null) {
            const now = new Date();
            let curYear, curQuarter;

            if (targetYear && targetQuarter) {
                // Use provided historical date context
                curYear = parseInt(targetYear);
                const quarterNum = parseInt(targetQuarter.replace('Q', ''));
                curQuarter = quarterNum;
            } else {
                // Calculate current date context
                curYear = now.getFullYear();
                curQuarter = Math.ceil((now.getMonth() + 1) / 3);
            }

            const nextYear = curYear + 1;
            const curQ = `Q${curQuarter}`;

            // Previous Quarter (for earnings)
            let prevQ, prevQYear;
            if (curQuarter === 1) {
                prevQ = 'Q4';
                prevQYear = curYear - 1;
            } else {
                prevQ = `Q${curQuarter - 1}`;
                prevQYear = curYear;
            }

            return {
                CY: curYear,
                NY: nextYear,
                CQ: curQ,
                PQ: prevQ,
                PQY: prevQYear
            };
        }

        // Tavily search queries - CURRENT period (event-specific for 2024-2025)
        function getCurrentPeriodQueries(t) {
            return {
                "1_US_POLICY_RISK": [
                    `White House press briefings US Canada trade relations ${t.CY}`,
                    `US Treasury debt ceiling risk and fiscal dysfunction ${t.CY}`,
                    `CBO Budget and Economic Outlook ${t.CY} ${t.NY} projections`,
                    `USTR announcements CUSMA USMCA trade dispute settlement ${t.CY}`,
                    `Federal Reserve FOMC minutes political gridlock risks ${t.CY}`,
                    `US Treasury yield curve inversion and repo market stress ${t.CY}`
                ],
                "2_MACRO_ECONOMY": [
                    `Statistics Canada CPI inflation and stagflation signs ${t.CQ} ${t.CY}`,
                    `Bank of Canada Financial System Review household debt ${t.CY}`,
                    `IMF World Economic Outlook Canada GDP growth forecast ${t.CY} ${t.NY}`,
                    `Bloomberg Commodity Index forecast oil and wheat prices ${t.NY}`,
                    `Sovereign CDS spreads Canada vs US ${t.CY} trends`
                ],
                "3_AI_AND_CYBER": [
                    `NIST AI Risk Management Framework financial sector adoption ${t.CY}`,
                    `CISA cybersecurity alerts financial sector ransomware ${t.CY}`,
                    `Chainalysis crypto crime report ransomware revenue ${t.CY}`,
                    `OECD employment outlook AI labor displacement Canada ${t.CY}`
                ],
                "4_GEOPOLITICS_TRADE": [
                    `CSIS report foreign interference Canadian economy ${t.CY}`,
                    `Foreign Policy magazine US isolationism impact on Canada ${t.CY}`,
                    `Freightos Baltic Index global shipping rates Red Sea ${t.CY}`,
                    `US Department of Commerce semiconductor trade restrictions ${t.CY}`
                ],
                "5_CLIMATE_PHYSICAL": [
                    `Environment Canada seasonal weather hazard outlook wildfire ${t.NY}`,
                    `OSFI climate risk management guidelines B-15 updates ${t.CY}`,
                    `Swiss Re Sigma report natural catastrophe losses Canada ${t.CY}`
                ],
                "6_DIGITAL_ASSETS": [
                    `OSFI crypto asset exposure guidelines for banks ${t.CY}`,
                    `Circle stablecoin peg stability report ${t.CY}`,
                    `Rekt.news DeFi exploits summary ${t.CY}`
                ],
                "7_REGULATORY_ENVIRONMENT": [
                    `OSFI Annual Risk Outlook ${t.CY} priorities`,
                    `FINTRAC anti-money laundering real estate updates ${t.CY}`,
                    `CFPB consumer protection rules impact on Canadian banks ${t.CY}`
                ],
                "8_SOCIETAL_DEMOGRAPHICS": [
                    `Angus Reid Institute poll Canadian political polarization ${t.CY}`,
                    `Statistics Canada immigration targets vs housing supply ${t.CY}`,
                    `Pew Research Center US political stability forecast ${t.CY}`
                ],
                "9_BANKING_SIGNALS": [
                    `RBC ${t.PQ} ${t.PQY} earnings call transcript analyst questions`,
                    `TD Bank BMO provision for credit losses ${t.PQ} ${t.PQY} trends`,
                    `Teranet-National Bank House Price Index composite ${t.CY}`,
                    `VIX and MOVE index volatility correlation ${t.CY}`
                ]
            };
        }

        // Tavily search queries - HISTORICAL period (generic/evergreen queries)
        function getHistoricalPeriodQueries(t) {
            // More generic queries that work for any time period
            // Focus on fundamental economic indicators and recurring risk themes
            return {
                "1_MACRO_INDICATORS": [
                    `Canada GDP growth rate ${t.CQ} ${t.CY} Statistics Canada`,
                    `Bank of Canada interest rate decision ${t.CQ} ${t.CY}`,
                    `Canada unemployment rate ${t.CQ} ${t.CY} labor market`,
                    `Canadian inflation CPI ${t.CQ} ${t.CY}`,
                    `Canada housing market prices ${t.CQ} ${t.CY}`
                ],
                "2_CENTRAL_BANK_POLICY": [
                    `Bank of Canada monetary policy report ${t.CQ} ${t.CY}`,
                    `Federal Reserve interest rate decision ${t.CQ} ${t.CY}`,
                    `Bank of Canada Financial System Review ${t.CY}`,
                    `Canada yield curve ${t.CQ} ${t.CY} bond market`
                ],
                "3_FINANCIAL_MARKETS": [
                    `TSX stock market performance ${t.CQ} ${t.CY}`,
                    `Canadian dollar exchange rate ${t.CQ} ${t.CY}`,
                    `Canada credit spreads corporate bonds ${t.CQ} ${t.CY}`,
                    `VIX volatility index ${t.CQ} ${t.CY}`
                ],
                "4_GEOPOLITICS_TRADE": [
                    `Canada US trade relations ${t.CQ} ${t.CY}`,
                    `global supply chain disruption ${t.CQ} ${t.CY}`,
                    `oil prices impact Canada ${t.CQ} ${t.CY}`,
                    `commodity prices Canada exports ${t.CQ} ${t.CY}`
                ],
                "5_REGULATORY_BANKING": [
                    `OSFI regulatory updates Canada ${t.CQ} ${t.CY}`,
                    `Canadian bank earnings results ${t.CQ} ${t.CY}`,
                    `RBC TD BMO credit loss provisions ${t.CQ} ${t.CY}`,
                    `Canada mortgage market stress ${t.CQ} ${t.CY}`
                ],
                "6_RISK_EVENTS": [
                    `Canada financial risk concerns ${t.CQ} ${t.CY}`,
                    `Canadian economy recession risk ${t.CQ} ${t.CY}`,
                    `Canada household debt ${t.CQ} ${t.CY}`,
                    `Canadian real estate market risk ${t.CQ} ${t.CY}`
                ],
                "7_CLIMATE_DISASTERS": [
                    `Canada natural disaster ${t.CY} wildfire flood`,
                    `Canadian insurance claims catastrophe ${t.CY}`,
                    `climate risk Canada financial sector ${t.CY}`
                ],
                "8_TECHNOLOGY_CYBER": [
                    `cybersecurity threats financial sector ${t.CQ} ${t.CY}`,
                    `data breach Canada ${t.CQ} ${t.CY}`,
                    `fintech disruption Canada banking ${t.CY}`
                ],
                "9_SOCIETAL_POLITICAL": [
                    `Canada political landscape ${t.CQ} ${t.CY}`,
                    `Canadian consumer confidence ${t.CQ} ${t.CY}`,
                    `Canada immigration policy ${t.CY} economic impact`
                ]
            };
        }

        // Choose appropriate query set based on year
        function getTavilyQueries(t, isHistorical = false) {
            // Use current period queries (event-specific) only for 2025 and after
            // Use historical/generic queries for 2024 and earlier
            if (isHistorical || t.CY < 2025) {
                return getHistoricalPeriodQueries(t);
            }
            return getCurrentPeriodQueries(t);
        }

        // For backwards compatibility, maintain a default TAVILY_QUERIES object
        const TAVILY_QUERIES = getTavilyQueries(getDynamicContext(), false);

        // --- 1. INITIAL RISK DATA (will be populated by AI) ---
        let INITIAL_DRIVERS = [];
        let selectedDrivers = [];
        var savedScenarios = [];
        let currentScenarioId = null;
        let isInitializing = false;

        // --- 2. CACHE UTILITIES ---
        function isCacheValid(cacheData) {
            if (!cacheData || !cacheData.timestamp) return false;
            const cacheDate = new Date(cacheData.timestamp);
            const now = new Date();
            const diffDays = (now - cacheDate) / (1000 * 60 * 60 * 24);
            return diffDays < CACHE_EXPIRY_DAYS;
        }

        // --- BASELINE MACRO DATA FETCHING ---
        async function fetchBaselineMacroData(periodInfo) {
            if (!periodInfo || !periodInfo.quarter || !periodInfo.year) {
                console.log('âš ï¸ No period info provided for macro data');
                return null;
            }

            try {
                const response = await fetch('/stress_test_data/macro_jumpoff.csv');
                if (!response.ok) {
                    console.error('Failed to load macro_jumpoff.csv from /stress_test_data/');
                    return null;
                }

                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',');

                // Find the column for the requested quarter/year
                const targetColumn = `${periodInfo.year}/Q${periodInfo.quarter.replace('Q', '')}`;
                let columnIndex = headers.indexOf(targetColumn);
                let usedLatest = false;

                if (columnIndex === -1) {
                    // Quarter not found - use the latest available quarter
                    console.log(`âš ï¸ ${targetColumn} not found in CSV, using latest available data`);
                    columnIndex = headers.length - 1;
                    usedLatest = true;
                }

                // Variable mapping
                const variableMap = {
                    'GDP_CA': 'Canada GDP',
                    'UR_CA': 'Unemployment Rate',
                    'INF_CA': 'CPI Inflation',
                    'USDCAD': 'CAD/USD',
                    'OR_CA': 'BoC Rate',
                    'HPI_CA': 'House Price Index',
                    'TSX_CA': 'TSX Composite',
                    '10YS_BBB_CA': 'Credit Spreads'
                };

                // Variables that need QoQ growth calculation
                const qoqVariables = new Set(['GDP_CA', 'HPI_CA', 'TSX_CA']);

                // Variables that are percentages (show 1 decimal)
                const percentageVariables = new Set(['UR_CA', 'INF_CA', 'OR_CA', '10YS_BBB_CA']);

                const macroValues = {};
                const rawValues = {}; // Store raw values for QoQ calculation

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    const mnemonic = cols[0];
                    if (variableMap[mnemonic]) {
                        const currentValue = parseFloat(cols[columnIndex]);
                        const prevValue = columnIndex > 1 ? parseFloat(cols[columnIndex - 1]) : null;

                        rawValues[mnemonic] = { current: currentValue, prev: prevValue };

                        let displayValue;
                        if (isNaN(currentValue)) {
                            displayValue = 'N/A';
                        } else if (qoqVariables.has(mnemonic) && prevValue && !isNaN(prevValue)) {
                            // Calculate QoQ growth
                            const qoqGrowth = ((currentValue - prevValue) / prevValue) * 100;
                            displayValue = `${currentValue.toFixed(1)} (QoQ: ${qoqGrowth >= 0 ? '+' : ''}${qoqGrowth.toFixed(1)}%)`;
                        } else if (percentageVariables.has(mnemonic)) {
                            // Format as percentage with 1 decimal
                            displayValue = `${currentValue.toFixed(1)}%`;
                        } else {
                            // Regular number with 1 decimal
                            displayValue = currentValue.toFixed(1);
                        }

                        macroValues[variableMap[mnemonic]] = displayValue;
                    }
                }

                // Build summary text
                const summary = Object.entries(macroValues)
                    .map(([key, val]) => `${key}: ${val}`)
                    .join('\n');

                return {
                    summary,
                    usedLatest,
                    actualQuarter: usedLatest ? headers[columnIndex] : targetColumn,
                    values: macroValues
                };

            } catch (error) {
                console.error('Error loading macro data:', error);
                return null;
            }
        }

        function getFromCache(key) {
            try {
                const data = localStorage.getItem(key);
                if (!data) return null;
                const parsed = JSON.parse(data);
                if (isCacheValid(parsed)) {
                    console.log(`âœ“ Using cached ${key} (${Math.round((new Date() - new Date(parsed.timestamp)) / (1000 * 60 * 60 * 24))} days old)`);
                    return parsed.data;
                } else {
                    console.log(`âœ— Cache expired for ${key}`);
                    localStorage.removeItem(key);
                    return null;
                }
            } catch (e) {
                console.error('Cache read error:', e);
                return null;
            }
        }

        function saveToCache(key, data) {
            try {
                const cacheEntry = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                localStorage.setItem(key, JSON.stringify(cacheEntry));
                console.log(`âœ“ Saved to cache: ${key}`);
            } catch (e) {
                console.error('Cache save error:', e);
            }
        }

        // --- 3. TAVILY API INTEGRATION ---
        async function fetchTavilySearch(query, retries = 3, retryDelay = 1000) {
            // Define trusted domains for risk intelligence
            const RISK_INTELLIGENCE_DOMAINS = [
                // --- 1. GLOBAL FINANCIAL MAJORS ---
                'bloomberg.com', 'reuters.com', 'ft.com', 'wsj.com', 'cnbc.com',
                'economist.com', 'forbes.com', 'marketwatch.com', 'barrons.com',

                // --- 2. CANADIAN CORE ---
                'bankofcanada.ca', 'statcan.gc.ca', 'osfi-bsif.gc.ca', 'canada.ca',
                'theglobeandmail.com', 'financialpost.com', 'bnnbloomberg.ca', 'cbc.ca',
                'globalnews.ca', 'advisor.ca', 'investmentexecutive.com',
                'cmhc-schl.gc.ca', 'crea.ca', 'angusreid.org', 'nanos.co',
                'ibc.ca', 'publicsafety.gc.ca',

                // --- 3. SPECIALIZED RISK INTELLIGENCE ---
                'risk.net', 'rmahq.org', 'aba.com', 'garp.org', 'bis.org', 'imf.org',
                'wired.com', 'techcrunch.com', 'csoonline.com', 'darkreading.com',
                'thehackernews.com', 'cisa.gov', 'nist.gov',
                'foreignpolicy.com', 'foreignaffairs.com', 'eurasiagroup.net', 'csis.org',
                'caixinglobal.com', 'nikkei.com', 'aljazeera.com',
                'oilprice.com', 'iea.org',
                'whitehouse.gov', 'state.gov', 'ustr.gov', 'commerce.gov', 'senate.gov',
                'environmental-finance.com', 'wri.org', 'ipcc.ch',

                // --- 4. INSTITUTIONAL THINK TANKS ---
                'brookings.edu', 'piie.com', 'cdhowe.org', 'fraserinstitute.org', 'conferenceboard.ca'
            ];

            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    console.log(`ðŸ” Tavily search (attempt ${attempt}/${retries}): "${query}"`);

                    const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:5001' : '';

                    // Use local Flask proxy endpoint instead of direct Tavily API
                    const response = await fetch(`${API_BASE}/api/tavily/search`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: query,
                            search_depth: 'advanced',
                            topic: 'news',
                            max_results: 10,
                            include_answer: true,
                            include_raw_content: true,
                            include_text: true,
                            include_domains: RISK_INTELLIGENCE_DOMAINS
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Tavily API HTTP ${response.status}:`, errorText);

                        // If 503 or 429, retry with exponential backoff
                        if ((response.status === 503 || response.status === 429) && attempt < retries) {
                            const waitTime = retryDelay * Math.pow(2, attempt - 1);
                            console.log(`â³ Retrying in ${waitTime}ms...`);
                            await new Promise(r => setTimeout(r, waitTime));
                            continue;
                        }

                        throw new Error(`Tavily API error: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log(`âœ“ Tavily returned ${data.results?.length || 0} results from ${RISK_INTELLIGENCE_DOMAINS.length} trusted domains`);
                    return data.results || [];
                } catch (error) {
                    console.error(`âŒ Tavily search failed for "${query}" (attempt ${attempt}/${retries}):`, error);

                    // If last attempt, return empty array instead of throwing
                    if (attempt === retries) {
                        console.warn(`âš ï¸ Skipping query "${query}" after ${retries} attempts`);
                        return []; // Return empty results instead of failing
                    }

                    // Wait before retrying
                    const waitTime = retryDelay * Math.pow(2, attempt - 1);
                    await new Promise(r => setTimeout(r, waitTime));
                }
            }
            return []; // Fallback
        }


        const SHARED_DOSSIER_PATH = './stress_test_data/dossier_current.json';

        async function fetchMarketDossier(progressCallback) {
            // 1. Try to fetch from the SHARED SERVER FILE first
            try {
                const response = await fetch(SHARED_DOSSIER_PATH);
                if (response.ok) {
                    const fileData = await response.json();
                    if (isCacheValid(fileData)) {
                        console.log(`âœ“ Using SHARED SERVER dossier from ${SHARED_DOSSIER_PATH}`);
                        progressCallback && progressCallback('Using shared server market intelligence...');
                        // Update local cache to match server text
                        saveToCache(CACHE_KEY, fileData.data);
                        return fileData.data;
                    } else {
                        console.log('Shared server dossier is expired.');
                    }
                }
            } catch (e) {
                // Ignore if file doesn't exist
                console.log('No shared dossier found on server.');
            }

            // 2. Check LOCAL CACHE
            const cachedDossier = getFromCache(CACHE_KEY);
            if (cachedDossier) {
                progressCallback && progressCallback('Using cached market intelligence...');
                return cachedDossier;
            }

            // 3. Fallback: RETURN NULL (Do not auto-generate)
            console.log('No cached or shared dossier found. Waiting for user action.');
            return null;
        }

        async function generateNewMarketDossier(progressCallback) {
            progressCallback && progressCallback('Scanning market intelligence via Tavily API...');
            const dossier = {};
            const categories = Object.keys(TAVILY_QUERIES);
            let completed = 0;

            for (const category of categories) {
                const queries = TAVILY_QUERIES[category];
                dossier[category] = [];

                for (const query of queries) {
                    completed++;
                    progressCallback && progressCallback(
                        `Scanning: ${category.replace(/_/g, ' ')} (${completed}/${Object.values(TAVILY_QUERIES).flat().length})`
                    );

                    const results = await fetchTavilySearch(query);
                    for (const result of results) {
                        const fullText = result.raw_content || result.content || '';
                        dossier[category].push({
                            query: query,
                            title: result.title,
                            url: result.url,
                            content: fullText.substring(0, 20000),
                            date: result.published_date || 'Unknown'
                        });
                    }

                    // Rate limiting - 500ms between requests
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            // Save to cache
            saveToCache(CACHE_KEY, dossier);

            // PROMPT ADMIN TO SAVE TO SERVER
            setTimeout(() => {
                downloadDossierForServer(dossier);
            }, 1000);

            return dossier;
        }

        function downloadDossierForServer(dossier) {
            const cacheEntry = {
                timestamp: new Date().toISOString(),
                data: dossier
            };
            const blob = new Blob([JSON.stringify(cacheEntry, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dossier_current.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("New Market Dossier Generated!\n\nA 'dossier_current.json' file has been downloaded.\nPlease move this file to the 'stress_test_data' folder on the server to share it with other users.");
        }

        // --- 4. AI DRIVER GENERATION ---

        // Deduplication helper: Calculate text similarity between two strings
        function calculateSimilarity(str1, str2) {
            // Normalize strings: lowercase, remove punctuation, split into words
            const normalize = (s) => s.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w.length > 2);

            const words1 = new Set(normalize(str1));
            const words2 = new Set(normalize(str2));

            if (words1.size === 0 || words2.size === 0) return 0;

            // Jaccard similarity: intersection / union
            const intersection = [...words1].filter(w => words2.has(w)).length;
            const union = new Set([...words1, ...words2]).size;

            return intersection / union;
        }

        // Remove duplicate or highly similar drivers
        function deduplicateDrivers(drivers) {
            const uniqueDrivers = [];
            const removedDrivers = [];
            const SIMILARITY_THRESHOLD = 0.5; // 50% similar words = likely duplicate

            for (const driver of drivers) {
                let isDuplicate = false;
                let duplicateOf = null;

                for (const existing of uniqueDrivers) {
                    // Check title similarity
                    const titleSimilarity = calculateSimilarity(driver.title, existing.title);

                    // Check description similarity (weighted less)
                    const descSimilarity = calculateSimilarity(driver.desc || '', existing.desc || '');

                    // Combined similarity score (title is more important)
                    const combinedSimilarity = (titleSimilarity * 0.7) + (descSimilarity * 0.3);

                    if (combinedSimilarity >= SIMILARITY_THRESHOLD) {
                        isDuplicate = true;
                        duplicateOf = existing.title;
                        break;
                    }
                }

                if (isDuplicate) {
                    removedDrivers.push({ title: driver.title, duplicateOf });
                } else {
                    uniqueDrivers.push(driver);
                }
            }

            // Log removed duplicates for debugging
            if (removedDrivers.length > 0) {
                console.log(`ðŸ”„ Deduplication removed ${removedDrivers.length} duplicate drivers:`);
                removedDrivers.forEach(r => {
                    console.log(`   - "${r.title}" (duplicate of "${r.duplicateOf}")`);
                });
            }

            return uniqueDrivers;
        }

        const PROMPT_TEMPLATES = {
            RISK_DRIVERS: `You are an expert financial risk analyst. Based on the following EXTENSIVE market intelligence dossier from {{PERIOD_QUARTER}} {{PERIOD_YEAR}}, generate exactly 55 unique risk drivers that could impact Royal Bank of Canada (RBC) and the Canadian financial system. (We request 55 to allow for deduplication to reach exactly 50.)

{{PERIOD_CONTEXT}}

BASELINE MACROECONOMIC DATA ({{MACRO_PERIOD}}):
{{MACRO_SUMMARY}}

MARKET INTELLIGENCE DOSSIER:
{{DOSSIER_SUMMARY}}

Generate 55 risk drivers distributed across these categories:
- Macroeconomic (inflation, rates, growth): 11 drivers
- Geopolitical (wars, conflicts): 12 drivers
- Cyber / Tech (AI, cybersecurity, digital disruption): 7 drivers
- Financial (credit, liquidity, market stress): 9 drivers
- Environmental (climate, natural disasters): 6 drivers
- Regulatory (policy changes, compliance): 5 drivers
- Social (demographics, political stability): 5 drivers

CRITICAL: AVOID DUPLICATION
- Each driver MUST be UNIQUE - do not repeat the same risk topic with different wording
- Before generating each driver, check if a similar risk has already been covered
- Different aspects of the same event should be consolidated into ONE comprehensive driver, not split into multiple

For each driver, provide:
1. A concise title (4-8 words) using specific terminology from the search results.
2. A detailed description (50~100 words) explicitly determining the risk. CITE SPECIFIC DATA, percentages, or entities mentioned in the dossier. Explain HOW and WHY this risk could impact RBC and the Canadian financial system.
3. A sources array (up to 3 articles) that support this driver. Include the article title and URL from the dossier.

CRITICAL REQUIREMENTS - NEGATIVE RISKS ONLY:
**ONLY include ADVERSE/NEGATIVE risk drivers.** Do NOT include positive developments (e.g., "easing inflation", "strong earnings", "improved credit quality") disguised as risks.

CRITICAL ANTI-HALLUCINATION RULES:
1. **ZERO FABRICATION**: DO NOT invent country names, company names, legislation names, people's names or events. ONLY use entities explicitly mentioned in the dossier articles.
2. **VERIFY EVERY ENTITY**: Before including any proper noun (country, company, law, person), confirm it appears verbatim in the dossier text.
3. **NO WORD CREATION**: Do not create new words or terms. Use only real English words and proper nouns from the dossier.
4. **REAL GEOGRAPHY ONLY**: Use only actual country names that exist.
5. **SOURCE VALIDATION**: Every fact, number, and entity MUST have a corresponding source article.
6. **DEEP GROUNDING**: Every driver MUST quote or paraphrase actual content from the dossier articles.
7. **SPECIFICITY**: Include specific numbers, dates, company names, or legislation names.
8. **TIMING**: Ensure risks are appropriate for {{PERIOD_QUARTER}} {{PERIOD_YEAR}}.
9. **NO SPECULATION**: If the dossier lacks information on a topic, skip that category.

Format your response as a JSON array:
[
  {
    "id": "d1",
    "cat": "Macroeconomic",
    "title": "US-Canada Tariff Escalation",
    "desc": "Ongoing trade disputes regarding softwood lumber and dairy intensified in Q4, with new 15% tariffs proposed...",
    "sources": [
      {"title": "Reuters: US announces new tariffs on Canadian lumber", "url": "https://reuters.com/..."},
      {"title": "Globe and Mail: Trade tensions escalate", "url": "https://theglobeandmail.com/..."}
    ]
  }
]

Generate exactly 55 risk drivers. Return ONLY the JSON array, no additional text.`,

            RISK_DRIVERS_ADDITIONAL: `Generate 5 NEW {{CATEGORY}} risk drivers for RBC based on the market dossier.

AVOID DUPLICATES - These drivers already exist:
{{EXISTING_TITLES}}

MARKET DOSSIER:
{{DOSSIER_SUMMARY}}

Requirements:
- Completely different from existing drivers
- Use specific facts from dossier only
- Relevant to RBC and Canadian financial system
- Title: 4-8 words
- Description: 50-100 words with dossier data
- Sources: up to 2 articles with title and URL

Return ONLY this JSON array:
[
  {
    "id": "new_{{CATEGORY_SNAKE}}_1",
    "cat": "{{CATEGORY}}",
    "title": "Unique Risk Title",
    "desc": "Detailed description...",
    "sources": [{"title": "Article Title", "url": "https://..."}]
  }
]

Return exactly 5 drivers as JSON array only.`,

            HEATMAP_ASSESSMENT: `You are an expert risk analyst. For each of the following risk drivers, assess:
1. LIKELIHOOD (1-10): How likely is this risk to materialize with adverse outcomes for RBC? (1=very unlikely, 10=very likely)
2. MATERIALITY (1-10): What is the potential impact on RBC if this risk materializes? (1=minimal impact, 10=severe impact)
3. VELOCITY (1-3): the time elapsed between the materialization of a risk event and the point of RBC's impact (1=more than 3 months, 2=2 weeks to 3 months, 3=less than 2 weeks)

RISK DRIVERS TO ASSESS:
{{DRIVERS_LIST}}

Return a JSON array with assessments for each driver:
[
  {
    "id": "driver_id",
    "likelihood": 7,
    "materiality": 8,
    "velocity": 2,
    "likelihoodReasoning": "1-2 sentence justification for the likelihood score, explaining why this risk is likely/unlikely to materialize.",
    "materialityReasoning": "1-2 sentence justification for the materiality score, explaining the potential impact severity if the risk materializes.",
    "reasoning": "Brief summary (1-2 sentences) covering velocity and overall assessment for RBC."
  },
  ...
]

Be specific and realistic. Consider current market conditions and the severity described in each driver.
Provide clear, concise reasoning that explains the rationale behind EACH assessment dimension.
Return ONLY the JSON array.`,

            SCENARIO_GENERATION: `You are a Senior Chief Risk Officer for Royal Bank of Canada (RBC). Your task is to construct a concise, high-impact stress scenario narrative based on the specific risk drivers provided below.

CONTEXT:
{{BASELINE_CONTEXT}}

RISK DRIVERS TO MATERIALIZE:
{{DRIVERS_SUMMARY}}

SCENARIO STRUCTURE GUIDANCE:
- Overall Scenario Severity: {{SEVERITY}}
- Highest Priority Risks: {{HIGH_RISKS}}
- Immediate/Fast-Moving Threats: {{IMMEDIATE_THREATS}}
- Near-Term Threats: {{NEAR_TERM_THREATS}}

Generate a cohesive scenario narrative that combines these drivers into a plausible stress scenario. Your response must be a valid JSON object with the following structure:

{
  "scenarioTitle": "A compelling 3-6 word title for the scenario (e.g., 'Perfect Storm 2026' or 'Global Trade Collapse')",
  "globalConditions": {
    "summary": "2-3 paragraphs (HTML formatted with <p> tags and <strong> for emphasis) describing global economic and geopolitical conditions. Use severity guidance to calibrate tone. Do NOT mention likelihood/materiality scores.",
    "keyPoints": ["Point 1", "Point 2", "Point 3"]
  },
  "canadianConditions": {
    "summary": "2-3 paragraphs (HTML formatted) describing how these conditions impact the Canadian economy, housing market, and Bank of Canada policy.",
    "keyPoints": ["Point 1", "Point 2", "Point 3"]
  },
  "rbcImpact": {
    "summary": "2-3 paragraphs (HTML formatted) describing the direct impact on RBC's business lines including: Personal & Commercial Banking, Capital Markets, Wealth Management, and overall capital/liquidity position.",
    "keyPoints": ["Point 1", "Point 2", "Point 3"]
  },
  "macroProjections": {
    "canadaGDP": { "value": "-X.X%" },
    "unemployment": { "value": "X.X%" },
    "inflation": { "value": "X.X%" },
    "usdCad": { "value": "1.XX" },
    "bocRate": { "value": "X.X%" },
    "housePrice": { "value": "-XX%" },
    "tsx": { "value": "-XX%" },
    "creditSpreads": { "value": "XXX" }
  }
}

CRITICAL INSTRUCTIONS:
1. DO NOT mention "likelihood", "materiality", "velocity", or numerical scores (e.g., "7/10") in narrative text
2. Let severity guidance naturally inform how severe/urgent the narrative sounds
3. Use priority ordering to determine which risks to emphasize first
4. Use immediacy cues (immediate = "unfolding rapidly", near-term = "emerging", longer-term = "developing")
5. Connect risks into coherent narrative rather than listing them
6. Make scenario severity match guidance (SEVERE = deep recession -4% to -6% GDP, MODERATE = recession -2.5% to -4% GDP, MILD = slowdown -1% to -2% GDP)
7. Provide ONLY stress projection values. System will calculate deltas from baseline automatically.
8. Format summaries with proper HTML <p> tags and <strong> for emphasis

IMPORTANT: Only provide the STRESS/PROJECTION values. Do NOT include delta or direction fields. The system will automatically calculate deltas from baseline.

CRITICAL: For usdCad, use format "1.XX" representing CAD per 1 USD (e.g., 1.45 means 1 USD = 1.45 CAD). Higher values = weaker CAD.

Return ONLY the JSON object, no additional text.`
        };

        function fillPrompt(template, subs) {
            let result = template;
            for (const [key, val] of Object.entries(subs)) {
                result = result.split(`{{${key}}}`).join(val);
            }
            return result;
        }

        async function generateRiskDriversFromDossier(dossier, progressCallback, dossierId = 'current', periodInfo = null) {
            // Use dossier-specific cache key
            const dossierCacheKey = `${DRIVERS_CACHE_KEY}_${dossierId}`;

            // Check for cached drivers for THIS SPECIFIC dossier
            const cachedDrivers = getFromCache(dossierCacheKey);
            if (cachedDrivers && cachedDrivers.length >= 50) {
                progressCallback && progressCallback('Using cached risk drivers...');
                return cachedDrivers;
            }

            progressCallback && progressCallback('AI is analyzing market intelligence and generating risk drivers...');

            // Fetch baseline macro data from CSV
            const macroData = await fetchBaselineMacroData(periodInfo);

            // If using latest data (future quarter), notify user in chat
            if (macroData && macroData.usedLatest) {
                notifyScenarioAssistant(`ðŸ“Š Macro Data: ${periodInfo.quarter} ${periodInfo.year} is not available yet. Using latest available data from ${macroData.actualQuarter}.`);
            }

            // Summarize dossier for AI prompt - deep content WITH URLS
            const dossierSummary = Object.entries(dossier).map(([category, articles]) => {
                // Top 5 articles, but much deeper content (4000 chars ~ 800 words)
                const summaries = articles.slice(0, 5).map(a => `- [${a.title}](${a.url || '#'}): ${a.content?.substring(0, 4000)}...`).join('\n\n');
                return `## ${category.replace(/_/g, ' ')}\n${summaries}`;
            }).join('\n\n');            // Build period context for historical dossiers
            let periodContext = '';
            if (periodInfo && periodInfo.quarter && periodInfo.year) {
                periodContext = `
TIME PERIOD CONTEXT:
This dossier is from ${periodInfo.quarter} ${periodInfo.year}. Generate risk drivers that were RELEVANT and ACTIVE during this specific quarter.
Consider what major events, crises, or trends were occurring globally and in Canada during ${periodInfo.quarter} ${periodInfo.year}.
The drivers should reflect the actual risk environment of that time period.
`;
            }

            const prompt = fillPrompt(PROMPT_TEMPLATES.RISK_DRIVERS, {
                PERIOD_QUARTER: periodInfo?.quarter || 'current',
                PERIOD_YEAR: periodInfo?.year || 'period',
                PERIOD_CONTEXT: periodContext,
                MACRO_PERIOD: `${periodInfo?.quarter || 'Current'} ${periodInfo?.year || ''}`,
                MACRO_SUMMARY: macroData ? macroData.summary : 'Not available',
                DOSSIER_SUMMARY: dossierSummary
            });


            try {
                // Notify user that this may take several minutes for large dossiers
                progressCallback && progressCallback('ðŸ¤– AI is analyzing the dossier... This may take 5-10 minutes for comprehensive results.');

                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [{ role: 'user', content: prompt }],
                        // temperature omitted - GPT-5 only supports default value of 1
                        max_completion_tokens: 24000  // Optimized for quality while avoiding timeout (50 drivers)
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`âŒ API error ${response.status}: `, errorText);
                    throw new Error(`Azure OpenAI API error: ${response.status} `);
                }

                const data = await response.json();
                console.log('âœ“ API response received:', data);

                const aiResponse = data.choices[0].message.content;
                console.log('ðŸ“ AI response content (first 500 chars):', aiResponse.substring(0, 500));

                // Parse JSON from response
                let drivers = [];
                try {
                    const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        console.log('âœ“ Found JSON array in response');
                        drivers = JSON.parse(jsonMatch[0]);
                    } else {
                        console.log('âš ï¸  No JSON array pattern found, trying direct parse');
                        drivers = JSON.parse(aiResponse);
                    }
                    console.log(`âœ“ Parsed ${drivers.length} drivers from AI response`);
                } catch (parseError) {
                    console.error('âŒ JSON parse error:', parseError);
                    console.error('Raw AI response:', aiResponse);
                    throw new Error('Failed to parse AI response');
                }

                // Deduplicate drivers based on title similarity
                progressCallback && progressCallback('Removing duplicate risk drivers...');
                drivers = deduplicateDrivers(drivers);
                console.log(`âœ“ After deduplication: ${drivers.length} unique drivers`);

                // Ensure exactly 50 drivers (trim if we have more, warn if we have less)
                const TARGET_DRIVER_COUNT = 50;
                if (drivers.length > TARGET_DRIVER_COUNT) {
                    console.log(`âœ“ Trimming from ${drivers.length} to ${TARGET_DRIVER_COUNT} drivers`);
                    drivers = drivers.slice(0, TARGET_DRIVER_COUNT);
                } else if (drivers.length < TARGET_DRIVER_COUNT) {
                    console.warn(`âš ï¸ Only ${drivers.length} unique drivers available(target: ${TARGET_DRIVER_COUNT})`);
                }

                // Add colors, chat history, and preserve sources to each driver
                drivers = drivers.map((d, idx) => {
                    const colors = CATEGORY_COLORS[d.cat] || { tagColor: '#E5E7EB', textColor: '#374151' };
                    return {
                        ...d,
                        id: d.id || `ai_${idx + 1} `,
                        tagColor: colors.tagColor,
                        textColor: colors.textColor,
                        chatHistory: [],
                        sources: d.sources || [] // Preserve sources from AI response
                    };
                });

                // Cache the generated drivers for this specific dossier
                saveToCache(dossierCacheKey, drivers);
                return drivers;

            } catch (error) {
                console.error('AI driver generation failed:', error);
                throw error;
            }
        }

        // Add more drivers to a specific category
        async function addMoreDriversForCategory(category, skipDossierCheck = false, loadedDossier = null) {
            // Use the loaded dossier if provided, otherwise get from cache
            let dossier = loadedDossier || getFromCache(CACHE_KEY);

            // If not in main cache, check if we're using a historical dossier
            if (!dossier && currentDossierId !== 'current') {
                const storedDossier = localStorage.getItem(`astra_dossier_${currentDossierId}`);
                if (storedDossier) {
                    const parsed = JSON.parse(storedDossier);
                    dossier = parsed.dossier || parsed.rawDossier;
                }
            }

            // If no dossier found and not skipping the check, ask user what to do
            if (!dossier && !skipDossierCheck) {
                const choice = confirm(
                    `No market dossier found in cache.\n\n` +
                    `Click OK to load a dossier file from your computer.\n` +
                    `Click Cancel to generate drivers based on existing risk drivers only.`
                );

                if (choice) {
                    // User wants to load a dossier file
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        const loader = document.getElementById('loader');
                        const loaderText = document.getElementById('loaderText');
                        loader.style.display = 'flex';
                        loaderText.innerText = `Loading ${file.name}...`;

                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const data = JSON.parse(event.target.result);
                                let extractedDossier = null;

                                // Check if it's a raw dossier
                                if (data.data && data.timestamp) {
                                    extractedDossier = data.data;
                                    // Try to save to cache, but don't fail if quota exceeded
                                    try {
                                        saveToCache(CACHE_KEY, data.data);
                                    } catch (cacheError) {
                                        console.warn('Could not cache dossier (quota exceeded), using in-memory only');
                                    }
                                } else if (data.rawDossier) {
                                    extractedDossier = data.rawDossier;
                                    try {
                                        saveToCache(CACHE_KEY, data.rawDossier);
                                    } catch (cacheError) {
                                        console.warn('Could not cache dossier (quota exceeded), using in-memory only');
                                    }
                                } else {
                                    loader.style.display = 'none';
                                    alert('Invalid dossier file format. Please select a valid market dossier file.');
                                    return;
                                }

                                loaderText.innerText = `âœ“ ${file.name} loaded! Generating new drivers...`;
                                // Pass the dossier directly to avoid cache dependency
                                await addMoreDriversForCategory(category, true, extractedDossier);
                            } catch (err) {
                                loader.style.display = 'none';
                                alert('Error loading dossier file: ' + err.message);
                            }
                        };
                        reader.readAsText(file);
                    };
                    fileInput.click();
                    return; // Exit and wait for file load
                }
                // User chose Cancel - continue with existing drivers as context
            }

            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loaderText');

            loader.style.display = 'flex';
            loaderText.innerText = `Generating more ${category} risk drivers...`;

            try {
                // Build dossier summary
                let dossierSummary = '';
                if (!dossier) {
                    // Use existing drivers as context
                    const existingByCategory = {};
                    INITIAL_DRIVERS.forEach(d => {
                        if (!existingByCategory[d.cat]) existingByCategory[d.cat] = [];
                        existingByCategory[d.cat].push(`- ${d.title}: ${d.desc?.substring(0, 200)}`);
                    });

                    dossierSummary = Object.entries(existingByCategory).map(([cat, items]) => {
                        return `## ${cat}\n${items.slice(0, 5).join('\n')}`;
                    }).join('\n\n');

                    if (!dossierSummary) {
                        loader.style.display = 'none';
                        alert('No market intelligence available. Please generate or import a market dossier first.');
                        return;
                    }

                    console.log('Using existing drivers as context (no dossier available)');
                } else {
                    // Summarize dossier for AI prompt
                    console.log('Building dossier summary from loaded dossier');
                    if (!dossier || typeof dossier !== 'object') {
                        console.error('Invalid dossier object:', dossier);
                        loader.style.display = 'none';
                        alert('Invalid dossier data. Please load a valid dossier file.');
                        return;
                    }

                    // Use same dossier summary format as 50-driver generation
                    dossierSummary = Object.entries(dossier).map(([cat, articles]) => {
                        if (!articles || !Array.isArray(articles)) {
                            console.warn(`Invalid articles for category ${cat}:`, articles);
                            return '';
                        }
                        // Top 5 articles, 4000 chars each (same as 50-driver generation)
                        const summaries = articles.slice(0, 5).map(a => `- [${a.title}](${a.url || '#'}): ${a.content?.substring(0, 4000)}...`).join('\n\n');
                        return `## ${cat.replace(/_/g, ' ')}\n${summaries}`;
                    }).join('\n\n');

                    console.log(`Dossier summary length: ${dossierSummary.length} characters`);
                }

                // Get existing drivers for this category
                const existingDrivers = INITIAL_DRIVERS.filter(d => d.cat === category);
                const existingTitles = existingDrivers.map(d => d.title);

                const prompt = fillPrompt(PROMPT_TEMPLATES.RISK_DRIVERS_ADDITIONAL, {
                    CATEGORY: category,
                    EXISTING_TITLES: existingTitles.map((t, i) => `${i + 1}."${t}"`).join('\n'),
                    DOSSIER_SUMMARY: dossierSummary,
                    CATEGORY_SNAKE: category.toLowerCase().replace(/\s+/g, '_')
                });


                loaderText.innerText = `Sending request to AI for ${category} risk drivers...`;

                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [{ role: 'user', content: prompt }],
                        max_completion_tokens: 8000  // Match 50-driver generation approach
                    })
                });

                loaderText.innerText = `Processing AI response...`;

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                console.log('API Response received:', data);
                console.log('Choices array:', data.choices);
                console.log('First choice:', data.choices?.[0]);
                console.log('Message object:', data.choices?.[0]?.message);
                console.log('Finish reason:', data.choices?.[0]?.finish_reason);

                // Validate response structure
                if (!data || !data.choices || !data.choices[0]) {
                    console.error('Invalid API response structure:', data);
                    throw new Error('Invalid response from AI service. Please try again.');
                }

                const firstChoice = data.choices[0];

                // Check if response was truncated
                if (firstChoice.finish_reason === 'length') {
                    console.warn('Response was truncated due to max_tokens limit');
                    throw new Error('AI response was truncated. Please try again or reduce the complexity of your request.');
                }

                // Handle different response formats
                let aiResponse;

                // Try different possible response structures
                if (firstChoice.message?.content) {
                    aiResponse = firstChoice.message.content;
                } else if (firstChoice.text) {
                    aiResponse = firstChoice.text;
                } else if (firstChoice.content) {
                    aiResponse = firstChoice.content;
                } else if (typeof firstChoice === 'string') {
                    aiResponse = firstChoice;
                }

                console.log('AI Response content:', aiResponse);
                console.log('AI Response type:', typeof aiResponse);
                console.log('AI Response length:', aiResponse?.length);

                if (!aiResponse) {
                    console.error('Empty AI response. Full first choice:', JSON.stringify(firstChoice, null, 2));
                    throw new Error('AI returned empty response. The response may have been filtered or truncated.');
                }

                loaderText.innerText = 'Parsing new risk drivers...';

                // Parse JSON from response
                let newDrivers = [];
                try {
                    if (!aiResponse || typeof aiResponse !== 'string') {
                        console.error('Invalid aiResponse:', aiResponse);
                        throw new Error('AI response is not a valid string');
                    }

                    const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        newDrivers = JSON.parse(jsonMatch[0]);
                    } else {
                        newDrivers = JSON.parse(aiResponse);
                    }

                    if (!Array.isArray(newDrivers)) {
                        throw new Error('AI response did not contain a valid array of drivers');
                    }
                } catch (parseError) {
                    console.error('Parse error:', parseError);
                    console.error('AI Response was:', aiResponse);
                    throw new Error(`Failed to parse AI response: ${parseError.message}`);
                }

                loaderText.innerText = `Checking ${newDrivers.length} new drivers for duplicates...`;

                // Deduplicate against ALL existing drivers (not just this category)
                const allExistingDrivers = INITIAL_DRIVERS;
                newDrivers = newDrivers.filter(newDriver => {
                    for (const existing of allExistingDrivers) {
                        const similarity = calculateSimilarity(newDriver.title, existing.title);
                        if (similarity >= 0.4) { // Slightly stricter threshold for new additions
                            console.log(`ðŸ”„ Filtered duplicate: "${newDriver.title}" similar to "${existing.title}"`);
                            return false;
                        }
                    }
                    return true;
                });

                if (newDrivers.length === 0) {
                    loader.style.display = 'none';
                    alert(`All generated drivers were too similar to existing ones. Try again or the category may be saturated.`);
                    return;
                }

                // Add colors and metadata to new drivers
                const colors = CATEGORY_COLORS[category] || { tagColor: '#E5E7EB', textColor: '#374151' };
                const timestamp = Date.now();
                newDrivers = newDrivers.map((d, idx) => ({
                    ...d,
                    id: `add_${category.toLowerCase().replace(/\s+/g, '_')}_${timestamp}_${idx}`,
                    cat: category,
                    tagColor: colors.tagColor,
                    textColor: colors.textColor,
                    chatHistory: [],
                    sources: d.sources || []
                }));

                // Add to INITIAL_DRIVERS
                INITIAL_DRIVERS.push(...newDrivers);

                // Update cache
                const dossierCacheKey = `${DRIVERS_CACHE_KEY}_${currentDossierId}`;
                saveToCache(dossierCacheKey, INITIAL_DRIVERS);

                loader.style.display = 'none';

                // Re-render marketplace
                renderMarketplace();

                // Show success message
                const successMsg = `âœ… Added ${newDrivers.length} new ${category} risk driver${newDrivers.length > 1 ? 's' : ''}!`;
                console.log(successMsg);

                // Optional: Show a toast or brief notification
                alert(successMsg);

            } catch (error) {
                console.error('Error adding more drivers:', error);
                console.error('Error stack:', error.stack);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                loader.style.display = 'none';
                alert(`Failed to generate more drivers: ${error.message || error.toString()}`);
            }
        }

        // --- 5. INITIALIZATION ---
        async function initializeApp() {
            if (isInitializing) return;
            isInitializing = true;

            // Load saved dossiers list for the dropdown
            loadDossiersList();

            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loaderText');
            loader.style.display = 'flex'; // Ensure loader is visible during initial checks
            loaderText.innerText = 'Checking for cached market intelligence...';

            try {
                // Check if we have valid cached drivers
                const cachedDrivers = getFromCache(`${DRIVERS_CACHE_KEY}_current`);
                if (cachedDrivers && cachedDrivers.length >= 50) {
                    INITIAL_DRIVERS = cachedDrivers;
                    console.log(`âœ“ Loaded ${INITIAL_DRIVERS.length} risk drivers from cache`);
                    updateConnectionStatus(true, 'Cached');
                    loader.style.display = 'none';
                    showMarketplace();
                } else {
                    // Try to fetch shared dossier ONLY (passive check)
                    loaderText.innerText = 'Checking for shared market intelligence file...';
                    const dossier = await fetchMarketDossier((msg) => loaderText.innerText = msg);

                    if (dossier) {
                        // Found shared file or cache! Proceed normally.
                        loaderText.innerText = 'Generating AI-powered risk drivers...';
                        INITIAL_DRIVERS = await generateRiskDriversFromDossier(dossier, (msg) => {
                            loaderText.innerText = msg;
                        }, 'current');

                        console.log(`âœ“ Generated ${INITIAL_DRIVERS.length} risk drivers`);
                        updateConnectionStatus(true, 'Live');
                        loader.style.display = 'none';
                        showMarketplace();
                    } else {
                        // NO DATA FOUND. STOP. Show "Start Screen".
                        loader.style.display = 'none';
                        showStartScreen();
                    }
                }

                // Load and merge custom drivers from localStorage
                loadCustomDrivers();

                // Load saved scenarios from localStorage
                loadSavedScenarios();

            } catch (error) {
                console.error('Initialization error:', error);
                loaderText.innerText = `Error: ${error.message}. Loading fallback drivers...`;
                await new Promise(r => setTimeout(r, 2000));

                // Fallback to default drivers
                INITIAL_DRIVERS = getDefaultDrivers();
                updateConnectionStatus(false, 'Offline');
                loader.style.display = 'none';
                showMarketplace();

                // Still load custom drivers and saved scenarios
                loadCustomDrivers();
                loadSavedScenarios();

            } finally {
                isInitializing = false;
            }
        }

        function updateConnectionStatus(connected, mode) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('connectionStatusText');

            if (statusDot && statusText) {
                if (connected) {
                    statusDot.style.background = '#10B981';
                    statusText.innerText = `${mode} - Connected to Tavily API`;
                } else {
                    statusDot.style.background = '#F59E0B';
                    statusText.innerText = `${mode} - Using Fallback Data`;
                }
            }
        }

        function getDefaultDrivers() {
            // Fallback drivers if API fails
            return [
                { id: 'm1', cat: 'Macroeconomic', title: 'US-Canada Tariff Escalation', desc: 'Trump administration increases tariffs from 25% to 35% on Canadian imports, disrupting trade relations.', tagColor: '#DBEAFE', textColor: '#1E40AF', chatHistory: [] },
                { id: 'm2', cat: 'Macroeconomic', title: 'Canada Inflation Above Target', desc: 'CPI inflation at 2.4%, overshooting Bank of Canada\'s 2% threshold amid persistent price pressures.', tagColor: '#DBEAFE', textColor: '#1E40AF', chatHistory: [] },
                { id: 'm3', cat: 'Macroeconomic', title: 'Household Debt Vulnerability', desc: 'Debt-to-income ratio at 173%, leaving households exposed to rate volatility despite recent declines.', tagColor: '#DBEAFE', textColor: '#1E40AF', chatHistory: [] },
                { id: 'm4', cat: 'Macroeconomic', title: 'CBO Growth Downgrade', desc: 'Congressional Budget Office projects only 1.4% US growth in 2025, signaling economic slowdown.', tagColor: '#DBEAFE', textColor: '#1E40AF', chatHistory: [] },
                { id: 'm5', cat: 'Macroeconomic', title: 'US Debt Ceiling Uncertainty', desc: 'Treasury extraordinary measures strain after $5T ceiling raise, risking future fiscal crises.', tagColor: '#DBEAFE', textColor: '#1E40AF', chatHistory: [] },
                { id: 'g1', cat: 'Geopolitical', title: 'USMCA 2026 Review Risk', desc: 'Upcoming USMCA joint review in July 2026 creates trade policy uncertainty for Canada.', tagColor: '#FEE2E2', textColor: '#991B1B', chatHistory: [] },
                { id: 'g2', cat: 'Geopolitical', title: 'Foreign Interference Threat', desc: 'CSIS reports increasing foreign interference targeting Canadian democratic and economic institutions.', tagColor: '#FEE2E2', textColor: '#991B1B', chatHistory: [] },
                { id: 'g3', cat: 'Geopolitical', title: 'US Semiconductor Restrictions', desc: 'Commerce Department Section 232 investigations threaten semiconductor supply chains and AI development.', tagColor: '#FEE2E2', textColor: '#991B1B', chatHistory: [] },
                { id: 'g4', cat: 'Geopolitical', title: 'US Isolationism Wave', desc: 'America-first policies force Canada to recalibrate foreign policy and economic partnerships.', tagColor: '#FEE2E2', textColor: '#991B1B', chatHistory: [] },
                { id: 'g5', cat: 'Geopolitical', title: 'Shipping Route Disruption', desc: 'Freightos Baltic Index shows Red Sea diversions continue affecting global supply chains.', tagColor: '#FEE2E2', textColor: '#991B1B', chatHistory: [] },
                { id: 'c1', cat: 'Cyber / Tech', title: 'Ransomware Financial Sector', desc: 'CISA reports Medusa and Akira ransomware groups targeting financial institutions in 2025.', tagColor: '#E0E7FF', textColor: '#4338CA', chatHistory: [] },
                { id: 'c2', cat: 'Cyber / Tech', title: 'AI Risk Framework Adoption', desc: 'NIST AI RMF 2025 updates require banks to operationalize AI governance rapidly.', tagColor: '#E0E7FF', textColor: '#4338CA', chatHistory: [] },
                { id: 'c3', cat: 'Cyber / Tech', title: 'Record Crypto Theft', desc: 'Chainalysis reports $2.17B stolen in crypto hacks by mid-2025, including $1.5B Bybit heist.', tagColor: '#E0E7FF', textColor: '#4338CA', chatHistory: [] },
                { id: 'c4', cat: 'Cyber / Tech', title: 'DeFi Protocol Exploits', desc: 'October 2025 saw $38.6M lost across 9 DeFi exploits targeting DEXes and yield aggregators.', tagColor: '#E0E7FF', textColor: '#4338CA', chatHistory: [] },
                { id: 'c5', cat: 'Cyber / Tech', title: 'AI Labor Displacement', desc: 'OECD warns AI adoption may accelerate labor market shifts despite record employment.', tagColor: '#E0E7FF', textColor: '#4338CA', chatHistory: [] },
                { id: 'f1', cat: 'Financial', title: 'Housing Price Correction', desc: 'Toronto house prices down 7.9% YTD, Vancouver down 4.5% as Teranet Index shows continued weakness.', tagColor: '#D1FAE5', textColor: '#065F46', chatHistory: [] },
                { id: 'f2', cat: 'Financial', title: 'Credit Loss Provisions Rising', desc: 'TD and BMO Q3 2025 show elevated PCL trends, signaling credit quality deterioration.', tagColor: '#D1FAE5', textColor: '#065F46', chatHistory: [] },
                { id: 'f3', cat: 'Financial', title: 'OSFI Crypto Guidelines', desc: 'OSFI October 2025 allows greater crypto exposure but imposes strict capital treatment rules.', tagColor: '#D1FAE5', textColor: '#065F46', chatHistory: [] },
                { id: 'f4', cat: 'Financial', title: 'Negative Swap Spreads', desc: 'Bank of Canada notes negative swap spreads signal market stress and demand for government bonds.', tagColor: '#D1FAE5', textColor: '#065F46', chatHistory: [] },
                { id: 'f5', cat: 'Financial', title: 'RBC Q3 Record Earnings', desc: 'RBC reports $5.4B Q3 earnings but faces questions on capital allocation amid uncertainty.', tagColor: '#D1FAE5', textColor: '#065F46', chatHistory: [] },
                { id: 'e1', cat: 'Environmental', title: 'Record NatCat Losses', desc: 'Swiss Re reports $137B global insured losses in 2024, Canada\'s worst-ever catastrophe year at $9B.', tagColor: '#FEF3C7', textColor: '#92400E', chatHistory: [] },
                { id: 'e2', cat: 'Environmental', title: 'Wildfire Season 2026', desc: 'La NiÃ±a pattern suggests continued elevated fire risk for Canada through January 2026.', tagColor: '#FEF3C7', textColor: '#92400E', chatHistory: [] },
                { id: 'e3', cat: 'Environmental', title: 'OSFI B-15 Climate Rules', desc: 'Updated B-15 guidelines align with CSSB standards, requiring enhanced climate risk disclosure.', tagColor: '#FEF3C7', textColor: '#92400E', chatHistory: [] },
                { id: 'e4', cat: 'Environmental', title: 'Peak Loss Year Risk', desc: 'Swiss Re estimates 10% probability of $300B global insured losses in 2025.', tagColor: '#FEF3C7', textColor: '#92400E', chatHistory: [] },
                { id: 'e5', cat: 'Environmental', title: 'California Wildfire Contagion', desc: 'LA wildfires contribute $40B insured losses, impacting reinsurance market globally.', tagColor: '#FEF3C7', textColor: '#92400E', chatHistory: [] },
                { id: 's1', cat: 'Social', title: 'Housing Supply Gap', desc: 'PBO estimates 658,000 unit housing gap in Canada by 2030 despite reduced immigration targets.', tagColor: '#F3E8FF', textColor: '#6B21A8', chatHistory: [] },
                { id: 's2', cat: 'Social', title: 'US Political Instability', desc: 'Pew Research shows public trust at 17%, Democrats frustration with party up sharply.', tagColor: '#F3E8FF', textColor: '#6B21A8', chatHistory: [] },
                { id: 's3', cat: 'Social', title: 'Immigration Policy Reversal', desc: 'Canada reduces immigration targets after expanding to 500,000, affecting housing demand.', tagColor: '#F3E8FF', textColor: '#6B21A8', chatHistory: [] },
                { id: 's4', cat: 'Social', title: 'Liberal Electoral Shift', desc: 'Angus Reid shows Liberals at 46% support, potential policy shifts under Carney government.', tagColor: '#F3E8FF', textColor: '#6B21A8', chatHistory: [] },
                { id: 's5', cat: 'Social', title: 'Political Polarization', desc: 'Growing partisan divides in both US and Canada increase policy uncertainty.', tagColor: '#F3E8FF', textColor: '#6B21A8', chatHistory: [] },
                { id: 'r1', cat: 'Regulatory', title: 'OSFI Integrity Risk Priority', desc: 'OSFI Annual Risk Outlook 2025-26 elevates integrity and security risk as top priority.', tagColor: '#E5E7EB', textColor: '#374151', chatHistory: [] },
                { id: 'r2', cat: 'Regulatory', title: 'FINTRAC Real Estate Penalties', desc: 'FINTRAC imposes five AMPs on real estate brokerages, signaling enforcement acceleration.', tagColor: '#E5E7EB', textColor: '#374151', chatHistory: [] },
                { id: 'r3', cat: 'Regulatory', title: 'NSF Fee Restrictions', desc: 'March 2026 Bank Act amendments limit NSF fees for personal deposit accounts.', tagColor: '#E5E7EB', textColor: '#374151', chatHistory: [] },
                { id: 'r4', cat: 'Regulatory', title: 'Wholesale Credit Stress', desc: 'OSFI flags elevated wholesale credit risks from macroeconomic uncertainties.', tagColor: '#E5E7EB', textColor: '#374151', chatHistory: [] },
                { id: 'r5', cat: 'Regulatory', title: 'Funding Liquidity Concerns', desc: 'OSFI identifies funding and liquidity risks amid market volatility and rate uncertainty.', tagColor: '#E5E7EB', textColor: '#374151', chatHistory: [] }
            ];
        }

        // Force refresh function (for testing/manual refresh)
        async function forceRefreshDrivers() {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(DRIVERS_CACHE_KEY);
            // Don't remove custom drivers - only refresh AI-generated ones
            const customDrivers = INITIAL_DRIVERS.filter(d => d.id.startsWith('cust_'));
            INITIAL_DRIVERS = [];
            isInitializing = false;
            await initializeApp();
        }

        // --- DOSSIER MANAGEMENT ---
        function loadDossiersList() {
            try {
                const stored = localStorage.getItem(DOSSIERS_LIST_KEY);
                if (stored) {
                    dossiersList = JSON.parse(stored);
                    updateDossierSelector();
                }
            } catch (e) {
                console.error('Failed to load dossiers list:', e);
                dossiersList = [];
            }
        }

        function saveDossiersList() {
            try {
                localStorage.setItem(DOSSIERS_LIST_KEY, JSON.stringify(dossiersList));
            } catch (e) {
                console.error('Failed to save dossiers list:', e);
            }
        }

        function updateDossierSelector() {
            const selector = document.getElementById('dossierSelector');
            if (!selector) return;

            // Keep current option, add historical dossiers
            selector.innerHTML = '<option value="current">Current (Live)</option>';

            dossiersList.forEach(d => {
                const option = document.createElement('option');
                option.value = d.id;
                option.textContent = `${d.quarter} ${d.year}`;
                if (d.id === currentDossierId) option.selected = true;
                selector.appendChild(option);
            });
        }

        function showGenerateDossierModal() {
            document.getElementById('generateDossierModal').style.display = 'flex';
            document.getElementById('dossierGenerationStatus').style.display = 'none';
            document.getElementById('generateDossierBtn').disabled = false;
        }

        function closeGenerateDossierModal() {
            document.getElementById('generateDossierModal').style.display = 'none';
        }

        async function generateHistoricalDossier() {
            const quarter = document.getElementById('dossierQuarter').value;
            const year = document.getElementById('dossierYear').value;
            const dossierId = `${quarter}_${year}`;

            // Check if dossier already exists
            if (dossiersList.some(d => d.id === dossierId)) {
                if (!confirm(`A dossier for ${quarter} ${year} already exists. Generate a new one and replace it?`)) {
                    return;
                }
            }

            // Show loading state
            document.getElementById('dossierGenerationStatus').style.display = 'block';
            document.getElementById('generateDossierBtn').disabled = true;
            const statusText = document.getElementById('dossierGenerationText');

            try {
                // Generate date range for the quarter
                const dateRange = getQuarterDateRange(quarter, year);

                statusText.innerText = `Searching Tavily for ${quarter} ${year} data...`;

                // Fetch historical dossier with date context
                const dossier = await fetchHistoricalDossier(quarter, year, dateRange, (msg) => {
                    statusText.innerText = msg;
                });

                // Generate drivers from the historical dossier
                statusText.innerText = 'Generating risk drivers from historical data...';
                const periodInfo = { quarter: quarter, year: year };
                const drivers = await generateRiskDriversFromDossier(dossier, (msg) => {
                    statusText.innerText = msg;
                }, dossierId, periodInfo);

                // Store the dossier
                const dossierData = {
                    id: dossierId,
                    quarter: quarter,
                    year: year,
                    dateRange: dateRange,
                    createdAt: new Date().toISOString(),
                    dossier: dossier,
                    drivers: drivers
                };

                // Save to localStorage
                localStorage.setItem(`astra_dossier_${dossierId}`, JSON.stringify(dossierData));

                // Update dossiers list
                const existingIdx = dossiersList.findIndex(d => d.id === dossierId);
                if (existingIdx > -1) {
                    dossiersList[existingIdx] = { id: dossierId, quarter, year, createdAt: dossierData.createdAt };
                } else {
                    dossiersList.push({ id: dossierId, quarter, year, createdAt: dossierData.createdAt });
                }
                saveDossiersList();
                updateDossierSelector();

                // Switch to the new dossier
                document.getElementById('dossierSelector').value = dossierId;
                await loadSelectedDossier();

                closeGenerateDossierModal();
                alert(`âœ“ Dossier for ${quarter} ${year} generated successfully!`);

            } catch (error) {
                console.error('Dossier generation error:', error);
                statusText.innerText = `Error: ${error.message}`;
                await new Promise(r => setTimeout(r, 2000));
            } finally {
                document.getElementById('dossierGenerationStatus').style.display = 'none';
                document.getElementById('generateDossierBtn').disabled = false;
            }
        }

        function getQuarterDateRange(quarter, year) {
            const ranges = {
                'Q1': { start: `${year}-01-01`, end: `${year}-03-31` },
                'Q2': { start: `${year}-04-01`, end: `${year}-06-30` },
                'Q3': { start: `${year}-07-01`, end: `${year}-09-30` },
                'Q4': { start: `${year}-10-01`, end: `${year}-12-31` }
            };
            return ranges[quarter];
        }

        async function fetchHistoricalDossier(quarter, year, dateRange, progressCallback) {
            const dossier = {};

            // Generate date-specific queries using the dynamic context function
            // Use historical query set for periods before 2024
            const historicalContext = getDynamicContext(year, quarter);
            const isHistorical = parseInt(year) < 2025;
            const historicalQueries = getTavilyQueries(historicalContext, isHistorical);

            console.log(`ðŸ“… Generating ${isHistorical ? 'HISTORICAL' : 'CURRENT'} queries for ${quarter} ${year}`);

            const categories = Object.keys(historicalQueries);
            let queryCount = 0;
            const totalQueries = Object.values(historicalQueries).reduce((sum, arr) => sum + arr.length, 0);

            // Track seen URLs to prevent duplicates across all queries
            const seenUrls = new Set();
            let duplicatesSkipped = 0;

            progressCallback(`Generating ${totalQueries} queries for ${quarter} ${year}...`);

            for (const category of categories) {
                dossier[category] = [];
                const queries = historicalQueries[category];

                for (const query of queries) {
                    queryCount++;
                    progressCallback(`[${queryCount}/${totalQueries}] Searching: ${category.replace(/_/g, ' ')}...`);

                    try {
                        const results = await fetchTavilySearchWithDate(query, dateRange);

                        // Add only unique articles (not seen before)
                        for (const r of results) {
                            if (!seenUrls.has(r.url)) {
                                seenUrls.add(r.url);
                                dossier[category].push({
                                    query: query,
                                    title: r.title,
                                    url: r.url,
                                    content: r.content,
                                    date: r.published_date || `${quarter} ${year}`
                                });
                            } else {
                                duplicatesSkipped++;
                            }
                        }
                    } catch (error) {
                        console.error(`Search failed for ${query}:`, error);
                    }

                    // Rate limiting - same as Python script
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            console.log(`ðŸ“Š Dossier complete. Skipped ${duplicatesSkipped} duplicate articles.`);
            return dossier;
        }

        async function fetchTavilySearchWithDate(query, dateRange) {
            try {
                const targetYear = dateRange ? parseInt(dateRange.start.split('-')[0]) : null;

                // Trusted Canadian financial and news sources for better historical data
                const trustedDomains = [
                    'bankofcanada.ca',
                    'statcan.gc.ca',
                    'reuters.com',
                    'bloomberg.com',
                    'cbc.ca',
                    'globalnews.ca',
                    'financialpost.com',
                    'theglobeandmail.com',
                    'bnnbloomberg.ca',
                    'rbc.com'
                ];

                // Build request with Tavily's date filtering
                const requestBody = {
                    api_key: TAVILY_API_KEY,
                    query: query,
                    search_depth: 'advanced',
                    topic: 'news',  // Use news topic for better date filtering and published_date metadata
                    max_results: 20,  // Request more since we'll filter strictly
                    include_answer: false,
                    include_raw_content: false,
                    include_domains: trustedDomains  // Focus on trusted sources
                };

                // Add date filtering for historical queries
                if (dateRange && dateRange.start && dateRange.end) {
                    requestBody.start_date = dateRange.start;  // YYYY-MM-DD format
                    requestBody.end_date = dateRange.end;      // YYYY-MM-DD format
                    console.log(`ðŸ“… Tavily request: topic=news, date=${dateRange.start} to ${dateRange.end}, domains=${trustedDomains.length} trusted`);
                }

                // Use local Flask proxy endpoint
                const response = await fetch(`${API_BASE_URL}/api/tavily/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Tavily error response:', errorText);
                    throw new Error(`Tavily error: ${response.status}`);
                }

                const data = await response.json();
                let results = data.results || [];

                console.log(`ðŸ“Š Tavily returned ${results.length} raw results`);

                // STRICT POST-RETRIEVAL DATE VALIDATION
                // Tavily's date filtering may not work for historical queries, so we validate strictly
                if (targetYear && results.length > 0) {
                    const validatedResults = results.filter(r => {
                        // STRICT: Reject articles without published_date
                        // Articles without dates are likely modern content that Tavily returned incorrectly
                        if (!r.published_date) {
                            console.log(`  âŒ No date (rejected): ${r.title?.substring(0, 40)}...`);
                            return false;
                        }

                        const pubDate = new Date(r.published_date);
                        const pubYear = pubDate.getFullYear();

                        // STRICT: Only accept if published in the TARGET YEAR
                        // No Â±1 year flexibility - if we asked for 2023, we want 2023 articles
                        if (pubYear === targetYear) {
                            console.log(`  âœ“ Valid (${pubYear}): ${r.title?.substring(0, 40)}...`);
                            return true;
                        }

                        // Allow Q4 content published in early Q1 of next year (common for economic reports)
                        if (pubYear === targetYear + 1) {
                            const pubMonth = pubDate.getMonth() + 1; // 0-indexed
                            if (pubMonth <= 3) { // Jan, Feb, Mar
                                console.log(`  âœ“ Valid (early ${pubYear}, likely Q4 report): ${r.title?.substring(0, 40)}...`);
                                return true;
                            }
                        }

                        console.log(`  âŒ Wrong year (${pubYear}): ${r.title?.substring(0, 40)}...`);
                        return false;
                    });

                    console.log(`ðŸ“Š After strict date validation: ${validatedResults.length}/${results.length} passed`);

                    // If too few results passed, log a warning
                    if (validatedResults.length < 2) {
                        console.warn(`âš ï¸ Very few results (${validatedResults.length}) for: ${query}`);
                    }

                    results = validatedResults;
                }

                // Log final results
                results.slice(0, 5).forEach((r, i) => {
                    console.log(`  [${i + 1}] ${r.published_date || 'no date'}: ${r.title?.substring(0, 50)}...`);
                });

                return results.slice(0, 5);
            } catch (error) {
                console.error('Tavily search error:', error);
                return [];
            }
        }

        async function loadSelectedDossier() {
            const selector = document.getElementById('dossierSelector');
            const selectedId = selector.value;

            if (selectedId === 'current') {
                // Load current/live dossier
                currentDossierId = 'current';
                localStorage.removeItem(DRIVERS_CACHE_KEY); // Force regeneration
                INITIAL_DRIVERS = [];
                selectedDrivers = []; // Clear selection when switching dossiers
                await initializeApp();
                return;
            }

            // Load historical dossier
            const stored = localStorage.getItem(`astra_dossier_${selectedId}`);
            if (!stored) {
                alert('Dossier not found. It may have been deleted.');
                selector.value = 'current';
                return;
            }

            try {
                const dossierData = JSON.parse(stored);
                currentDossierId = selectedId;
                INITIAL_DRIVERS = dossierData.drivers || [];

                // Update status to show historical mode
                document.getElementById('connectionStatusText').innerText =
                    `Historical: ${dossierData.quarter} ${dossierData.year}`;

                const statusDot = document.querySelector('.status-dot');
                if (statusDot) statusDot.style.background = '#F59E0B'; // Orange for historical

                // Clear selected drivers when switching dossiers
                selectedDrivers = [];

                // Load custom drivers
                loadCustomDrivers();
                renderMarketplace();
                updateInventory(); // Update basket to show empty

                console.log(`âœ“ Loaded ${INITIAL_DRIVERS.length} drivers from ${dossierData.quarter} ${dossierData.year} dossier`);
            } catch (e) {
                console.error('Failed to load dossier:', e);
                alert('Failed to load dossier.');
            }
        }

        function deleteSelectedDossier() {
            const selector = document.getElementById('dossierSelector');
            const selectedId = selector.value;

            // Prevent deleting the current/live dossier
            if (selectedId === 'current') {
                alert('Cannot delete the live dossier. Select a historical dossier to delete.');
                return;
            }

            // Find dossier info for display
            const dossierInfo = dossiersList.find(d => d.id === selectedId);
            const displayName = dossierInfo ? `${dossierInfo.quarter} ${dossierInfo.year}` : selectedId;

            // Confirm deletion
            if (!confirm(`Are you sure you want to delete the "${displayName}" dossier? This action cannot be undone.`)) {
                return;
            }

            // Remove from localStorage
            localStorage.removeItem(`astra_dossier_${selectedId}`);

            // Remove from dossiers list
            dossiersList = dossiersList.filter(d => d.id !== selectedId);
            saveDossiersList();
            updateDossierSelector();

            // Determine which dossier to switch to
            if (dossiersList.length > 0) {
                // Switch to another available historical dossier
                const nextDossier = dossiersList[0];
                selector.value = nextDossier.id;
                loadSelectedDossier();
                console.log(`ðŸ—‘ï¸ Deleted dossier: ${displayName}. Switched to ${nextDossier.quarter} ${nextDossier.year}`);
                alert(`Dossier "${displayName}" has been deleted. Switched to ${nextDossier.quarter} ${nextDossier.year}.`);
            } else {
                // No other dossiers available, stay on current view
                // Don't call loadSelectedDossier() to avoid triggering Tavily fetch
                selector.value = 'current';
                currentDossierId = 'current';

                // Check if we have cached drivers
                const cachedDrivers = getFromCache(DRIVERS_CACHE_KEY);
                if (cachedDrivers && cachedDrivers.length > 0) {
                    INITIAL_DRIVERS = cachedDrivers;
                    loadCustomDrivers();
                    renderMarketplace();
                    updateConnectionStatus(true, false, false);
                    console.log(`ðŸ—‘ï¸ Deleted dossier: ${displayName}. Using cached live data.`);
                    alert(`Dossier "${displayName}" has been deleted. Using cached live data.`);
                } else {
                    // No cache, will need to fetch
                    console.log(`ðŸ—‘ï¸ Deleted dossier: ${displayName}. No cached data, will fetch new data.`);
                    alert(`Dossier "${displayName}" has been deleted. No other dossiers available.`);
                    loadSelectedDossier();
                }
            }
        }

        function exportCurrentDossier() {
            const dossierData = {
                exportedAt: new Date().toISOString(),
                dossierId: currentDossierId,
                drivers: INITIAL_DRIVERS.filter(d => !d.id.startsWith('cust_')), // Exclude custom drivers
                customDrivers: INITIAL_DRIVERS.filter(d => d.id.startsWith('cust_'))
            };

            // If we have a historical dossier, include raw dossier data
            if (currentDossierId !== 'current') {
                const stored = localStorage.getItem(`astra_dossier_${currentDossierId}`);
                if (stored) {
                    const fullDossier = JSON.parse(stored);
                    dossierData.quarter = fullDossier.quarter;
                    dossierData.year = fullDossier.year;
                    dossierData.rawDossier = fullDossier.dossier;
                }
            }

            const blob = new Blob([JSON.stringify(dossierData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `astra_dossier_${currentDossierId}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importDossierFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    // DETECT FILE TYPE:
                    // Type A: Raw market dossier from Tavily (has 'data' and 'timestamp')
                    // Type B: Exported scenario file (has 'drivers' array)
                    // Type C: Workspace backup (has 'exportType: astra_workspace_backup')

                    // --- TYPE C: Workspace Backup ---
                    if (data.exportType === 'astra_workspace_backup' && data.data) {
                        console.log('âœ“ Detected workspace backup file. Restoring...');

                        // Reuse the importWorkspace logic inline
                        const workspaceData = data.data;
                        let restoredItems = [];

                        // Restore saved scenarios
                        if (workspaceData.savedScenarios && workspaceData.savedScenarios.length > 0) {
                            savedScenarios = workspaceData.savedScenarios;
                            saveScenariosToStorage();
                            restoredItems.push(`${workspaceData.savedScenarios.length} scenarios`);
                        }

                        // Restore market dossier
                        if (workspaceData.marketDossier) {
                            saveToCache(CACHE_KEY, workspaceData.marketDossier.data || workspaceData.marketDossier);
                            restoredItems.push('market dossier');
                        }

                        // Restore risk drivers
                        if (workspaceData.riskDrivers) {
                            const driversToRestore = workspaceData.riskDrivers.data || workspaceData.riskDrivers;
                            saveToCache(`${DRIVERS_CACHE_KEY}_current`, driversToRestore);
                            INITIAL_DRIVERS = driversToRestore;
                            restoredItems.push(`${driversToRestore.length} risk drivers`);
                        }

                        // Restore custom drivers
                        if (workspaceData.customDrivers && workspaceData.customDrivers.length > 0) {
                            localStorage.setItem(CUSTOM_DRIVERS_KEY, JSON.stringify(workspaceData.customDrivers));
                            restoredItems.push(`${workspaceData.customDrivers.length} custom drivers`);
                        }

                        // Restore dossiers list
                        if (workspaceData.dossiersList) {
                            localStorage.setItem('astra_dossiers_list', JSON.stringify(workspaceData.dossiersList));
                        }

                        // Restore historical dossiers
                        if (workspaceData.historicalDossiers) {
                            Object.entries(workspaceData.historicalDossiers).forEach(([id, dossierData]) => {
                                localStorage.setItem(`astra_dossier_${id}`, JSON.stringify(dossierData));
                            });
                        }

                        // Hide start screen and show marketplace
                        const startScreen = document.getElementById('startScreen');
                        if (startScreen) startScreen.style.display = 'none';

                        loadCustomDrivers();
                        loadSavedScenarios();
                        loadDossiersList();
                        updateDossierSelector();
                        showMarketplace();
                        updateConnectionStatus(true, 'Restored');

                        alert(`âœ“ Workspace restored successfully!\n\nRestored:\nâ€¢ ${restoredItems.join('\nâ€¢ ')}`);
                        return;
                    }

                    // --- TYPE A: Raw Market Dossier (dossier_current.json) ---
                    if (data.data && data.timestamp) {
                        console.log('âœ“ Detected raw market dossier file. Processing...');

                        // Validate cache freshness
                        if (!isCacheValid(data)) {
                            const proceed = confirm('This dossier file is older than ' + CACHE_EXPIRY_DAYS + ' days. Load anyway?');
                            if (!proceed) return;
                        }

                        // Save raw dossier to cache
                        saveToCache(CACHE_KEY, data.data);

                        // Hide start screen, show loader
                        const startScreen = document.getElementById('startScreen');
                        if (startScreen) startScreen.style.display = 'none';
                        const loader = document.getElementById('loader');
                        const loaderText = document.getElementById('loaderText');
                        loader.style.display = 'flex';
                        loaderText.innerText = 'Generating risk drivers from loaded dossier...';

                        // Generate AI drivers from this dossier
                        INITIAL_DRIVERS = await generateRiskDriversFromDossier(data.data, (msg) => {
                            loaderText.innerText = msg;
                        }, 'current');

                        console.log(`âœ“ Generated ${INITIAL_DRIVERS.length} risk drivers from imported dossier`);
                        updateConnectionStatus(true, 'Loaded');
                        loader.style.display = 'none';
                        showMarketplace();
                        loadCustomDrivers();
                        loadSavedScenarios();

                        alert(`âœ“ Market dossier loaded successfully! Generated ${INITIAL_DRIVERS.length} risk drivers.`);
                        return;
                    }

                    // --- TYPE B: Exported Scenario File (from export button) ---
                    if (data.drivers && Array.isArray(data.drivers)) {
                        console.log('âœ“ Detected exported scenario file. Processing...');

                        // Directly load the drivers
                        INITIAL_DRIVERS = data.drivers;

                        // Save to cache for persistence
                        saveToCache(`${DRIVERS_CACHE_KEY}_current`, INITIAL_DRIVERS);

                        // Load custom drivers if present
                        if (data.customDrivers && data.customDrivers.length > 0) {
                            localStorage.setItem(CUSTOM_DRIVERS_KEY, JSON.stringify(data.customDrivers));
                        }

                        // Hide start screen and show marketplace
                        const startScreen = document.getElementById('startScreen');
                        if (startScreen) startScreen.style.display = 'none';

                        loadCustomDrivers();
                        loadSavedScenarios();
                        showMarketplace();
                        updateConnectionStatus(true, 'Loaded');

                        alert(`âœ“ Scenario loaded successfully! (${data.drivers.length} risk drivers)`);
                        return;
                    }

                    // Unknown format
                    throw new Error('Unrecognized file format. Expected:\nâ€¢ Raw dossier (with "data" and "timestamp")\nâ€¢ Exported scenario (with "drivers" array)\nâ€¢ Workspace backup (with "exportType")');

                } catch (error) {
                    console.error('Import error:', error);
                    alert('Failed to import file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // --- CUSTOM DRIVERS PERSISTENCE ---
        function loadCustomDrivers() {
            try {
                const stored = localStorage.getItem(CUSTOM_DRIVERS_KEY);
                if (stored) {
                    const customDrivers = JSON.parse(stored);
                    // Normalize custom drivers to have "Customized" category
                    const normalizedDrivers = customDrivers.map(d => ({
                        ...d,
                        cat: 'Customized', // Force to Customized category
                        tagColor: '#CFFAFE', // Teal/Cyan
                        textColor: '#0E7490'
                    }));
                    // Filter out any drivers that already exist (by ID)
                    const existingIds = new Set(INITIAL_DRIVERS.map(d => d.id));
                    const newCustomDrivers = normalizedDrivers.filter(d => !existingIds.has(d.id));
                    INITIAL_DRIVERS = [...INITIAL_DRIVERS, ...newCustomDrivers];
                    console.log(`âœ“ Loaded ${newCustomDrivers.length} custom drivers from storage`);
                    renderMarketplace();
                }
            } catch (e) {
                console.error('Failed to load custom drivers:', e);
            }
        }

        function saveCustomDrivers() {
            try {
                // Save only drivers with IDs starting with 'cust_'
                const customDrivers = INITIAL_DRIVERS.filter(d => d.id.startsWith('cust_'));
                localStorage.setItem(CUSTOM_DRIVERS_KEY, JSON.stringify(customDrivers));
                console.log(`âœ“ Saved ${customDrivers.length} custom drivers to storage`);
            } catch (e) {
                console.error('Failed to save custom drivers:', e);
            }
        }

        function deleteCustomDriver(driverId) {
            if (!driverId.startsWith('cust_')) {
                alert('Only custom drivers can be deleted.');
                return;
            }

            if (!confirm('Delete this custom driver? This cannot be undone.')) {
                return;
            }

            // Remove from INITIAL_DRIVERS
            const index = INITIAL_DRIVERS.findIndex(d => d.id === driverId);
            if (index > -1) {
                INITIAL_DRIVERS.splice(index, 1);
            }

            // Remove from selected drivers if present
            const selectedIdx = selectedDrivers.findIndex(d => d.id === driverId);
            if (selectedIdx > -1) {
                selectedDrivers.splice(selectedIdx, 1);
            }

            // Save updated custom drivers
            saveCustomDrivers();

            // Close modal if open
            closeModal();

            // Re-render
            renderMarketplace();
            updateInventory();
        }

        // --- SAVED SCENARIOS PERSISTENCE ---
        function loadSavedScenarios() {
            try {
                const stored = localStorage.getItem(SAVED_SCENARIOS_KEY);
                console.log('Loading scenarios from localStorage:', stored);
                if (stored) {
                    savedScenarios = JSON.parse(stored);
                    console.log('Parsed savedScenarios:', savedScenarios);
                }
            } catch (e) {
                console.error('Failed to load saved scenarios:', e);
                savedScenarios = [];
            }
        }

        // Helper to strip heavy data from drivers for storage
        function sanitizeDriverForStorage(d) {
            if (!d) return d;
            // Create shallow copy first
            const newD = { ...d };
            // Remove heavy fields
            delete newD.chatHistory;
            delete newD.tavilyContext;
            delete newD.originalContext;

            // If we have sub-objects that are heavy, clean them too
            return newD;
        }

        // Helper to strip heavy data from execState
        function sanitizeExecState(state) {
            if (!state) return state;
            const newState = JSON.parse(JSON.stringify(state));

            if (newState.heatMap && newState.heatMap.drivers) {
                newState.heatMap.drivers = newState.heatMap.drivers.map(sanitizeDriverForStorage);
            }
            if (newState.scenario && newState.scenario.drivers) {
                newState.scenario.drivers = newState.scenario.drivers.map(sanitizeDriverForStorage);
            }
            return newState;
        }

        function saveScenariosToStorage() {
            try {
                localStorage.setItem(SAVED_SCENARIOS_KEY, JSON.stringify(savedScenarios));
            } catch (e) {
                console.error('Failed to save scenarios:', e);

                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    // Emergency cleanup: sanitize ALL saved scenarios to recover space
                    let recovered = false;

                    savedScenarios = savedScenarios.map(s => {
                        let modified = false;
                        if (s.type === 'executive_report' && s.execState) {
                            s.execState = sanitizeExecState(s.execState);
                            modified = true;
                        }
                        if (s.type === 'heatmap' && s.drivers) {
                            s.drivers = s.drivers.map(sanitizeDriverForStorage);
                            modified = true;
                        }
                        if (modified) recovered = true;
                        return s;
                    });

                    if (recovered) {
                        try {
                            localStorage.setItem(SAVED_SCENARIOS_KEY, JSON.stringify(savedScenarios));
                            console.log('âœ… Storage recovered by sanitizing old reports.');
                        } catch (retryErr) {
                            alert('Storage full! Please delete old reports from your folder.');
                        }
                    } else {
                        alert('Storage full! Please delete old reports from your folder.');
                    }
                }
            }
        }

        // --- SETTINGS MODAL ---
        function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
            document.getElementById('execPickerModal').style.display = 'none';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // --- UNIFIED WORKSPACE BACKUP/RESTORE ---
        function exportWorkspace() {
            // Gather all data from localStorage
            const workspaceData = {
                exportType: 'astra_workspace_backup',
                exportedAt: new Date().toISOString(),
                version: '1.0',
                data: {
                    // Saved scenarios
                    savedScenarios: savedScenarios,

                    // Market dossier (raw Tavily data)
                    marketDossier: JSON.parse(localStorage.getItem(CACHE_KEY) || 'null'),

                    // Generated risk drivers
                    riskDrivers: JSON.parse(localStorage.getItem(`${DRIVERS_CACHE_KEY}_current`) || 'null'),

                    // Custom drivers
                    customDrivers: JSON.parse(localStorage.getItem(CUSTOM_DRIVERS_KEY) || '[]'),

                    // Historical dossiers list
                    dossiersList: JSON.parse(localStorage.getItem('astra_dossiers_list') || '[]')
                }
            };

            // Also include any historical dossiers
            const historicalDossiers = {};
            const dossiersList = JSON.parse(localStorage.getItem('astra_dossiers_list') || '[]');
            dossiersList.forEach(d => {
                const dossierData = localStorage.getItem(`astra_dossier_${d.id}`);
                if (dossierData) {
                    historicalDossiers[d.id] = JSON.parse(dossierData);
                }
            });
            workspaceData.data.historicalDossiers = historicalDossiers;

            const blob = new Blob([JSON.stringify(workspaceData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `astra_workspace_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            closeSettingsModal();
            const dossierCount = Object.keys(historicalDossiers).length;
            const customDriverCount = JSON.parse(localStorage.getItem(CUSTOM_DRIVERS_KEY) || '[]').length;
            alert(`âœ“ Workspace exported successfully!\n\nThis backup includes:\nâ€¢ ${savedScenarios.length} folder items\nâ€¢ Market dossier data\nâ€¢ ${INITIAL_DRIVERS.length} risk drivers\nâ€¢ ${customDriverCount} custom drivers\nâ€¢ ${dossierCount} historical dossiers\n\nUse this file to restore your workspace on another browser or device.`);
        }

        function importWorkspace(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const workspaceData = JSON.parse(e.target.result);

                    // Validate backup format
                    if (workspaceData.exportType !== 'astra_workspace_backup' || !workspaceData.data) {
                        throw new Error('Invalid workspace backup file. Please select a valid ASTRA workspace backup.');
                    }

                    const data = workspaceData.data;
                    let restoredItems = [];
                    let skippedItems = [];

                    // Helper function to safely store items
                    function safeSetItem(key, value) {
                        try {
                            localStorage.setItem(key, JSON.stringify(value));
                            return true;
                        } catch (e) {
                            if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                                console.warn(`Storage quota exceeded for ${key}, skipping...`);
                                return false;
                            }
                            throw e;
                        }
                    }

                    // Restore saved scenarios (priority - usually small)
                    if (data.savedScenarios && data.savedScenarios.length > 0) {
                        savedScenarios = data.savedScenarios;
                        if (safeSetItem(SAVED_SCENARIOS_KEY, savedScenarios)) {
                            restoredItems.push(`${data.savedScenarios.length} folder items`);
                        } else {
                            skippedItems.push('folder items (too large)');
                        }
                    }

                    // Restore risk drivers (priority - needed for app to work)
                    if (data.riskDrivers) {
                        const driversToRestore = data.riskDrivers.data || data.riskDrivers;
                        if (safeSetItem(`${DRIVERS_CACHE_KEY}_current`, { data: driversToRestore, timestamp: Date.now() })) {
                            INITIAL_DRIVERS = driversToRestore;
                            restoredItems.push(`${driversToRestore.length} risk drivers`);
                        } else {
                            skippedItems.push('risk drivers (too large)');
                        }
                    }

                    // Restore custom drivers
                    if (data.customDrivers && data.customDrivers.length > 0) {
                        if (safeSetItem(CUSTOM_DRIVERS_KEY, data.customDrivers)) {
                            loadCustomDrivers();
                            restoredItems.push(`${data.customDrivers.length} custom drivers`);
                        } else {
                            skippedItems.push('custom drivers');
                        }
                    }

                    // Restore market dossier (can be large - lower priority)
                    if (data.marketDossier) {
                        if (safeSetItem(CACHE_KEY, { data: data.marketDossier.data || data.marketDossier, timestamp: Date.now() })) {
                            restoredItems.push('market dossier');
                        } else {
                            skippedItems.push('market dossier (too large)');
                        }
                    }

                    // Restore dossiers list (small)
                    if (data.dossiersList) {
                        safeSetItem('astra_dossiers_list', data.dossiersList);
                    }

                    // Restore historical dossiers (can be very large - skip if quota exceeded)
                    if (data.historicalDossiers) {
                        let restoredDossiers = 0;
                        let skippedDossiers = 0;
                        for (const [id, dossierData] of Object.entries(data.historicalDossiers)) {
                            if (safeSetItem(`astra_dossier_${id}`, dossierData)) {
                                restoredDossiers++;
                            } else {
                                skippedDossiers++;
                            }
                        }
                        if (restoredDossiers > 0) restoredItems.push(`${restoredDossiers} historical dossiers`);
                        if (skippedDossiers > 0) skippedItems.push(`${skippedDossiers} historical dossiers (storage full)`);
                    }

                    // Refresh UI
                    renderMarketplace();
                    renderSavedScenarios();
                    loadDossiersList();
                    updateDossierSelector();

                    closeSettingsModal();

                    let message = `âœ“ Workspace restored!\n\nRestored:\nâ€¢ ${restoredItems.join('\nâ€¢ ')}`;
                    if (skippedItems.length > 0) {
                        message += `\n\nâš ï¸ Skipped (storage full):\nâ€¢ ${skippedItems.join('\nâ€¢ ')}\n\nTip: Use Settings â†’ Clear All Cached Data to free up space.`;
                    }
                    alert(message);

                } catch (error) {
                    console.error('Workspace import error:', error);
                    alert('Failed to import workspace: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function clearAllCaches() {
            if (!confirm('This will clear ALL cached data including:\n\nâ€¢ Market dossier\nâ€¢ Generated risk drivers\nâ€¢ Custom drivers\nâ€¢ Historical dossiers\n\nSaved scenarios will be preserved.\n\nAre you sure?')) {
                return;
            }

            // Clear caches but preserve scenarios
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(`${DRIVERS_CACHE_KEY}_current`);
            localStorage.removeItem(CUSTOM_DRIVERS_KEY);

            // Clear historical dossiers
            const dossiersList = JSON.parse(localStorage.getItem('astra_dossiers_list') || '[]');
            dossiersList.forEach(d => {
                localStorage.removeItem(`astra_dossier_${d.id}`);
            });
            localStorage.removeItem('astra_dossiers_list');

            closeSettingsModal();
            alert('âœ“ All cached data cleared.\n\nRefresh the page to start fresh.');
            location.reload();
        }

        async function startNewSession() {
            // Hide start screen, show loader
            const startScreen = document.getElementById('startScreen');
            if (startScreen) startScreen.style.display = 'none';

            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loaderText');
            loader.style.display = 'flex';
            loaderText.innerText = 'Initializing new market scan...';

            try {
                // FORCE NEW GENERATION
                const dossier = await generateNewMarketDossier((msg) => {
                    loaderText.innerText = msg;
                });

                loaderText.innerText = 'Generating AI risk drivers...';
                INITIAL_DRIVERS = await generateRiskDriversFromDossier(dossier, (msg) => {
                    loaderText.innerText = msg;
                }, 'current');

                console.log(`âœ“ Generated ${INITIAL_DRIVERS.length} risk drivers`);
                updateConnectionStatus(true, 'Live');
                loader.style.display = 'none';
                showMarketplace();

                // Reload custom drivers & scenarios
                loadCustomDrivers();
                loadSavedScenarios();

            } catch (error) {
                console.error("Session start error:", error);
                alert("Failed to generate session: " + error.message);
                loader.style.display = 'none';
                showStartScreen();
            }
        }

        function showStartScreen() {
            // Create start screen overlay if it doesn't exist
            let startScreen = document.getElementById('startScreen');
            if (!startScreen) {
                startScreen = document.createElement('div');
                startScreen.id = 'startScreen';
                startScreen.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;';
                startScreen.innerHTML = `
                    <div style="text-align:center; max-width:520px; padding:40px; background:white; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.1); border:1px solid #e5e7eb;">
                        <div style="font-size:48px; margin-bottom:16px;">ðŸŒŒ</div>
                        <h1 style="margin:0 0 12px 0; color:#111827; font-size:24px;">Welcome to ASTRA</h1>
                        <p style="color:#6b7280; margin-bottom:24px; line-height:1.5;">
                            Choose how to initialize your session:
                        </p>

                        <div style="display:flex; flex-direction:column; gap:12px;">
                            <label class="btn-primary" style="background:#4F46E5; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:14px 20px;">
                                ðŸ“‚ Load Dossier File
                                <input type="file" onchange="importDossierFile(event);" style="display:none;" accept=".json">
                            </label>
                            <p style="margin:0; font-size:11px; color:#9CA3AF;">Loads risk drivers only.</p>

                            <label style="margin-top:8px; background:#f3f4f6; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:14px 20px; border:1px solid #d1d5db; border-radius:12px; font-weight:600; color:#374151;">
                                ðŸ’¾ Load Full Workspace
                                <input type="file" onchange="loadWorkspaceWithClear(event);" style="display:none;" accept=".json">
                            </label>
                            <p style="margin:0; font-size:11px; color:#9CA3AF;">Restores scenarios & drivers.</p>

                            <button onclick="startNewSession()" class="btn-primary" style="margin-top:16px; background:#10B981;">
                                ðŸ” Start New Scan
                            </button>
                            <p style="margin:0; font-size:11px; color:#9CA3AF;">* Incurs Tavily API costs.</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(startScreen);
            }
            startScreen.style.display = 'flex';
        }

        function loadWorkspaceWithClear(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Clear ALL existing ASTRA data first to make room
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('astra_')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            console.log(`Cleared ${keysToRemove.length} existing ASTRA entries from localStorage`);

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const workspaceData = JSON.parse(e.target.result);

                    if (workspaceData.exportType !== 'astra_workspace_backup' || !workspaceData.data) {
                        throw new Error('Invalid file. Please select an ASTRA workspace backup.');
                    }

                    document.getElementById('startScreen').style.display = 'none';
                    document.getElementById('loader').style.display = 'flex';
                    document.getElementById('loaderText').innerText = 'Restoring workspace...';

                    const data = workspaceData.data;
                    let restoredItems = [];

                    // Restore scenarios
                    if (data.savedScenarios && data.savedScenarios.length > 0) {
                        savedScenarios = data.savedScenarios;
                        localStorage.setItem(SAVED_SCENARIOS_KEY, JSON.stringify(savedScenarios));
                        restoredItems.push(`${data.savedScenarios.length} scenarios`);
                    }

                    // Restore drivers
                    if (data.riskDrivers) {
                        const drivers = data.riskDrivers.data || data.riskDrivers;
                        INITIAL_DRIVERS = drivers;
                        localStorage.setItem(`${DRIVERS_CACHE_KEY}_current`, JSON.stringify({ data: drivers, timestamp: Date.now() }));
                        restoredItems.push(`${drivers.length} risk drivers`);
                    }

                    // Restore custom drivers
                    if (data.customDrivers && data.customDrivers.length > 0) {
                        localStorage.setItem(CUSTOM_DRIVERS_KEY, JSON.stringify(data.customDrivers));
                        restoredItems.push(`${data.customDrivers.length} custom drivers`);
                    }

                    // Restore dossiers list
                    if (data.dossiersList && data.dossiersList.length > 0) {
                        localStorage.setItem('astra_dossiers_list', JSON.stringify(data.dossiersList));
                    }

                    // Restore historical dossiers
                    if (data.historicalDossiers) {
                        let restoredDossiers = 0;
                        for (const [id, dossierData] of Object.entries(data.historicalDossiers)) {
                            try {
                                localStorage.setItem(`astra_dossier_${id}`, JSON.stringify(dossierData));
                                restoredDossiers++;
                            } catch (e) {
                                console.warn(`Failed to restore dossier ${id}:`, e);
                            }
                        }
                        if (restoredDossiers > 0) {
                            restoredItems.push(`${restoredDossiers} historical dossiers`);
                        }
                    }

                    // Show marketplace
                    document.getElementById('loader').style.display = 'none';
                    loadCustomDrivers();
                    loadSavedScenarios();
                    loadDossiersList();
                    updateDossierSelector();
                    showMarketplace();
                    updateConnectionStatus(true, 'Restored');

                    alert(`âœ“ Workspace restored!\n\nâ€¢ ${restoredItems.join('\nâ€¢ ')}`);

                } catch (error) {
                    console.error('Workspace import error:', error);
                    document.getElementById('loader').style.display = 'none';
                    alert('Failed to load: ' + error.message);
                    showStartScreen();
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function deleteScenario(scenarioId) {
            if (!confirm('Delete this saved scenario? This cannot be undone.')) {
                return;
            }

            const index = savedScenarios.findIndex(s => s.id === scenarioId);
            if (index > -1) {
                savedScenarios.splice(index, 1);
                saveScenariosToStorage();
                renderSavedScenarios();
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

        function filterDrivers(query) {
            renderMarketplace(query);
        }

        function renderMarketplace(filterText = '') {
            const container = document.getElementById('driversContainer');

            // Filter drivers based on text
            const filteredDrivers = INITIAL_DRIVERS.filter(d => {
                const searchStr = (d.title + ' ' + d.desc + ' ' + d.cat).toLowerCase();
                return searchStr.includes(filterText.toLowerCase());
            });

            if (filteredDrivers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 32px; margin-bottom: 16px;">ðŸ”</div>
                        <p>No drivers found matching "${filterText}"</p>
                        <button onclick="createCustomDriver()" style="margin-top: 16px; color: var(--primary); background: none; border: none; font-weight: 600; cursor: pointer;">
                            Ask AI to generate it?
                        </button>
                    </div>
                `;
                return;
            }

            // Separate custom drivers from regular drivers
            const regularDrivers = filteredDrivers.filter(d => !d.id.startsWith('cust_'));
            const customDrivers = filteredDrivers.filter(d => d.id.startsWith('cust_'));

            // Get unique categories for regular drivers only
            const regularCategories = [...new Set(regularDrivers.map(d => d.cat))];

            // Render regular categories with "Add More" button
            let html = regularCategories.map(cat => `
                <div class="category-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <div class="category-label" style="margin-bottom: 0;">${cat}</div>
                    <button class="add-more-btn" onclick="event.stopPropagation(); addMoreDriversForCategory('${cat}')" 
                        title="Add more ${cat} risk drivers"
                        style="
                            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(79, 70, 229, 0.1));
                            border: 1px solid rgba(37, 99, 235, 0.3);
                            color: var(--primary);
                            padding: 4px 10px;
                            border-radius: 100px;
                            font-size: 11px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        "
                        onmouseover="this.style.background='linear-gradient(135deg, var(--primary), #4F46E5)'; this.style.color='white'; this.style.transform='scale(1.05)';"
                        onmouseout="this.style.background='linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(79, 70, 229, 0.1))'; this.style.color='var(--primary)'; this.style.transform='scale(1)';">
                        <span>+</span> Add More
                    </button>
                </div>
                <div class="drivers-grid">
                    ${regularDrivers.filter(d => d.cat === cat).map(d => {
                const sourcesHtml = (d.sources && d.sources.length > 0) ? `
                            <div class="driver-sources">
                                <div class="sources-label">Sources</div>
                                <div class="source-list">
                                    ${d.sources.slice(0, 3).map(src => `
                                        <a href="${src.url || '#'}" class="source-item" target="_blank" rel="noopener" onclick="event.stopPropagation()">
                                            <span class="source-item-text">${src.title || 'Source'}</span>
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        ` : '';
                return `
                        <div id="card_${d.id}" class="driver-card ${selectedDrivers.some(s => s.id === d.id) ? 'selected' : ''}" 
                            draggable="true"
                            ondragstart="handleDragStart(event, '${d.id}')"
                            ondragend="handleDragEnd(event)"
                            onclick="openDriverDetails('${d.id}')"
                            onmouseenter="startDeleteTimer(event, '${d.id}')"
                            onmouseleave="cancelDeleteTimer(event, '${d.id}')">
                            <button class="driver-delete-btn" onclick="event.stopPropagation(); deleteDriver('${d.id}')">Ã—</button>
                            <span class="driver-tag" style="background:${d.tagColor}; color:${d.textColor}">${cat}</span>
                            <div class="driver-title">${d.title}</div>
                            <div class="driver-desc">${d.desc}</div>
                            ${sourcesHtml}
                        </div>
                        `;
            }).join('')}
                </div>
            `).join('');            // Render Customized section at the end if there are custom drivers
            if (customDrivers.length > 0) {
                html += `
                    <div class="category-label">Customized</div>
                    <div class="drivers-grid">
                        ${customDrivers.map(d => {
                    const sourcesHtml = (d.sources && d.sources.length > 0) ? `
                                <div class="driver-sources">
                                    <div class="sources-label">Sources</div>
                                    <div class="source-list">
                                        ${d.sources.slice(0, 3).map(src => `
                                            <a href="${src.url || '#'}" class="source-item" target="_blank" rel="noopener" onclick="event.stopPropagation()">
                                                <span class="source-item-text">${src.title || 'Source'}</span>
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : '';
                    return `
                            <div id="card_${d.id}" class="driver-card ${selectedDrivers.some(s => s.id === d.id) ? 'selected' : ''}" 
                                draggable="true"
                                ondragstart="handleDragStart(event, '${d.id}')"
                                ondragend="handleDragEnd(event)"
                                onclick="openDriverDetails('${d.id}')"
                                onmouseenter="startDeleteTimer(event, '${d.id}')"
                                onmouseleave="cancelDeleteTimer(event, '${d.id}')">
                                <button class="driver-delete-btn" onclick="event.stopPropagation(); deleteDriver('${d.id}')">Ã—</button>
                                <span class="driver-tag" style="background:${d.tagColor}; color:${d.textColor}">Customized</span>
                                <div class="driver-title">${d.title}</div>
                                <div class="driver-desc">${d.desc}</div>
                                ${sourcesHtml}
                            </div>
                            `;
                }).join('')}
                    </div>
                `;
            } container.innerHTML = html;
        }

        // --- DELETE DRIVER FUNCTIONALITY ---
        let deleteTimers = {};

        function startDeleteTimer(event, driverId) {
            const card = event.currentTarget;
            // Clear any existing timer for this card
            if (deleteTimers[driverId]) {
                clearTimeout(deleteTimers[driverId]);
            }
            // Show delete button after 2 seconds
            deleteTimers[driverId] = setTimeout(() => {
                card.classList.add('show-delete');
            }, 2000);
        }

        function cancelDeleteTimer(event, driverId) {
            const card = event.currentTarget;
            // Clear the timer
            if (deleteTimers[driverId]) {
                clearTimeout(deleteTimers[driverId]);
                delete deleteTimers[driverId];
            }
            // Hide delete button
            card.classList.remove('show-delete');
        }

        function deleteDriver(driverId) {
            if (!confirm('Are you sure you want to delete this risk driver?')) {
                return;
            }

            // Remove from INITIAL_DRIVERS array
            const index = INITIAL_DRIVERS.findIndex(d => d.id === driverId);
            if (index !== -1) {
                INITIAL_DRIVERS.splice(index, 1);
            }

            // Remove from selectedDrivers if present
            const selectedIndex = selectedDrivers.findIndex(d => d.id === driverId);
            if (selectedIndex !== -1) {
                selectedDrivers.splice(selectedIndex, 1);
            }

            // Update the UI
            renderMarketplace();
            updateSelectedCount();

            // Show confirmation
            console.log(`Deleted driver: ${driverId}`);
        }

        // --- 3. MODAL LOGIC ---
        let currentModalDriverId = null;

        function openDriverDetails(id) {
            currentModalDriverId = id;
            const driver = INITIAL_DRIVERS.find(d => d.id === id);
            if (!driver) return;

            document.getElementById('modalTitle').innerText = driver.title;

            // Build description with heat map assessment if available
            const hmData = heatMapData[id];
            let descContent = driver.desc;

            if (hmData && (hmData.likelihoodReasoning || hmData.materialityReasoning || hmData.reasoning)) {
                // Add heat map assessment section with separate justifications
                const likelihoodLevel = getLevelLabel(hmData.likelihood);
                const materialityLevel = getLevelLabel(hmData.materiality);
                const velocityLabel = hmData.velocity === 3 ? 'High' : hmData.velocity === 2 ? 'Medium' : 'Low';

                descContent += `\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ“Š HEAT MAP ASSESSMENT:\n`;
                descContent += `\nðŸ“ˆ Likelihood: ${likelihoodLevel} (${hmData.likelihood}/10)`;
                if (hmData.likelihoodReasoning) {
                    descContent += `\n   â†’ ${hmData.likelihoodReasoning}`;
                }
                descContent += `\n\nðŸ’¥ Materiality: ${materialityLevel} (${hmData.materiality}/10)`;
                if (hmData.materialityReasoning) {
                    descContent += `\n   â†’ ${hmData.materialityReasoning}`;
                }
                descContent += `\n\nâš¡ Velocity: ${velocityLabel}`;
                if (hmData.reasoning) {
                    descContent += `\n   â†’ ${hmData.reasoning}`;
                }
            }

            document.getElementById('modalDesc').innerText = descContent;
            const tag = document.getElementById('modalTag');
            tag.innerText = driver.cat;
            tag.style.background = driver.tagColor;
            tag.style.color = driver.textColor;

            renderChat(driver);

            const btn = document.getElementById('modalActionBtn');
            const isSelected = selectedDrivers.some(d => d.id === id);
            btn.innerText = isSelected ? "Remove from Scenario" : "Add to Scenario";
            btn.style.background = isSelected ? "#DC2626" : "var(--primary)";

            // Show delete button only for custom drivers
            const deleteBtn = document.getElementById('deleteDriverBtn');
            deleteBtn.style.display = id.startsWith('cust_') ? 'inline-block' : 'none';

            document.getElementById('driverModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('driverModal').style.display = 'none';
            currentModalDriverId = null;
        }

        function toggleDriverFromModal() {
            if (!currentModalDriverId) return;
            toggleDriver(currentModalDriverId);
            closeModal();
        }

        function generateContextualSuggestions(driver) {
            const suggestions = [];
            const text = (driver.title + " " + driver.desc).toLowerCase();

            // 1. Severity/Metric suggestions
            if (text.includes('inflation') || text.includes('cpi') || text.includes('price')) {
                suggestions.push('Adjust peak CPI inflation assumption (e.g., +200 bps shock)');
                suggestions.push('Model second-round effects on wage growth');
            }
            if (text.includes('gdp') || text.includes('recession') || text.includes('growth')) {
                suggestions.push('Specify depth of GDP contraction (e.g., -2.5%)');
                suggestions.push('Define recovery curve shape (V-shaped vs U-shaped)');
            }
            if (text.includes('unemployment') || text.includes('labor') || text.includes('jobs')) {
                suggestions.push('Define peak unemployment rate stress level');
            }
            if (text.includes('housing') || text.includes('real estate') || text.includes('mortgage')) {
                suggestions.push('Set magnitude of house price correction (e.g., -15%)');
                suggestions.push('Impact on uninsured mortgage portfolio LTVs');
            }
            if (text.includes('rate') || text.includes('yield') || text.includes('monetary')) {
                suggestions.push('Model parallel shift in yield curve (+100 bps)');
                suggestions.push('Test impact of "Higher for Longer" rate scenario');
            }

            // 2. Policy/Regulatory/Geopolitics
            if (driver.cat === 'Regulatory' || text.includes('osfi') || text.includes('capital')) {
                suggestions.push('Quantify impact on CET1 capital ratios');
                suggestions.push('Detail specific capital buffer (DSB) increases');
            }
            if (driver.cat === 'Geopolitical' || text.includes('trade') || text.includes('tariff')) {
                suggestions.push('Simulate specific tariff levels on key sectors');
                suggestions.push('Model disruption to cross-border supply chains');
            }

            // 3. Portfolio/Risk Type
            if (text.includes('credit') || text.includes('default') || text.includes('pcl')) {
                suggestions.push('Focus on Commercial Real Estate (CRE) loss rates');
                suggestions.push('Stress provision for credit losses (PCL) ratios');
            }
            if (text.includes('cyber') || text.includes('tech') || text.includes('ransomware')) {
                suggestions.push('Estimate operational loss magnitude');
                suggestions.push('Model reputational impact duration');
            }

            // Fallback generic suggestion if list is short
            if (suggestions.length < 2) {
                suggestions.push('Elaborate on transmission channels to earnings');
                suggestions.push('Quantify financial impact severity (Low/Medium/High)');
            }

            // Fallback generic suggestion if list is short
            if (suggestions.length < 3) {
                suggestions.push('Elaborate on transmission channels to RBC earnings');
            }

            return suggestions.slice(0, 3); // Return top 3
        }

        function renderChat(driver) {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = '';

            if (driver.chatHistory.length === 0) {
                // Use professional, banking-appropriate greeting
                const suggestions = generateContextualSuggestions(driver); // Use the new function

                chatHistory.innerHTML = `
                    <div class="chat-message ai">
                        <p style="margin: 0 0 8px 0;"><strong>Driver Refinement: "${driver.title}"</strong></p>
                        <p style="margin: 0 0 8px 0;">Risk parameters for this <em>${driver.cat}</em> driver are loaded. Please provide calibration instructions.</p>
                        <p style="margin: 8px 0 4px 0; font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">SUGGESTED ACTIONS:</p>
                        <ul style="margin: 0 0 0 16px; padding: 0; font-size: 13px; color: #374151;">
                            ${suggestions.map(s => `<li style="margin-bottom: 4px;">${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                driver.chatHistory.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `chat-message ${msg.role}`;

                    if (msg.role === 'ai') {
                        // Check if this is the OLD legacy greeting in history, and replace it on fly
                        if (msg.text.includes("AI Risk Analyst")) {
                            const suggestions = generateContextualSuggestions(driver);
                            div.innerHTML = `
                                <p style="margin: 0 0 8px 0;"><strong>Driver Refinement: "${driver.title}"</strong></p>
                                <p style="margin: 0 0 8px 0;">Risk parameters for this <em>${driver.cat}</em> driver are loaded. Please provide calibration instructions.</p>
                                <p style="margin: 8px 0 4px 0; font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;">SUGGESTED ACTIONS:</p>
                                <ul style="margin: 0 0 0 16px; padding: 0; font-size: 13px; color: #374151;">
                                    ${suggestions.map(s => `<li style="margin-bottom: 4px;">${s}</li>`).join('')}
                                </ul>
                            `;
                        } else {
                            div.innerHTML = msg.text.replace(/\n/g, '<br>');
                        }
                    } else {
                        div.innerText = msg.text;
                    }
                    chatHistory.appendChild(div);
                });
            }
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function getContextualSuggestions(driver) {
            const baseSuggestions = [
                'Make it more severe or moderate',
                'Add specific quantitative impacts'
            ];

            const categorySuggestions = {
                'Macroeconomic': [
                    'Focus on GDP, inflation, or employment impacts',
                    'Add Bank of Canada policy response scenarios',
                    'Model transmission to consumer credit quality'
                ],
                'Geopolitical': [
                    'Specify trade flow disruptions and tariff impacts',
                    'Add supply chain contagion effects',
                    'Model currency and commodity price shocks'
                ],
                'Cyber / Tech': [
                    'Quantify potential operational downtime',
                    'Add reputational and regulatory fine estimates',
                    'Model customer attrition from service disruption'
                ],
                'Financial': [
                    'Add credit spread widening assumptions',
                    'Model mark-to-market losses on securities',
                    'Specify provisions for credit losses (PCL) increase'
                ],
                'Environmental': [
                    'Add insurance and reinsurance cost impacts',
                    'Model stranded asset valuations',
                    'Specify geographic concentration risks'
                ],
                'Social': [
                    'Model consumer behavior and spending shifts',
                    'Add housing demand and price assumptions',
                    'Quantify labor market disruption'
                ],
                'Regulatory': [
                    'Add compliance cost and timeline estimates',
                    'Model capital requirement changes',
                    'Specify affected business lines and products'
                ]
            };

            const catSuggestions = categorySuggestions[driver.cat] || [
                'Adjust the severity level',
                'Focus on specific RBC business lines',
                'Add Canadian market context'
            ];

            return [...baseSuggestions, ...catSuggestions.slice(0, 3)];
        }

        function handleChatEnter(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const val = input.value.trim();
            if (!val || !currentModalDriverId) return;

            const driver = INITIAL_DRIVERS.find(d => d.id === currentModalDriverId);
            if (!driver) return;

            // Add user message to history
            driver.chatHistory.push({ role: 'user', text: val });
            renderChat(driver);
            input.value = '';
            input.disabled = true;

            // Show typing indicator
            const chatHistoryEl = document.getElementById('chatHistory');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai';
            typingDiv.style.fontStyle = 'italic';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerText = 'Analyzing and refining...';
            chatHistoryEl.appendChild(typingDiv);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

            try {
                // Build conversation history for context
                const conversationHistory = driver.chatHistory.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'assistant',
                    content: msg.text
                }));

                // Get heat map data if available
                const hmData = heatMapData[driver.id];
                const hasHeatMapData = hmData && (hmData.likelihoodReasoning || hmData.materialityReasoning || hmData.reasoning);

                let heatMapContext = '';
                if (hasHeatMapData) {
                    heatMapContext = `

HEAT MAP ASSESSMENT:
- Likelihood: ${hmData.likelihood}/10${hmData.likelihoodReasoning ? ` (${hmData.likelihoodReasoning})` : ''}
- Materiality (Impact to RBC): ${hmData.materiality}/10${hmData.materialityReasoning ? ` (${hmData.materialityReasoning})` : ''}
- Velocity: ${hmData.velocity} (1=slow, 2=medium, 3=fast)${hmData.reasoning ? ` (${hmData.reasoning})` : ''}`;
                }

                // Create AI prompt with dual mode: Q&A vs Editing
                const systemPrompt = `You are an expert financial risk analyst helping users understand and refine risk drivers for stress testing scenarios at Royal Bank of Canada (RBC).

CURRENT RISK DRIVER:
- Title: "${driver.title}"
- Category: "${driver.cat}"
- Description: "${driver.desc}"${heatMapContext}

YOUR ROLE - TWO MODES:

**MODE 1: Q&A (DEFAULT)**
If the user asks questions like "what does this mean?", "why is this important?", "how does this affect RBC?", etc.:
- Provide helpful explanations and answers
- Do NOT modify the driver
- Do NOT include any JSON in your response
- Just have a natural conversation

**MODE 2: EDITING**
If the user explicitly asks to CHANGE, UPDATE, MODIFY, or ADJUST something:
- For description/title changes: Update and return JSON with new values
- For heat map assessment changes (likelihood/materiality/velocity): Update the scores
- Provide brief explanation of changes

EDITING FORMAT:
When making changes, respond with:
1. Brief explanation (2-3 sentences)
2. JSON block with updates:

\`\`\`json
{
  "title": "New title (only if changed)",
  "desc": "New description (only if changed)",
  "likelihood": 7,  // 1-10, only if heat map exists and user requests change
  "materiality": 8,  // 1-10, only if heat map exists and user requests change
  "velocity": 2,     // 1-3, only if heat map exists and user requests change
  "likelihoodReasoning": "Brief justification for the likelihood score",
  "materialityReasoning": "Brief justification for the materiality score",
  "reasoning": "Brief explanation for velocity and overall assessment"
}
\`\`\`

Only include fields that are being changed. Omit fields that stay the same.

CONFIRMATION:
If the user's intent is unclear (could be Q&A or editing), ask them to clarify before making changes.

KEY PHRASES THAT INDICATE EDITING:
- "change the", "update the", "modify the", "adjust the", "make it more/less"
- "increase/decrease likelihood", "set materiality to", "change velocity"
- "rewrite", "revise", "fix"

KEY PHRASES THAT INDICATE Q&A:
- "what", "why", "how", "explain", "tell me about", "what does this mean"
- "why is this risky", "how does this impact", "what are the implications"`;

                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...conversationHistory
                        ],
                        // temperature omitted - GPT-5 only supports default value of 1
                        max_tokens: 20000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();

                // Parse AI response to extract updates (if any)
                let updates = null;
                let explanationText = aiResponse;

                // Try to extract JSON from the response
                const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    try {
                        updates = JSON.parse(jsonMatch[1]);
                        // Get explanation text (everything before the JSON block)
                        explanationText = aiResponse.substring(0, aiResponse.indexOf('```json')).trim();
                    } catch (e) {
                        console.error('Failed to parse update JSON:', e);
                    }
                }

                let needsRerender = false;
                let needsHeatMapUpdate = false;

                // Apply updates if we got valid JSON
                if (updates) {
                    // Update driver description/title
                    if (updates.title) {
                        driver.title = updates.title;
                        document.getElementById('modalTitle').innerText = driver.title;
                        needsRerender = true;
                    }
                    if (updates.desc) {
                        driver.desc = updates.desc;
                        // Will update modal desc below after heat map check
                        needsRerender = true;
                    }

                    // Update heat map assessment if provided
                    const currentHmData = heatMapData[driver.id];
                    if (currentHmData && (updates.likelihood || updates.materiality || updates.velocity || updates.reasoning || updates.likelihoodReasoning || updates.materialityReasoning)) {
                        if (updates.likelihood) {
                            currentHmData.likelihood = Math.max(1, Math.min(10, updates.likelihood));
                            needsHeatMapUpdate = true;
                        }
                        if (updates.materiality) {
                            currentHmData.materiality = Math.max(1, Math.min(10, updates.materiality));
                            needsHeatMapUpdate = true;
                        }
                        if (updates.velocity) {
                            currentHmData.velocity = Math.max(1, Math.min(3, updates.velocity));
                            needsHeatMapUpdate = true;
                        }
                        if (updates.likelihoodReasoning) {
                            currentHmData.likelihoodReasoning = updates.likelihoodReasoning;
                        }
                        if (updates.materialityReasoning) {
                            currentHmData.materialityReasoning = updates.materialityReasoning;
                        }
                        if (updates.reasoning) {
                            currentHmData.reasoning = updates.reasoning;
                        }

                        console.log('âœ“ Heat map assessment updated:', currentHmData);
                    }

                    // Update modal description with latest heat map data
                    if (updates.desc || needsHeatMapUpdate) {
                        const updatedHmData = heatMapData[driver.id];
                        let descContent = driver.desc;

                        if (updatedHmData && (updatedHmData.likelihoodReasoning || updatedHmData.materialityReasoning || updatedHmData.reasoning)) {
                            const likelihoodLevel = getLevelLabel(updatedHmData.likelihood);
                            const materialityLevel = getLevelLabel(updatedHmData.materiality);
                            const velocityLabel = updatedHmData.velocity === 3 ? 'High' : updatedHmData.velocity === 2 ? 'Medium' : 'Low';

                            descContent += `\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ“Š HEAT MAP ASSESSMENT:\n`;
                            descContent += `\nðŸ“ˆ Likelihood: ${likelihoodLevel} (${updatedHmData.likelihood}/10)`;
                            if (updatedHmData.likelihoodReasoning) {
                                descContent += `\n   â†’ ${updatedHmData.likelihoodReasoning}`;
                            }
                            descContent += `\n\nðŸ’¥ Materiality: ${materialityLevel} (${updatedHmData.materiality}/10)`;
                            if (updatedHmData.materialityReasoning) {
                                descContent += `\n   â†’ ${updatedHmData.materialityReasoning}`;
                            }
                            descContent += `\n\nâš¡ Velocity: ${velocityLabel}`;
                            if (updatedHmData.reasoning) {
                                descContent += `\n   â†’ ${updatedHmData.reasoning}`;
                            }
                        }

                        document.getElementById('modalDesc').innerText = descContent;
                    }

                    if (needsRerender) {
                        // Save updated driver to cache
                        saveToCache(`${DRIVERS_CACHE_KEY}_current`, INITIAL_DRIVERS);
                        console.log('âœ“ Driver updates saved to cache');
                    }
                }

                // Add AI response to chat history (explanation only, no JSON)
                const displayText = explanationText || (updates ? "Updates applied. Check the changes above." : aiResponse);
                driver.chatHistory.push({ role: 'ai', text: displayText });

                // Re-render components as needed
                renderChat(driver);
                if (needsRerender) {
                    renderMarketplace();
                    updateInventory();
                }
                if (needsHeatMapUpdate) {
                    renderHeatMap(); // Update heat map visual positions
                    renderHeatMapDriverList(); // Update driver list
                }

            } catch (error) {
                console.error('AI refinement error:', error);

                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();

                // Add error message to chat
                driver.chatHistory.push({
                    role: 'ai',
                    text: `Sorry, I encountered an error while processing your request: ${error.message}. Please try again.`
                });
                renderChat(driver);
            }

            input.disabled = false;
            input.focus();
        }

        // --- 4. DRIVER SELECTION ---
        function toggleDriver(id) {
            const card = document.getElementById(`card_${id}`);
            const driver = INITIAL_DRIVERS.find(d => d.id === id);
            if (!driver) return;

            const idx = selectedDrivers.findIndex(d => d.id === id);
            if (idx > -1) {
                selectedDrivers.splice(idx, 1);
                if (card) card.classList.remove('selected');
            } else {
                selectedDrivers.push(driver);
                if (card) card.classList.add('selected');
            }
            updateInventory();
        }

        function updateInventory() {
            const list = document.getElementById('inventoryList');
            const countEl = document.getElementById('count');
            const btn = document.getElementById('generateBtn');
            const heatMapBtn = document.getElementById('generateHeatMapBtn');

            countEl.innerText = selectedDrivers.length;
            btn.disabled = selectedDrivers.length === 0;
            if (heatMapBtn) {
                heatMapBtn.disabled = selectedDrivers.length === 0;
            }

            if (selectedDrivers.length === 0) {
                list.innerHTML = `
                    <div class="basket-empty">
                        <div class="basket-empty-icon">ðŸ›’</div>
                        <p>Your basket is empty.<br>Click drivers to add them.</p>
                    </div>
                `;
            } else {
                list.innerHTML = selectedDrivers.map(d => `
                    <div class="basket-item" onclick="openDriverDetails('${d.id}')">
                        <div class="basket-item-info">
                            <div class="basket-item-dot" style="background: ${d.textColor}"></div>
                            <span class="basket-item-title">${d.title}</span>
                        </div>
                        <span class="basket-remove" onclick="event.stopPropagation(); toggleDriver('${d.id}')">âœ•</span>
                    </div>
                `).join('');
            }
        }


        // --- 5. CUSTOM DRIVER CREATION ---
        function handleEnter(e) {
            if (e.key === 'Enter') createCustomDriver();
        }

        async function createCustomDriver() {
            const input = document.getElementById('aiInput');
            const query = input.value.trim();
            if (!query) return;

            const originalPlaceholder = input.placeholder;
            input.value = "";
            input.disabled = true;

            // Check if this is a hypothetical scenario (keywords: "hypothetical", "what if", "scenario:")
            const isHypothetical = /\b(hypothetical|what if|scenario:|imagine|suppose)\b/i.test(query);

            try {
                // Step 1: Search Tavily API for relevant information (skip for hypothetical scenarios)
                let tavilyResults = [];
                let usingTavily = false;

                if (!isHypothetical) {
                    input.placeholder = "ðŸ” Searching market intelligence...";
                    try {
                        tavilyResults = await fetchTavilySearch(query);
                        usingTavily = true;
                    } catch (tavilyError) {
                        console.warn('Tavily API failed, proceeding without market intelligence:', tavilyError);
                    }
                } else {
                    console.log('ðŸ“ Hypothetical scenario detected - skipping Tavily search');
                    input.placeholder = "ðŸ¤– Creating hypothetical scenario...";
                }

                // Step 2: Prepare context for AI
                input.placeholder = "ðŸ¤– AI is analyzing your request...";
                let sourcesSummary = '';

                if (tavilyResults && tavilyResults.length > 0) {
                    sourcesSummary = tavilyResults.slice(0, 5).map((r, idx) =>
                        `${idx + 1}. "${r.title}": ${r.content?.substring(0, 300) || 'No content available'}...`
                    ).join('\n\n');
                }

                // Step 3: Use AI to generate a structured risk driver
                console.log('ðŸ¤– Calling Azure OpenAI to generate risk driver...');

                const prompt = usingTavily && tavilyResults.length > 0
                    ? `You are an expert financial risk analyst at Royal Bank of Canada (RBC) specializing in FORWARD-LOOKING risk assessment for stress testing.

USER SEARCH QUERY: "${query}"

TAVILY SEARCH RESULTS (for context only):
${sourcesSummary}

CRITICAL INSTRUCTIONS - FORWARD-LOOKING RISK DRIVER:
1. Use the search results as CONTEXT about current/recent developments
2. DO NOT simply summarize what has already happened
3. Focus on what COULD HAPPEN NEXT - potential escalation, contagion, or deterioration
4. Project forward: "If current trends continue/worsen, what are the risks?"
5. Describe TRANSMISSION CHANNELS: How does this evolve into an RBC/Canadian banking risk?
6. Quantify POTENTIAL impacts using conditional language ("could lead to...", "may result in...")

EXAMPLES OF FORWARD-LOOKING FRAMING:
âŒ BAD (backward-looking): "Inflation reached 3.5% in Q4 2025"
âœ… GOOD (forward-looking): "Persistent inflation above 3.5% could force aggressive BoC tightening, triggering mortgage defaults"

âŒ BAD: "Trade tensions between US and China escalated"
âœ… GOOD: "Escalating US-China trade war could disrupt Canadian exports, weaken CAD, and stress commodity-dependent loan portfolios"

Generate a FORWARD-LOOKING risk driver. Return a JSON object:

{
  "category": "Macroeconomic" | "Geopolitical" | "Cyber / Tech" | "Financial" | "Environmental" | "Social" | "Regulatory",
  "title": "Concise 4-8 word title focused on the FUTURE risk (e.g., 'Stagflation Triggers Wave of Mortgage Defaults')",
  "description": "50-100 word FORWARD-LOOKING description. Use conditional/future language ('could', 'may', 'if...then', 'would lead to'). Describe the following: escalation scenarios, contagion risks, transmission to RBC. Quantify potential impacts where possible.",
  "keyFindings": ["Forward-looking risk pathway 1", "Potential escalation scenario 2", "Transmission channel to RBC 3"],
  "suggestedRefinements": ["Refine severity assumptions", "Adjust time horizon"]
}

Return ONLY the JSON object.`
                    : `You are an expert financial risk analyst at Royal Bank of Canada (RBC) specializing in FORWARD-LOOKING risk assessment for stress testing.

USER REQUEST: "${query}"

${isHypothetical ? `This is a HYPOTHETICAL scenario for stress testing purposes. You do NOT need news sources or real events. Create a plausible, detailed FORWARD-LOOKING risk driver.

CRITICAL INSTRUCTIONS FOR HYPOTHETICAL SCENARIOS:
1. DO NOT search for or reference real news articles
2. DO NOT claim this event has happened or cite sources
3. Focus on what COULD HAPPEN if this scenario were to occur or escalate
4. Project forward: describe the evolution and contagion pathways
5. Describe TRANSMISSION CHANNELS to RBC and Canadian financial system (specific business lines, portfolios, funding sources)
6. Quantify POTENTIAL impacts using conditional language (e.g., "could widen credit spreads by +150-250 bps", "may trigger $X billion in provisions")
7. Make it realistic and actionable for stress testing` : `NOTE: Market intelligence is unavailable. Create a FORWARD-LOOKING risk driver based on financial risk expertise.

CRITICAL: Focus on FUTURE scenarios, not past events. Use conditional language to describe what COULD happen.`}

EXAMPLES OF FORWARD-LOOKING FRAMING:
âœ… "If [scenario] escalates, could lead to..."
âœ… "Contagion risk: may spread to [sector/geography]..."
âœ… "Potential impacts: credit spreads +X bps, provisions up $Y billion..."

Generate a FORWARD-LOOKING risk driver. Return a JSON object:

{
  "category": "Macroeconomic" | "Geopolitical" | "Cyber / Tech" | "Financial" | "Environmental" | "Social" | "Regulatory",
  "title": "Concise 4-8 word title focused on the FUTURE risk",
  "description": "50-100 word FORWARD-LOOKING description. Use conditional/future language ('could', 'may', 'if...then'). Describe future impacts: escalation pathways, contagion risks, transmission to RBC. ${isHypothetical ? 'Explain HOW scenario evolves and impacts specific RBC business lines. DO NOT claim this has happened.' : 'Be specific and actionable.'}",
  "keyFindings": ["${isHypothetical ? 'Escalation pathway 1 if scenario unfolds' : 'Forward-looking risk 1'}", "${isHypothetical ? 'Contagion risk 2' : 'Potential development 2'}", "${isHypothetical ? 'RBC transmission channel 3' : 'Future impact 3'}"],
  "suggestedRefinements": ["Adjust severity/time horizon", "Refine transmission assumptions"]
}

Return ONLY the JSON object.`;

                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [{ role: 'user', content: prompt }],
                        // temperature omitted - GPT-5 only supports default value of 1
                        max_tokens: 20000
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Azure OpenAI API HTTP ${response.status}:`, errorText);
                    throw new Error(`Azure OpenAI API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('âœ“ Azure OpenAI response received');
                const aiResponse = data.choices[0].message.content;

                // Parse AI response
                let driverData;
                try {
                    const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/) ||
                        aiResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        driverData = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                    } else {
                        throw new Error('No JSON in response');
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                    throw new Error('Failed to parse AI response');
                }

                // Step 4: Create the driver object
                const newId = 'cust_' + Date.now();
                // Custom drivers always go under "Customized" category
                const customCategory = 'Customized';
                const colors = { tagColor: '#CFFAFE', textColor: '#0E7490' }; // Teal/Cyan - unique color

                // Build initial chat message with context
                const keyFindingsHtml = driverData.keyFindings?.map(f => `â€¢ ${f}`).join('<br>') || '';
                const refinementsHtml = driverData.suggestedRefinements?.map(r => `â€¢ ${r}`).join('<br>') || '';

                const initialChatMessage = usingTavily && tavilyResults.length > 0
                    ? `I've created a <strong>FORWARD-LOOKING</strong> risk driver based on ${tavilyResults.length} sources about "${query}".

<strong>Projected Risk Pathways:</strong><br>${keyFindingsHtml}

<strong>You can refine this driver by asking me to:</strong><br>${refinementsHtml}

Or tell me to adjust severity, time horizon, or transmission assumptions (e.g., "make it more severe", "focus on 3-month horizon", "quantify credit spread impact").`
                    : isHypothetical
                        ? `I've created a <strong>HYPOTHETICAL FORWARD-LOOKING</strong> risk driver: "${query}".

âš ï¸ <strong>Note:</strong> This is a scenario-based driver for stress testing (no real-world sources required).

<strong>Potential Escalation Pathways:</strong><br>${keyFindingsHtml}

<strong>You can refine this scenario by asking me to:</strong><br>${refinementsHtml}

Or tell me to adjust severity, time horizon, or quantify specific impacts (e.g., "increase to 18-month scenario", "add credit spread widening +200 bps").`
                        : `I've created a <strong>FORWARD-LOOKING</strong> risk driver based on your request: "${query}".

<strong>âš ï¸ Note:</strong> This driver was created without live market intelligence (Tavily unavailable).

<strong>Projected Risk Developments:</strong><br>${keyFindingsHtml}

<strong>You can refine this driver by asking me to:</strong><br>${refinementsHtml}

Or tell me to adjust severity, time horizon, or transmission channels.`;

                const newDriver = {
                    id: newId,
                    cat: customCategory,
                    title: driverData.title || query.split(' ').slice(0, 5).join(' '),
                    desc: driverData.description || `Risk driver based on "${query}".`,
                    tagColor: colors.tagColor,
                    textColor: colors.textColor,
                    chatHistory: [
                        { role: 'ai', text: initialChatMessage }
                    ],
                    tavilyContext: tavilyResults && tavilyResults.length > 0 ? tavilyResults : [] // Store for potential future refinement
                };

                INITIAL_DRIVERS.push(newDriver);
                saveCustomDrivers(); // Persist custom drivers to localStorage
                renderMarketplace();

                const successMessage = usingTavily && tavilyResults.length > 0
                    ? "âœ“ Driver created with market intelligence!"
                    : isHypothetical
                        ? "âœ“ Hypothetical scenario created!"
                        : "âœ“ Driver created (without Tavily data)";

                input.placeholder = successMessage;
                setTimeout(() => { input.placeholder = originalPlaceholder; }, 3000);

                openDriverDetails(newId);

            } catch (error) {
                console.error('Custom driver creation error:', error);
                input.placeholder = `Error: ${error.message}. Try again.`;
                setTimeout(() => { input.placeholder = originalPlaceholder; }, 3000);
            } finally {
                input.disabled = false;
            }
        }

        // --- 6. SCENARIO GENERATION (AI-Powered) ---
        async function generateScenario() {
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loaderText');

            if (selectedDrivers.length === 0) {
                alert('Please select at least one risk driver.');
                return;
            }

            loader.style.display = 'flex';
            loaderText.innerText = 'Fetching baseline macro data...';

            try {
                // Determine current period info for baseline data
                const currentPeriodInfo = {
                    quarter: `Q${Math.ceil((new Date().getMonth() + 1) / 3)}`,
                    year: new Date().getFullYear()
                };

                // Fetch baseline macro data from CSV
                const baselineMacroData = await fetchBaselineMacroData(currentPeriodInfo);

                // Build baseline context for AI prompt and extract numeric values
                let baselineContext = '';
                let baselineNumericValues = {};

                if (baselineMacroData && baselineMacroData.values) {
                    const vals = baselineMacroData.values;

                    // Extract numeric values from formatted strings
                    const extractNumeric = (val) => {
                        if (!val) return null;
                        const match = val.match(/^([+-]?\d+\.?\d*)/);
                        return match ? parseFloat(match[1]) : null;
                    };

                    const extractQoQ = (val) => {
                        const match = val?.match(/QoQ:\s*([+-]?\d+\.\d+%)/);
                        return match ? match[1] : val;
                    };

                    const extractQoQNumeric = (val) => {
                        const match = val?.match(/QoQ:\s*([+-]?\d+\.\d+)/);
                        return match ? parseFloat(match[1]) : null;
                    };

                    // Store numeric baseline values for later delta calculation
                    baselineNumericValues = {
                        gdp: extractQoQNumeric(vals['Canada GDP']),
                        unemployment: extractNumeric(vals['Unemployment Rate']),
                        inflation: extractNumeric(vals['CPI Inflation']),
                        cadUsd: extractNumeric(vals['CAD/USD']),
                        bocRate: extractNumeric(vals['BoC Rate']),
                        hpi: extractQoQNumeric(vals['House Price Index']),
                        tsx: extractQoQNumeric(vals['TSX Composite']),
                        creditSpreads: extractNumeric(vals['Credit Spreads'])
                    };

                    console.log('ðŸ“Š Extracted baseline numeric values:', baselineNumericValues);

                    baselineContext = `
BASELINE MACROECONOMIC DATA (${currentPeriodInfo.quarter} ${currentPeriodInfo.year}):
- Canada GDP Growth (QoQ): ${extractQoQ(vals['Canada GDP']) || 'N/A'}
- Unemployment Rate: ${vals['Unemployment Rate'] || 'N/A'}
- CPI Inflation: ${vals['CPI Inflation'] || 'N/A'}
- USD/CAD Exchange Rate: ${vals['CAD/USD'] || 'N/A'} (CAD per 1 USD - higher = weaker CAD)
- Bank of Canada Policy Rate: ${vals['BoC Rate'] || 'N/A'}
- House Price Index (QoQ): ${extractQoQ(vals['House Price Index']) || 'N/A'}
- TSX Composite (QoQ): ${extractQoQ(vals['TSX Composite']) || 'N/A'}
- Credit Spreads (10Y BBB): ${vals['Credit Spreads'] || 'N/A'}

These are reference values for context only. Generate stress projections as absolute values; the system will calculate deltas automatically.

CRITICAL: For USD/CAD, use the format "1.XX" (CAD per 1 USD). For example, 1.45 means 1 USD = 1.45 CAD. Higher values = weaker CAD, lower values = stronger CAD.
`;
                }

                // Store for post-processing
                window.currentBaselineValues = baselineNumericValues;

                loaderText.innerText = 'Preparing scenario analysis...';

                // Build driver summary for the AI
                const driversSummary = selectedDrivers.map((d, idx) =>
                    `${idx + 1}. [${d.cat}] ${d.title}: ${d.desc}`
                ).join('\n');

                const prompt = `You are an expert financial risk analyst at Royal Bank of Canada (RBC). Generate a comprehensive stress testing scenario report based on the following risk drivers that have been selected and refined by the risk team.

${baselineContext}

SELECTED RISK DRIVERS:
${driversSummary}

Generate a cohesive scenario narrative that combines these drivers into a plausible stress scenario. Your response must be a valid JSON object with the following structure:

{
  "scenarioTitle": "A compelling 3-6 word title for the scenario (e.g., 'Perfect Storm 2026' or 'Global Trade Collapse')",
  "globalConditions": {
    "summary": "3-4 paragraphs (HTML formatted with <p> tags and <strong> for emphasis) describing global economic and geopolitical conditions that set the stage for this scenario. Reference specific drivers where relevant.",
    "keyPoints": ["Point 1", "Point 2", "Point 3"]
  },
  "canadianConditions": {
    "summary": "3-4 paragraphs (HTML formatted) describing how these global conditions specifically impact the Canadian economy, housing market, energy sector, and Bank of Canada policy.",
    "keyPoints": ["Point 1", "Point 2", "Point 3"]
  },
  "rbcImpact": {
    "summary": "3-4 paragraphs (HTML formatted) describing the direct impact on RBC's business lines including: Personal & Commercial Banking (mortgages, credit cards), Capital Markets (trading, underwriting), Wealth Management (AUM), and overall capital/liquidity position.",
    "keyPoints": ["Point 1", "Point 2", "Point 3"]
  },
  "macroProjections": {
    "canadaGDP": { "value": "-X.X%" },
    "unemployment": { "value": "X.X%" },
    "inflation": { "value": "X.X%" },
    "usdCad": { "value": "1.XX" },
    "bocRate": { "value": "X.X%" },
    "housePrice": { "value": "-XX%" },
    "tsx": { "value": "-XX%" },
    "creditSpreads": { "value": "XXX" }
  }
  
IMPORTANT: Only provide the STRESS/PROJECTION values. Do NOT include delta or direction fields. The system will automatically calculate deltas from baseline.

CRITICAL: For usdCad, use format "1.XX" representing CAD per 1 USD (e.g., 1.45 means 1 USD = 1.45 CAD). Higher values = weaker CAD.
}

CRITICAL GUIDELINES FOR MACRO PROJECTIONS:
1. **Economic Coherence**: Ensure all variables move in economically consistent ways:
   - GDP contraction â†’ Unemployment rises, TSX falls, House prices fall, Credit spreads widen
   - CAD typically weakens in recession (lower commodity demand, risk-off)
   - BoC cuts rates aggressively in recession to stimulate economy
   - Inflation: Falls in demand-driven recession, but can rise in stagflation (supply shocks + weak growth)
   
2. **Severity Calibration** (use these as guides):
   - **Mild recession**: GDP -1% to -2%, Unemp 6.5-7.5%, HPI -5 to -10%, TSX -10 to -15%
   - **Moderate recession**: GDP -2.5% to -4%, Unemp 7.5-9%, HPI -12 to -20%, TSX -18 to -25%
   - **Severe recession**: GDP -4.5% to -6%+, Unemp 9-11%+, HPI -22 to -30%+, TSX -28 to -35%+
   - **Stagflation**: GDP -2 to -3%, Unemp 7-9%, Inflation 4-6%+, HPI -10 to -18%
   
3. **Variable Relationships** (maintain these correlations):
   - GDP vs Unemployment: Roughly -2:1 ratio (e.g., -3% GDP â†’ +1.5% unemployment increase)
   - GDP vs TSX: TSX typically falls 5-7x GDP contraction (e.g., -3% GDP â†’ -18% TSX)
   - GDP vs House Prices: HPI falls 4-6x GDP contraction (e.g., -3% GDP â†’ -15% HPI)
   - BoC Rate: Cut 25-50 bps per 1% GDP contraction expected
   - Credit Spreads: Widen 50-100 bps in moderate stress, 150-300 bps in severe stress
   


IMPORTANT GUIDELINES:
- Make the macro projections realistic and internally consistent with the scenario severity
- For a moderate scenario: GDP -1.5% to -3%, unemployment 6-8%
- For a severe scenario: GDP -3% to -6%, unemployment 8-10%
- For a very severe scenario: GDP -7% or worse, unemployment 10%+
- Ensure the narrative logically connects the selected drivers
- Reference actual Canadian/RBC context (Big 6 banks, OSFI regulations, BoC policy)

CRITICAL ANTI-HALLUCINATION RULES FOR SCENARIO NARRATIVE:
1. **NO INVENTED POLICY ACTIONS**: Do NOT fabricate central bank actions (e.g., "successive interest rate hikes by the Bank of Canada"). Only reference policy actions explicitly mentioned in the selected risk drivers or baseline data.
2. **DRIVER-BASED ONLY**: Every claim in the narrative must trace back to one of the selected risk drivers. Do not add generic industry commentary or fabricated events.
3. **NO SPECULATION BEYOND DRIVERS**: Only project what logically follows from the selected drivers. Do not invent additional crises, bank failures, or events not implied by the drivers.
4. **BASELINE ACCURACY**: Use the provided baseline macro data accurately. Do not invent baseline values or trends.
5. **REAL ENTITIES ONLY**: Reference only real institutions (RBC, Bank of Canada, OSFI, Big 6 banks). Do not invent fictional banks, regulations, or policies.

Return ONLY the JSON object, no additional text or markdown formatting.`;

                loaderText.innerText = 'AI is generating scenario narrative...';

                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [{ role: 'user', content: prompt }],
                        // temperature omitted - GPT-5 only supports default value of 1
                        max_tokens: 20000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                loaderText.innerText = 'Processing scenario data...';

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Parse the JSON response
                let scenario;
                try {
                    // Try to extract JSON if wrapped in markdown
                    const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/) ||
                        aiResponse.match(/```\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) {
                        scenario = JSON.parse(jsonMatch[1]);
                    } else {
                        scenario = JSON.parse(aiResponse);
                    }
                } catch (parseError) {
                    console.error('Failed to parse scenario JSON:', parseError);
                    console.log('Raw response:', aiResponse);
                    throw new Error('Failed to parse AI response');
                }

                // POST-PROCESS: Calculate macro deltas and directions from baseline values
                console.log('ðŸ“Š Checking post-processing conditions...');
                console.log('   - scenario.macroProjections exists?', !!scenario.macroProjections);
                console.log('   - baselineNumericValues exists?', !!baselineNumericValues);
                console.log('   - baselineNumericValues content:', baselineNumericValues);

                if (scenario.macroProjections && baselineNumericValues && Object.keys(baselineNumericValues).length > 0) {
                    const macro = scenario.macroProjections;

                    console.log('ðŸ“Š Post-processing macro projections with baselines:', baselineNumericValues);
                    console.log('ðŸ“Š AI-generated macro projections:', macro);

                    // Helper to extract numeric value from string (handles "X.X%" or "X.X" formats)
                    const extractNumber = (val) => {
                        if (typeof val === 'number') return val;
                        if (typeof val === 'string') {
                            const cleaned = val.replace(/[^\d.-]/g, '');
                            return parseFloat(cleaned);
                        }
                        return NaN;
                    };

                    // Canada GDP - calculate delta from baseline
                    if (macro.canadaGDP && macro.canadaGDP.value) {
                        const gdpValue = extractNumber(macro.canadaGDP.value);
                        console.log('GDP value:', macro.canadaGDP.value, 'â†’', gdpValue);
                        if (!isNaN(gdpValue)) {
                            const absDelta = Math.abs(gdpValue).toFixed(1);
                            macro.canadaGDP.delta = `â†“ ${absDelta}% from current`;
                            macro.canadaGDP.direction = 'negative';
                        }
                    }

                    // Unemployment - calculate delta from actual baseline
                    if (macro.unemployment && macro.unemployment.value && baselineNumericValues.unemployment) {
                        const stressValue = extractNumber(macro.unemployment.value);
                        const baselineValue = baselineNumericValues.unemployment;
                        console.log('Unemployment:', macro.unemployment.value, 'â†’', stressValue, 'vs baseline', baselineValue);
                        if (!isNaN(stressValue)) {
                            const delta = stressValue - baselineValue;
                            const arrow = delta > 0 ? 'â†‘' : 'â†“';
                            macro.unemployment.delta = `${arrow} to ${stressValue.toFixed(1)}% from ${baselineValue.toFixed(1)}%`;
                            macro.unemployment.direction = delta > 0 ? 'negative' : 'positive';
                        }
                    }

                    // CPI Inflation - calculate delta from actual baseline
                    if (macro.inflation && macro.inflation.value && baselineNumericValues.inflation) {
                        const stressValue = extractNumber(macro.inflation.value);
                        const baselineValue = baselineNumericValues.inflation;
                        console.log('Inflation:', macro.inflation.value, 'â†’', stressValue, 'vs baseline', baselineValue);
                        if (!isNaN(stressValue)) {
                            const delta = stressValue - baselineValue;
                            const arrow = delta > 0 ? 'â†‘' : 'â†“';
                            macro.inflation.delta = `${arrow} to ${stressValue.toFixed(1)}% from ${baselineValue.toFixed(1)}%`;
                            // High inflation is bad (negative), low inflation is good (positive) in stress context
                            macro.inflation.direction = delta > 0 ? 'negative' : 'positive';
                        }
                    }

                    // USD/CAD - calculate delta from actual baseline (support both usdCad and cadUsd keys)
                    const usdCadData = macro.usdCad || macro.cadUsd;
                    if (usdCadData && usdCadData.value && baselineNumericValues.cadUsd) {
                        const stressValue = extractNumber(usdCadData.value);
                        const baselineValue = baselineNumericValues.cadUsd;
                        console.log('USD/CAD:', usdCadData.value, 'â†’', stressValue, 'vs baseline', baselineValue);
                        if (!isNaN(stressValue)) {
                            const delta = stressValue - baselineValue;
                            const arrow = delta > 0 ? 'â†‘' : 'â†“';
                            usdCadData.delta = `${arrow} to ${stressValue.toFixed(2)} from ${baselineValue.toFixed(2)}`;
                            // Weaker CAD (higher USD/CAD) is generally negative
                            usdCadData.direction = delta > 0 ? 'negative' : 'positive';
                        }
                        // Ensure both keys point to same object for compatibility
                        if (macro.usdCad) macro.cadUsd = macro.usdCad;
                        if (macro.cadUsd && !macro.usdCad) macro.usdCad = macro.cadUsd;
                    }

                    // BoC Rate - calculate delta from actual baseline
                    if (macro.bocRate && macro.bocRate.value && baselineNumericValues.bocRate) {
                        const stressValue = extractNumber(macro.bocRate.value);
                        const baselineValue = baselineNumericValues.bocRate;
                        console.log('BoC Rate:', macro.bocRate.value, 'â†’', stressValue, 'vs baseline', baselineValue);
                        if (!isNaN(stressValue)) {
                            const deltaBps = Math.round((stressValue - baselineValue) * 100);
                            const arrow = deltaBps < 0 ? 'â†“' : 'â†‘';
                            macro.bocRate.delta = `${arrow} ${Math.abs(deltaBps)} bps to ${stressValue.toFixed(2)}% from ${baselineValue.toFixed(1)}%`;
                            // Rate cuts are typically positive in stress scenarios (stimulus)
                            macro.bocRate.direction = deltaBps < 0 ? 'positive' : 'negative';
                        }
                    }

                    // House Price Index - calculate delta
                    if (macro.housePrice && macro.housePrice.value) {
                        const hpiValue = extractNumber(macro.housePrice.value);
                        console.log('HPI:', macro.housePrice.value, 'â†’', hpiValue);
                        if (!isNaN(hpiValue)) {
                            macro.housePrice.delta = `â†“ ${Math.abs(hpiValue).toFixed(1)}% from current`;
                            macro.housePrice.direction = 'negative';
                        }
                    }

                    // TSX Composite - calculate delta
                    if (macro.tsx && macro.tsx.value) {
                        const tsxValue = extractNumber(macro.tsx.value);
                        console.log('TSX:', macro.tsx.value, 'â†’', tsxValue);
                        if (!isNaN(tsxValue)) {
                            macro.tsx.delta = `â†“ ${Math.abs(tsxValue).toFixed(1)}% from current`;
                            macro.tsx.direction = 'negative';
                        }
                    }

                    // Credit Spreads - calculate delta from actual baseline
                    if (macro.creditSpreads && macro.creditSpreads.value && baselineNumericValues.creditSpreads) {
                        const stressValue = extractNumber(macro.creditSpreads.value);
                        const baselineValue = baselineNumericValues.creditSpreads;
                        console.log('Credit Spreads:', macro.creditSpreads.value, 'â†’', stressValue, 'vs baseline', baselineValue);
                        if (!isNaN(stressValue)) {
                            const stressBps = Math.round(stressValue * 100);
                            const baselineBps = Math.round(baselineValue * 100);
                            const deltaBps = stressBps - baselineBps;
                            macro.creditSpreads.value = `${stressBps} bps`;
                            macro.creditSpreads.delta = `â†‘ ${deltaBps} bps to ${stressBps} from ${baselineBps} bps`;
                            macro.creditSpreads.direction = 'negative';
                        }
                    }

                    console.log('ðŸ“Š Final processed macro projections:', macro);
                }

                loaderText.innerText = 'Rendering scenario report...';
                await new Promise(r => setTimeout(r, 500));

                // Store the generated scenario for later use
                window.currentGeneratedScenario = scenario;

                // Render the report
                renderAIReport(scenario);

            } catch (error) {
                console.error('Scenario generation error:', error);
                loaderText.innerText = `Error: ${error.message}. Falling back to default...`;
                await new Promise(r => setTimeout(r, 2000));

                // Fallback to static report
                generateFallbackReport();
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderAIReport(scenario) {
            const driverCount = selectedDrivers.length;
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Set title and subtitle
            document.getElementById('reportTitle').innerText = scenario.scenarioTitle || 'Stress Test Scenario';
            document.getElementById('reportSubtitle').innerText = `Generated on ${dateStr} | Based on ${driverCount} Risk Drivers`;

            // Render selected drivers
            document.getElementById('reportDriversList').innerHTML = selectedDrivers.map(d => `
                <span class="driver-pill" style="background: ${d.tagColor}; color: ${d.textColor};">${d.title}</span>
            `).join('');

            // Render global conditions
            document.getElementById('globalConditions').innerHTML = scenario.globalConditions?.summary ||
                '<p>Global conditions analysis unavailable.</p>';

            // Render Canadian conditions
            document.getElementById('canadianConditions').innerHTML = scenario.canadianConditions?.summary ||
                '<p>Canadian conditions analysis unavailable.</p>';

            // Render RBC impact
            document.getElementById('rbcImpact').innerHTML = scenario.rbcImpact?.summary ||
                '<p>RBC impact analysis unavailable.</p>';

            // Render macro projections
            const macro = scenario.macroProjections || {};
            document.getElementById('macroProjections').innerHTML = `
                <div class="macro-card">
                    <div class="macro-label">Canada GDP</div>
                    <div class="macro-value ${macro.canadaGDP?.direction || 'negative'}">${macro.canadaGDP?.value || 'N/A'}</div>
                    <div class="macro-delta">${macro.canadaGDP?.delta || ''}</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">Unemployment</div>
                    <div class="macro-value ${macro.unemployment?.direction || 'negative'}">${macro.unemployment?.value || 'N/A'}</div>
                    <div class="macro-delta">${macro.unemployment?.delta || ''}</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">CPI Inflation</div>
                    <div class="macro-value ${macro.inflation?.direction || 'negative'}">${macro.inflation?.value || 'N/A'}</div>
                    <div class="macro-delta">${macro.inflation?.delta || ''}</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">USD/CAD</div>
                    <div class="macro-value ${(macro.usdCad || macro.cadUsd)?.direction || 'negative'}">${(macro.usdCad || macro.cadUsd)?.value || 'N/A'}</div>
                    <div class="macro-delta">${(macro.usdCad || macro.cadUsd)?.delta || ''}</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">BoC Rate</div>
                    <div class="macro-value ${macro.bocRate?.direction === 'positive' ? '' : 'negative'}">${macro.bocRate?.value || 'N/A'}</div>
                    <div class="macro-delta" style="${macro.bocRate?.direction === 'positive' ? 'color: #059669;' : ''}">${macro.bocRate?.delta || ''}</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">House Price Index</div>
                    <div class="macro-value ${macro.housePrice?.direction || 'negative'}">${macro.housePrice?.value || 'N/A'}</div>
                    <div class="macro-delta">${macro.housePrice?.delta || ''}</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">TSX Composite</div>
                    <div class="macro-value ${macro.tsx?.direction || 'negative'}">${macro.tsx?.value || 'N/A'}</div>
                    <div class="macro-delta">${macro.tsx?.delta || ''}</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">Credit Spreads</div>
                    <div class="macro-value ${macro.creditSpreads?.direction || 'negative'}">${macro.creditSpreads?.value || 'N/A'}</div>
                    <div class="macro-delta">${macro.creditSpreads?.delta || ''}</div>
                </div>
            `;

            // Generate context-aware initial chat message for the report
            // Clear conversation history for new scenario generation
            reportChatHistory = [];
            currentScenarioId = null; // Reset scenario ID for new scenario

            const contextualReportSuggestions = getReportContextualSuggestions(selectedDrivers, scenario, macro);

            const initialMessage = `
                <div class="chat-message ai">
                    <p style="margin: 0 0 8px 0;">ðŸ“Š Scenario <strong>"${scenario.scenarioTitle}"</strong> has been generated based on ${driverCount} selected risk drivers.</p>
                    <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">Key projections: GDP ${macro.canadaGDP?.value || 'N/A'}, Unemployment ${macro.unemployment?.value || 'N/A'}, House Prices ${macro.housePrice?.value || 'N/A'}</p>
                    <p style="margin: 8px 0;">Based on the driver selection, consider:</p>
                    <ul style="margin: 8px 0 0 16px; padding: 0;">
                        ${contextualReportSuggestions.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                </div>
            `;

            document.getElementById('reportChatHistory').innerHTML = initialMessage;

            document.getElementById('reportOverlay').style.display = 'flex';
        }

        function getReportContextualSuggestions(drivers, scenario, macro) {
            const suggestions = [];

            // Analyze driver categories
            const categories = drivers.map(d => d.cat);
            const uniqueCategories = [...new Set(categories)];

            // Base suggestions
            suggestions.push('Adjust overall scenario severity (moderate â†’ severe â†’ very severe)');

            // Category-specific suggestions
            if (categories.includes('Macroeconomic') || categories.includes('Financial')) {
                const gdpValue = parseFloat(macro.canadaGDP?.value) || -2;
                if (gdpValue > -2) {
                    suggestions.push('Increase GDP decline to model a deeper recession');
                } else {
                    suggestions.push('Add second-round effects on consumer spending');
                }
            }

            if (categories.includes('Geopolitical') || categories.includes('Trade & Geopolitics')) {
                suggestions.push('Elaborate on trade disruption impacts to Canadian exports');
            }

            if (categories.includes('Environmental') || categories.includes('Climate')) {
                suggestions.push('Add regional breakdowns for climate-related losses (BC, Alberta, Ontario)');
            }

            if (categories.includes('Cyber / Tech') || categories.includes('AI & Cyber')) {
                suggestions.push('Model operational risk and potential regulatory response');
            }

            if (categories.includes('Regulatory')) {
                suggestions.push('Detail OSFI supervisory response and capital actions');
            }

            // Housing-specific if relevant
            const hasHousingDrivers = drivers.some(d =>
                d.title.toLowerCase().includes('housing') ||
                d.title.toLowerCase().includes('mortgage') ||
                d.desc.toLowerCase().includes('housing') ||
                d.desc.toLowerCase().includes('mortgage')
            );
            if (hasHousingDrivers) {
                suggestions.push('Break down mortgage impacts by product type (fixed vs. variable)');
            }

            // Tone suggestion
            suggestions.push('Make the narrative more formal for executive presentation');

            // Return top 5 most relevant
            return suggestions.slice(0, 5);
        }

        function generateFallbackReport() {
            const driverCount = selectedDrivers.length;
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            document.getElementById('reportTitle').innerText = 'Stress Test Scenario Analysis';
            document.getElementById('reportSubtitle').innerText = `Generated on ${dateStr} | Based on ${driverCount} Risk Drivers`;

            document.getElementById('reportDriversList').innerHTML = selectedDrivers.map(d => `
                <span class="driver-pill" style="background: ${d.tagColor}; color: ${d.textColor};">${d.title}</span>
            `).join('');

            document.getElementById('globalConditions').innerHTML = `
                <p><strong>Trade Disruptions:</strong> Global trade patterns are experiencing significant stress from the selected risk drivers, contributing to supply chain disruptions and inflationary pressures.</p>
                <p style="margin-top: 12px;"><strong>Monetary Policy Divergence:</strong> Central banks face challenging policy decisions as they balance growth concerns against inflation risks.</p>
                <p style="margin-top: 12px;"><strong>Geopolitical Tensions:</strong> Heightened geopolitical uncertainty is affecting investor confidence and capital flows globally.</p>
            `;

            document.getElementById('canadianConditions').innerHTML = `
                <p><strong>Housing Market Stress:</strong> Canadian housing markets face headwinds from the selected risk factors, with potential price corrections in major metropolitan areas.</p>
                <p style="margin-top: 12px;"><strong>Economic Growth:</strong> GDP growth faces downside risks from external shocks and domestic vulnerabilities.</p>
                <p style="margin-top: 12px;"><strong>BoC Policy:</strong> The Bank of Canada must navigate between supporting growth and maintaining price stability.</p>
            `;

            document.getElementById('rbcImpact').innerHTML = `
                <p><strong>Credit Quality:</strong> The selected risk drivers would likely impact credit quality across retail and commercial portfolios.</p>
                <p style="margin-top: 12px;"><strong>Capital Position:</strong> Capital ratios may face pressure requiring proactive management actions.</p>
                <p style="margin-top: 12px;"><strong>Revenue Impact:</strong> Trading and fee-based revenues may experience volatility under stress conditions.</p>
            `;

            document.getElementById('macroProjections').innerHTML = `
                <div class="macro-card">
                    <div class="macro-label">Canada GDP</div>
                    <div class="macro-value negative">-2.0%</div>
                    <div class="macro-delta">â†“ from +1.2% baseline</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">Unemployment</div>
                    <div class="macro-value negative">8.5%</div>
                    <div class="macro-delta">â†‘ from 5.8% baseline</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">CPI Inflation</div>
                    <div class="macro-value negative">4.5%</div>
                    <div class="macro-delta">â†‘ from 2.4% baseline</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">CAD/USD</div>
                    <div class="macro-value negative">0.70</div>
                    <div class="macro-delta">â†“ from 0.74 baseline</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">BoC Rate</div>
                    <div class="macro-value">3.50%</div>
                    <div class="macro-delta" style="color: #059669;">â†“ from 5.0% (cuts)</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">House Price Index</div>
                    <div class="macro-value negative">-20%</div>
                    <div class="macro-delta">Peak-to-trough</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">TSX Composite</div>
                    <div class="macro-value negative">-25%</div>
                    <div class="macro-delta">From current levels</div>
                </div>
                <div class="macro-card">
                    <div class="macro-label">Credit Spreads</div>
                    <div class="macro-value negative">+150 bps</div>
                    <div class="macro-delta">IG corporate widening</div>
                </div>
            `;

            document.getElementById('reportChatHistory').innerHTML = `
                <div class="chat-message ai">
                    A baseline scenario has been generated based on ${driverCount} selected risk drivers. AI service was unavailable; this is a template report. Use the input below to request refinements to specific sections.
                </div>
            `;

            document.getElementById('reportOverlay').style.display = 'flex';
        }

        function closeReport() {
            document.getElementById('reportOverlay').style.display = 'none';

            // Clear selected drivers when closing (same as save)
            selectedDrivers = [];
            currentScenarioId = null;
            renderMarketplace(); // Re-render to show unselected state
            updateInventory(); // Update basket to show empty
        }

        function addMoreDriversToScenario() {
            // Keep the current scenario's drivers in selectedDrivers (they're already there from openSavedReport)
            // Close the report overlay
            document.getElementById('reportOverlay').style.display = 'none';

            // Navigate to marketplace with the drivers still in the basket
            showMarketplace();

            // Update the inventory/basket to show current drivers
            updateInventory();

            // Show a helpful message
            const driverCount = selectedDrivers.length;
            console.log(`âœ“ Editing scenario with ${driverCount} drivers. Select more drivers and regenerate.`);
        }

        // --- SCENARIO ASSISTANT NOTIFICATIONS ---
        function notifyScenarioAssistant(message) {
            const chatHistoryEl = document.getElementById('reportChatHistory');
            if (!chatHistoryEl) return;

            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'chat-message ai';
            notificationDiv.style.background = '#FEF3C7';
            notificationDiv.style.color = '#92400E';
            notificationDiv.style.borderLeft = '4px solid #F59E0B';
            notificationDiv.innerText = message;
            chatHistoryEl.appendChild(notificationDiv);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        // --- 7. REPORT INTERACTION & SAVING ---
        let reportChatHistory = []; // Track report chat for context

        function handleReportChatEnter(e) {
            if (e.key === 'Enter') sendReportChatMessage();
        }

        async function sendReportChatMessage() {
            const input = document.getElementById('reportChatInput');
            const val = input.value.trim();
            if (!val) return;

            // Add User Message to UI
            const chatHistoryEl = document.getElementById('reportChatHistory');
            const userDiv = document.createElement('div');
            userDiv.className = 'chat-message user';
            userDiv.innerText = val;
            chatHistoryEl.appendChild(userDiv);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

            // Track in conversation history
            reportChatHistory.push({ role: 'user', content: val });

            input.value = '';
            input.disabled = true;

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai';
            typingDiv.style.fontStyle = 'italic';
            typingDiv.id = 'reportTypingIndicator';
            typingDiv.innerText = 'Analyzing and refining scenario...';
            chatHistoryEl.appendChild(typingDiv);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

            try {
                // Get current report state
                const currentReport = {
                    title: document.getElementById('reportTitle').innerText,
                    globalConditions: document.getElementById('globalConditions').innerHTML,
                    canadianConditions: document.getElementById('canadianConditions').innerHTML,
                    rbcImpact: document.getElementById('rbcImpact').innerHTML,
                    macroProjections: document.getElementById('macroProjections').innerHTML
                };

                const driversSummary = selectedDrivers.map((d, idx) =>
                    `${idx + 1}. [${d.cat}] ${d.title}: ${d.desc}`
                ).join('\n');

                // Get current macro projections from the UI
                const currentMacroValues = {};
                const macroCards = document.querySelectorAll('.macro-card');
                if (macroCards.length >= 8) {
                    currentMacroValues.gdp = macroCards[0]?.querySelector('.macro-value')?.innerText || 'N/A';
                    currentMacroValues.unemployment = macroCards[1]?.querySelector('.macro-value')?.innerText || 'N/A';
                    currentMacroValues.inflation = macroCards[2]?.querySelector('.macro-value')?.innerText || 'N/A';
                    currentMacroValues.usdCad = macroCards[3]?.querySelector('.macro-value')?.innerText || 'N/A';
                    currentMacroValues.bocRate = macroCards[4]?.querySelector('.macro-value')?.innerText || 'N/A';
                    currentMacroValues.housePrice = macroCards[5]?.querySelector('.macro-value')?.innerText || 'N/A';
                    currentMacroValues.tsx = macroCards[6]?.querySelector('.macro-value')?.innerText || 'N/A';
                    currentMacroValues.creditSpreads = macroCards[7]?.querySelector('.macro-value')?.innerText || 'N/A';
                }

                // Format baseline values for AI (if available)
                let baselineSection = '';
                if (window.currentBaselineValues) {
                    const bl = window.currentBaselineValues;
                    const formatNum = (num) => num != null ? num.toFixed(1) : 'N/A';
                    const formatNum2 = (num) => num != null ? num.toFixed(2) : 'N/A';
                    baselineSection = `
BASELINE MACROECONOMIC DATA (Current Economic Conditions):
- Canada GDP: QoQ Growth ${bl.gdp != null ? (bl.gdp >= 0 ? '+' : '') + formatNum(bl.gdp) + '%' : 'N/A'}
- Unemployment Rate: ${bl.unemployment != null ? formatNum(bl.unemployment) + '%' : 'N/A'}
- CPI Inflation: ${bl.inflation != null ? formatNum(bl.inflation) + '%' : 'N/A'}
- USD/CAD: ${bl.cadUsd != null ? formatNum2(bl.cadUsd) + ' (CAD per 1 USD)' : 'N/A'}
- BoC Rate: ${bl.bocRate != null ? formatNum(bl.bocRate) + '%' : 'N/A'}
- House Price Index: QoQ Growth ${bl.hpi != null ? (bl.hpi >= 0 ? '+' : '') + formatNum(bl.hpi) + '%' : 'N/A'}
- TSX Composite: QoQ Growth ${bl.tsx != null ? (bl.tsx >= 0 ? '+' : '') + formatNum(bl.tsx) + '%' : 'N/A'}
- Credit Spreads: ${bl.creditSpreads != null ? formatNum(bl.creditSpreads) + '%' : 'N/A'}

CURRENT STRESS SCENARIO PROJECTIONS:
- Canada GDP: ${currentMacroValues.gdp}
- Unemployment: ${currentMacroValues.unemployment}
- Inflation: ${currentMacroValues.inflation}
- USD/CAD: ${currentMacroValues.usdCad}
- BoC Rate: ${currentMacroValues.bocRate}
- House Prices: ${currentMacroValues.housePrice}
- TSX Composite: ${currentMacroValues.tsx}
- Credit Spreads: ${currentMacroValues.creditSpreads}

When adjusting macro variables, you MUST:
1. Calculate the actual change from BASELINE to your new projection
2. Explain the reasoning based on the DELTA from baseline, not absolute values
3. Example: If baseline BoC Rate is 2.5% and you project 2.0%, explain "BoC cuts rates by 50 bps (from 2.5% to 2.0%)"
`;
                }

                const systemPrompt = `You are an expert financial risk analyst at Royal Bank of Canada (RBC). You are helping to refine a stress testing scenario report.

SELECTED RISK DRIVERS:
${driversSummary}
${baselineSection}
CURRENT SCENARIO REPORT:
Title: ${currentReport.title}

Global Conditions (HTML):
${currentReport.globalConditions}

Canadian Conditions (HTML):
${currentReport.canadianConditions}

RBC Impact (HTML):
${currentReport.rbcImpact}

The user wants to refine this scenario. Based on their request, provide:
1. A brief conversational response explaining what you're changing (2-3 sentences)
2. If the user wants changes to a specific section, include the updated HTML in a JSON block

Your response should be in this format:
[Your conversational explanation here]

If making changes to sections, include:
\`\`\`json
{
  "updateSection": "global" | "canadian" | "rbc" | "macro" | "title" | null,
  "newContent": "HTML content for that section" or "New title text",
  "macroUpdates": {
    "canadaGDP": { "value": "-X.X%" },
    "unemployment": { "value": "X.X%" },
    "inflation": { "value": "X.X%" },
    "usdCad": { "value": "1.XX" },
    "bocRate": { "value": "X.XX%" },
    "housePrice": { "value": "-XX%" },
    "tsx": { "value": "-XX%" },
    "creditSpreads": { "value": "X.XX" }
  }
}
\`\`\`

IMPORTANT: For macro projections, ONLY provide the stress values. Do NOT include delta or direction fields. The system will automatically calculate deltas from baseline.

CRITICAL: For usdCad, use format "1.XX" representing CAD per 1 USD (e.g., 1.45 means 1 USD = 1.45 CAD). Higher values = weaker CAD, lower values = stronger CAD.

CRITICAL RULES FOR MACRO PROJECTIONS:

1. **ECONOMIC CORRELATIONS - MANDATORY**: Variables are economically linked and MUST move together:
   
   **When GDP Falls (More Negative)**:
   - Unemployment MUST RISE (â†‘) - businesses cut jobs when economy contracts
   - TSX MUST FALL (more negative â†“) - corporate earnings decline with GDP
   - House Prices MUST FALL (more negative â†“) - real estate weakens in recession
   - Credit Spreads MUST RISE (â†‘) - default risk increases in recession
   - Inflation: Depends on scenario type (see below)
   
   **When GDP Improves (Less Negative)**:
   - All correlations reverse: Unemploymentâ†“, TSXâ†‘, House Pricesâ†‘, Credit Spreadsâ†“

2. **Severity Adjustments**: 
   - **Single Variable Request** (e.g., "change GDP to -4%", "make GDP more severe"):
     * Adjust the specified variable to requested level
     * **MUST adjust economically correlated variables** proportionally based on the relationships above
     * **PRESERVE inflation direction** unless scenario type is explicitly changed
     * Use economic multipliers to determine magnitude of correlated adjustments
   
   - **Overall Severity Request** (e.g., "make entire scenario more severe", "dial everything back"):
     * Adjust ALL variables proportionally including inflation
     * Maintain current scenario type relationships
   
   - **Scenario Type Changes** (e.g., "make it a stagflation scenario", "convert to demand shock"):
     * This changes the fundamental narrative and inflation behavior
     * Explain the shift in scenario dynamics
   
3. **Inflation Handling - CRITICAL**:
   - **ALWAYS CHECK CURRENT INFLATION VALUE FIRST**
   - Stagflation = falling GDP + rising inflation (supply-driven crisis, cost-push)
   - Demand shock = falling GDP + falling inflation (consumption collapse, demand-pull reversal)
   - **When user adjusts GDP severity, PRESERVE the current inflation trajectory** (if rising, keep rising; if falling, keep falling)
   - Only change inflation direction if user explicitly requests scenario type change
   - Example: If inflation is 4.5% and user says "make GDP -4% instead of -3%", keep inflation at ~4.5% or slightly higher (stagflation worsening)
   
4. **Response Format & Explanation - MANDATORY**:

When adjusting macro projections, you MUST provide detailed economic reasoning BEFORE the JSON block:

**Required Explanation Structure:**

1. **User Request Summary**: "You've requested [specific change]"

2. **Economic Reasoning for EACH Variable**:
   - **GDP**: Explain the change and mechanism
   - **Unemployment**: "GDP fell by Xpp â†’ unemployment rises by Ypp because [job losses/hiring freeze]. Historical multiplier: ~0.6-0.8pp unemployment per 1pp GDP decline"
   - **TSX**: "GDP contraction worsens â†’ corporate earnings decline â†’ TSX falls from [old%] to [new%]. This represents a [X]% to [Y]% decline from baseline, proportional to GDP severity"
   - **House Prices**: "Deeper recession + higher unemployment â†’ housing demand falls â†’ prices decline from [old%] to [new%]"
   - **BoC Rate**: "BoC responds to deeper recession with [more aggressive/less aggressive] rate cuts: [old] â†’ [new]. In severe recessions, BoC typically cuts 25-50bps per quarter"
   - **USD/CAD**: "Rate differential with US Fed widens/narrows â†’ CAD [weakens/strengthens] to [new value]"
   - **Credit Spreads**: "Default risk [increases/decreases] as recession [deepens/moderates] â†’ spreads move from [old] to [new]"
   - **Inflation**: "**PRESERVING [stagflationary/disinflationary] TRAJECTORY** - Inflation [remains elevated/continues falling] at [value] because [supply-side pressures persist / demand destruction continues]"

3. **Magnitude Justification**:
   - Reference historical precedents (e.g., "Similar to 2008-2009 crisis")
   - Use economic multipliers (e.g., "1% deeper GDP decline â†’ 15% additional TSX decline")
   - Explain policy response logic

4. **Coherence Check**: "All variables now align with a [stagflationary/demand-driven] recession scenario"

**MANDATORY MACRO EXPLANATION FORMAT**:
When adjusting macro projections, you MUST provide a detailed explanation BEFORE the JSON block:


\

If the user just wants clarification or discussion without changes, don't include the JSON block.`;

                // Build conversation for context
                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...reportChatHistory
                ];

                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: messages,
                        // temperature omitted - GPT-5 only supports default value of 1
                        max_tokens: 20000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Remove typing indicator
                const typingIndicator = document.getElementById('reportTypingIndicator');
                if (typingIndicator) typingIndicator.remove();

                // Parse the response
                let displayText = aiResponse;
                let updates = null;

                const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    try {
                        updates = JSON.parse(jsonMatch[1]);
                        displayText = aiResponse.substring(0, aiResponse.indexOf('```json')).trim();

                        // POST-PROCESS: Calculate deltas for macro updates if baseline values available
                        console.log('ðŸ” Checking post-processing conditions:', {
                            hasMacroUpdates: !!updates.macroUpdates,
                            hasBaselineValues: !!window.currentBaselineValues,
                            baselineValues: window.currentBaselineValues
                        });

                        // If baseline values not available, fetch them now
                        if (updates.macroUpdates && !window.currentBaselineValues) {
                            console.log('âš ï¸ Baseline values missing, fetching now...');
                            try {
                                const currentPeriodInfo = {
                                    quarter: `Q${Math.ceil((new Date().getMonth() + 1) / 3)}`,
                                    year: new Date().getFullYear()
                                };
                                const baselineData = await fetchBaselineMacroData(currentPeriodInfo);

                                console.log('ðŸ“¥ Raw baseline data received:', baselineData);

                                if (baselineData && baselineData.values) {
                                    const vals = baselineData.values;
                                    console.log('ðŸ“¥ Baseline values object:', vals);

                                    window.currentBaselineValues = {
                                        gdp: vals['Canada GDP'] ? parseFloat(vals['Canada GDP'].match(/QoQ:\s*([+-]?\d+\.?\d*)/)?.[1] || '0') : 0,
                                        unemployment: parseFloat(vals['Unemployment Rate']) || 0,
                                        inflation: parseFloat(vals['CPI Inflation']) || 0,
                                        cadUsd: parseFloat(vals['CAD/USD']) || 0,
                                        bocRate: parseFloat(vals['BoC Rate']) || 0,
                                        housePrice: vals['House Price Index'] ? parseFloat(vals['House Price Index'].match(/QoQ:\s*([+-]?\d+\.?\d*)/)?.[1] || '0') : 0,
                                        tsx: vals['TSX Composite'] ? parseFloat(vals['TSX Composite'].match(/QoQ:\s*([+-]?\d+\.?\d*)/)?.[1] || '0') : 0,
                                        creditSpreads: parseFloat(vals['Credit Spreads']) || 0
                                    };
                                    console.log('âœ… Baseline values fetched:', window.currentBaselineValues);
                                } else {
                                    console.error('âŒ Baseline data structure invalid:', baselineData);
                                }
                            } catch (err) {
                                console.error('âŒ Failed to fetch baseline values:', err);
                            }
                        }

                        if (updates.macroUpdates && window.currentBaselineValues) {
                            const baselineValues = window.currentBaselineValues;

                            console.log('ðŸ“Š Post-processing macro updates with baselines:', baselineValues);
                            console.log('ðŸ“Š AI-provided macro updates:', updates.macroUpdates);

                            const extractNumber = (val) => {
                                if (typeof val === 'number') return val;
                                if (typeof val === 'string') {
                                    const cleaned = val.replace(/[^\d.-]/g, '');
                                    return parseFloat(cleaned);
                                }
                                return NaN;
                            };

                            for (const [key, data] of Object.entries(updates.macroUpdates)) {
                                if (!data.value) continue;

                                const stressValue = extractNumber(data.value);
                                if (isNaN(stressValue)) continue;

                                // Calculate delta and direction based on variable
                                switch (key) {
                                    case 'canadaGDP':
                                        // GDP stress values are negative (e.g., -3.0), baseline is QoQ growth (e.g., +0.1)
                                        // Delta should show how much it declined from baseline
                                        const gdpDelta = Math.abs(stressValue);

                                        data.delta = `â†“ ${gdpDelta.toFixed(1)}% from current`;
                                        data.direction = 'negative';
                                        break;

                                    case 'unemployment':
                                        if (baselineValues.unemployment) {
                                            const baseline = baselineValues.unemployment;
                                            const delta = stressValue - baseline;
                                            data.delta = `${delta > 0 ? 'â†‘' : 'â†“'} to ${stressValue.toFixed(1)}% from ${baseline.toFixed(1)}%`;
                                            data.direction = delta > 0 ? 'negative' : 'positive';
                                        }
                                        break;

                                    case 'inflation':
                                        if (baselineValues.inflation) {
                                            const baseline = baselineValues.inflation;
                                            const delta = stressValue - baseline;
                                            data.delta = `${delta > 0 ? 'â†‘' : 'â†“'} to ${stressValue.toFixed(1)}% from ${baseline.toFixed(1)}%`;
                                            data.direction = delta > 0 ? 'negative' : 'positive';
                                        }
                                        break;

                                    case 'usdCad':
                                    case 'cadUsd':
                                        if (baselineValues.cadUsd) {
                                            const baseline = baselineValues.cadUsd;
                                            const delta = stressValue - baseline;
                                            data.delta = `${delta > 0 ? 'â†‘' : 'â†“'} to ${stressValue.toFixed(2)} from ${baseline.toFixed(2)}`;
                                            data.direction = delta > 0 ? 'negative' : 'positive';
                                        }
                                        break;

                                    case 'bocRate':
                                        if (baselineValues.bocRate) {
                                            const baseline = baselineValues.bocRate;
                                            const deltaBps = Math.round((stressValue - baseline) * 100);
                                            data.delta = `${deltaBps < 0 ? 'â†“' : 'â†‘'} ${Math.abs(deltaBps)} bps to ${stressValue.toFixed(2)}% from ${baseline.toFixed(1)}%`;
                                            data.direction = deltaBps < 0 ? 'positive' : 'negative';
                                        }
                                        break;

                                    case 'housePrice':
                                        // House price stress values are negative percentage changes (e.g., -15.0%)
                                        const hpiDelta = Math.abs(stressValue);
                                        data.delta = `â†“ ${hpiDelta.toFixed(1)}% from current`;
                                        data.direction = 'negative';
                                        break;

                                    case 'tsx':
                                        // TSX stress values are negative percentage changes (e.g., -20.0%)
                                        const tsxDelta = Math.abs(stressValue);
                                        data.delta = `â†“ ${tsxDelta.toFixed(1)}% from current`;
                                        data.direction = 'negative';
                                        break;

                                    case 'creditSpreads':
                                        if (baselineValues.creditSpreads) {
                                            const stressBps = Math.round(stressValue * 100);
                                            const baselineBps = Math.round(baselineValues.creditSpreads * 100);
                                            const deltaBps = stressBps - baselineBps;
                                            data.value = `${stressBps} bps`;
                                            data.delta = `â†‘ ${deltaBps} bps to ${stressBps} from ${baselineBps} bps`;
                                            data.direction = 'negative';
                                        }
                                        break;
                                }
                            }

                            console.log('ðŸ“Š Final processed macro updates:', updates.macroUpdates);
                        }
                    } catch (e) {
                        console.error('Failed to parse update JSON:', e);
                    }
                }

                // Apply updates if any
                if (updates) {
                    if (updates.updateSection === 'global' && updates.newContent) {
                        document.getElementById('globalConditions').innerHTML = updates.newContent;
                    } else if (updates.updateSection === 'canadian' && updates.newContent) {
                        document.getElementById('canadianConditions').innerHTML = updates.newContent;
                    } else if (updates.updateSection === 'rbc' && updates.newContent) {
                        document.getElementById('rbcImpact').innerHTML = updates.newContent;
                    } else if (updates.updateSection === 'title' && updates.newContent) {
                        document.getElementById('reportTitle').innerText = updates.newContent;
                    }

                    // Handle macro updates with rationale display
                    if (updates.updateSection === 'macro' && updates.macroUpdates) {
                        // Display rationale in chat if provided
                        if (updates.rationale) {
                            let rationaleText = `\n\nðŸ“Š **Macro Projection Rationale:**\n\n`;

                            if (updates.rationale.overall) {
                                rationaleText += `**Overall:** ${updates.rationale.overall}\n\n`;
                            }

                            const varNames = {
                                'canadaGDP': 'ðŸ‡¨ðŸ‡¦ GDP',
                                'unemployment': 'ðŸ‘¥ Unemployment',
                                'inflation': 'ðŸ’¹ Inflation',
                                'cadUsd': 'ðŸ’± CAD/USD',
                                'bocRate': 'ðŸ¦ BoC Rate',
                                'housePrice': 'ðŸ  House Prices',
                                'tsx': 'ðŸ“ˆ TSX',
                                'creditSpreads': 'ðŸ’³ Credit Spreads'
                            };

                            for (const [key, label] of Object.entries(varNames)) {
                                if (updates.rationale[key]) {
                                    rationaleText += `**${label}:** ${updates.rationale[key]}\n`;
                                }
                            }

                            displayText = displayText + '\n' + rationaleText;
                        }

                        // Update macro cards
                        const macroCards = document.querySelectorAll('.macro-card');
                        const macroMap = {
                            'canadaGDP': 0, 'unemployment': 1, 'inflation': 2, 'cadUsd': 3,
                            'bocRate': 4, 'housePrice': 5, 'tsx': 6, 'creditSpreads': 7
                        };

                        for (const [key, data] of Object.entries(updates.macroUpdates)) {
                            const idx = macroMap[key];
                            if (idx !== undefined && macroCards[idx]) {
                                const valueEl = macroCards[idx].querySelector('.macro-value');
                                const deltaEl = macroCards[idx].querySelector('.macro-delta');

                                if (valueEl && data.value) {
                                    valueEl.innerText = data.value;
                                    // Update direction class
                                    valueEl.className = 'macro-value';
                                    if (data.direction === 'negative') {
                                        valueEl.classList.add('negative');
                                    } else if (data.direction === 'positive') {
                                        valueEl.classList.add('positive');
                                    }
                                }

                                if (deltaEl && data.delta) {
                                    deltaEl.innerText = data.delta;
                                }
                            }
                        }

                        // Update stored scenario - deep merge to preserve nested structure
                        if (window.currentGeneratedScenario && window.currentGeneratedScenario.macroProjections) {
                            const macro = window.currentGeneratedScenario.macroProjections;
                            for (const [key, data] of Object.entries(updates.macroUpdates)) {
                                if (!macro[key]) {
                                    macro[key] = {};
                                }
                                // Deep merge each property (value, delta, direction)
                                Object.assign(macro[key], data);
                            }
                            console.log('âœ… Updated window.currentGeneratedScenario.macroProjections:', macro);
                        }
                    }

                    // ALWAYS update macro cards if macroUpdates present (regardless of updateSection)
                    // This ensures deltas are refreshed even when AI doesn't set updateSection='macro'
                    if (updates.macroUpdates) {
                        console.log('ðŸ”„ Updating macro cards with:', updates.macroUpdates);
                        const macroCards = document.querySelectorAll('.macro-card');
                        const macroMap = {
                            'canadaGDP': 0, 'unemployment': 1, 'inflation': 2,
                            'cadUsd': 3, 'usdCad': 3,  // Support both key names
                            'bocRate': 4, 'housePrice': 5, 'tsx': 6, 'creditSpreads': 7
                        };
                        for (const [key, data] of Object.entries(updates.macroUpdates)) {
                            const idx = macroMap[key];
                            console.log(`ðŸ”„ Processing ${key}: idx=${idx}, value=${data.value}, delta=${data.delta}`);
                            if (idx !== undefined && macroCards[idx]) {
                                const valueEl = macroCards[idx].querySelector('.macro-value');
                                const deltaEl = macroCards[idx].querySelector('.macro-delta');

                                if (valueEl && data.value) {
                                    console.log(`  âœï¸ Updating value to: ${data.value}`);
                                    valueEl.innerText = data.value;
                                    // Update direction class
                                    valueEl.className = 'macro-value';
                                    if (data.direction === 'negative') {
                                        valueEl.classList.add('negative');
                                    } else if (data.direction === 'positive') {
                                        valueEl.classList.add('positive');
                                    }
                                }

                                if (deltaEl && data.delta) {
                                    console.log(`  âœï¸ Updating delta to: ${data.delta}`);
                                    deltaEl.innerText = data.delta;
                                }
                            }
                        }

                        // Update stored scenario - deep merge to preserve nested structure
                        if (window.currentGeneratedScenario && window.currentGeneratedScenario.macroProjections) {
                            const macro = window.currentGeneratedScenario.macroProjections;
                            for (const [key, data] of Object.entries(updates.macroUpdates)) {
                                if (!macro[key]) {
                                    macro[key] = {};
                                }
                                // Deep merge each property (value, delta, direction)
                                Object.assign(macro[key], data);
                            }
                            console.log('âœ… Updated window.currentGeneratedScenario.macroProjections (fallback):', macro);
                        }
                    }
                }

                // Add AI response to chat
                reportChatHistory.push({ role: 'assistant', content: aiResponse });

                const aiDiv = document.createElement('div');
                aiDiv.className = 'chat-message ai';
                aiDiv.innerHTML = displayText.replace(/\n/g, '<br>');
                chatHistoryEl.appendChild(aiDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

            } catch (error) {
                console.error('Report chat error:', error);

                // Remove typing indicator
                const typingIndicator = document.getElementById('reportTypingIndicator');
                if (typingIndicator) typingIndicator.remove();

                const aiDiv = document.createElement('div');
                aiDiv.className = 'chat-message ai';
                aiDiv.innerText = `Sorry, I encountered an error: ${error.message}. Please try again.`;
                chatHistoryEl.appendChild(aiDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            }

            input.disabled = false;
            input.focus();
        }

        function saveReport() {
            const now = new Date();
            const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Always use the current report title from the DOM
            const currentTitle = document.getElementById('reportTitle').innerText || 'Untitled Scenario';

            const scenarioData = {
                id: currentScenarioId || 'scen_' + Date.now(),
                title: currentTitle,
                date: timestamp,
                driverCount: selectedDrivers.length,
                drivers: [...selectedDrivers],
                global: document.getElementById('globalConditions').innerHTML,
                canadian: document.getElementById('canadianConditions').innerHTML,
                rbc: document.getElementById('rbcImpact').innerHTML,
                macros: document.getElementById('macroProjections').innerHTML,
                chatHistory: [...reportChatHistory] // Save chat history with scenario
            };

            // Update existing or add new
            const existingIdx = savedScenarios.findIndex(s => s.id === scenarioData.id);
            if (existingIdx > -1) {
                savedScenarios[existingIdx] = scenarioData;
            } else {
                savedScenarios.push(scenarioData);
            }

            // Persist to localStorage
            saveScenariosToStorage();

            // Clear selected drivers after saving
            selectedDrivers = [];
            currentScenarioId = null;

            alert('Scenario saved successfully.');
            closeReport();
            renderMarketplace(); // Re-render to show unselected state
            updateInventory(); // Update basket to show empty
            showSavedScenarios(); // Switch to saved view
        }

        // ========================================
        // SEND TO ASTRA INTEGRATION
        // ========================================
        function sendToAstra() {
            const currentTitle = document.getElementById('reportTitle').innerText || 'Untitled Scenario';

            // Gather all scenario data for Astra
            const astraPayload = {
                // Metadata
                id: 'astra_' + Date.now(),
                title: currentTitle,
                timestamp: Date.now(),
                source: 'scenario.html',

                // Narrative content (HTML)
                globalConditions: document.getElementById('globalConditions').innerHTML,
                canadianConditions: document.getElementById('canadianConditions').innerHTML,
                rbcImpact: document.getElementById('rbcImpact').innerHTML,

                // Macro projections (for reference)
                macroProjectionsHtml: document.getElementById('macroProjections').innerHTML,

                // Structured risk drivers with heat map data
                riskDrivers: selectedDrivers.map(d => ({
                    id: d.id,
                    title: d.title,
                    category: d.cat,
                    description: d.desc,
                    heatMapData: heatMapData[d.id] || null
                })),

                // Plain text summary for AI context
                narrativeSummary: buildNarrativeSummary()
            };

            // Save to localStorage for Astra to pick up
            localStorage.setItem('astraScenarioImport', JSON.stringify(astraPayload));

            // Visual feedback
            const btn = document.getElementById('sendToAstraBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ“ Sent!';
            btn.style.background = '#10B981';

            // Trigger Internal CET1 Analysis (No new window)
            // 1. Prepare AI Chat State (calls cet1UpdateChat, so history is ready)
            cet1HandleScenarioImport(astraPayload);

            // 2. Switch View (ensure elements are visible)
            showCET1Analysis();

            // 3. Open Modal (will check reset condition, but history is now populated so it won't reset)
            openCET1AIModal();

            // Reset button visual state after delay
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, #8B5CF6, #6366F1)';
            }, 1000);
        }

        function cet1HandleScenarioImport(payload) {
            // Reset conversation to Clean Slate
            cet1ConversationHistory = [];

            // Format drivers (limit to 5 like Astra)
            const riskDrivers = payload.riskDrivers || [];
            const driversList = riskDrivers.slice(0, 5).map(d => `â€¢ ${d.title} (${d.category})`).join('\n');
            const extraDrivers = riskDrivers.length > 5 ? `\n...and ${riskDrivers.length - 5} more` : '';
            const fullDriversDisplay = driversList + extraDrivers || 'â€¢ None';

            // System Context (EXACTLY from Astra.html)
            // Includes JSON output instructions and exact persona context
            const systemContext = `You are a financial risk analyst helping to create stress testing scenarios for Royal Bank of Canada (RBC).

IMPORTANT: A scenario has been imported from the Scenario Narrative Platform. You must analyze this scenario and determine CET1 component severity levels.

IMPORTED SCENARIO CONTEXT:
${payload.narrativeSummary}

Your job now is to:
1. Acknowledge that you've received the imported scenario "${payload.title}"
2. Briefly summarize the key risks and their implications for RBC
3. Ask if the user wants you to proceed with the CET1 component severity assessment
4. When ready (or if user confirms), provide the severity assessments for all 18 CET1 components

The 18 CET1 components are:
- PPNR Canada, PPNR US, PPNR International
- PCL Canada, PCL US, PCL International (Provision for Credit Losses by geography)
- Dividend
- Trading PnL
- AFS Losses
- Operational Risk Losses
- Currency Translation Adj
- Shortfall in Allowance
- Credit RWA Change Canada, Credit RWA Change US, Credit RWA Change International (Credit Risk-Weighted Assets by geography)
- Market CCR CVA RWA Change
- Operational Risk RWA Change
- Other

When the user asks you to finalize or you believe you have enough information, respond with a JSON object in this EXACT format:
{
    "FINALIZE": true,
    "title": "${payload.title}",
    "description": "Brief description based on imported scenario",
    "severity": "very_severe|severe|moderate|benchmark",
    "componentSeverities": {
        "PPNR Canada": "very_severe|severe|moderate|benchmark",
        "PPNR US": "very_severe|severe|moderate|benchmark",
        "PPNR International": "very_severe|severe|moderate|benchmark",
        "PCL Canada": "very_severe|severe|moderate|benchmark",
        "PCL US": "very_severe|severe|moderate|benchmark",
        "PCL International": "very_severe|severe|moderate|benchmark",
        "Dividend": "very_severe|severe|moderate|benchmark",
        "Trading PnL": "very_severe|severe|moderate|benchmark",
        "AFS Losses": "very_severe|severe|moderate|benchmark",
        "Operational Risk Losses": "very_severe|severe|moderate|benchmark",
        "Currency Translation Adj": "very_severe|severe|moderate|benchmark",
        "Shortfall in Allowance": "very_severe|severe|moderate|benchmark",
        "Credit RWA Change Canada": "very_severe|severe|moderate|benchmark",
        "Credit RWA Change US": "very_severe|severe|moderate|benchmark",
        "Credit RWA Change International": "very_severe|severe|moderate|benchmark",
        "Market CCR CVA RWA Change": "very_severe|severe|moderate|benchmark",
        "Operational Risk RWA Change": "very_severe|severe|moderate|benchmark",
        "Other": "very_severe|severe|moderate|benchmark"
    },
    "componentRationale": {
        "PPNR Canada": "1-2 sentence explanation",
        "PPNR US": "1-2 sentence explanation",
        "PPNR International": "1-2 sentence explanation",
        "PCL Canada": "1-2 sentence explanation",
        "PCL US": "1-2 sentence explanation",
        "PCL International": "1-2 sentence explanation",
        "Dividend": "1-2 sentence explanation",
        "Trading PnL": "1-2 sentence explanation",
        "AFS Losses": "1-2 sentence explanation",
        "Operational Risk Losses": "1-2 sentence explanation",
        "Currency Translation Adj": "1-2 sentence explanation",
        "Shortfall in Allowance": "1-2 sentence explanation",
        "Credit RWA Change Canada": "1-2 sentence explanation",
        "Credit RWA Change US": "1-2 sentence explanation",
        "Credit RWA Change International": "1-2 sentence explanation",
        "Market CCR CVA RWA Change": "1-2 sentence explanation",
        "Operational Risk RWA Change": "1-2 sentence explanation",
        "Other": "1-2 sentence explanation"
    }
}

Use the imported scenario details to make informed severity assessments. Consider:
- Risk driver categories and their assessed likelihood/materiality/velocity
- Macroeconomic projections (GDP, unemployment, housing, etc.)
- Geographic concentration of risks (Canada vs US vs International)
- Speed of impact (velocity) for time-sensitive components`;

            // Welcome Message (Matches Astra.html UX)
            const welcomeMsg = `ðŸ“Š **Scenario Imported Successfully!**

I've received the scenario **"${payload.title}"** from the Scenario Narrative Platform with ${payload.riskDrivers ? payload.riskDrivers.length : 0} risk drivers.

**Key Risk Drivers:**
${fullDriversDisplay}

Based on this scenario, I'm ready to analyze the impact on RBC's 18 CET1 capital components.

Would you like me to:
1. **Proceed with assessment** - I'll analyze each component and provide severity ratings
2. **Review the scenario first** - I can summarize the key points before assessment
3. **Adjust the scenario** - Tell me if you'd like to modify any aspects

What would you prefer?`;

            // Initialize History
            // 1. System Prompt
            cet1ConversationHistory.push({ role: 'system', content: systemContext });
            // 2. Assistant Welcome
            cet1ConversationHistory.push({ role: 'assistant', content: welcomeMsg });

            // Store context for subsequent messages
            cet1CurrentImportedScenario = payload.narrativeSummary;

            // Update UI
            cet1UpdateChat();
        }


        function buildNarrativeSummary() {
            // Extract text content from HTML for AI consumption
            const globalEl = document.getElementById('globalConditions');
            const canadianEl = document.getElementById('canadianConditions');
            const rbcEl = document.getElementById('rbcImpact');
            const macroEl = document.getElementById('macroProjections');

            const globalText = globalEl ? globalEl.innerText : '';
            const canadianText = canadianEl ? canadianEl.innerText : '';
            const rbcText = rbcEl ? rbcEl.innerText : '';

            // Extract macro projections values
            let macroSummary = '';
            if (macroEl) {
                const macroCards = macroEl.querySelectorAll('.macro-card');
                const macroValues = [];
                macroCards.forEach(card => {
                    const label = card.querySelector('.macro-label')?.innerText || '';
                    const value = card.querySelector('.macro-value')?.innerText || '';
                    const delta = card.querySelector('.macro-delta')?.innerText || '';
                    if (label && value) {
                        macroValues.push(`- ${label}: ${value}${delta ? ' (' + delta + ')' : ''}`);
                    }
                });
                macroSummary = macroValues.join('\n');
            }

            // Build driver summary
            const driverSummary = selectedDrivers.map(d => {
                const hm = heatMapData[d.id];
                if (hm) {
                    return `- ${d.title} (${d.cat}): Likelihood ${hm.likelihood}/10, Materiality ${hm.materiality}/10, Velocity ${hm.velocity === 3 ? 'High' : hm.velocity === 2 ? 'Medium' : 'Low'}`;
                }
                return `- ${d.title} (${d.cat})`;
            }).join('\n');

            return `
SCENARIO: ${document.getElementById('reportTitle').innerText}

MACROECONOMIC PROJECTIONS:
${macroSummary || 'Not available'}

GLOBAL CONDITIONS:
${globalText}

CANADIAN CONDITIONS:
${canadianText}

RBC IMPACT:
${rbcText}

RISK DRIVERS:
${driverSummary}
            `.trim();
        }

        function renderSavedScenarios() {
            console.log('Rendering saved scenarios. Total count:', savedScenarios.length);
            console.log('Scenarios to render:', savedScenarios);

            const grid = document.getElementById('savedScenariosGrid');

            if (savedScenarios.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); margin-top: 40px;">
                        <div style="font-size: 40px; margin-bottom: 16px; opacity: 0.5;">ðŸ“</div>
                        <p style="font-size: 16px; font-weight: 500;">Folder is empty</p>
                        <p style="font-size: 13px; margin-top: 8px;">Save scenarios or heat maps to see them here.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = savedScenarios.map(s => {
                const isHeatmap = s.type === 'heatmap';
                const isCalculation = s.type === 'calculation' || (s.id && s.id.startsWith('cet1_'));

                let typeLabel = 'Scenario';
                let typeColor = '#E0F2FE'; // Teal/Cyan
                let typeText = '#0891B2';
                let icon = 'ðŸ“„';

                if (isHeatmap) {
                    typeLabel = 'Heat Map';
                    typeColor = '#FFF7ED'; // Orange
                    typeText = '#C2410C';
                    icon = 'ðŸ“Š';
                } else if (isCalculation) {
                    typeLabel = 'CALCULATION';
                    typeColor = '#DCFCE7'; // Green
                    typeText = '#15803d';
                    icon = 'ðŸ§®';
                } else if (s.type === 'executive_report') {
                    typeLabel = 'Report';
                    typeColor = '#F3E8FF'; // Purple
                    typeText = '#7E22CE';
                    icon = 'ðŸ“Š';
                }


                console.log(`Rendering ${typeLabel}:`, s.title);

                // Calculate the details section HTML
                let detailsHtml = '';
                if (s.type === 'executive_report' && s.execState && s.execState.tempBar) {
                    const tempBar = s.execState.tempBar;
                    const cet1Ratio = tempBar.troughCET1 || tempBar.minimumRatio || (tempBar.data ? tempBar.data.minimumRatio : null);
                    if (cet1Ratio) {
                        const ratioColor = cet1Ratio >= 11 ? '#10B981' : cet1Ratio >= 9 ? '#F59E0B' : '#EF4444';
                        detailsHtml = '<div class="driver-desc" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">' +
                            '<span style="font-weight: 600; color: #003168;">CET1 Ratio:</span>' +
                            '<span style="font-size: 16px; font-weight: 700; color: ' + ratioColor + ';">' +
                            parseFloat(cet1Ratio).toFixed(1) + '%</span></div>';
                    }
                }

                // Fallback: show Risk Drivers for other types or if no CET1 ratio
                if (!detailsHtml) {
                    const driverCount = s.driverCount || (s.drivers ? s.drivers.length : 0);
                    const driverTags = (s.drivers || []).slice(0, 8).map(d =>
                        '<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: ' +
                        (d.tagColor || '#eee') + '; color: ' + (d.textColor || '#333') +
                        '; white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis;">' +
                        d.title + '</span>'
                    ).join('');
                    const moreTag = (s.drivers || []).length > 8 ?
                        '<span style="font-size: 10px; padding: 2px 6px; color: var(--text-muted);">+' +
                        (s.drivers.length - 8) + ' more</span>' : '';
                    detailsHtml = '<div class="driver-desc" style="margin-bottom: 6px;">' + driverCount + ' Risk Drivers:</div>' +
                        '<div style="display: flex; flex-wrap: wrap; gap: 4px;">' + driverTags + moreTag + '</div>';
                }

                return `
                <div class="driver-card" onclick="openSavedItem('${s.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <span class="driver-tag" style="background: ${typeColor}; color: ${typeText};">${typeLabel}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 11px; color: var(--text-muted);">${s.date}</span>
                            <button onclick="event.stopPropagation(); deleteScenario('${s.id}')"
                                    style="background: none; border: none; cursor: pointer; padding: 2px 6px; font-size: 14px; opacity: 0.5; transition: opacity 0.2s;"
                                    onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'"
                                    title="Delete">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="driver-title">${s.title}</div>
                    <div style="margin-top: 12px;">
                        ${detailsHtml}
                    </div>
                </div>
            `}).join('');
        }

        function saveHeatMap() {
            if (selectedDrivers.length === 0) {
                alert('No drivers to save.');
                return;
            }

            const title = prompt('Enter a name for this Heat Map:', 'Heat Map ' + new Date().toLocaleDateString());
            if (!title) return;

            const heatmap = {
                id: 'heatmap_' + Date.now(),
                type: 'heatmap',
                title: title,
                date: new Date().toLocaleDateString(),
                drivers: selectedDrivers.map(sanitizeDriverForStorage),
                heatMapData: JSON.parse(JSON.stringify(heatMapData)),
                driverCount: selectedDrivers.length
            };

            console.log('Saving heat map:', heatmap);
            console.log('Current savedScenarios before save:', savedScenarios);

            savedScenarios.unshift(heatmap);

            console.log('Current savedScenarios after unshift:', savedScenarios);

            saveScenariosToStorage();

            console.log('Heat map saved to localStorage');

            alert('Heat Map saved to Folder.');
            updateInventory();
            showSavedScenarios(); // Go to folder to show it
        }

        function openSavedItem(id) {
            const item = savedScenarios.find(s => s.id === id);
            if (!item) return;

            // Handle CET1 Scenarios (loaded into CET1 Builder)
            if (item.id.startsWith('cet1_')) {
                if (typeof cet1LoadSavedScenario === 'function') {
                    cet1LoadSavedScenario(item.data);
                } else {
                    alert('CET1 loader not initialized.');
                }
                return;
            }

            // Handle Executive Reports
            if (item.type === 'executive_report') {
                // Restore execState from saved data
                if (item.execState) {
                    window.execState = {
                        heatMap: item.execState.heatMap || null,
                        scenario: item.execState.scenario || null,
                        tempBar: item.execState.tempBar || null,
                        macro: item.execState.macro || null,
                        scenarioBadgeOverride: item.execState.scenarioBadgeOverride || null
                    };

                    // Show executive report panel first
                    showExecutiveReport();

                    // Re-render all components with restored data
                    if (window.execState.heatMap) {
                        renderExecHeatMap(window.execState.heatMap);
                    }
                    if (window.execState.scenario) {
                        renderExecScenarioDesc(window.execState.scenario);
                    }
                    if (window.execState.macro) {
                        renderExecMacro(window.execState.macro);
                    }
                    if (window.execState.tempBar) {
                        renderExecTempBar(window.execState.tempBar);
                    }
                } else {
                    alert('This report appears to be corrupted or missing data.');
                }
                return;
            }

            if (item.type === 'heatmap') {
                // Restore Heat Map
                selectedDrivers = [...item.drivers];
                heatMapData = item.heatMapData || {};

                // Update Basket/Inventory state to match
                updateInventory();

                // Show Heat Map View
                showHeatMap();
                renderHeatMap();
            } else {
                // Open Scenario Report
                openSavedReport(id);
            }
        }

        function openSavedReport(id) {
            const scenario = savedScenarios.find(s => s.id === id);
            if (!scenario) return;

            currentScenarioId = scenario.id; // Set current ID for updates
            selectedDrivers = [...scenario.drivers]; // Restore drivers for context

            // Restore chat history for this specific scenario
            reportChatHistory = scenario.chatHistory ? [...scenario.chatHistory] : [];

            // Restore state
            document.getElementById('reportTitle').innerText = scenario.title;
            document.getElementById('reportSubtitle').innerText = `Last saved on ${scenario.date} | ${scenario.driverCount} Drivers`;

            document.getElementById('reportDriversList').innerHTML = scenario.drivers.map(d => `
                <span class="driver-pill" style="background: ${d.tagColor}; color: ${d.textColor};">${d.title}</span>
            `).join('');

            document.getElementById('globalConditions').innerHTML = scenario.global;
            document.getElementById('canadianConditions').innerHTML = scenario.canadian;
            document.getElementById('rbcImpact').innerHTML = scenario.rbc;
            document.getElementById('macroProjections').innerHTML = scenario.macros;

            // Restore chat history UI
            const chatHistoryEl = document.getElementById('reportChatHistory');
            if (reportChatHistory.length > 0) {
                chatHistoryEl.innerHTML = reportChatHistory.map(msg => {
                    const className = msg.role === 'user' ? 'chat-message user' : 'chat-message ai';
                    const div = document.createElement('div');
                    div.className = className;
                    div.innerHTML = msg.content;
                    return div.outerHTML;
                }).join('');
            } else {
                // Show default message if no chat history
                chatHistoryEl.innerHTML = `
                    <div class="chat-message ai">
                        <p style="margin: 0;">ðŸ“Š Scenario <strong>"${scenario.title}"</strong> loaded.</p>
                        <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">You can refine this scenario by asking questions or requesting changes.</p>
                    </div>
                `;
            }

            document.getElementById('reportOverlay').style.display = 'flex';
        }

        function showMarketplace() {
            document.getElementById('marketplacePanel').style.display = 'flex';
            document.getElementById('savedScenariosPanel').style.display = 'none';
            document.getElementById('heatMapPanel').style.display = 'none';
            document.getElementById('cet1AnalysisPanel').style.display = 'none';
            document.getElementById('executiveReportPanel').style.display = 'none';
            document.getElementById('execPickerModal').style.display = 'none';
            document.getElementById('basketPanel').style.display = 'flex';
            document.getElementById('heatmapBasketPanel').style.display = 'none';
            document.getElementById('playgroundPanel').style.display = 'none';

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector('.nav-item[title="Risk Drivers"]').classList.add('active');

            currentScenarioId = null; // Reset current scenario when going back to marketplace
            renderMarketplace(); // Re-render marketplace to ensure correct selected states
            updateInventory(); // Update basket in case drivers were changed in a report
        }


        function showSavedScenarios() {
            console.log('showSavedScenarios called');
            document.getElementById('marketplacePanel').style.display = 'none';
            document.getElementById('savedScenariosPanel').style.display = 'flex';
            document.getElementById('heatMapPanel').style.display = 'none';
            document.getElementById('cet1AnalysisPanel').style.display = 'none';
            document.getElementById('executiveReportPanel').style.display = 'none';
            document.getElementById('execPickerModal').style.display = 'none';
            document.getElementById('basketPanel').style.display = 'none';
            document.getElementById('heatmapBasketPanel').style.display = 'none';
            document.getElementById('playgroundPanel').style.display = 'none';

            renderSavedScenarios();

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector('.nav-item[title="Folder"]').classList.add('active');
        }

        // ========================================
        // HEAT MAP FUNCTIONS
        // ========================================

        // Store heat map data for each driver
        let heatMapData = {};

        // Heat map view mode: 'default', 'compact', or 'minimal'
        let heatMapViewMode = 'default';

        // Set heat map view mode
        function setHeatMapViewMode(mode) {
            heatMapViewMode = mode;

            // Update button styles
            // Update button styles
            ['default', 'compact', 'minimal'].forEach(m => {
                const btn = document.getElementById(`viewMode${m.charAt(0).toUpperCase() + m.slice(1)}`);
                if (btn) {
                    if (m === mode) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                    // Remove inline styles to allow CSS to take over
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }
            });

            // Show/hide driver legend in heat map legend and driver list in controls panel
            const driverList = document.getElementById('heatmapDriverList');
            const driverLegendSection = document.getElementById('driverLegendSection');

            if (mode === 'minimal') {
                if (driverList) driverList.style.display = 'none';
                if (driverLegendSection) driverLegendSection.style.display = 'block';
                renderDriverLegendInHeatMap();
            } else {
                if (driverList) driverList.style.display = 'block';
                if (driverLegendSection) driverLegendSection.style.display = 'none';
            }

            // Re-render heat map with new mode
            renderHeatMap();
        }

        // Render driver legend inside the heat map legend panel (for minimal view)
        function renderDriverLegendInHeatMap() {
            const container = document.getElementById('driverLegendItems');
            if (!container) return;

            const driversToRender = getFilteredDrivers();
            container.innerHTML = driversToRender.map((d, idx) => {
                const hmData = heatMapData[d.id] || { velocity: 2 };
                const velocityColor = hmData.velocity === 3 ? '#EF4444' : hmData.velocity === 2 ? '#F59E0B' : '#22C55E';

                return `
                    <div class="heatmap-legend-item" style="cursor: pointer; padding: 2px 0;" 
                        onclick="openDriverDetails('${d.id}')"
                        onmouseenter="highlightHeatMapDriver('${d.id}', true)"
                        onmouseleave="highlightHeatMapDriver('${d.id}', false)">
                        <div style="
                            width: 16px;
                            height: 16px;
                            border-radius: 50%;
                            background: ${velocityColor};
                            color: white;
                            font-size: 9px;
                            font-weight: 700;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            flex-shrink: 0;
                        ">${idx + 1}</div>
                        <span style="font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${d.title}</span>
                    </div>
                `;
            }).join('');
        }


        function showHeatMap() {
            document.getElementById('marketplacePanel').style.display = 'none';
            document.getElementById('savedScenariosPanel').style.display = 'none';
            document.getElementById('heatMapPanel').style.display = 'flex';
            document.getElementById('cet1AnalysisPanel').style.display = 'none';
            document.getElementById('executiveReportPanel').style.display = 'none';
            document.getElementById('execPickerModal').style.display = 'none';
            document.getElementById('basketPanel').style.display = 'none';
            document.getElementById('heatmapBasketPanel').style.display = 'flex';
            document.getElementById('playgroundPanel').style.display = 'none';

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const heatMapNav = document.querySelector('.nav-item[title="Heat Map"]');
            if (heatMapNav) heatMapNav.classList.add('active');

            // Update count
            document.getElementById('heatmapCount').innerText = selectedDrivers.length;

            // Render the heat map if we have data
            if (Object.keys(heatMapData).length > 0) {
                renderHeatMap();
            }

            // Render driver list in basket
            renderHeatMapDriverList();

            // Render Category Legend
            renderCategoryLegend();
        }

        function toggleHeatMapHelp() {
            const helpPanel = document.getElementById('heatmapHelpPanel');
            if (helpPanel.style.display === 'none') {
                helpPanel.style.display = 'block';
            } else {
                helpPanel.style.display = 'none';
            }
        }

        function highlightHeatMapDriver(driverId, highlight) {
            const driverCard = document.querySelector(`.heatmap-driver[data-driver-id="${driverId}"]`);
            if (!driverCard) return;

            if (highlight) {
                // Bring to front and add highlight effect
                driverCard.style.zIndex = '2000';
                driverCard.style.boxShadow = '0 0 0 3px var(--primary), 0 8px 24px rgba(0,0,0,0.3)';
                driverCard.style.transition = 'all 0.2s ease';
                // Expand the card to show description
                driverCard.classList.add('expanded');

                // For compact view, also show the expand section
                const compactExpand = driverCard.querySelector('.compact-expand');
                if (compactExpand) {
                    compactExpand.style.display = 'block';
                }

                // For compact pill, add shadow
                const compactPill = driverCard.querySelector('.compact-pill');
                if (compactPill) {
                    compactPill.style.boxShadow = '0 4px 16px rgba(0,0,0,0.15)';
                }

                // For minimal view, show the expand section
                const minimalExpand = driverCard.querySelector('.minimal-expand');
                if (minimalExpand) {
                    minimalExpand.style.display = 'block';
                }
            } else {
                // Reset to original state
                const yPercent = parseFloat(driverCard.style.top) || 0;
                driverCard.style.zIndex = Math.floor(10 + yPercent);
                driverCard.style.boxShadow = '';
                // Collapse the card
                driverCard.classList.remove('expanded');

                // For compact view, hide the expand section
                const compactExpand = driverCard.querySelector('.compact-expand');
                if (compactExpand) {
                    compactExpand.style.display = 'none';
                }

                // For compact pill, reset shadow
                const compactPill = driverCard.querySelector('.compact-pill');
                if (compactPill) {
                    compactPill.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                }

                // For minimal view, hide the expand section
                const minimalExpand = driverCard.querySelector('.minimal-expand');
                if (minimalExpand) {
                    minimalExpand.style.display = 'none';
                }
            }
        }

        function renderHeatMapDriverList() {
            const list = document.getElementById('heatmapDriverList');
            if (!list) return;

            // Start with global empty check
            if (selectedDrivers.length === 0) {
                list.innerHTML = `
                    <div class="basket-empty">
                        <div class="basket-empty-icon">ðŸ“Š</div>
                        <p>No drivers in heat map.</p>
                    </div>
                `;
                return;
            }

            const filteredDrivers = getFilteredDrivers();

            if (filteredDrivers.length === 0) {
                list.innerHTML = `
                    <div class="basket-empty">
                        <div class="basket-empty-icon" style="font-size: 32px; opacity: 0.3;">ðŸ”</div>
                        <p style="font-size: 13px;">No drivers match filter.</p>
                    </div>
                 `;
                return;
            }

            list.innerHTML = filteredDrivers.map(d => {
                const hmData = heatMapData[d.id] || { likelihood: '?', materiality: '?', velocity: 2 };
                const velocityLabel = hmData.velocity === 3 ? 'ðŸ”´' : hmData.velocity === 2 ? 'ðŸŸ¡' : 'ðŸŸ¢';

                // Get L/M/H labels for likelihood and materiality
                const getLevelAbbr = (value) => {
                    if (value === '?') return '?';
                    const num = parseInt(value);
                    if (num >= 7) return 'H';
                    if (num >= 4) return 'M';
                    return 'L';
                };

                const likelihoodAbbr = getLevelAbbr(hmData.likelihood);
                const materialityAbbr = getLevelAbbr(hmData.materiality);

                return `
                    <div class="basket-item" 
                         onclick="openDriverDetails('${d.id}')" 
                         onmouseenter="highlightHeatMapDriver('${d.id}', true)" 
                         onmouseleave="highlightHeatMapDriver('${d.id}', false)"
                         style="cursor: pointer;">
                        <div class="basket-item-info">
                            <div class="basket-item-dot" style="background: ${d.textColor}"></div>
                            <span class="basket-item-title">${d.title}</span>
                        </div>
                        <span style="font-size: 11px; color: var(--text-muted); display: flex; gap: 4px; align-items: center;" title="Likelihood: ${hmData.likelihood}, Materiality: ${hmData.materiality}, Velocity">
                            <span>${likelihoodAbbr}</span>
                            <span>${materialityAbbr}</span>
                            ${velocityLabel}
                        </span>
                    </div>
                `;
            }).join('');
        }

        async function generateHeatMap() {
            if (selectedDrivers.length === 0) {
                alert('Please select at least one risk driver first.');
                return;
            }

            // Show loader
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loaderText');
            loader.style.display = 'flex';
            loaderText.innerText = 'Analyzing risk drivers for heat map positioning...';

            try {
                // Build driver summaries for AI
                const driverSummaries = selectedDrivers.map(d => ({
                    id: d.id,
                    title: d.title,
                    category: d.cat,
                    description: d.desc
                }));

                loaderText.innerText = 'AI is assessing likelihood, materiality, and velocity...';

                // Call AI to assess each driver
                const assessments = await getAIHeatMapAssessments(driverSummaries);

                // Store assessments
                assessments.forEach(assessment => {
                    heatMapData[assessment.id] = {
                        likelihood: assessment.likelihood, // 1-10
                        materiality: assessment.materiality, // 1-10
                        velocity: assessment.velocity, // 1-3 (1=low, 2=medium, 3=high)
                        likelihoodReasoning: assessment.likelihoodReasoning || '', // Justification for likelihood score
                        materialityReasoning: assessment.materialityReasoning || '', // Justification for materiality score
                        reasoning: assessment.reasoning || '', // Velocity and overall summary
                        aiGenerated: true
                    };
                });

                loaderText.innerText = 'Rendering heat map...';
                await new Promise(r => setTimeout(r, 300));

                // Switch to heat map view
                loader.style.display = 'none';
                showHeatMap();
                renderHeatMap();
                renderCategoryLegend();

            } catch (error) {
                console.error('Heat map generation error:', error);
                loaderText.innerText = 'AI unavailable. Generating random positions...';

                // Fallback: Generate random positions
                selectedDrivers.forEach(d => {
                    heatMapData[d.id] = {
                        likelihood: Math.floor(Math.random() * 10) + 1,
                        materiality: Math.floor(Math.random() * 10) + 1,
                        velocity: Math.floor(Math.random() * 3) + 1,
                        aiGenerated: false
                    };
                });

                await new Promise(r => setTimeout(r, 1000));
                loader.style.display = 'none';
                showHeatMap();
                renderHeatMap();
                renderCategoryLegend();

                // Notify user
                setTimeout(() => {
                    alert('Note: AI was unavailable. Positions were randomly generated. You can drag drivers to adjust their positions.');
                }, 500);
            }
        }

        async function getAIHeatMapAssessments(drivers) {
            const driversList = drivers.map((d, i) => `${i + 1}. ID: "${d.id}"
   Title: "${d.title}"
   Category: ${d.category}
   Description: ${d.description}`).join('\n\n');

            const prompt = fillPrompt(PROMPT_TEMPLATES.HEATMAP_ASSESSMENT, {
                DRIVERS_LIST: driversList
            });

            const response = await fetch(AZURE_OPENAI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-5-2025-08-07-eastus-dz',
                    messages: [{ role: 'user', content: prompt }],
                    // temperature omitted - GPT-5 only supports default value of 1
                    max_tokens: 20000
                })
            });

            if (!response.ok) {
                throw new Error(`AI API error: ${response.status} `);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;

            // Parse JSON
            const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
            throw new Error('Failed to parse AI response');
        }

        // --- Heatmap Filtering Logic ---
        let activeVelocityFilters = new Set();
        let activeCategoryFilters = new Set();
        const VELOCITY_CONFIG = {
            3: { label: 'High (< 2 weeks)', color: '#EF4444', value: 3 },
            2: { label: 'Medium (2 wks - 3 mos)', color: '#F59E0B', value: 2 },
            1: { label: 'Low (> 3 months)', color: '#10B981', value: 1 }
        };

        function renderVelocityLegend() {
            const container = document.getElementById('velocityLegendItems');
            if (!container) return;
            container.innerHTML = [3, 2, 1].map(v => {
                const config = VELOCITY_CONFIG[v];
                const isActive = activeVelocityFilters.size === 0 || activeVelocityFilters.has(config.value);
                const dimClass = isActive ? '' : 'legend-dimmed';
                return `<div class="heatmap-legend-item ${dimClass}" onclick="toggleVelocityFilter(${config.value})">
                         <div class="heatmap-legend-velocity" style="background: ${config.color};"></div>
                         <span>${config.label}</span>
                    </div>`;
            }).join('');
        }

        function toggleVelocityFilter(val) {
            if (activeVelocityFilters.has(val)) activeVelocityFilters.delete(val);
            else activeVelocityFilters.add(val);
            renderVelocityLegend();
            renderHeatMap();
            renderHeatMapDriverList();
        }

        function toggleCategoryFilter(cat) {
            if (activeCategoryFilters.has(cat)) activeCategoryFilters.delete(cat);
            else activeCategoryFilters.add(cat);
            renderCategoryLegend();
            renderHeatMap();
            renderHeatMapDriverList();
        }

        function getFilteredDrivers() {
            // Remove window. prefix as let/const globals aren't always on window
            if (!selectedDrivers) {
                console.warn("getFilteredDrivers: selectedDrivers is missing");
                return [];
            }
            return selectedDrivers.filter(driver => {
                const data = heatMapData[driver.id];
                if (!data) {
                    console.warn("getFilteredDrivers: No heatMapData for driver", driver.id, driver);
                    return false;
                }
                if (activeVelocityFilters.size > 0 && !activeVelocityFilters.has(data.velocity)) return false;
                if (activeCategoryFilters.size > 0 && !activeCategoryFilters.has(driver.cat)) return false;
                return true;
            });
        }

        function renderHeatMap() {
            const grid = document.getElementById('heatmapGrid');
            const gridRect = grid.getBoundingClientRect();
            const cardWidth = 180; // Driver card width
            const cardHeight = 80; // Approximate driver card height

            grid.innerHTML = '';

            renderVelocityLegend();
            renderCategoryLegend();

            const filteredDrivers = getFilteredDrivers();

            // Update plotting count
            const countEl = document.getElementById('heatmapCount');
            if (countEl) countEl.innerText = filteredDrivers.length;

            // Detect overlapping drivers and apply smart offsets
            const positionMap = new Map(); // Key: "likelihood,materiality", Value: array of driver IDs

            filteredDrivers.forEach(driver => {
                const data = heatMapData[driver.id];
                if (!data) return;

                const posKey = `${data.likelihood},${data.materiality}`;
                if (!positionMap.has(posKey)) {
                    positionMap.set(posKey, []);
                }
                positionMap.get(posKey).push(driver.id);
            });

            filteredDrivers.forEach((driver, index) => {
                const data = heatMapData[driver.id];
                if (!data) return;

                // Calculate base position (1-10 scale to percentage)
                // X: likelihood (1=left/low, 10=right/high)
                // Y: materiality (1=bottom/low, 10=top/high) - invert Y
                let xPercent = ((data.likelihood - 1) / 9) * 100;
                let yPercent = 100 - ((data.materiality - 1) / 9) * 100;

                // Apply smart offset for overlapping drivers
                const posKey = `${data.likelihood},${data.materiality}`;
                const driversAtPosition = positionMap.get(posKey);
                if (driversAtPosition && driversAtPosition.length > 1) {
                    const index = driversAtPosition.indexOf(driver.id);
                    const totalAtPos = driversAtPosition.length;

                    // Calculate offset based on view mode
                    // Compact/minimal views need more spread since cards are smaller
                    let spreadFactor = heatMapViewMode === 'default' ? 2.5 :
                        heatMapViewMode === 'compact' ? 4 : 3;

                    // Spread in a radial pattern to minimize overlap
                    const angle = (index / totalAtPos) * 2 * Math.PI;
                    const radius = Math.min(index + 1, 3) * spreadFactor;

                    const offsetX = Math.cos(angle) * radius;
                    const offsetY = Math.sin(angle) * radius;

                    xPercent += offsetX;
                    yPercent += offsetY;
                }

                // Clamp positions so cards stay fully within grid
                // Account for card dimensions and grid padding
                const minX = 2; // 2% from left edge
                const maxX = 95; // Allow full width (legend is gone)
                const minY = 5; // 5% from top
                const maxY = 90; // 90% from top

                xPercent = Math.max(minX, Math.min(maxX, xPercent));
                yPercent = Math.max(minY, Math.min(maxY, yPercent));

                // Velocity class
                const velocityClass = data.velocity === 3 ? 'high' : data.velocity === 2 ? 'medium' : 'low';
                const velocityLabel = data.velocity === 3 ? 'High' : data.velocity === 2 ? 'Medium' : 'Low';

                // Get Low/Medium/High labels for likelihood and materiality
                const likelihoodLevel = getLevelLabel(data.likelihood);
                const materialityLevel = getLevelLabel(data.materiality);

                // Determine tooltip position class based on card position
                // Always show below for cards in top half, to prevent going outside window
                let tooltipClass = '';
                if (yPercent < 50) tooltipClass = 'tooltip-below';
                if (xPercent < 15) tooltipClass += ' tooltip-right';
                if (xPercent > 45) tooltipClass += ' tooltip-left';

                // Abbreviate levels for compact display
                const likelihoodAbbr = likelihoodLevel[0]; // L, M, or H
                const materialityAbbr = materialityLevel[0];
                const velocityAbbr = velocityLabel[0];

                // Create driver card
                const card = document.createElement('div');
                // Add view mode class to apply correct styling
                const viewModeClass = heatMapViewMode === 'compact' ? 'compact-mode' :
                    heatMapViewMode === 'minimal' ? 'minimal-mode' : '';
                card.className = `heatmap-driver ${viewModeClass}`.trim();
                card.id = `heatmap-${driver.id}`;
                card.style.left = `${xPercent}%`;
                card.style.top = `${yPercent}%`;
                // Layer cards so lower ones (higher Top %) appear on top of upper ones
                card.style.zIndex = Math.floor(10 + yPercent);
                card.setAttribute('data-driver-id', driver.id);

                // Add smart expansion classes based on position to prevent going outside window
                if (xPercent > 35) card.classList.add('expand-left');
                if (yPercent > 60) card.classList.add('expand-up');

                // Card HTML with anchor circle and expandable content
                const likelihoodReasoning = data.likelihoodReasoning || '';
                const materialityReasoning = data.materialityReasoning || '';
                const velocityReasoning = data.reasoning || '';

                // Get driver index for minimal view numbering
                const driverIndex = selectedDrivers.findIndex(d => d.id === driver.id) + 1;

                // Generate HTML based on view mode
                if (heatMapViewMode === 'minimal') {
                    // Minimal view: Velocity circle with number + fully expanded white card on hover
                    const velocityColor = data.velocity === 3 ? '#EF4444' : data.velocity === 2 ? '#F59E0B' : '#22C55E';

                    card.innerHTML = `
                <!-- Number circle - always visible -->
                <!--Z-index higher than expand card to sit on top-->
                        <!--Removed position:relative to keep anchor absolutely positioned(-10, -10) like default view-->
                        <div class="heatmap-driver-anchor ${velocityClass}" title="${driver.title}" style="width: 28px; height: 28px; cursor: pointer; z-index: 101;">
                            <span style="font-size: 12px; font-weight: 700; color: white;">${driverIndex}</span>
                        </div>
                        
                        <!--Expandable details - Full White Card mimicking Default View-->
                        <!--Anchored Top-Right(Expanded Left) to match user preference-->
                <div class="minimal-expand" style="
                            display: none;
                            position: absolute;
                            top: -10px;
                            right: -10px; /* Align Right edge with anchor */
                            left: auto;
                            width: 260px;
                            background: rgba(255, 255, 255, 0.98);
                            backdrop-filter: blur(12px);
                            border: 1px solid rgba(0, 0, 0, 0.1);
                            border-radius: 12px;
                            padding: 16px; /* Standard padding */
                            box-shadow: 0 16px 40px rgba(0,0,0,0.25);
                            z-index: 100;
                            color: #1F2937;
                        ">
                    <!-- Header -->
                    <div class="heatmap-driver-header" style="margin-bottom: 2px; padding-right: 20px;"> <!-- Padding right to avoid anchor overlap -->
                        <div class="heatmap-driver-title" style="color: #1F2937; font-size: 13px;">${driver.title}</div>
                    </div>

                    <!-- Category -->
                    <span class="heatmap-driver-category" style="background: ${driver.tagColor}; color: ${driver.textColor}; font-size: 9px; padding: 2px 8px; margin-bottom: 10px;">${driver.cat}</span>

                    <!-- Description -->
                    <div style="font-size: 11px; color: #4B5563; line-height: 1.4; margin-bottom: 12px;">${driver.desc}</div>

                    <!-- Assessment Justifications -->
                    <div style="padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.08);">
                        ${likelihoodReasoning ? `
                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            <span style="font-size: 11px; font-weight: 600; color: #2563EB;">ðŸ“Š Likelihood: ${likelihoodLevel} (${data.likelihood}/10)</span>
                                        </div>
                                        <div style="font-size: 11px; color: #4B5563; line-height: 1.4; padding-left: 2px;">${likelihoodReasoning}</div>
                                    </div>
                                    ` : ''}

                        ${materialityReasoning ? `
                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            <span style="font-size: 11px; font-weight: 600; color: #DC2626;">ðŸ’¥ Materiality: ${materialityLevel} (${data.materiality}/10)</span>
                                        </div>
                                        <div style="font-size: 11px; color: #4B5563; line-height: 1.4; padding-left: 2px;">${materialityReasoning}</div>
                                    </div>
                                    ` : ''}

                        ${velocityReasoning ? `
                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            <span style="font-size: 11px; font-weight: 600; color: #F59E0B;">âš¡ Velocity: ${velocityLabel}</span>
                                        </div>
                                        <div style="font-size: 11px; color: #4B5563; line-height: 1.4; padding-left: 2px;">${velocityReasoning}</div>
                                    </div>
                                    ` : ''}
                    </div>

                    <!-- Meta -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 10px; color: #6B7280; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.06);">
                        <span>Likelihood: <strong style="color: #1F2937;">${likelihoodAbbr}</strong></span>
                        <span>Materiality: <strong style="color: #1F2937;">${materialityAbbr}</strong></span>
                        <span>Velocity: <strong style="color: #1F2937;">${velocityAbbr}</strong></span>
                    </div>
                </div>
            `;
                    card.style.cursor = 'pointer';
                } else if (heatMapViewMode === 'compact') {
                    // Compact view: Small pill with velocity dot and title only, expands on hover
                    const velocityColor = data.velocity === 3 ? '#EF4444' : data.velocity === 2 ? '#F59E0B' : '#22C55E';

                    card.innerHTML = `
                        <div class="compact-pill" style="
                            display: inline-flex;
                            flex-direction: column;
                            background: rgba(255, 255, 255, 0.98);
                            border: 1px solid rgba(0, 0, 0, 0.1);
                            border-radius: 12px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            cursor: pointer;
                            overflow: visible;
                        ">
                            <!-- Header: always visible (white pill with just title) -->
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 6px;
                                padding: 6px 10px;
                            ">
                                <span style="
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 50%;
                                    background: ${velocityColor};
                                    flex-shrink: 0;
                                "></span>
                                <span style="
                                    font-size: 11px;
                                    font-weight: 600;
                                    color: #1F2937;
                                ">${driver.title}</span>
                            </div>
                            
                            <!-- Expandable details: hidden by default, shown on hover -->
                            <div class="compact-expand" style="display: none;">
                                <div style="
                                    background: rgba(255, 255, 255, 0.98);
                                    border-radius: 0 0 12px 12px;
                                    padding: 12px;
                                    color: #1F2937;
                                    min-width: 260px;
                                    max-width: 320px;
                                    border-top: 1px solid rgba(0,0,0,0.06);
                                ">
                                    <span style="display: inline-block; font-size: 10px; background: ${driver.tagColor}; color: ${driver.textColor}; padding: 3px 10px; border-radius: 6px; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">${driver.cat}</span>
                                    <div style="font-size: 11px; color: #4B5563; line-height: 1.5; margin-bottom: 12px;">
                                        ${driver.desc}
                                    </div>

                                    <!-- Summary Meta -->
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 10px; color: #6B7280; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.06);">
                                        <span>Likelihood: <strong style="color: #1F2937;">${likelihoodAbbr}</strong></span>
                                        <span>Materiality: <strong style="color: #1F2937;">${materialityAbbr}</strong></span>
                                        <span>Velocity: <strong style="color: #1F2937;">${velocityAbbr}</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    card.style.cursor = 'pointer';
                } else {
                    // Default view: Card with title, category, description, and compact L/M/V row visible
                    // Detailed reasoning only shows on click/expansion
                    card.innerHTML = `
                        <div class="heatmap-driver-anchor ${velocityClass}" title="Click to change velocity">
                            <svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" /></svg>
                        </div>
                        <div class="heatmap-driver-body">
                            <div class="heatmap-driver-header">
                                <div class="heatmap-driver-title">${driver.title}</div>
                            </div>
                            <span class="heatmap-driver-category" style="background: ${driver.tagColor}; color: ${driver.textColor};">${driver.cat}</span>
                            <div class="heatmap-driver-expand">
                                <div class="heatmap-driver-expand-desc">${driver.desc}</div>
                                <div class="heatmap-driver-expand-meta">
                                    <div style="flex: 1;">Likelihood: <strong style="color: white;">${likelihoodAbbr}</strong></div>
                                    <div style="flex: 1;">Materiality: <strong style="color: white;">${materialityAbbr}</strong></div>
                                    <div style="flex: 1;">Velocity: <strong style="color: white;">${velocityAbbr}</strong></div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Track if drag occurred to prevent click
                let hasDragged = false;
                let dragStartX = 0;
                let dragStartY = 0;

                // Hover to bring to front with visual feedback
                card.addEventListener('mouseenter', () => {
                    // Bring to front
                    card.style.zIndex = 1000;
                    // Add subtle glow effect
                    card.style.boxShadow = '0 0 0 2px var(--primary), 0 8px 24px rgba(0,0,0,0.15)';
                });

                card.addEventListener('mouseleave', () => {
                    // Reset z-index to layer based on position
                    card.style.zIndex = Math.floor(10 + yPercent);
                    // Remove glow
                    card.style.boxShadow = '';
                });

                // Unified click handler
                card.addEventListener('click', (e) => {
                    if (hasDragged) {
                        hasDragged = false; // Reset for next interaction
                        return; // Ignore click after drag
                    }

                    // For compact/minimal views, just open details on click
                    if (heatMapViewMode === 'compact' || heatMapViewMode === 'minimal') {
                        openDriverDetails(driver.id);
                        return;
                    }

                    // For default view
                    const isAnchor = e.target.closest('.heatmap-driver-anchor');
                    if (isAnchor) {
                        e.stopPropagation();
                        cycleVelocity(driver.id);
                        return;
                    }

                    // Otherwise open details
                    openDriverDetails(driver.id);
                });

                // Add drag handlers with threshold to distinguish from clicks
                card.addEventListener('mousedown', (e) => {
                    // Prevent drag side-effects if interacting with expanded text content in minimal/compact views
                    // This allows text selection to work naturally without triggering a drag/update
                    if (heatMapViewMode === 'minimal' || heatMapViewMode === 'compact') {
                        if (e.target.closest('.minimal-expand') || e.target.closest('.compact-expand')) {
                            return;
                        }
                    }

                    hasDragged = false;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    let dragInitiated = false;

                    const onMouseMove = (moveE) => {
                        const dx = Math.abs(moveE.clientX - dragStartX);
                        const dy = Math.abs(moveE.clientY - dragStartY);

                        // Only start drag if moved more than 5 pixels
                        if (!dragInitiated && (dx > 5 || dy > 5)) {
                            hasDragged = true;
                            dragInitiated = true;
                            document.removeEventListener('mousemove', onMouseMove);
                            startHeatmapDrag(e, card, driver.id);
                        }
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                grid.appendChild(card);
            });
        }



        // Helper function to get Low/Medium/High label from 1-10 score
        // Helper function to get Low/Medium/High label from 1-10 score
        function getLevelLabel(score) {
            if (score <= 3) return 'Low';
            if (score <= 7) return 'Medium';
            return 'High';
        }

        // Cycle velocity when clicking the velocity indicator
        function cycleVelocity(driverId) {
            if (!heatMapData[driverId]) return;

            // Cycle: 1 -> 2 -> 3 -> 1
            heatMapData[driverId].velocity = (heatMapData[driverId].velocity % 3) + 1;
            heatMapData[driverId].aiGenerated = false;

            // Re-render heat map and driver list
            renderHeatMap();
            renderHeatMapDriverList();
        }


        // Heat map drag functionality
        let isDraggingHeatmap = false;
        let currentDragCard = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let cardStartX = 0;
        let cardStartY = 0;

        function startHeatmapDrag(e, card, driverId) {
            if (e.button !== 0) return; // Only left click

            isDraggingHeatmap = true;
            currentDragCard = card;
            card.classList.add('dragging');

            dragStartX = e.clientX;
            dragStartY = e.clientY;
            cardStartX = card.offsetLeft;
            cardStartY = card.offsetTop;

            document.addEventListener('mousemove', handleHeatmapDrag);
            document.addEventListener('mouseup', endHeatmapDrag);

            e.preventDefault();
        }

        function handleHeatmapDrag(e) {
            if (!isDraggingHeatmap || !currentDragCard) return;

            const grid = document.getElementById('heatmapGrid');
            const gridRect = grid.getBoundingClientRect();

            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;

            let newX = cardStartX + deltaX;
            let newY = cardStartY + deltaY;

            // During drag, card is collapsed to 24x24 circle
            const circleSize = 24;

            // Allow small margin from edges
            const margin = 10;
            // Full width (legend moved out)
            const rightLimit = gridRect.width - circleSize - margin;

            newX = Math.max(margin, Math.min(rightLimit, newX));
            newY = Math.max(margin, Math.min(gridRect.height - circleSize - margin, newY));

            currentDragCard.style.left = `${newX}px`;
            currentDragCard.style.top = `${newY}px`;
        }


        function endHeatmapDrag(e) {
            if (!isDraggingHeatmap || !currentDragCard) return;

            const grid = document.getElementById('heatmapGrid');
            const gridRect = grid.getBoundingClientRect();
            const driverId = currentDragCard.getAttribute('data-driver-id');

            // Calculate position based on circle center (which is at card's top-left + 12px)
            const circleSize = 24;
            const circleCenterX = currentDragCard.offsetLeft + circleSize / 2;
            const circleCenterY = currentDragCard.offsetTop + circleSize / 2;

            // Use full width for percentage calculation
            const usableWidth = gridRect.width;
            const xPercent = circleCenterX / usableWidth;
            const yPercent = circleCenterY / gridRect.height;

            // Convert to 1-10 scale
            const newLikelihood = Math.round(xPercent * 9) + 1;
            const newMateriality = Math.round((1 - yPercent) * 9) + 1; // Invert Y

            // Clamp values
            heatMapData[driverId].likelihood = Math.max(1, Math.min(10, newLikelihood));
            heatMapData[driverId].materiality = Math.max(1, Math.min(10, newMateriality));
            heatMapData[driverId].aiGenerated = false; // Mark as user-modified

            // Clean up drag state
            currentDragCard.classList.remove('dragging');
            document.removeEventListener('mousemove', handleHeatmapDrag);
            document.removeEventListener('mouseup', endHeatmapDrag);

            isDraggingHeatmap = false;
            currentDragCard = null;

            // Full Re-render to ensure all views (Compact/Minimal) reflect updated data
            renderHeatMap();
            renderHeatMapDriverList();
        }


        function renderCategoryLegend() {
            const legendContainer = document.getElementById('categoryLegendItems');
            if (!legendContainer) return;

            // Get unique categories from ALL drivers to keep legend stable
            const categories = [...new Set(selectedDrivers.map(d => d.cat))];

            legendContainer.innerHTML = categories.map(cat => {
                const driver = selectedDrivers.find(d => d.cat === cat);
                const isActive = activeCategoryFilters.size === 0 || activeCategoryFilters.has(cat);
                const dimClass = isActive ? '' : 'legend-dimmed';
                return `
                <div class="heatmap-legend-item ${dimClass}" onclick="toggleCategoryFilter('${cat}')">
                        <div class="heatmap-legend-color" style="background: ${driver.tagColor}; border: 1px solid ${driver.textColor}; width: 12px; height: 12px; border-radius: 3px;"></div>
                        <span>${cat}</span>
                    </div>
                `;
            }).join('');
        }

        async function generateScenarioFromHeatMap() {
            if (selectedDrivers.length === 0) {
                alert('No drivers in heat map.');
                return;
            }

            // Enhance drivers with heat map data for scenario generation
            const enhancedDrivers = selectedDrivers.map(d => {
                const hmData = heatMapData[d.id] || { likelihood: 5, materiality: 5, velocity: 2 };
                const velocityLabel = hmData.velocity === 3 ? 'High (< 2 weeks)' :
                    hmData.velocity === 2 ? 'Medium (2 weeks - 3 months)' :
                        'Low (> 3 months)';
                return {
                    ...d,
                    heatMapLikelihood: hmData.likelihood,
                    heatMapMateriality: hmData.materiality,
                    heatMapVelocity: velocityLabel,
                    heatMapVelocityVal: hmData.velocity,
                    heatMapContext: `This risk has a materiality of ${hmData.materiality}/10 with ${velocityLabel.toLowerCase()} velocity.`
                };
            });

            // Sort by Materiality (Likelihood ignored as event is assumed to happen)
            enhancedDrivers.sort((a, b) => {
                if (b.heatMapMateriality !== a.heatMapMateriality) return b.heatMapMateriality - a.heatMapMateriality;
                return b.heatMapVelocityVal - a.heatMapVelocityVal; // Secondary sort: Velocity
            });

            // Call existing generateScenario but with enhanced context
            await generateScenarioWithHeatMapData(enhancedDrivers);
        }

        async function generateScenarioWithHeatMapData(enhancedDrivers) {
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loaderText');
            loader.style.display = 'flex';
            loaderText.innerText = 'Fetching baseline macro data...';

            try {
                // Determine current period info for baseline data
                const currentPeriodInfo = {
                    quarter: `Q${Math.ceil((new Date().getMonth() + 1) / 3)} `,
                    year: new Date().getFullYear()
                };

                // Fetch baseline macro data from CSV
                const baselineMacroData = await fetchBaselineMacroData(currentPeriodInfo);

                // Build baseline context for AI prompt and extract numeric values
                let baselineContext = '';
                let baselineNumericValues = {};

                if (baselineMacroData && baselineMacroData.values) {
                    const vals = baselineMacroData.values;

                    // Extract numeric values from formatted strings
                    const extractNumeric = (val) => {
                        if (!val) return null;
                        const match = val.match(/^([+-]?\d+\.?\d*)/);
                        return match ? parseFloat(match[1]) : null;
                    };

                    const extractQoQ = (val) => {
                        const match = val?.match(/QoQ:\s*([+-]?\d+\.\d+%)/);
                        return match ? match[1] : val;
                    };

                    const extractQoQNumeric = (val) => {
                        const match = val?.match(/QoQ:\s*([+-]?\d+\.\d+)/);
                        return match ? parseFloat(match[1]) : null;
                    };

                    // Store numeric baseline values for later delta calculation
                    baselineNumericValues = {
                        gdp: extractQoQNumeric(vals['Canada GDP']),
                        unemployment: extractNumeric(vals['Unemployment Rate']),
                        inflation: extractNumeric(vals['CPI Inflation']),
                        cadUsd: extractNumeric(vals['CAD/USD']),
                        bocRate: extractNumeric(vals['BoC Rate']),
                        hpi: extractQoQNumeric(vals['House Price Index']),
                        tsx: extractQoQNumeric(vals['TSX Composite']),
                        creditSpreads: extractNumeric(vals['Credit Spreads'])
                    };

                    console.log('ðŸ“Š Extracted baseline numeric values:', baselineNumericValues);

                    baselineContext = `
BASELINE MACROECONOMIC DATA(${currentPeriodInfo.quarter} ${currentPeriodInfo.year}):
            - Canada GDP Growth(QoQ): ${extractQoQ(vals['Canada GDP']) || 'N/A'}
            - Unemployment Rate: ${vals['Unemployment Rate'] || 'N/A'}
            - CPI Inflation: ${vals['CPI Inflation'] || 'N/A'}
            - USD / CAD Exchange Rate: ${vals['CAD/USD'] || 'N/A'} (CAD per 1 USD - higher = weaker CAD)
            - Bank of Canada Policy Rate: ${vals['BoC Rate'] || 'N/A'}
            - House Price Index(QoQ): ${extractQoQ(vals['House Price Index']) || 'N/A'}
            - TSX Composite(QoQ): ${extractQoQ(vals['TSX Composite']) || 'N/A'}
            - Credit Spreads(10Y BBB): ${vals['Credit Spreads'] || 'N/A'}

These are reference values for context only.Generate stress projections as absolute values; the system will calculate deltas automatically.

                CRITICAL: For USD / CAD, use the format "1.XX"(CAD per 1 USD).For example, 1.45 means 1 USD = 1.45 CAD.Higher values = weaker CAD, lower values = stronger CAD.
`;
                }

                // Store for post-processing
                window.currentBaselineValues = baselineNumericValues;

                loaderText.innerText = 'Generating scenario narrative with heat map insights...';

                // Categorize drivers by Materiality only (Likelihood ignored)
                const highRiskDrivers = enhancedDrivers.filter(d =>
                    d.heatMapMateriality >= 7
                );
                const moderateRiskDrivers = enhancedDrivers.filter(d =>
                    d.heatMapMateriality >= 5 && d.heatMapMateriality < 7
                );
                const immediateThreats = enhancedDrivers.filter(d =>
                    d.heatMapVelocity.includes('High')
                );
                const nearTermThreats = enhancedDrivers.filter(d =>
                    d.heatMapVelocity.includes('Medium')
                );

                // Build driver list (without mentioning scores in the description for AI)
                const driversSummary = enhancedDrivers.map((d, idx) =>
                    `${idx + 1}.[${d.cat}] ${d.title}: ${d.desc} `
                ).join('\n');

                // Calculate overall severity guidance (Materiality only)
                const avgMateriality = enhancedDrivers.reduce((sum, d) => sum + d.heatMapMateriality, 0) / enhancedDrivers.length;
                const severityGuidance = avgMateriality >= 7 ? 'SEVERE' :
                    avgMateriality >= 5 ? 'MODERATE' : 'MILD';

                const prompt = fillPrompt(PROMPT_TEMPLATES.SCENARIO_GENERATION, {
                    BASELINE_CONTEXT: baselineContext,
                    DRIVERS_SUMMARY: driversSummary,
                    SEVERITY: severityGuidance,
                    HIGH_RISKS: highRiskDrivers.map(d => d.title).join(', ') || 'None in high-risk category',
                    IMMEDIATE_THREATS: immediateThreats.map(d => d.title).join(', ') || 'None identified',
                    NEAR_TERM_THREATS: nearTermThreats.map(d => d.title).join(', ') || 'None identified'
                });


                loaderText.innerText = 'AI is generating scenario narrative...';

                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [{ role: 'user', content: prompt }],
                        // temperature omitted - GPT-5 only supports default value of 1
                        max_tokens: 20000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                loaderText.innerText = 'Processing scenario data...';

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Parse the JSON response
                let scenario;
                try {
                    const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/) ||
                        aiResponse.match(/```\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) {
                        scenario = JSON.parse(jsonMatch[1]);
                    } else {
                        const directMatch = aiResponse.match(/\{[\s\S]*\}/);
                        if (directMatch) {
                            scenario = JSON.parse(directMatch[0]);
                        } else {
                            throw new Error('No JSON found in response');
                        }
                    }
                } catch (parseError) {
                    console.error('Failed to parse scenario JSON:', parseError);
                    console.log('Raw response:', aiResponse);
                    throw new Error('Failed to parse AI response');
                }

                // POST-PROCESS: Calculate macro deltas and directions from baseline values
                console.log('ðŸ“Š Post-processing heat map scenario with baselines:', baselineNumericValues);

                if (scenario.macroProjections && baselineNumericValues && Object.keys(baselineNumericValues).length > 0) {
                    const macro = scenario.macroProjections;

                    // Helper to extract numeric value from string
                    const extractNumber = (val) => {
                        if (typeof val === 'number') return val;
                        if (typeof val === 'string') {
                            const cleaned = val.replace(/[^\d.-]/g, '');
                            return parseFloat(cleaned);
                        }
                        return NaN;
                    };

                    // Canada GDP - calculate delta from baseline
                    if (macro.canadaGDP && macro.canadaGDP.value) {
                        const gdpValue = extractNumber(macro.canadaGDP.value);
                        if (!isNaN(gdpValue)) {
                            const absDelta = Math.abs(gdpValue).toFixed(1);
                            macro.canadaGDP.delta = `â†“ ${absDelta}% from current`;
                            macro.canadaGDP.direction = 'negative';
                        }
                    }

                    // Unemployment - calculate delta from actual baseline
                    if (macro.unemployment && macro.unemployment.value && baselineNumericValues.unemployment) {
                        const stressValue = extractNumber(macro.unemployment.value);
                        const baselineValue = baselineNumericValues.unemployment;
                        if (!isNaN(stressValue)) {
                            const delta = stressValue - baselineValue;
                            const arrow = delta > 0 ? 'â†‘' : 'â†“';
                            macro.unemployment.delta = `${arrow} to ${stressValue.toFixed(1)}% from ${baselineValue.toFixed(1)}%`;
                            macro.unemployment.direction = delta > 0 ? 'negative' : 'positive';
                        }
                    }

                    // CPI Inflation - calculate delta from actual baseline
                    if (macro.inflation && macro.inflation.value && baselineNumericValues.inflation) {
                        const stressValue = extractNumber(macro.inflation.value);
                        const baselineValue = baselineNumericValues.inflation;
                        if (!isNaN(stressValue)) {
                            const delta = stressValue - baselineValue;
                            const arrow = delta > 0 ? 'â†‘' : 'â†“';
                            macro.inflation.delta = `${arrow} to ${stressValue.toFixed(1)}% from ${baselineValue.toFixed(1)}%`;
                            macro.inflation.direction = delta > 0 ? 'negative' : 'positive';
                        }
                    }

                    // USD/CAD - calculate delta from actual baseline
                    const usdCadData = macro.usdCad || macro.cadUsd;
                    if (usdCadData && usdCadData.value && baselineNumericValues.cadUsd) {
                        const stressValue = extractNumber(usdCadData.value);
                        const baselineValue = baselineNumericValues.cadUsd;
                        if (!isNaN(stressValue)) {
                            const delta = stressValue - baselineValue;
                            const arrow = delta > 0 ? 'â†‘' : 'â†“';
                            usdCadData.delta = `${arrow} to ${stressValue.toFixed(2)} from ${baselineValue.toFixed(2)}`;
                            usdCadData.direction = delta > 0 ? 'negative' : 'positive';
                        }
                        if (macro.usdCad) macro.cadUsd = macro.usdCad;
                        if (macro.cadUsd && !macro.usdCad) macro.usdCad = macro.cadUsd;
                    }

                    // BoC Rate - calculate delta from actual baseline
                    if (macro.bocRate && macro.bocRate.value && baselineNumericValues.bocRate) {
                        const stressValue = extractNumber(macro.bocRate.value);
                        const baselineValue = baselineNumericValues.bocRate;
                        if (!isNaN(stressValue)) {
                            const deltaBps = Math.round((stressValue - baselineValue) * 100);
                            const arrow = deltaBps < 0 ? 'â†“' : 'â†‘';
                            macro.bocRate.delta = `${arrow} ${Math.abs(deltaBps)} bps to ${stressValue.toFixed(2)}% from ${baselineValue.toFixed(1)}%`;
                            macro.bocRate.direction = deltaBps < 0 ? 'positive' : 'negative';
                        }
                    }

                    // House Price Index - calculate delta
                    if (macro.housePrice && macro.housePrice.value) {
                        const hpiValue = extractNumber(macro.housePrice.value);
                        if (!isNaN(hpiValue)) {
                            macro.housePrice.delta = `â†“ ${Math.abs(hpiValue).toFixed(1)}% from current`;
                            macro.housePrice.direction = 'negative';
                        }
                    }

                    // TSX Composite - calculate delta
                    if (macro.tsx && macro.tsx.value) {
                        const tsxValue = extractNumber(macro.tsx.value);
                        if (!isNaN(tsxValue)) {
                            macro.tsx.delta = `â†“ ${Math.abs(tsxValue).toFixed(1)}% from current`;
                            macro.tsx.direction = 'negative';
                        }
                    }

                    // Credit Spreads - calculate delta from actual baseline
                    if (macro.creditSpreads && macro.creditSpreads.value && baselineNumericValues.creditSpreads) {
                        const stressValue = extractNumber(macro.creditSpreads.value);
                        const baselineValue = baselineNumericValues.creditSpreads;
                        if (!isNaN(stressValue)) {
                            const stressBps = Math.round(stressValue * 100);
                            const baselineBps = Math.round(baselineValue * 100);
                            const deltaBps = stressBps - baselineBps;
                            macro.creditSpreads.value = `${stressBps} bps`;
                            macro.creditSpreads.delta = `â†‘ ${deltaBps} bps to ${stressBps} from ${baselineBps} bps`;
                            macro.creditSpreads.direction = 'negative';
                        }
                    }

                    console.log('ðŸ“Š Final processed heat map macro projections:', macro);
                }

                loaderText.innerText = 'Rendering scenario report...';
                await new Promise(r => setTimeout(r, 500));

                // Store the generated scenario for later use
                window.currentGeneratedScenario = scenario;

                // Use the same rendering function as regular scenario generation
                // Store enhanced drivers as selectedDrivers for rendering
                selectedDrivers = enhancedDrivers;

                // Render using the standard format
                renderAIReport(scenario);

            } catch (error) {
                console.error('Heat map scenario generation error:', error);
                loader.style.display = 'none';
                alert(`Failed to generate scenario: ${error.message}. Please try again.`);
            } finally {
                loader.style.display = 'none';
            }
        }

        function exportReport() {
            alert('PDF export would be implemented here using jsPDF or server-side generation.');
        }


        // --- DRAG AND DROP HANDLERS ---
        function handleDragStart(e, id) {
            if (!id) return;
            e.dataTransfer.setData("text/plain", id);
            e.dataTransfer.effectAllowed = "copy";

            // Visual feedback on basket
            const basket = document.getElementById('basketPanel');
            basket.style.transition = 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
            // Use INSET shadow to stay within bounds
            basket.style.boxShadow = 'inset 0 0 0 3px var(--primary), var(--shadow-float)';
        }

        function handleDragEnd(e) {
            const basket = document.getElementById('basketPanel');
            basket.style.transform = '';
            basket.style.boxShadow = '';
            basket.style.background = '';
            basket.classList.remove('drag-over');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = "copy";
            return false;
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const basket = document.getElementById('basketPanel');
            if (!basket.classList.contains('drag-over')) {
                basket.classList.add('drag-over');
                basket.style.background = 'rgba(239, 246, 255, 0.95)'; // Highlight blue
                basket.style.borderColor = 'var(--primary)';
            }
        }

        function handleDragLeave(e) {
            const basket = document.getElementById('basketPanel');
            // Check if leaving basket panel completely (not entering a child)
            if (!basket.contains(e.relatedTarget)) {
                basket.classList.remove('drag-over');
                basket.style.background = '';
                basket.style.borderColor = '';
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            handleDragEnd(e); // Reset styles

            const id = e.dataTransfer.getData("text/plain");
            if (id) {
                // Add if not already present
                const exists = selectedDrivers.some(d => d.id === id);
                if (!exists) {
                    toggleDriver(id);
                } else {
                    // Maybe shake animation to say "already added"?
                    const basket = document.getElementById('basketPanel');
                    basket.animate([
                        { transform: 'translateX(0)' },
                        { transform: 'translateX(-5px)' },
                        { transform: 'translateX(5px)' },
                        { transform: 'translateX(0)' }
                    ], { duration: 300 });
                }
            }
        }

        // Export current report overlay as PDF
        function exportScenarioPdf() {
            const title = (document.getElementById('reportTitle')?.innerText || 'Scenario')
                .replace(/[^a-z0-9\s\-]/gi, '')
                .trim();
            const dateStr = new Date().toISOString().slice(0, 10);

            // Clone the report container to avoid modifying the live DOM
            const reportContainer = document.querySelector('.report-container');
            if (!reportContainer) {
                alert('Report content not available to export.');
                return;
            }

            const clone = reportContainer.cloneNode(true);
            // Optional: remove interactive elements from clone
            clone.querySelectorAll('button, input, textarea, .chat-input-area, .report-actions').forEach(n => n.remove());

            const opt = {
                margin: 10,
                filename: `${title.replace(/\s+/g, '_')}_${dateStr}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
            };

            // Create a container element to render
            const wrapper = document.createElement('div');
            wrapper.style.padding = '20px';
            wrapper.style.background = '#ffffff';
            wrapper.appendChild(clone);

            // Use html2pdf to generate PDF
            if (window.html2pdf) {
                window.html2pdf().set(opt).from(wrapper).save();
            } else {
                alert('PDF library not loaded. Please refresh the page.');
            }
        }
        // --- PDF EXPORT FUNCTION ---
        // --- PDF EXPORT FUNCTION (Smart Page Breaks) ---
        async function exportScenarioPdf() {
            const btn = document.getElementById('exportPdfBtn');
            const originalText = btn ? btn.innerHTML : '';

            try {
                if (btn) btn.innerHTML = 'â³ Generating PDF...';
                if (btn) btn.disabled = true;

                // --- 1. SETUP PDF & DATA ---
                const title = (document.getElementById('reportTitle')?.innerText || 'Scenario')
                    .replace(/[^a-z0-9\s\-]/gi, '').trim();
                const dateStr = new Date().toISOString().slice(0, 10);
                const filename = `${title.replace(/\s+/g, '_')}_${dateStr}.pdf`;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15; // mm
                const contentWidth = pageWidth - (margin * 2);
                let cursorY = margin;

                // --- 2. SETUP OFF-SCREEN RENDER CONTAINER ---
                // We recreate the DOM structure to ensure styles apply correctly during partial capture
                const renderContainer = document.createElement('div');
                renderContainer.style.position = 'absolute';
                renderContainer.style.left = '-9999px';
                renderContainer.style.top = '0';
                renderContainer.style.width = '800px'; // Fixed width for consistent text wrapping
                renderContainer.style.background = '#ffffff';
                // wrapper to match CSS selectors
                renderContainer.innerHTML = '<div class="report-main"><div class="report-body" id="renderBody"></div></div>';
                document.body.appendChild(renderContainer);

                const renderBody = renderContainer.querySelector('#renderBody');

                // --- HELPER: CAPTURE & ADD TO PDF ---
                async function captureAndAdd(element, addsPadding = true) {
                    renderBody.appendChild(element); // Move element to render area

                    const canvas = await html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const imgHeight = (canvas.height * contentWidth) / canvas.width;

                    // Check page break
                    if (cursorY + imgHeight > pageHeight - margin) {
                        pdf.addPage();
                        cursorY = margin;
                    }

                    pdf.addImage(imgData, 'JPEG', margin, cursorY, contentWidth, imgHeight);
                    cursorY += imgHeight + (addsPadding ? 8 : 0); // Add spacing between sections

                    renderBody.innerHTML = ''; // Clean up for next item
                }

                // --- 3. PROCESS HEADER ---
                const originalHeader = document.querySelector('.report-header');
                if (originalHeader) {
                    const headerClone = originalHeader.cloneNode(true);
                    // Stylistic adjustments for white paper export
                    headerClone.style.background = 'white';
                    headerClone.style.color = '#0F172A';
                    headerClone.style.borderBottom = '2px solid #2563EB';
                    headerClone.style.padding = '20px 0';
                    headerClone.style.marginBottom = '10px';

                    // Fix text colors manually since we stripped the dark background
                    const hTitle = headerClone.querySelector('.report-title');
                    if (hTitle) hTitle.style.color = '#0F172A';
                    const hSub = headerClone.querySelector('.report-subtitle');
                    if (hSub) hSub.style.color = '#64748b';

                    // Remove buttons
                    const buttons = headerClone.querySelectorAll('button');
                    buttons.forEach(b => b.remove());

                    await captureAndAdd(headerClone);
                }

                // --- 4. PROCESS SECTIONS LOOP ---
                // We capture each section individually to ensure we never cut a section in half
                const sections = document.querySelectorAll('.report-section');
                for (const section of sections) {
                    const sectionClone = section.cloneNode(true);
                    // Ensure text colors are correct for white paper
                    sectionClone.style.color = '#334155';
                    sectionClone.style.marginBottom = '0'; // We handle spacing via cursorY
                    sectionClone.style.padding = '10px';
                    sectionClone.style.background = 'white';
                    sectionClone.style.borderRadius = '0'; // Clean look
                    // Ensure titles are dark text
                    const sTitle = sectionClone.querySelector('.section-title');
                    if (sTitle) sTitle.style.color = '#2563EB';

                    await captureAndAdd(sectionClone);
                }

                // --- 5. FINALIZE ---
                pdf.save(filename);
                document.body.removeChild(renderContainer);

                if (btn) {
                    btn.innerHTML = 'âœ… Downloaded!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                }

            } catch (error) {
                console.error('PDF Export Error:', error);
                alert('Failed to export PDF: ' + error.message);
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

    </script>

    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Heat Map Export Logic
        function openHeatmapExportModal() {
            document.getElementById('heatmapExportModal').style.display = 'flex';
        }

        function closeHeatmapExportModal() {
            document.getElementById('heatmapExportModal').style.display = 'none';
        }

        async function exportHeatmap(format) {
            const heatmapView = document.getElementById('heatMapPanel');
            if (!heatmapView) {
                console.error('Heat Map panel not found!');
                alert('Error: Heat Map panel not active.');
                return;
            }

            // Show loading state (optional, or just change button text if we had a Ref to it)
            // But since this is a modal, we can just proceed.
            const exportModal = document.getElementById('heatmapExportModal');
            exportModal.style.display = 'none'; // Hide modal during capture if it overlaps, though it shouldn't if we capture specific element.  
            // Actually we interpret the user intention to close it after selection.

            // Wait a moment for modal to disappear visually if needed, though we are capturing 'heatmapView' which is in the background.
            // Using html2canvas with onclone to hide instructions

            try {
                const canvas = await html2canvas(heatmapView, {
                    scale: 3, // Increased scale for better clarity
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff', // Canvas base is white
                    onclone: (clonedDoc) => {
                        const clonedHeatmap = clonedDoc.getElementById('heatMapPanel');
                        if (clonedHeatmap) {
                            // STOP ANIMATIONS: The 'floatIn' animation might be restarting in the clone, causing opacity < 1
                            clonedHeatmap.style.animation = 'none';
                            clonedHeatmap.style.transition = 'none';
                            clonedHeatmap.style.opacity = '1';

                            // 1. Strip main container styles
                            clonedHeatmap.style.background = 'transparent';
                            clonedHeatmap.style.backgroundColor = 'transparent';
                            clonedHeatmap.style.backdropFilter = 'none';
                            clonedHeatmap.style.webkitBackdropFilter = 'none';
                            clonedHeatmap.style.boxShadow = 'none';
                            clonedHeatmap.style.border = 'none';

                            // 2. Nuclear option: Remove ALL backdrop-filters, animations, and transparency issues
                            const allElements = clonedHeatmap.querySelectorAll('*');
                            allElements.forEach(el => {
                                el.style.animation = 'none';
                                el.style.transition = 'none';
                                el.style.backdropFilter = 'none';
                                el.style.webkitBackdropFilter = 'none';
                                if (window.getComputedStyle(el).opacity !== '1') {
                                    el.style.opacity = '1';
                                }
                            });

                            // 3. Ensure the Panel Header (title) is clean
                            const header = clonedHeatmap.querySelector('.panel-header');
                            if (header) {
                                header.style.background = 'transparent';
                                header.style.borderBottom = '1px solid #E2E8F0'; // Keen a subtle divider
                            }
                        }

                        // Hide instructions
                        const instructions = clonedDoc.querySelector('.heatmap-instructions');
                        if (instructions) {
                            instructions.style.display = 'none';
                        }
                    }
                });

                if (format === 'jpg') {
                    const link = document.createElement('a');
                    link.download = 'Risk_Heat_Map.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('landscape', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);

                    // Calculate dimensions to fit A4 landscape
                    const imgWidth = 297; // A4 width mm
                    const pageHeight = 210; // A4 height mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    let heightLeft = imgHeight;
                    let position = 0;

                    // If image is taller than page, might need scaling, but Heatmap is usually landscape.
                    // Let's center it or fit it.
                    // For a heatmap, fitting to page is best.

                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    pdf.save('Risk_Heat_Map.pdf');
                }

            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed: ' + error.message);
            }
        }

        function toggleReportSidebar() {
            const sidebar = document.getElementById('reportSidebar');
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
            }
        }

    </script>
    <!-- Settings Modal -->
    <div id="aiPromptsModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(31, 41, 55, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); align-items: center; justify-content: center; z-index: 2000;">
        <div class="modal-content"
            style="width: 900px; height: 80vh; background: #ffffff; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; overflow: hidden; padding: 0;">
            <div class="modal-header"
                style="padding: 20px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 18px;">System Settings</h2>
                    <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-muted);">View AI instruction
                        templates
                    </p>
                </div>
                <button class="icon-btn" onclick="closeAiPromptsModal()" style="font-size: 20px;">&times;</button>
            </div>

            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Sidebar -->
                <div
                    style="width: 240px; background: #F9FAFB; border-right: 1px solid var(--border-subtle); padding: 16px; overflow-y: auto;">
                    <div
                        style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
                        AI Prompts</div>
                    <button id="btn-RISK_DRIVERS" class="settings-nav-btn active" onclick="showPrompt('RISK_DRIVERS')"
                        style="width: 100%; text-align: left; padding: 10px; border: none; background: transparent; border-radius: 8px; font-size: 13px; color: var(--text-main); cursor: pointer; margin-bottom: 4px;">Risk
                        Generation</button>
                    <button id="btn-RISK_DRIVERS_ADDITIONAL" class="settings-nav-btn"
                        onclick="showPrompt('RISK_DRIVERS_ADDITIONAL')"
                        style="width: 100%; text-align: left; padding: 10px; border: none; background: transparent; border-radius: 8px; font-size: 13px; color: var(--text-main); cursor: pointer; margin-bottom: 4px;">Additional
                        Drivers</button>
                    <button id="btn-HEATMAP_ASSESSMENT" class="settings-nav-btn"
                        onclick="showPrompt('HEATMAP_ASSESSMENT')"
                        style="width: 100%; text-align: left; padding: 10px; border: none; background: transparent; border-radius: 8px; font-size: 13px; color: var(--text-main); cursor: pointer; margin-bottom: 4px;">Heat
                        Map Assmnt.</button>
                    <button id="btn-SCENARIO_GENERATION" class="settings-nav-btn"
                        onclick="showPrompt('SCENARIO_GENERATION')"
                        style="width: 100%; text-align: left; padding: 10px; border: none; background: transparent; border-radius: 8px; font-size: 13px; color: var(--text-main); cursor: pointer; margin-bottom: 4px;">Scenario
                        Narrative</button>
                </div>

                <!-- Content -->
                <div id="promptContent"
                    style="flex: 1; padding: 24px; overflow-y: auto; white-space: pre-wrap; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.5; color: #374151; background: white;">
                    Select a prompt to view...
                </div>
            </div>
        </div>
    </div>

    <!-- Styles for Settings Nav -->
    <style>
        .settings-nav-btn:hover {
            background: #F3F4F6 !important;
        }

        .settings-nav-btn.active {
            background: #E0E7FF !important;
            color: #4F46E5 !important;
            font-weight: 500;
        }
    </style>

    <script>
        function openAiPromptsModal() {
            const modal = document.getElementById('aiPromptsModal');
            if (modal) {
                modal.style.display = 'flex';
                showPrompt('RISK_DRIVERS');
            }
        }

        function closeAiPromptsModal() {
            const modal = document.getElementById('aiPromptsModal');
            if (modal) modal.style.display = 'none';
        }

        function showPrompt(key) {
            const content = document.getElementById('promptContent');
            const template = PROMPT_TEMPLATES[key];
            if (content && template) {
                content.textContent = template;

                document.querySelectorAll('.settings-nav-btn').forEach(btn => btn.classList.remove('active'));
                const btn = document.getElementById(`btn-${key}`);
                if (btn) btn.classList.add('active');
            }
        }
    </script>

    <!-- CET1 Capital Analysis JavaScript -->
    <script>
        // ========================================
        // CET1 CAPITAL ANALYSIS - NAVIGATION
        // ========================================

        function showCET1Analysis() {
            // Hide all center panels
            document.getElementById('marketplacePanel').style.display = 'none';
            document.getElementById('savedScenariosPanel').style.display = 'none';
            document.getElementById('heatMapPanel').style.display = 'none';
            document.getElementById('executiveReportPanel').style.display = 'none';
            document.getElementById('execPickerModal').style.display = 'none';
            document.getElementById('cet1AnalysisPanel').style.display = 'flex';

            // Hide scenario basket and heatmap basket
            document.getElementById('basketPanel').style.display = 'none';
            document.getElementById('basketPanel').style.display = 'none';
            document.getElementById('heatmapBasketPanel').style.display = 'none';
            const pgPanel = document.getElementById('playgroundPanel');
            if (pgPanel) pgPanel.style.display = 'none';

            // Update nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector('.nav-item[title="CET1 Capital Analysis"]')?.classList.add('active');

            // Initialize CET1 if not already done
            if (!window.cet1Initialized) {
                cet1Initialize();
                window.cet1Initialized = true;
            }
        }

        function toggleAstraPanel(panelId) {
            const panel = document.getElementById(panelId);
            const allPanels = document.querySelectorAll('.astra-side-panel');

            const isOpen = panel.classList.contains('open');
            allPanels.forEach(p => p.classList.remove('open'));
            document.getElementById('navScenarioBuilder')?.classList.remove('active');
            document.getElementById('navOverlayControls')?.classList.remove('active');

            if (!isOpen) {
                panel.classList.add('open');
                if (panelId === 'scenarioBuilderPanel') {
                    document.getElementById('navScenarioBuilder')?.classList.add('active');
                } else if (panelId === 'overlayControlsPanel') {
                    document.getElementById('navOverlayControls')?.classList.add('active');
                }
            }
        }

        function closeAstraPanel(panelId) {
            document.getElementById(panelId)?.classList.remove('open');
            document.getElementById('navScenarioBuilder')?.classList.remove('active');
            document.getElementById('navOverlayControls')?.classList.remove('active');
        }

        // ========================================
        // CET1 DATA & STATE
        // ========================================
        const CET1_JUMP_OFF_CAPITAL = 98748;
        const CET1_JUMP_OFF_RWA = 730225;
        const CET1_JUMP_OFF = (CET1_JUMP_OFF_CAPITAL / CET1_JUMP_OFF_RWA) * 100;

        const CET1_COMPONENTS = [
            'PPNR Canada', 'PPNR US', 'PPNR International',
            'PCL Canada', 'PCL US', 'PCL International',
            'Dividend', 'Trading PnL', 'AFS Losses', 'Operational Risk Losses',
            'Currency Translation Adj', 'Shortfall in Allowance',
            'Credit RWA Change Canada', 'Credit RWA Change US', 'Credit RWA Change International',
            'Market CCR CVA RWA Change', 'Operational Risk RWA Change', 'Other'
        ];

        let cet1CustomScenarioComponents = {};
        let cet1CustomScenarioName = 'My Custom Scenario';
        let cet1SelectedDetailScenario = 'very_severe';
        let cet1ComponentOverrides = {};
        let cet1QuarterlyOverlayValues = Array(20).fill(0);
        let cet1DecompositionMode = 'cumulative';

        // Additional state for modals
        let cet1CurrentEditingComponent = null;
        let cet1TempOverrideValues = [];
        let cet1TempDirectOverlayValues = [];
        let cet1DirectOverlayDragState = { isDragging: false, pointIndex: -1 };
        let cet1DirectOverlayListenersAttached = false;
        let cet1ChartDragState = { isDragging: false, pointIndex: -1, baseData: null };

        // AI Chat State
        let cet1ConversationHistory = [];
        let cet1UploadedFileContent = null;
        let cet1CustomScenarioResult = null;
        let cet1CurrentImportedScenario = '';

        // Complete Scenario Data with all 18 components x 20 quarters
        const cet1ScenarioData = {
            very_severe: {
                'PPNR Canada': [3222.969, 2869.014, 3246.041, 2425.790, 2208.116, 2216.719, 2256.318, 2121.919, 2230.711, 2395.313, 2497.842, 2374.226, 2505.064, 2678.626, 2787.497, 2699.540, 2903.747, 3024.551, 3121.453, 3009.034],
                'PPNR US': [1550.440, 1524.281, 1807.919, 1248.145, 1243.531, 1126.131, 1077.533, 996.843, 1022.774, 1136.775, 1171.424, 1163.200, 1193.935, 1192.430, 1195.289, 1214.409, 1260.840, 1295.810, 1309.765, 1369.222],
                'PPNR International': [193.681, 150.924, 204.917, 166.304, 190.095, 157.354, 162.964, 166.120, 178.882, 181.390, 184.648, 187.102, 191.639, 195.733, 196.838, 200.324, 205.627, 213.901, 217.252, 218.989],
                'PCL Canada': [-11405.368, -3587.163, -4173.969, -849.652, -616.655, -617.109, -504.758, -457.835, -435.168, -410.620, -506.328, -568.407, -583.140, -581.718, -591.112, -592.912, -594.914, -608.561, -601.405, -585.543],
                'PCL US': [-2244.115, -907.714, -856.424, -267.425, -233.045, -303.639, -189.325, -148.783, -154.668, -122.178, -129.232, -109.077, -97.757, -98.563, -90.833, -98.776, -102.792, -105.393, -107.721, -105.726],
                'PCL International': [-667.439, -401.831, -293.005, -76.167, -86.545, -172.095, -67.289, 17.646, 11.326, 5.519, -4.619, -9.340, -12.202, -14.126, -14.817, -17.054, -18.788, -18.938, -20.323, -19.701],
                'Dividend': [-2099.366, -2099.366, 0.000, 0.000, -901.082, -1292.664, -742.119, -869.983, -854.050, -1043.352, -1175.751, -1186.984, -1116.019, -1255.703, -1987.866, -2054.851, -2008.324, -2099.366, -2099.366, -2099.366],
                'Trading PnL': [-3145.140, 0.000, -434.069, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'AFS Losses': [-304.110, -127.747, -2498.338, -1151.227, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'Operational Risk Losses': [-436.745, -428.431, -432.227, -422.954, -583.533, -581.167, -589.280, -589.249, -275.734, -277.056, -276.512, -277.933, -89.557, -90.551, -89.410, -89.620, -86.189, -87.099, -86.556, -87.276],
                'Currency Translation Adj': [4744.389, 1721.768, -2246.537, -1764.379, -1478.117, -1262.725, -1042.542, -896.217, -727.225, -620.314, -527.563, -453.629, -388.267, -334.929, -283.614, 316.626, 361.750, 358.890, -0.355, -2.142],
                'Shortfall in Allowance': [0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, -37.996, -2801.624, -2358.694, -361.419, 447.815, 383.139, 354.948, 127.578, -24.600, -22.588, -36.288, -12.396, -51.108],
                'Credit RWA Change Canada': [20290.025, 10827.208, 14101.148, 12620.922, 13701.387, 7521.052, 1880.906, -1579.892, -1842.791, -2721.816, -1609.174, 559.560, -457.413, -570.669, -974.871, 809.841, 1406.369, 1557.481, 311.876, 1640.982],
                'Credit RWA Change US': [16694.742, 8421.918, 10884.448, 9258.506, 9856.767, 5249.626, 1302.004, -1081.001, -1261.148, -1855.705, -1098.065, 379.817, -307.437, -382.217, -654.876, 546.290, 950.903, 1052.819, 210.380, 1107.537],
                'Credit RWA Change International': [5155.745, 2476.162, 3206.737, 2716.690, 2897.394, 1557.941, 387.093, -323.158, -376.088, -555.068, -329.122, 112.792, -91.233, -113.075, -192.445, 159.541, 275.370, 303.461, 60.543, 315.914],
                'Market CCR CVA RWA Change': [33362.485, -9356.292, 2238.157, -955.388, -853.065, -1022.164, 216.116, -609.793, -1020.904, 153.103, -1195.055, -1399.577, -673.175, -990.498, -137.695, -368.514, -807.253, -637.088, -309.598, -667.771],
                'Operational Risk RWA Change': [5156.603, 4992.019, 4582.980, 3184.095, 3792.922, 3780.136, 3530.788, 3198.994, 913.953, 667.663, 504.453, 104.827, -645.954, -244.376, 328.338, 1219.514, 1774.708, 2055.454, 1954.058, 2049.244],
                'Other': [218.263, -720.742, -374.733, -35.461, 75.777, 246.562, 198.263, 177.831, 134.431, 116.779, 99.926, 88.068, 76.164, 67.081, 58.325, -57.677, -64.359, -63.272, 7.719, 8.541]
            },
            severe: {
                'PPNR Canada': [3232.323, 2929.987, 2831.885, 2769.059, 2596.351, 2699.171, 2965.343, 2878.666, 2928.040, 2995.619, 3033.575, 2848.626, 2932.465, 3091.373, 3162.364, 3069.851, 3250.604, 3424.641, 3500.885, 3385.004],
                'PPNR US': [1572.454, 1512.868, 1604.046, 1612.721, 1745.888, 1647.600, 1657.803, 1623.993, 1661.470, 1698.608, 1692.290, 1671.795, 1659.208, 1656.221, 1655.710, 1670.353, 1672.518, 1714.055, 1701.671, 1749.562],
                'PPNR International': [183.090, 137.510, 129.531, 146.609, 192.205, 171.464, 180.960, 188.304, 219.166, 210.535, 211.919, 214.498, 218.618, 226.282, 227.538, 230.474, 226.903, 233.251, 229.886, 227.837],
                'PCL Canada': [-6215.633, -1526.590, -1228.631, -748.438, -586.901, -611.947, -697.290, -591.703, -569.049, -521.465, -529.614, -578.840, -611.765, -655.927, -660.430, -721.910, -657.310, -727.318, -639.803, -593.706],
                'PCL US': [-936.402, -302.113, -196.839, -235.701, -181.635, -168.365, -168.526, -120.585, -131.779, -127.265, -132.451, -110.375, -106.722, -108.776, -106.285, -115.667, -110.659, -124.223, -113.214, -106.456],
                'PCL International': [-248.520, -119.559, -70.414, -53.079, -56.520, -74.294, -65.502, -24.838, -23.236, -15.309, -18.803, -19.329, -20.997, -23.203, -22.251, -26.033, -24.149, -26.250, -25.438, -22.156],
                'Dividend': [-2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366],
                'Trading PnL': [-2089.959, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'AFS Losses': [-915.230, -858.043, -857.927, -1613.056, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'Operational Risk Losses': [-174.032, -168.491, -171.916, -164.239, -314.611, -314.973, -318.385, -319.782, -112.268, -113.490, -112.845, -113.685, -50.520, -51.783, -50.874, -49.217, -45.977, -49.662, -49.010, -49.589],
                'Currency Translation Adj': [2279.970, 2185.995, 3017.030, 2417.307, 44.602, -2017.659, -1716.052, -1444.671, -1199.956, -1004.789, -843.562, -715.453, -615.919, -514.352, -442.319, -377.315, -324.692, -279.569, -238.971, -195.381],
                'Shortfall in Allowance': [0.000, 0.000, 0.000, 0.000, 0.000, 0.000, -820.325, -1557.031, -1285.016, -800.107, -176.789, 204.637, 198.550, 72.654, 23.260, -29.267, -29.801, -7.502, 1.552, -37.499],
                'Credit RWA Change Canada': [20401.463, 7762.742, 17240.635, 14813.732, 13834.723, 3773.282, 2573.217, -268.130, -1141.498, -276.010, 93.302, 1171.675, 595.990, 502.458, 478.588, 855.279, -2099.629, 924.490, 352.861, 1175.647],
                'Credit RWA Change US': [16786.434, 5934.028, 13073.292, 10968.735, 10265.614, 2741.374, 1848.228, -190.616, -809.175, -193.908, 65.263, 811.524, 407.806, 341.652, 325.073, 581.710, -1425.103, 628.737, 238.789, 795.868],
                'Credit RWA Change International': [5184.062, 1758.565, 3811.509, 3092.325, 2834.985, 756.460, 508.188, -52.651, -224.818, -54.515, 18.426, 228.080, 114.860, 96.119, 90.965, 162.227, -395.733, 174.639, 66.339, 219.444],
                'Market CCR CVA RWA Change': [30266.720, -15746.882, 1857.587, -1122.230, -976.758, -1379.554, -175.582, -319.654, -1103.841, 310.169, -844.272, -116.135, -314.097, -217.278, -90.198, -252.139, -109.698, -168.960, -235.996, -89.533],
                'Operational Risk RWA Change': [2361.909, 2433.917, 2576.360, 2040.927, 3361.786, 3608.641, 3410.371, 3179.461, 1154.634, 866.252, 694.598, 342.169, 317.544, 536.119, 580.720, 522.752, 672.247, 830.062, 884.471, 1016.590],
                'Other': [827.367, -296.078, -499.552, -363.865, -195.804, 397.110, 339.340, 286.719, 231.466, 190.644, 157.583, 135.841, 117.635, 97.727, 85.065, 74.668, 67.277, 59.384, 52.877, 41.569]
            },
            moderate: {
                'PPNR Canada': [3360.477, 3055.115, 3076.815, 3139.289, 2941.480, 3067.658, 3288.897, 3136.822, 3172.283, 3314.940, 3398.201, 3241.048, 3378.442, 3547.666, 3715.846, 3654.490, 3791.255, 3880.189, 4002.668, 3899.802],
                'PPNR US': [1590.275, 1450.832, 1474.157, 1437.628, 1494.714, 1509.426, 1485.384, 1471.550, 1529.603, 1562.694, 1589.955, 1636.797, 1720.419, 1727.836, 1769.750, 1828.787, 1903.469, 1953.614, 2008.633, 2058.994],
                'PPNR International': [183.584, 152.390, 147.475, 151.343, 180.946, 176.457, 182.207, 185.923, 191.408, 194.902, 197.502, 199.261, 201.570, 204.818, 205.121, 202.526, 202.553, 207.818, 210.257, 212.342],
                'PCL Canada': [-2479.798, -827.166, -814.815, -672.813, -588.550, -562.905, -550.956, -485.868, -524.370, -521.269, -503.654, -567.371, -595.937, -628.463, -623.616, -618.757, -624.452, -620.400, -611.068, -611.499],
                'PCL US': [-85.777, -155.752, -115.075, -130.030, -128.754, -130.860, -129.559, -111.754, -133.325, -125.373, -110.183, -95.812, -97.567, -100.713, -105.204, -109.229, -112.612, -117.090, -114.460, -112.816],
                'PCL International': [-51.356, -45.273, -32.150, -34.762, -34.735, -30.529, -29.680, -23.747, -27.513, -21.215, -19.536, -18.867, -19.989, -21.559, -21.568, -25.133, -28.691, -30.614, -35.113, -30.379],
                'Dividend': [-2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366],
                'Trading PnL': [-1043.706, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'AFS Losses': [-236.933, -466.978, -528.252, -586.508, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'Operational Risk Losses': [-124.930, -119.217, -122.071, -116.139, -72.044, -72.289, -73.422, -73.707, -69.431, -68.506, -67.809, -68.467, -51.243, -52.445, -51.478, -51.776, -45.750, -46.589, -45.953, -46.517],
                'Currency Translation Adj': [-450.522, 474.725, -137.509, 20.652, -364.390, -274.247, -224.822, -611.668, -566.165, -605.662, -149.865, -114.027, -63.549, -108.092, 2.158, 299.913, 324.563, 365.049, 323.378, -677.479],
                'Shortfall in Allowance': [-152.913, -179.308, -558.071, -698.551, -682.110, -674.880, -628.469, -501.031, -163.718, -58.838, 76.183, 187.563, 167.644, 150.493, 120.784, 12.480, -2.899, -28.471, -61.664, -95.204],
                'Credit RWA Change Canada': [15167.103, 6596.458, 11714.279, 6597.880, 7165.854, 4276.721, 4668.248, 2169.613, 1179.065, 95.668, 638.790, 1505.571, 1819.452, 1822.352, 1903.995, 3217.152, 3961.643, 3451.423, 3471.805, 1259.130],
                'Credit RWA Change US': [12479.574, 5289.564, 9223.501, 5122.299, 5455.431, 3201.101, 3476.990, 1595.439, 875.686, 71.706, 488.162, 1165.041, 1423.746, 1437.350, 1513.778, 2568.823, 3149.172, 2713.440, 2702.123, 974.088],
                'Credit RWA Change International': [3853.998, 1571.311, 2707.409, 1468.277, 1556.534, 915.397, 989.918, 455.121, 249.613, 20.497, 139.792, 332.581, 406.647, 410.460, 431.538, 732.995, 897.794, 773.561, 772.831, 276.936],
                'Market CCR CVA RWA Change': [10158.535, -4408.842, 3072.085, -117.115, 135.009, 53.930, 582.074, -119.662, -160.422, 130.173, -176.369, -222.461, -278.651, -316.292, 79.720, -120.849, -191.008, -169.127, -102.555, -161.048],
                'Operational Risk RWA Change': [1790.977, 1842.818, 1913.045, 1288.924, 664.436, 1048.613, 942.740, 846.201, 730.577, 466.779, 367.117, 119.665, 650.568, 917.481, 1105.319, 1248.347, 1400.804, 1487.303, 1546.632, 1577.332],
                'Other': [1268.738, -148.643, -91.548, -143.815, -121.927, 69.668, 57.505, 132.086, 115.812, 113.012, 27.120, 20.706, 11.895, 22.358, 3.386, -43.089, -47.720, -56.091, -49.001, 96.756]
            },
            benchmark: {
                'PPNR Canada': [4236.801, 4015.482, 4241.677, 4290.276, 4177.913, 4248.206, 4475.423, 4378.012, 4546.092, 4613.281, 4834.622, 4734.219, 4898.294, 4953.740, 5164.019, 5053.130, 5045.437, 5101.151, 5312.042, 5201.711],
                'PPNR US': [827.089, 1048.255, 1033.996, 1160.377, 1264.229, 1292.857, 1382.458, 1456.961, 1447.448, 1475.277, 1563.203, 1637.867, 1541.262, 1565.303, 1649.506, 1719.185, 1955.125, 1978.821, 2062.631, 2131.713],
                'PPNR International': [32.495, -10.566, -2.521, -15.759, 64.455, 49.335, 70.921, 73.758, 88.746, 73.482, 95.102, 97.959, 132.584, 117.230, 138.376, 140.906, 110.643, 95.384, 116.529, 119.088],
                'PCL Canada': [-1649.598, -602.685, -695.952, -565.180, -549.293, -561.663, -543.534, -575.358, -592.579, -583.309, -603.344, -615.435, -604.150, -602.867, -606.816, -619.199, -615.667, -621.525, -616.684, -621.328],
                'PCL US': [852.783, -77.953, -71.419, -70.722, -71.898, -68.668, -69.671, -64.500, -69.957, -71.042, -71.222, -68.094, -69.909, -70.265, -69.283, -68.631, -71.514, -74.434, -72.070, -71.005],
                'PCL International': [110.063, -32.149, -28.989, -28.589, -31.170, -27.276, -26.553, -29.535, -28.958, -26.273, -28.198, -27.690, -27.437, -27.147, -26.027, -26.023, -26.761, -27.398, -32.061, -27.965],
                'Dividend': [-2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366, -2099.366],
                'Trading PnL': [-177.881, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'AFS Losses': [-111.397, -2.387, 11.935, -27.849, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'Operational Risk Losses': [-62.033, -56.344, -53.831, -55.157, -49.480, -50.537, -49.797, -50.257, -47.436, -48.503, -47.779, -48.238, -45.601, -46.668, -45.985, -46.437, -43.182, -44.256, -43.576, -44.034],
                'Currency Translation Adj': [331.839, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'Shortfall in Allowance': [-1461.122, -338.211, -401.809, -431.269, -229.030, -265.201, -308.262, -222.312, -58.655, -23.486, -3.005, -9.841, -22.303, -27.763, -15.093, -66.565, -77.919, -65.483, -57.190, -79.672],
                'Credit RWA Change Canada': [14794.718, 5931.893, 13376.786, 5547.907, 7092.030, 4832.720, 4293.430, 4495.188, 3689.604, 3725.074, 3859.706, 4584.491, 4365.400, 4188.355, 3522.698, 4092.212, 4181.854, 4068.701, 3725.514, 3377.998],
                'Credit RWA Change US': [12173.174, 4771.257, 10617.965, 4286.135, 5413.794, 3628.272, 3195.607, 3311.255, 2705.103, 2713.883, 2803.442, 3307.027, 3128.174, 2983.114, 2497.417, 2890.614, 2934.276, 2829.962, 2564.441, 2314.588],
                'Credit RWA Change International': [3759.374, 1417.344, 3116.731, 1228.596, 1544.654, 1037.552, 909.807, 944.581, 771.084, 775.761, 802.805, 944.047, 893.461, 851.881, 711.948, 824.815, 836.530, 806.780, 733.453, 658.043],
                'Market CCR CVA RWA Change': [2600.356, 0.000, 3318.889, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
                'Operational Risk RWA Change': [1683.906, 1676.140, 1836.867, 1305.966, 1401.018, 1705.786, 1721.113, 1742.312, 1822.209, 1439.890, 1474.129, 1296.354, 1542.081, 1637.640, 1716.214, 1811.825, 1858.945, 1858.550, 1858.172, 1857.412],
                'Other': [166.648, 0.908, 130.188, -222.289, -164.576, 15.078, 15.024, 18.673, 14.613, 14.533, 14.497, 14.408, 12.208, 12.139, 12.099, 11.998, 13.390, 13.319, 13.281, 4.970]
            }
        };

        // ========================================
        // CET1 CALCULATION FUNCTIONS
        // ========================================
        function cet1CalculatePath(scenario, overlayType, quarterlyOverlays, applyOverrides = true) {
            let capital = CET1_JUMP_OFF_CAPITAL;
            let rwa = CET1_JUMP_OFF_RWA;
            const path = [CET1_JUMP_OFF];
            const getValue = (comp, q) => {
                if (applyOverrides && cet1ComponentOverrides[comp]) return cet1ComponentOverrides[comp][q];
                return scenario[comp] ? scenario[comp][q] : 0;
            };
            for (let q = 0; q < 20; q++) {
                let capitalChange = 0;
                ['PPNR Canada', 'PPNR US', 'PPNR International', 'PCL Canada', 'PCL US', 'PCL International',
                    'Dividend', 'Trading PnL', 'AFS Losses', 'Operational Risk Losses',
                    'Currency Translation Adj', 'Shortfall in Allowance', 'Other'].forEach(comp => { capitalChange += getValue(comp, q); });
                let rwaChange = 0;
                ['Credit RWA Change Canada', 'Credit RWA Change US', 'Credit RWA Change International',
                    'Market CCR CVA RWA Change', 'Operational Risk RWA Change'].forEach(comp => { rwaChange += getValue(comp, q); });
                if (applyOverrides && overlayType !== 'none') {
                    const qOverlay = quarterlyOverlays[q] || 0;
                    if (overlayType === 'dollar') capitalChange += qOverlay;
                    else if (overlayType === 'rwa') rwaChange += qOverlay;
                    else if (overlayType === 'bps') capitalChange += (rwa * qOverlay / 10000);
                }
                capital += capitalChange;
                rwa += rwaChange;
                path.push((capital / rwa) * 100);
            }
            return path;
        }

        function cet1CalculateAttributedBps(data, troughIndex) {
            const impacts = {
                'PPNR': [], 'PCL': [], 'Dividend': [], 'Trading PnL': [], 'AFS Losses': [],
                'Operational Risk Losses': [], 'Currency Translation Adj': [], 'Shortfall in Allowance': [], 'Other': [],
                'Credit RWA Change': [], 'Market CCR CVA RWA Change': [], 'Operational Risk RWA Change': []
            };
            let currentCapital = CET1_JUMP_OFF_CAPITAL, currentRWA = CET1_JUMP_OFF_RWA;
            const maxQ = troughIndex || 20;
            for (let q = 0; q < maxQ; q++) {
                const prevCapital = currentCapital, prevRWA = currentRWA;
                const ppnr = (data['PPNR Canada'][q] || 0) + (data['PPNR US'][q] || 0) + (data['PPNR International'][q] || 0);
                const pcl = (data['PCL Canada'][q] || 0) + (data['PCL US'][q] || 0) + (data['PCL International'][q] || 0);
                let other = 0;
                ['Dividend', 'Trading PnL', 'AFS Losses', 'Operational Risk Losses', 'Currency Translation Adj', 'Shortfall in Allowance', 'Other'].forEach(k => { other += (data[k][q] || 0); });
                currentCapital = prevCapital + ppnr + pcl + other;
                const creditRwa = (data['Credit RWA Change Canada'][q] || 0) + (data['Credit RWA Change US'][q] || 0) + (data['Credit RWA Change International'][q] || 0);
                const marketRwa = data['Market CCR CVA RWA Change'][q] || 0;
                const opRwa = data['Operational Risk RWA Change'][q] || 0;
                const totalRwaChange = creditRwa + marketRwa + opRwa;
                currentRWA = prevRWA + totalRwaChange;
                impacts['PPNR'].push((ppnr / currentRWA) * 10000);
                impacts['PCL'].push((pcl / currentRWA) * 10000);
                ['Dividend', 'Trading PnL', 'AFS Losses', 'Operational Risk Losses', 'Currency Translation Adj', 'Shortfall in Allowance', 'Other'].forEach(k => {
                    impacts[k].push(((data[k][q] || 0) / currentRWA) * 10000);
                });
                const rwaBps = (prevCapital / currentRWA - prevCapital / prevRWA) * 10000;
                if (totalRwaChange !== 0) {
                    impacts['Credit RWA Change'].push(rwaBps * (creditRwa / totalRwaChange));
                    impacts['Market CCR CVA RWA Change'].push(rwaBps * (marketRwa / totalRwaChange));
                    impacts['Operational Risk RWA Change'].push(rwaBps * (opRwa / totalRwaChange));
                } else {
                    impacts['Credit RWA Change'].push(0); impacts['Market CCR CVA RWA Change'].push(0); impacts['Operational Risk RWA Change'].push(0);
                }
            }
            return impacts;
        }

        // ========================================
        // CET1 UTILITY FUNCTIONS
        // ========================================
        function cet1ToggleCollapse(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(contentId.replace('Content', 'Icon'));
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                if (icon) icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                if (icon) icon.classList.add('collapsed');
            }
        }

        function cet1GetComponentValue(componentName, quarterIndex, scenarioData) {
            if (cet1ComponentOverrides[componentName]) {
                return cet1ComponentOverrides[componentName][quarterIndex];
            }
            return scenarioData[componentName] ? scenarioData[componentName][quarterIndex] : 0;
        }

        function cet1SaveScenarioFromBuilder() {
            const scenarioName = document.getElementById('cet1CustomScenarioName').value || 'Custom Scenario';

            // Collect severities
            const componentSeverities = {};
            let hasAnySelection = false;
            const driversForCard = [];

            // Reconstruct the hybrid data for full calculation
            const hybridData = {};

            CET1_COMPONENTS.forEach(comp => {
                const selectId = `cet1Comp_${comp.replace(/\s+/g, '_')}`;
                const selectEl = document.getElementById(selectId);
                if (selectEl) {
                    const sev = selectEl.value;
                    componentSeverities[comp] = sev;
                    hasAnySelection = true;

                    // Add data for calculation
                    let key = sev.toLowerCase().replace(' ', '_');
                    if (!cet1ScenarioData[key]) key = 'moderate';
                    hybridData[comp] = cet1ScenarioData[key][comp];

                    // Add to card visual tags if significant (Severe/Very Severe)
                    if (sev === 'severe' || sev === 'very_severe') {
                        driversForCard.push({
                            title: `${comp}: ${sev.replace('_', ' ')}`,
                            tagColor: sev === 'very_severe' ? '#FECACA' : '#FDE68A',
                            textColor: sev === 'very_severe' ? '#DC2626' : '#B45309'
                        });
                    }
                }
            });

            if (!hasAnySelection) {
                alert('Please configure at least one component severity before saving.');
                return;
            }

            // Determine mathematical severity and full path
            const overallSeverity = cet1DetermineSeverityFromComponents(componentSeverities);
            const calculatedPath = cet1CalculatePath(hybridData, 'none', [], false);
            const minimumRatio = Math.min(...calculatedPath);

            const timestamp = Date.now();
            const dateStr = new Date().toLocaleDateString();

            // 1. Create full scenario object for download/restoration
            const scenarioToSave = {
                id: 'cet1_' + timestamp,
                title: scenarioName,
                description: 'Manually configured scenario from Scenario Builder',
                severity: overallSeverity,
                minimumRatio: minimumRatio,
                componentSeverities: componentSeverities,
                calculatedPath: calculatedPath,
                savedAt: new Date().toLocaleString(),
                timestamp: timestamp,
                importedFrom: 'Manual',
                type: 'calculation' // Updated type per request
            };

            // 2. Add to In-App "Folder" (savedScenarios global array)
            // Ensure we have the latest list from storage to avoid overwrites
            if (typeof loadSavedScenarios === 'function') loadSavedScenarios();
            if (typeof savedScenarios === 'undefined') savedScenarios = [];

            const folderItem = {
                id: 'cet1_' + timestamp,
                type: 'calculation', // Use 'calculation' type for icon rendering
                title: scenarioName,
                date: dateStr,
                driverCount: driversForCard.length,
                drivers: driversForCard.length > 0 ? driversForCard : [{ title: 'All Moderate', tagColor: '#E0E7FF', textColor: '#3730A3' }],
                data: scenarioToSave
            };

            savedScenarios.push(folderItem);

            // Save to correct localStorage key (SAVED_SCENARIOS_KEY is 'astra_saved_scenarios')
            localStorage.setItem(SAVED_SCENARIOS_KEY, JSON.stringify(savedScenarios));

            // 3. Update UI if needed
            if (typeof renderSavedScenarios === 'function') {
                renderSavedScenarios();
            }

            alert(`âœ… Calculation saved to Folder!`);
        }

        function cet1LoadSavedScenario(data) {
            if (!data) return;

            // 1. Switch to Analysis View First (Ensure container is visible for Plotly)
            showCET1Analysis();

            // 2. Restore Name
            const nameInput = document.getElementById('cet1CustomScenarioName');
            if (nameInput) nameInput.value = data.title || 'Loaded Scenario';
            cet1CustomScenarioName = data.title || 'Loaded Scenario';

            // 3. Restore Component Severities
            if (data.componentSeverities) {
                for (const [comp, sev] of Object.entries(data.componentSeverities)) {
                    const selectId = `cet1Comp_${comp.replace(/\s+/g, '_')}`;
                    const el = document.getElementById(selectId);
                    if (el) el.value = sev;
                }
            }

            // 4. Trigger Full Recalculation & UI Update
            // Pass true to autoCalculate to ensure it actually runs the math and updates charts
            cet1UpdateCustomScenario(true);

            // 5. Force Switch to Custom Scenario View
            cet1SelectScenarioForDetails('custom');

            // 6. Notify
            console.log(`Loaded CET1 Scenario: ${data.title}`, data);
        }

        async function cet1ExportPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('PDF library not loaded.');
                return;
            }

            const btn = document.querySelector('button[onclick="cet1ExportPDF()"]');
            const originalText = btn ? btn.innerHTML : 'Export Report';
            if (btn) {
                btn.innerHTML = 'Generating PDF...';
                btn.disabled = true;
            }

            try {
                // Ensure custom scenario is selected for report
                if (cet1SelectedDetailScenario !== 'custom') {
                    cet1SelectScenarioForDetails('custom');
                    await new Promise(r => setTimeout(r, 500));
                }

                const pdf = new jsPDF('p', 'mm', 'a4', true);
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                let yOffset = 15;
                const margin = 10;
                const contentWidth = pageWidth - (margin * 2);

                // Title
                pdf.setFontSize(18);
                pdf.text(`Scenario Report: ${cet1CustomScenarioName}`, margin, yOffset);
                yOffset += 10;
                pdf.setFontSize(10);
                pdf.setTextColor(100);
                pdf.text(`Generated on: ${new Date().toLocaleString()}`, margin, yOffset);
                yOffset += 15;
                pdf.setTextColor(0);

                // Helper
                const addContentToPDF = async (elementId, title, isChart = false) => {
                    const el = document.getElementById(elementId);
                    if (!el) return;
                    if (yOffset > pageHeight - 80) { pdf.addPage(); yOffset = 15; }

                    if (title) {
                        pdf.setFontSize(14);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(title, margin, yOffset);
                        yOffset += 8;
                        pdf.setFont(undefined, 'normal');
                    }

                    if (isChart) {
                        const chartDiv = el.querySelector('.js-plotly-plot'); // Plotly attaches here
                        if (chartDiv) {
                            try {
                                const imgData = await Plotly.toImage(chartDiv, { format: 'png', width: 1200, height: 600 });
                                const imgHeight = (600 * contentWidth) / 1200;
                                if (yOffset + imgHeight > pageHeight - margin) { pdf.addPage(); yOffset = 15; }
                                pdf.addImage(imgData, 'PNG', margin, yOffset, contentWidth, imgHeight);
                                yOffset += imgHeight + 10;
                                return;
                            } catch (e) { console.warn('Plotly export failed', e); }
                        }
                    }

                    // Fallback to html2canvas
                    const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#ffffff', logging: false });
                    const imgData = canvas.toDataURL('image/png');
                    const imgHeight = (canvas.height * contentWidth) / canvas.width;
                    if (yOffset + imgHeight > pageHeight - margin) { pdf.addPage(); yOffset = 15; }
                    pdf.addImage(imgData, 'PNG', margin, yOffset, contentWidth, imgHeight);
                    yOffset += imgHeight + 10;
                };

                // Add Cards
                await addContentToPDF('cet1TroughCard', 'Projected CET1 Ratios (Trough)');
                await addContentToPDF('cet1CapitalProjectionCard', 'Capital Projection', true);

                // Detailed Pages
                if (yOffset > pageHeight - 50) { pdf.addPage(); yOffset = 15; } else { yOffset += 5; }
                pdf.setFontSize(16);
                pdf.text('Detailed Impact Analysis', margin, yOffset);
                yOffset += 10;

                const views = [
                    { id: 'cet1Waterfall', title: 'Waterfall Chart' },
                    { id: 'cet1Decomposition', title: 'Decomposition Chart' },
                    { id: 'cet1DollarImpact', title: '$ Impact Table' },
                    { id: 'cet1BpsImpact', title: 'BPS Impact Table' }
                ];

                for (const view of views) {
                    const el = document.getElementById(view.id);
                    const wasActive = el.classList.contains('active');
                    el.classList.add('active'); // Force visible
                    void el.offsetHeight;
                    await new Promise(r => setTimeout(r, 100));

                    // Re-render chart if needed (plot needs dimensions)
                    if (view.id === 'cet1Waterfall') { cet1UpdateWaterfallChart(cet1SelectedDetailScenario); }
                    if (view.id === 'cet1Decomposition') { cet1UpdateDecompositionChart(cet1SelectedDetailScenario); }

                    if (view.id.includes('Table') || view.id.includes('Impact')) {
                        // Use AutoTable for tables
                        const table = el.querySelector('table');
                        if (table) {
                            if (yOffset > pageHeight - 80) { pdf.addPage(); yOffset = 15; }
                            pdf.setFontSize(14); pdf.setFont(undefined, 'bold');
                            pdf.text(view.title, margin, yOffset); yOffset += 8;

                            pdf.autoTable({
                                html: table,
                                startY: yOffset,
                                margin: { left: margin, right: margin },
                                styles: { fontSize: 8, cellPadding: 2 },
                                didParseCell: function (data) {
                                    if (data.column.index > 0) {
                                        const text = data.cell.text[0];
                                        if (text && text.includes('+')) data.cell.styles.textColor = [16, 185, 129];
                                        else if (text && text.includes('-')) data.cell.styles.textColor = [239, 68, 68];
                                    }
                                }
                            });
                            yOffset = pdf.lastAutoTable.finalY + 10;
                            if (!wasActive) el.classList.remove('active');
                            continue;
                        }
                    } else {
                        // Chart
                        await addContentToPDF(view.id, view.title, true);
                    }

                    if (!wasActive) el.classList.remove('active');
                }

                pdf.save(`${cet1CustomScenarioName.replace(/[^a-zA-Z0-9]/g, '_')}_Report.pdf`);

            } catch (err) {
                console.error('Export error:', err);
                alert('Failed to generate PDF. Check console.');
            } finally {
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        // ========================================
        // CET1 INITIALIZATION
        // ========================================
        function cet1Initialize() {
            cet1InitComponentBuilder();
            cet1InitComponentOverrideList();
            cet1CalculateScenario();
        }

        function cet1InitComponentBuilder() {
            const builder = document.getElementById('cet1ComponentBuilder');
            if (!builder) return;
            builder.innerHTML = CET1_COMPONENTS.map(comp => {
                const selectId = `cet1Comp_${comp.replace(/\s+/g, '_')}`;
                return `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">${comp.toUpperCase()}</label>
                    <select id="${selectId}" style="display: block; width: 100%; background: #F8FAFC; padding: 12px 14px; font-size: 14px; border-radius: 12px; border: 1px solid var(--border-subtle); appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;%2364748B&quot; stroke-width=&quot;2&quot;><polyline points=&quot;6,9 12,15 18,9&quot;/></svg>'); background-repeat: no-repeat; background-position: right 14px center; cursor: pointer; box-sizing: border-box;" onchange="cet1UpdateCustomScenario(true)">
                        <option value="very_severe">Very Severe</option>
                        <option value="severe" selected>Severe</option>
                        <option value="moderate">Moderate</option>
                        <option value="benchmark">Benchmark</option>
                    </select>
                </div>`;
            }).join('');
        }

        function cet1InitComponentOverrideList() {
            const container = document.getElementById('cet1ComponentOverrideList');
            if (!container) return;
            container.innerHTML = CET1_COMPONENTS.map(comp => {
                const hasOverride = cet1ComponentOverrides[comp] !== undefined;
                const statusClass = hasOverride ? 'has-override' : '';
                const statusText = hasOverride ? 'Modified' : 'Default';
                return `
                <div class="cet1-component-item ${statusClass}" onclick="cet1OpenComponentOverride('${comp}')">
                    <span class="comp-name">${comp}</span>
                    <span class="comp-status" style="${hasOverride ? 'color: #2563EB; font-weight: 600;' : ''}">${statusText}</span>
                </div>`;
            }).join('');
        }

        // ========================================
        // CET1 VIEW SWITCHING
        // ========================================
        function cet1SwitchView(viewName) {
            document.querySelectorAll('.cet1-view-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.cet1-view-tab').forEach(t => t.classList.remove('active'));

            const prefix = viewName.charAt(0).toUpperCase() + viewName.slice(1);
            document.getElementById('cet1' + prefix)?.classList.add('active');
            event?.target?.classList.add('active');

            // Re-render charts after view becomes visible to ensure proper sizing
            setTimeout(() => {
                if (viewName === 'waterfall') {
                    cet1UpdateWaterfallChart(cet1SelectedDetailScenario);
                }
                if (viewName === 'decomposition') {
                    cet1UpdateDecompositionChart(cet1SelectedDetailScenario);
                }
            }, 50);
        }

        function cet1SelectScenarioForDetails(scenario) {
            cet1SelectedDetailScenario = scenario;
            ['cet1VsevereCard', 'cet1SevereCard', 'cet1ModerateCard', 'cet1BenchmarkCard', 'cet1CustomCard'].forEach(id => {
                document.getElementById(id)?.classList.remove('selected');
            });
            const cardMap = {
                'very_severe': 'cet1VsevereCard', 'severe': 'cet1SevereCard',
                'moderate': 'cet1ModerateCard', 'benchmark': 'cet1BenchmarkCard', 'custom': 'cet1CustomCard'
            };
            document.getElementById(cardMap[scenario])?.classList.add('selected');

            // Update detailed analysis charts for the selected scenario
            cet1UpdateWaterfallChart(scenario);
            cet1UpdateDecompositionChart(scenario);
            cet1UpdateTables(scenario);
        }

        // ========================================
        // CET1 CALCULATIONS & CHART RENDERING
        // ========================================
        function cet1CalculateScenario() {
            const overlayType = document.getElementById('cet1OverlayType')?.value || 'none';
            const scenarioToOverride = document.getElementById('cet1ScenarioToOverride')?.value || 'severe';

            // Calculate paths for all scenarios
            const allPaths = {};
            allPaths['Very Severe'] = cet1CalculatePath(cet1ScenarioData.very_severe, overlayType, cet1QuarterlyOverlayValues, scenarioToOverride === 'very_severe');
            allPaths['Severe'] = cet1CalculatePath(cet1ScenarioData.severe, overlayType, cet1QuarterlyOverlayValues, scenarioToOverride === 'severe');
            allPaths['Moderate'] = cet1CalculatePath(cet1ScenarioData.moderate, overlayType, cet1QuarterlyOverlayValues, scenarioToOverride === 'moderate');
            allPaths['Benchmark'] = cet1CalculatePath(cet1ScenarioData.benchmark, overlayType, cet1QuarterlyOverlayValues, scenarioToOverride === 'benchmark');

            if (Object.keys(cet1CustomScenarioComponents).length > 0) {
                const customData = {};
                CET1_COMPONENTS.forEach(comp => { customData[comp] = cet1CustomScenarioComponents[comp] || cet1ScenarioData.severe[comp]; });
                allPaths[cet1CustomScenarioName] = cet1CalculatePath(customData, overlayType, cet1QuarterlyOverlayValues, scenarioToOverride === 'custom');
            }

            // Update temperature bar and trough values
            cet1UpdateTemperatureBar(allPaths);

            // Render main projection chart
            cet1PlotProjectionChart(allPaths);

            // Render detailed analysis views
            cet1UpdateWaterfallChart(cet1SelectedDetailScenario);
            cet1UpdateDecompositionChart(cet1SelectedDetailScenario);
            cet1UpdateTables(cet1SelectedDetailScenario);
        }

        function cet1UpdateTemperatureBar(paths) {
            const tempBar = document.getElementById('cet1TempBar');
            if (!tempBar) return;
            tempBar.innerHTML = '';

            const troughs = {};
            Object.keys(paths).forEach(s => { troughs[s] = Math.min(...paths[s]); });

            // Update metric cards
            const jumpOffEl = document.getElementById('cet1JumpOffValue');
            if (jumpOffEl) jumpOffEl.textContent = CET1_JUMP_OFF.toFixed(1) + '%';

            if (troughs['Very Severe']) document.getElementById('cet1VsevereTrough').textContent = troughs['Very Severe'].toFixed(1) + '%';
            if (troughs['Severe']) document.getElementById('cet1SevereTrough').textContent = troughs['Severe'].toFixed(1) + '%';
            if (troughs['Moderate']) document.getElementById('cet1ModerateTrough').textContent = troughs['Moderate'].toFixed(1) + '%';
            if (troughs['Benchmark']) document.getElementById('cet1BenchmarkTrough').textContent = troughs['Benchmark'].toFixed(1) + '%';
            if (troughs[cet1CustomScenarioName]) document.getElementById('cet1CustomTrough').textContent = troughs[cet1CustomScenarioName].toFixed(1) + '%';

            const colors = { 'Very Severe': '#EF4444', 'Severe': '#F59E0B', 'Moderate': '#10B981', 'Benchmark': '#64748B', 'Jump-Off Q4/25': '#1E293B' };
            colors[cet1CustomScenarioName] = '#2563EB';

            const troughList = Object.keys(troughs).map(s => ({ name: s, trough: troughs[s], position: Math.max(0, Math.min(100, (troughs[s] / 15) * 100)) }));

            // Add Jump-Off to the list
            troughList.push({ name: 'Jump-Off Q4/25', trough: CET1_JUMP_OFF, position: Math.max(0, Math.min(100, (CET1_JUMP_OFF / 15) * 100)) });

            troughList.sort((a, b) => a.position - b.position);
            const levelLastPos = [-100, -100, -100];

            troughList.forEach(m => {
                let level = 0;
                for (let i = 0; i < 3; i++) { if (m.position - levelLastPos[i] > 16) { level = i; break; } }
                levelLastPos[level] = m.position;
                const marker = document.createElement('div');
                marker.className = 'cet1-temp-bar-marker';
                marker.style.left = m.position + '%';
                marker.style.backgroundColor = colors[m.name] || '#8B5CF6';
                marker.setAttribute('data-label', `${m.name === 'Very Severe' ? 'V. Severe' : m.name}: ${m.trough.toFixed(1)}%`);
                marker.dataset.stagger = level;
                tempBar.appendChild(marker);
            });
        }

        function cet1PlotProjectionChart(paths) {
            const quarters = Array.from({ length: 21 }, (_, i) => `Q${i}`);
            const colors = { 'Very Severe': '#EF4444', 'Severe': '#F59E0B', 'Moderate': '#10B981', 'Benchmark': '#64748B' };
            colors[cet1CustomScenarioName] = '#2563EB';

            const traces = Object.keys(paths).map(s => ({
                x: quarters, y: paths[s], name: s, type: 'scatter', mode: 'lines',
                line: { width: 3, shape: 'spline', smoothing: 0.5, color: colors[s] || '#9CA3AF' },
                hovertemplate: '<b>%{y:.2f}%</b><extra></extra>'
            }));

            // Add threshold lines
            traces.push({ x: [quarters[0], quarters[20]], y: [4.5, 4.5], mode: 'lines', name: 'Min Req', line: { dash: 'dash', color: '#EF4444', width: 1.5 }, showlegend: false });
            traces.push({ x: [quarters[0], quarters[20]], y: [8.1, 8.1], mode: 'lines', name: 'DSB', line: { dash: 'dash', color: '#F59E0B', width: 1.5 }, showlegend: false });
            traces.push({ x: [quarters[0], quarters[20]], y: [11.6, 11.6], mode: 'lines', name: 'Internal', line: { dash: 'dash', color: '#3B82F6', width: 1.5 }, showlegend: false });

            const allVals = Object.values(paths).flat().concat([4.5, 11.6, CET1_JUMP_OFF]);
            const layout = {
                font: { family: 'Inter, sans-serif' }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { tickfont: { size: 11, color: '#64748B' }, gridcolor: 'transparent', showgrid: false, fixedrange: true },
                yaxis: { title: 'CET1 Ratio (%)', tickfont: { size: 11, color: '#64748B' }, gridcolor: '#F1F5F9', zeroline: false, fixedrange: true, range: [Math.min(...allVals) - 1.5, Math.max(...allVals) + 1.5] },
                hovermode: 'x unified', showlegend: true,
                legend: { orientation: 'h', y: 1.1, x: 1, xanchor: 'right', yanchor: 'bottom', bgcolor: 'rgba(255,255,255,0.8)' },
                margin: { t: 40, b: 40, l: 60, r: 20 },
                annotations: [
                    { x: quarters[20], y: 4.5, text: 'Min (4.5%)', showarrow: false, xanchor: 'left', font: { size: 10, color: '#EF4444' } },
                    { x: quarters[20], y: 8.1, text: 'DSB (8.1%)', showarrow: false, xanchor: 'left', font: { size: 10, color: '#F59E0B' } },
                    { x: quarters[20], y: 11.6, text: 'Target (11.6%)', showarrow: false, xanchor: 'left', font: { size: 10, color: '#3B82F6' } }
                ]
            };
            Plotly.newPlot('cet1Chart', traces, layout, { displayModeBar: false, responsive: true });
        }

        function cet1UpdateWaterfallChart(scenario) {
            const data = scenario === 'custom' ? cet1CustomScenarioComponents : cet1ScenarioData[scenario];
            if (!data || (scenario === 'custom' && Object.keys(cet1CustomScenarioComponents).length === 0)) { Plotly.purge('cet1WaterfallChart'); return; }

            const path = cet1CalculatePath(data, 'none', [], false);
            const troughIdx = path.indexOf(Math.min(...path));
            const troughCET1 = path[troughIdx];
            const impacts = cet1CalculateAttributedBps(data, troughIdx);
            const totalImpacts = {};
            Object.keys(impacts).forEach(k => { totalImpacts[k] = impacts[k].reduce((a, b) => a + b, 0); });

            const comps = ['PPNR', 'PCL', 'Dividend', 'Trading PnL', 'AFS Losses', 'Operational Risk Losses', 'Currency Translation Adj', 'Shortfall in Allowance', 'Other', 'Credit RWA Change', 'Market CCR CVA RWA Change', 'Operational Risk RWA Change'];
            const labels = ['Jump-Off Q4/25', ...comps, 'Trough'];
            const startBps = CET1_JUMP_OFF * 100;
            const wValues = [startBps];
            const measures = ['absolute'];
            comps.forEach(c => { wValues.push(totalImpacts[c]); measures.push('relative'); });
            wValues.push(troughCET1 * 100);
            measures.push('total');

            const trace = {
                type: 'waterfall', orientation: 'v', measure: measures, x: labels, y: wValues,
                text: wValues.map((v, i) => (i === 0 || i === wValues.length - 1) ? (v / 100).toFixed(1) + '%' : (v > 0 ? '+' : '') + v.toFixed(0)),
                textposition: 'outside', cliponaxis: false, textfont: { size: 11 },
                decreasing: { marker: { color: '#EF4444' } }, increasing: { marker: { color: '#10B981' } }, totals: { marker: { color: '#2563EB' } },
                connector: { line: { color: '#CBD5E1', width: 1, dash: 'dot' } }
            };
            const layout = {
                font: { family: 'Inter, sans-serif' }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { tickangle: -45, tickfont: { size: 10, color: '#64748B' }, fixedrange: true },
                yaxis: { title: 'Impact (bps)', gridcolor: '#F1F5F9', zerolinecolor: '#CBD5E1', fixedrange: true },
                margin: { t: 40, b: 140, l: 60, r: 20 }, showlegend: false, autosize: true
            };
            Plotly.newPlot('cet1WaterfallChart', [trace], layout, { displayModeBar: false, responsive: true });
        }

        function cet1UpdateDecompositionChart(scenario) {
            const data = scenario === 'custom' ? cet1CustomScenarioComponents : cet1ScenarioData[scenario];
            if (!data || (scenario === 'custom' && Object.keys(cet1CustomScenarioComponents).length === 0)) { Plotly.purge('cet1DecompositionChart'); return; }

            const quarterImpacts = cet1CalculateAttributedBps(data, 20);
            const quarters = Array.from({ length: 20 }, (_, i) => `Q${i + 1}`);
            const chartData = {};
            const comps = Object.keys(quarterImpacts);

            if (cet1DecompositionMode === 'cumulative') {
                comps.forEach(c => { chartData[c] = []; let sum = 0; quarterImpacts[c].forEach(v => { sum += v; chartData[c].push(sum); }); });
            } else {
                comps.forEach(c => { chartData[c] = quarterImpacts[c]; });
            }

            const palette = { 'PPNR': '#10B981', 'PCL': '#EF4444', 'Dividend': '#F59E0B', 'Trading PnL': '#8B5CF6', 'Credit RWA Change': '#3B82F6', 'AFS Losses': '#EC4899', 'Operational Risk Losses': '#6366F1', 'Currency Translation Adj': '#14B8A6', 'Shortfall in Allowance': '#F97316', 'Market CCR CVA RWA Change': '#A855F7', 'Operational Risk RWA Change': '#22C55E', 'Other': '#6B7280' };
            const traces = [];
            ['PPNR', 'PCL', 'Credit RWA Change', 'Dividend', 'Trading PnL', 'AFS Losses', 'Operational Risk Losses', 'Currency Translation Adj', 'Shortfall in Allowance', 'Other', 'Market CCR CVA RWA Change', 'Operational Risk RWA Change'].forEach(c => {
                traces.push({ x: quarters, y: chartData[c], name: c, type: 'bar', marker: { color: palette[c] || '#6B7280' } });
            });

            const layout = {
                barmode: 'relative', font: { family: 'Inter, sans-serif' }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { tickfont: { size: 11, color: '#64748B' }, gridcolor: 'transparent' },
                yaxis: { title: cet1DecompositionMode === 'cumulative' ? 'Cumulative Impact (bps)' : 'Quarterly Impact (bps)', gridcolor: '#F1F5F9', zerolinecolor: '#475569' },
                margin: { t: 30, b: 100, l: 60, r: 20 }, legend: { orientation: 'h', y: -0.25, x: 0.5, xanchor: 'center' }, autosize: true
            };
            Plotly.newPlot('cet1DecompositionChart', traces, layout, { displayModeBar: false, responsive: true });
        }

        function cet1UpdateTables(scenario) {
            let data = scenario === 'custom' ? cet1CustomScenarioComponents : cet1ScenarioData[scenario];
            if (!data || (scenario === 'custom' && Object.keys(cet1CustomScenarioComponents).length === 0)) {
                document.getElementById('cet1DollarTable').innerHTML = '<p style="text-align:center; color: var(--text-muted);">No data available</p>';
                document.getElementById('cet1BpsTable').innerHTML = '<p style="text-align:center; color: var(--text-muted);">No data available</p>';
                return;
            }

            const overlayType = document.getElementById('cet1OverlayType')?.value || 'none';
            const overrideScenario = document.getElementById('cet1ScenarioToOverride')?.value || 'severe';
            let applyOverrides = (scenario === overrideScenario);
            if (scenario === 'custom' && overrideScenario === 'custom') applyOverrides = true;

            // Merge component overrides into data for table display
            if (applyOverrides && Object.keys(cet1ComponentOverrides).length > 0) {
                const merged = { ...data };
                Object.keys(cet1ComponentOverrides).forEach(comp => {
                    if (cet1ComponentOverrides[comp]) {
                        merged[comp] = cet1ComponentOverrides[comp];
                    }
                });
                data = merged;
            }

            // Calculate path with overlays (pass true for applyOverrides)
            const path = cet1CalculatePath(data, overlayType, cet1QuarterlyOverlayValues, applyOverrides);
            const troughIdx = path.indexOf(Math.min(...path));
            const impacts = cet1CalculateAttributedBps(data, troughIdx);
            const comps = ['PPNR', 'PCL', 'Dividend', 'Trading PnL', 'AFS Losses', 'Operational Risk Losses', 'Currency Translation Adj', 'Shortfall in Allowance', 'Other', 'Credit RWA Change', 'Market CCR CVA RWA Change', 'Operational Risk RWA Change'];

            // Dollar Table
            let dollarHTML = '<table class="cet1-table"><thead><tr><th>COMPONENT</th>';
            for (let q = 0; q < troughIdx; q++) dollarHTML += `<th>Q${q + 1}</th>`;
            dollarHTML += '<th>TOTAL</th></tr></thead><tbody>';
            comps.forEach(key => {
                let rowData = [];
                if (key === 'PPNR') { for (let q = 0; q < troughIdx; q++) rowData.push((data['PPNR Canada'][q] || 0) + (data['PPNR US'][q] || 0) + (data['PPNR International'][q] || 0)); }
                else if (key === 'PCL') { for (let q = 0; q < troughIdx; q++) rowData.push((data['PCL Canada'][q] || 0) + (data['PCL US'][q] || 0) + (data['PCL International'][q] || 0)); }
                else if (key === 'Credit RWA Change') { for (let q = 0; q < troughIdx; q++) rowData.push((data['Credit RWA Change Canada'][q] || 0) + (data['Credit RWA Change US'][q] || 0) + (data['Credit RWA Change International'][q] || 0)); }
                else { for (let q = 0; q < troughIdx; q++) rowData.push(data[key]?.[q] || 0); }
                dollarHTML += `<tr><td>${key}</td>`;
                let rowSum = 0;
                rowData.forEach(v => { dollarHTML += `<td class="${v >= 0 ? 'positive' : 'negative'}">${v >= 0 ? '+' : ''}${v.toFixed(0)}</td>`; rowSum += v; });
                dollarHTML += `<td class="${rowSum >= 0 ? 'positive' : 'negative'}"><strong>${rowSum >= 0 ? '+' : ''}${rowSum.toFixed(0)}</strong></td></tr>`;
            });
            dollarHTML += '</tbody></table>';
            document.getElementById('cet1DollarTable').innerHTML = dollarHTML;

            // BPS Table
            let bpsHTML = '<table class="cet1-table"><thead><tr><th>COMPONENT</th>';
            for (let q = 0; q < troughIdx; q++) bpsHTML += `<th>Q${q + 1}</th>`;
            bpsHTML += '<th>TOTAL</th></tr></thead><tbody>';
            comps.forEach(key => {
                const rowData = impacts[key] || [];
                bpsHTML += `<tr><td>${key}</td>`;
                let rowSum = 0;
                for (let i = 0; i < troughIdx; i++) { const v = rowData[i] || 0; bpsHTML += `<td class="${v >= 0 ? 'positive' : 'negative'}">${v >= 0 ? '+' : ''}${v.toFixed(0)}</td>`; rowSum += v; }
                bpsHTML += `<td class="${rowSum >= 0 ? 'positive' : 'negative'}"><strong>${rowSum >= 0 ? '+' : ''}${rowSum.toFixed(0)}</strong></td></tr>`;
            });
            bpsHTML += '</tbody></table>';
            document.getElementById('cet1BpsTable').innerHTML = bpsHTML;
        }

        function cet1UpdateCustomScenario(autoCalculate = false) {
            // Populate custom scenario from dropdown selections
            cet1CustomScenarioComponents = {};

            CET1_COMPONENTS.forEach(comp => {
                const selectId = `cet1Comp_${comp.replace(/\s+/g, '_')}`;
                const selectEl = document.getElementById(selectId);
                if (selectEl) {
                    const selectedScenario = selectEl.value;
                    cet1CustomScenarioComponents[comp] = cet1ScenarioData[selectedScenario][comp];
                }
            });

            // If autoCalculate, enable custom scenario and recalculate
            if (autoCalculate && Object.keys(cet1CustomScenarioComponents).length > 0) {
                // Ensure custom is selected in the scenario display (if applicable)
                const scenarioDisplay = document.getElementById('cet1ScenarioDisplay');
                if (scenarioDisplay) {
                    const customOption = Array.from(scenarioDisplay.options).find(opt => opt.value === 'custom');
                    if (customOption && !customOption.selected) {
                        customOption.selected = true;
                    }
                }

                // Switch to custom scenario view
                cet1SelectScenarioForDetails('custom');

                // Update the custom trough display
                const customPath = cet1CalculatePath(cet1CustomScenarioComponents, 'none', [], false);
                const customTrough = Math.min(...customPath);
                document.getElementById('cet1CustomTrough').textContent = customTrough.toFixed(1) + '%';

                // Recalculate and redraw all charts
                cet1CalculateScenario();
            }
        }

        function cet1UpdateCustomScenarioName() {
            cet1CustomScenarioName = document.getElementById('cet1CustomScenarioName')?.value || 'Custom';
            document.getElementById('cet1CustomScenarioLabel').textContent = cet1CustomScenarioName;
            // Recalculate to update chart legends
            if (Object.keys(cet1CustomScenarioComponents).length > 0) {
                cet1CalculateScenario();
            }
        }
        function cet1ToggleDecompositionMode() {
            cet1DecompositionMode = cet1DecompositionMode === 'cumulative' ? 'quarterly' : 'cumulative';
            const btn = document.getElementById('cet1DecompToggleBtn');
            if (btn) btn.textContent = cet1DecompositionMode === 'cumulative' ? 'Show Quarterly' : 'Show Cumulative';
            cet1UpdateDecompositionChart(cet1SelectedDetailScenario);
        }

        // ========================================
        // CET1 MODAL HANDLERS
        // ========================================
        function openCET1AIModal() {
            document.getElementById('cet1InputScenarioModal').style.display = 'flex';

            // Initialize Scenario Configuration if missing
            if (!cet1CustomScenarioResult) {
                cet1InitializeDefaultSeverities();
            }

            // Initialize Chat if missing
            if (cet1ConversationHistory.length === 0) {
                cet1ResetConversation();
            }
        }
        function closeCET1AIModal() { document.getElementById('cet1InputScenarioModal').style.display = 'none'; }

        // Direct Overlay Modal Functions
        function cet1OpenDirectOverlayModal() {
            const currentType = document.getElementById('cet1OverlayType').value;
            document.getElementById('cet1ModalOverlayType').value = currentType;
            cet1TempDirectOverlayValues = [...cet1QuarterlyOverlayValues];
            cet1HandleModalOverlayTypeChange();
            document.getElementById('cet1DirectOverlayModal').classList.add('open');
            setTimeout(() => {
                const type = document.getElementById('cet1ModalOverlayType').value;
                if (type !== 'none') { cet1RenderDirectOverlayChart(); }
            }, 100);
        }

        function cet1CloseDirectOverlayModal() {
            document.getElementById('cet1DirectOverlayModal').classList.remove('open');
        }

        function cet1HandleModalOverlayTypeChange() {
            const type = document.getElementById('cet1ModalOverlayType').value;
            const tableContainer = document.getElementById('cet1ModalOverlayTableContainer');
            const chartContainer = document.getElementById('cet1ModalOverlayChart');
            const description = document.getElementById('cet1ModalOverlayDescription');
            if (type === 'none') {
                tableContainer.style.display = 'none';
                chartContainer.style.display = 'none';
                description.textContent = 'Select an overlay type';
            } else {
                tableContainer.style.display = 'block';
                chartContainer.style.display = 'block';
                cet1InitModalOverlayTable();
                if (document.getElementById('cet1DirectOverlayModal').classList.contains('open')) {
                    cet1RenderDirectOverlayChart();
                }
                if (type === 'dollar') description.textContent = 'Capital adjustment in $M (positive = increase capital)';
                if (type === 'rwa') description.textContent = 'RWA adjustment in $M (positive = increase RWA)';
                if (type === 'bps') description.textContent = 'Basis points adjustment (100 bps = 1% CET1 ratio)';
            }
        }

        function cet1InitModalOverlayTable() {
            const headersRow = document.getElementById('cet1ModalOverlayHeaders');
            const inputsRow = document.getElementById('cet1ModalOverlayInputs');
            headersRow.innerHTML = Array.from({ length: 20 }, (_, i) => `<th>Q${i + 1}</th>`).join('');
            inputsRow.innerHTML = cet1TempDirectOverlayValues.map((val, i) => `
                <td><input type="number" id="cet1_direct_input_${i}" value="${val}" 
                    onchange="cet1UpdateDirectOverlayValue(${i}, this.value)" onfocus="this.select()"></td>
            `).join('');
        }

        function cet1UpdateDirectOverlayValue(i, val) {
            cet1TempDirectOverlayValues[i] = parseFloat(val) || 0;
            cet1RenderDirectOverlayChart();
        }

        function cet1RenderDirectOverlayChart() {
            const quarters = Array.from({ length: 20 }, (_, i) => `Q${i + 1}`);
            const type = document.getElementById('cet1ModalOverlayType').value;
            let yTitle = type === 'dollar' || type === 'rwa' ? '$ Million' : (type === 'bps' ? 'BPS' : 'Value');
            const traces = [
                { x: quarters, y: Array(20).fill(0), name: 'Baseline (0)', type: 'scatter', mode: 'lines', line: { color: '#94A3B8', width: 2, dash: 'dot' }, hoverinfo: 'none' },
                { x: quarters, y: cet1TempDirectOverlayValues, name: 'Overlay Value', type: 'scatter', mode: 'lines+markers', line: { color: '#2563EB', width: 2 }, marker: { size: 8 } }
            ];
            const layout = {
                font: { family: 'Inter, sans-serif', size: 10 }, paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                margin: { t: 20, b: 30, l: 50, r: 20 },
                xaxis: { tickfont: { size: 9 }, gridcolor: '#E2E8F0', fixedrange: true },
                yaxis: { tickfont: { size: 9 }, gridcolor: '#E2E8F0', title: yTitle, zeroline: true, zerolinecolor: '#94A3B8' },
                showlegend: true, legend: { orientation: 'h', y: 1.1, x: 0.5, xanchor: 'center' }, dragmode: false, hovermode: 'closest'
            };
            Plotly.newPlot('cet1ModalOverlayChart', traces, layout, { displayModeBar: false, responsive: true, scrollZoom: false });
            cet1SetupDirectOverlayDrag();
        }

        function cet1SetupDirectOverlayDrag() {
            const chartEl = document.getElementById('cet1ModalOverlayChart');
            if (!chartEl) return;
            chartEl.on('plotly_click', function (data) {
                if (data.points[0].curveNumber === 1) {
                    cet1DirectOverlayDragState.isDragging = true;
                    cet1DirectOverlayDragState.pointIndex = data.points[0].pointIndex;
                    chartEl.style.cursor = 'ns-resize';
                    const colors = cet1TempDirectOverlayValues.map((_, i) => i === cet1DirectOverlayDragState.pointIndex ? '#F59E0B' : '#2563EB');
                    Plotly.restyle('cet1ModalOverlayChart', { 'marker.color': [colors] }, [1]);
                }
            });
            if (cet1DirectOverlayListenersAttached) return;
            document.addEventListener('mousemove', function (e) {
                if (!cet1DirectOverlayDragState.isDragging || cet1DirectOverlayDragState.pointIndex < 0) return;
                const gd = document.getElementById('cet1ModalOverlayChart');
                if (!gd || !gd._fullLayout) return;
                if (!document.getElementById('cet1DirectOverlayModal').classList.contains('open')) return;
                const yaxis = gd._fullLayout.yaxis;
                const rect = gd.getBoundingClientRect();
                const margin = gd._fullLayout.margin;
                const plotTop = rect.top + margin.t;
                const plotHeight = rect.height - margin.t - margin.b;
                const relY = e.clientY - plotTop;
                const yRange = yaxis.range;
                const yValue = yRange[1] - (relY / plotHeight) * (yRange[1] - yRange[0]);
                const newValue = Math.round(yValue);
                cet1TempDirectOverlayValues[cet1DirectOverlayDragState.pointIndex] = newValue;
                Plotly.restyle('cet1ModalOverlayChart', { y: [cet1TempDirectOverlayValues] }, [1]);
                const input = document.getElementById(`cet1_direct_input_${cet1DirectOverlayDragState.pointIndex}`);
                if (input) input.value = newValue;
            });
            const endDrag = () => {
                if (cet1DirectOverlayDragState.isDragging) {
                    cet1DirectOverlayDragState.isDragging = false;
                    Plotly.restyle('cet1ModalOverlayChart', { 'marker.color': [null] }, [1]);
                    cet1DirectOverlayDragState.pointIndex = -1;
                    chartEl.style.cursor = '';
                }
            };
            document.addEventListener('mouseup', endDrag);
            chartEl.addEventListener('dblclick', endDrag);
            cet1DirectOverlayListenersAttached = true;
        }

        function cet1ApplyDirectOverlay() {
            const type = document.getElementById('cet1ModalOverlayType').value;
            document.getElementById('cet1OverlayType').value = type;
            cet1QuarterlyOverlayValues = [...cet1TempDirectOverlayValues];
            const statusEl = document.getElementById('cet1DirectOverlayStatus');
            const btnText = document.getElementById('cet1EditOverlayBtnText');
            if (type === 'none') {
                statusEl.textContent = 'None';
                btnText.textContent = 'Add Overlay';
                cet1QuarterlyOverlayValues = Array(20).fill(0);
            } else {
                let label = type === 'dollar' ? 'Capital ($M)' : (type === 'rwa' ? 'RWA ($M)' : 'Basis Points');
                statusEl.textContent = label;
                btnText.textContent = 'Edit Overlay';
            }
            cet1CalculateScenario();
            cet1CloseDirectOverlayModal();
        }

        function cet1ClearDirectOverlay() {
            cet1QuarterlyOverlayValues = Array(20).fill(0);
            document.getElementById('cet1OverlayType').value = 'none';
            document.getElementById('cet1DirectOverlayStatus').textContent = 'None';
            document.getElementById('cet1EditOverlayBtnText').textContent = 'Add Overlay';
            cet1CalculateScenario();
        }

        // Component Override Modal Functions
        function cet1OpenComponentOverride(componentName) {
            cet1CurrentEditingComponent = componentName;
            const selectedOverrideScenario = document.getElementById('cet1ScenarioToOverride')?.value || 'severe';
            let baseData, displayScenarioName;
            if (selectedOverrideScenario === 'custom') {
                baseData = cet1CustomScenarioComponents[componentName] ? [...cet1CustomScenarioComponents[componentName]] : (cet1ScenarioData.severe[componentName] || Array(20).fill(0));
                displayScenarioName = cet1CustomScenarioName || 'Custom';
            } else {
                baseData = cet1ScenarioData[selectedOverrideScenario][componentName] || Array(20).fill(0);
                displayScenarioName = selectedOverrideScenario.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
            cet1TempOverrideValues = cet1ComponentOverrides[componentName] ? [...cet1ComponentOverrides[componentName]] : [...baseData];
            document.getElementById('cet1OverrideModalTitle').textContent = `Edit: ${componentName}`;
            document.getElementById('cet1OverrideBaseScenario').textContent = displayScenarioName;
            document.getElementById('cet1OverrideComponentName').textContent = componentName;
            cet1RenderOverrideTable(baseData);
            cet1RenderOverrideChart(baseData);
            cet1UpdateModifiedCount(baseData);
            document.getElementById('cet1ComponentOverrideModal').classList.add('open');
        }

        function cet1RenderOverrideTable(baseData) {
            const headerRow = document.getElementById('cet1OverrideTableHeader');
            const baseRow = document.getElementById('cet1OverrideTableBaseRow');
            const inputRow = document.getElementById('cet1OverrideTableInputRow');
            headerRow.innerHTML = '<th>Quarter</th>' + Array.from({ length: 20 }, (_, i) => `<th>Q${i + 1}</th>`).join('');
            baseRow.innerHTML = '<td style="font-weight: 600; background: #F8FAFC;">Base</td>' + baseData.map(v => `<td style="color: var(--text-muted);">${v.toFixed(0)}</td>`).join('');
            inputRow.innerHTML = '<td style="font-weight: 600; background: #F8FAFC;">Override</td>' + cet1TempOverrideValues.map((v, i) => {
                const isModified = v !== baseData[i];
                return `<td><input type="number" value="${v.toFixed(0)}" class="${isModified ? 'modified' : ''}" onchange="cet1UpdateTempOverride(${i}, this.value, ${baseData[i]})" onfocus="this.select()"></td>`;
            }).join('');
        }

        function cet1RenderOverrideChart(baseData) {
            const quarters = Array.from({ length: 20 }, (_, i) => `Q${i + 1}`);
            const traces = [
                { x: quarters, y: baseData, name: 'Base', type: 'scatter', mode: 'lines+markers', line: { color: '#94A3B8', width: 2, dash: 'dot' }, marker: { size: 5 } },
                { x: quarters, y: cet1TempOverrideValues, name: 'Override (drag to edit)', type: 'scatter', mode: 'lines+markers', line: { color: '#2563EB', width: 2 }, marker: { size: 10 } }
            ];
            const layout = {
                font: { family: 'Inter, sans-serif', size: 10 }, paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                margin: { t: 10, b: 30, l: 50, r: 20 },
                xaxis: { tickfont: { size: 9 }, gridcolor: '#E2E8F0', fixedrange: true },
                yaxis: { tickfont: { size: 9 }, gridcolor: '#E2E8F0', title: 'Value' },
                showlegend: true, legend: { orientation: 'h', y: 1.15, x: 0.5, xanchor: 'center' }, dragmode: false, hovermode: 'closest'
            };
            Plotly.newPlot('cet1OverrideChart', traces, layout, { displayModeBar: false, responsive: true, scrollZoom: false });
            cet1SetupDragToEdit(baseData);
        }

        function cet1SetupDragToEdit(baseData) {
            const chartEl = document.getElementById('cet1OverrideChart');
            if (!chartEl) return;
            cet1ChartDragState.baseData = baseData;
            chartEl.on('plotly_click', function (data) {
                if (data.points[0].curveNumber === 1) {
                    cet1ChartDragState.isDragging = true;
                    cet1ChartDragState.pointIndex = data.points[0].pointIndex;
                    chartEl.style.cursor = 'ns-resize';
                    const colors = cet1TempOverrideValues.map((_, i) => i === cet1ChartDragState.pointIndex ? '#F59E0B' : '#2563EB');
                    Plotly.restyle('cet1OverrideChart', { 'marker.color': [colors] }, [1]);
                }
            });
            document.addEventListener('mousemove', function (e) {
                if (!cet1ChartDragState.isDragging || cet1ChartDragState.pointIndex < 0) return;
                const gd = document.getElementById('cet1OverrideChart');
                if (!gd || !gd._fullLayout) return;
                const yaxis = gd._fullLayout.yaxis;
                const rect = gd.getBoundingClientRect();
                const margin = gd._fullLayout.margin;
                const plotTop = rect.top + margin.t;
                const plotHeight = rect.height - margin.t - margin.b;
                const relY = e.clientY - plotTop;
                const clampedY = Math.max(0, Math.min(plotHeight, relY));
                const yRange = yaxis.range;
                const yValue = yRange[1] - (clampedY / plotHeight) * (yRange[1] - yRange[0]);
                const newValue = Math.round(yValue);
                cet1TempOverrideValues[cet1ChartDragState.pointIndex] = newValue;
                Plotly.restyle('cet1OverrideChart', { y: [cet1TempOverrideValues] }, [1]);
                const inputs = document.querySelectorAll('#cet1OverrideTableInputRow input');
                if (inputs[cet1ChartDragState.pointIndex]) {
                    inputs[cet1ChartDragState.pointIndex].value = newValue;
                    inputs[cet1ChartDragState.pointIndex].classList.toggle('modified', newValue !== cet1ChartDragState.baseData[cet1ChartDragState.pointIndex]);
                }
                cet1UpdateModifiedCount(cet1ChartDragState.baseData);
            });
            document.addEventListener('click', function (e) {
                setTimeout(() => {
                    if (cet1ChartDragState.isDragging && !chartEl.contains(e.target)) { cet1EndChartDrag(); }
                }, 50);
            });
            document.addEventListener('mouseup', function () {
                if (cet1ChartDragState.isDragging) { cet1EndChartDrag(); }
            });
            chartEl.addEventListener('dblclick', cet1EndChartDrag);
        }

        function cet1EndChartDrag() {
            if (!cet1ChartDragState.isDragging) return;
            cet1ChartDragState.isDragging = false;
            cet1ChartDragState.pointIndex = -1;
            const chartEl = document.getElementById('cet1OverrideChart');
            if (chartEl) {
                chartEl.style.cursor = 'default';
                Plotly.restyle('cet1OverrideChart', { 'marker.color': '#2563EB' }, [1]);
            }
        }

        function cet1UpdateTempOverride(index, value, baseValue) {
            const numValue = parseFloat(value) || 0;
            cet1TempOverrideValues[index] = numValue;
            const inputs = document.querySelectorAll('#cet1OverrideTableInputRow input');
            if (inputs[index]) inputs[index].classList.toggle('modified', numValue !== baseValue);
            const selectedOverrideScenario = document.getElementById('cet1ScenarioToOverride')?.value || 'severe';
            const baseScenario = selectedOverrideScenario === 'custom' ? 'severe' : selectedOverrideScenario;
            const baseData = cet1ScenarioData[baseScenario][cet1CurrentEditingComponent] || Array(20).fill(0);
            cet1RenderOverrideChart(baseData);
            cet1UpdateModifiedCount(baseData);
        }

        function cet1UpdateModifiedCount(baseData) {
            let count = 0;
            cet1TempOverrideValues.forEach((v, i) => { if (v !== baseData[i]) count++; });
            document.getElementById('cet1OverrideModifiedCount').textContent = count;
        }

        function cet1ApplyComponentOverride() {
            if (!cet1CurrentEditingComponent) return;
            const selectedOverrideScenario = document.getElementById('cet1ScenarioToOverride')?.value || 'severe';
            let baseData;
            if (selectedOverrideScenario === 'custom' && cet1CustomScenarioComponents[cet1CurrentEditingComponent]) {
                baseData = [...cet1CustomScenarioComponents[cet1CurrentEditingComponent]];
            } else {
                const scenarioKey = selectedOverrideScenario === 'custom' ? 'severe' : selectedOverrideScenario;
                baseData = cet1ScenarioData[scenarioKey][cet1CurrentEditingComponent] || Array(20).fill(0);
            }
            let hasChanges = false;
            cet1TempOverrideValues.forEach((v, i) => { if (v !== baseData[i]) hasChanges = true; });
            if (hasChanges) {
                cet1ComponentOverrides[cet1CurrentEditingComponent] = [...cet1TempOverrideValues];
            } else {
                delete cet1ComponentOverrides[cet1CurrentEditingComponent];
            }
            cet1InitComponentOverrideList();
            cet1CloseOverrideModal();
            cet1CalculateScenario();
        }

        function cet1ResetComponentOverride() {
            if (!cet1CurrentEditingComponent) return;
            const selectedOverrideScenario = document.getElementById('cet1ScenarioToOverride')?.value || 'severe';
            let baseData;
            if (selectedOverrideScenario === 'custom' && cet1CustomScenarioComponents[cet1CurrentEditingComponent]) {
                baseData = [...cet1CustomScenarioComponents[cet1CurrentEditingComponent]];
            } else {
                const scenarioKey = selectedOverrideScenario === 'custom' ? 'severe' : selectedOverrideScenario;
                baseData = cet1ScenarioData[scenarioKey][cet1CurrentEditingComponent] || Array(20).fill(0);
            }
            cet1TempOverrideValues = [...baseData];
            cet1RenderOverrideTable(baseData);
            cet1RenderOverrideChart(baseData);
            cet1UpdateModifiedCount(baseData);
        }

        function cet1CloseOverrideModal() {
            document.getElementById('cet1ComponentOverrideModal').classList.remove('open');
            cet1CurrentEditingComponent = null;
            cet1TempOverrideValues = [];
        }

        function cet1ClearAllOverrides() {
            cet1ComponentOverrides = {};
            cet1InitComponentOverrideList();
            cet1CalculateScenario();
        }

        function cet1SelectScenarioToOverride(scenarioValue) {
            cet1SelectScenarioForDetails(scenarioValue);
            if (scenarioValue === 'custom') {
                const scenarioDisplay = document.getElementById('cet1ScenarioDisplay');
                const customOption = Array.from(scenarioDisplay.options).find(opt => opt.value === 'custom');
                if (customOption && !customOption.selected) customOption.selected = true;
            }
            cet1CalculateScenario();
            cet1InitComponentOverrideList();
        }




        // ========================================
        // CET1 AI CHAT FUNCTIONS
        // ========================================
        async function cet1SendMessage(customMessage = null) {
            const userInput = customMessage || document.getElementById('cet1UserInput').value.trim();
            if (!userInput) return;

            cet1AddMessageToChat('user', userInput);
            if (!customMessage) document.getElementById('cet1UserInput').value = '';

            cet1ConversationHistory.push({ role: 'user', content: userInput });

            const loadingId = cet1AddMessageToChat('ai', 'ðŸ’­ Thinking...');

            try {
                const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:5001' : '';
                const API_ENDPOINT = `${API_BASE}/api/chat`;

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: cet1ConversationHistory,
                        max_completion_tokens: 24000  // Optimized for quality while avoiding timeout
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                cet1RemoveMessage(loadingId);

                // Check for finalization JSON
                let finalizeMatch = null;
                const jsonStartIndex = aiResponse.indexOf('"FINALIZE"');
                if (jsonStartIndex !== -1) {
                    let braceStart = aiResponse.lastIndexOf('{', jsonStartIndex);
                    if (braceStart !== -1) {
                        let braceCount = 0, braceEnd = -1;
                        for (let i = braceStart; i < aiResponse.length; i++) {
                            if (aiResponse[i] === '{') braceCount++;
                            if (aiResponse[i] === '}') braceCount--;
                            if (braceCount === 0) { braceEnd = i; break; }
                        }
                        if (braceEnd !== -1) finalizeMatch = [aiResponse.substring(braceStart, braceEnd + 1)];
                    }
                }

                if (finalizeMatch) {
                    try {
                        const scenarioData = JSON.parse(finalizeMatch[0]);
                        const mathSeverity = cet1DetermineSeverityFromComponents(scenarioData.componentSeverities);
                        scenarioData.severity = mathSeverity;
                        cet1CustomScenarioResult = scenarioData;

                        const textBeforeJson = aiResponse.substring(0, aiResponse.indexOf(finalizeMatch[0])).trim();
                        if (textBeforeJson) {
                            cet1AddMessageToChat('ai', textBeforeJson);
                        } else {
                            cet1AddMessageToChat('ai', "âœ… Scenario analysis complete. I've updated the configuration panel with component severities and rationale for your review.");
                        }
                        cet1DisplayScenarioResult(scenarioData);
                    } catch (e) {
                        console.error('Failed to parse finalization JSON:', e);
                        cet1AddMessageToChat('ai', aiResponse);
                    }
                } else {
                    cet1AddMessageToChat('ai', aiResponse);
                    cet1ConversationHistory.push({ role: 'assistant', content: aiResponse });
                }
            } catch (error) {
                cet1RemoveMessage(loadingId);
                console.error('Chat error:', error);
                cet1AddMessageToChat('ai', `âš ï¸ AI service unavailable (${error.message}).<br><br>You can still use this tool with default "Severe" severity for all components.<br><br><button class="astra-btn astra-btn-primary" onclick="cet1ApplyDefaultScenario()" style="margin-top: 10px;">Use Default Severities</button>`);
            }
        }

        function cet1AddMessageToChat(sender, message) {
            const chatContainer = document.getElementById('cet1ChatContainer');
            const messageId = 'cet1msg-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = `<div class="chat-bubble">${message}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageId;
        }

        function cet1RemoveMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) message.remove();
        }

        function cet1UpdateChat() {
            const chatContainer = document.getElementById('cet1ChatContainer');
            if (!chatContainer) return;

            chatContainer.innerHTML = '';

            cet1ConversationHistory.forEach(msg => {
                if (msg.role === 'system') return;

                const sender = msg.role === 'user' ? 'user' : 'ai';
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;

                let contentHtml = msg.content;
                if (typeof marked !== 'undefined' && marked.parse) {
                    contentHtml = marked.parse(msg.content);
                } else if (typeof marked !== 'undefined') {
                    // Fallback for older marked versions if necessary
                    contentHtml = marked(msg.content);
                }

                messageDiv.innerHTML = `<div class="chat-bubble">${contentHtml}</div>`;
                chatContainer.appendChild(messageDiv);
            });

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function cet1ResetConversation() {
            cet1ConversationHistory = [{
                role: 'system',
                content: `You are a financial risk analyst helping to create stress testing scenarios for Royal Bank of Canada (RBC). 
Your job is to:
1. Have a conversation with the user to understand their scenario
2. Ask clarifying questions about the scenario details, potential impacts, and magnitude
3. When you have enough information, assess the severity impact on each of the 18 CET1 components

The 18 CET1 components are:
- PPNR Canada, PPNR US, PPNR International
- PCL Canada, PCL US, PCL International (Provision for Credit Losses by geography)
- Dividend, Trading PnL, AFS Losses, Operational Risk Losses
- Currency Translation Adj, Shortfall in Allowance
- Credit RWA Change Canada, Credit RWA Change US, Credit RWA Change International
- Market CCR CVA RWA Change, Operational Risk RWA Change, Other

When the user asks you to finalize or you believe you have enough information, respond with a JSON object with "FINALIZE": true and componentSeverities for each of the 18 components.

Be conversational, ask thoughtful questions, and help the user think through all aspects of their scenario.`
            }, {
                role: 'assistant',
                content: "Hello! I'm here to help you create a custom stress testing scenario for RBC. You can describe your scenario in detail, or upload a document. I'll ask clarifying questions and then determine the severity impact on each CET1 component. What scenario would you like to explore?"
            }];

            const chatContainer = document.getElementById('cet1ChatContainer');
            chatContainer.innerHTML = `
                <div class="chat-message ai">
                    <div class="chat-bubble">
                        Hello! I'm here to help you create a custom stress testing scenario for RBC. 
                        You can describe your scenario in detail, or upload a document. 
                        I'll ask clarifying questions and then determine the severity impact on each CET1 component. 
                        What scenario would you like to explore?
                    </div>
                </div>
            `;
            document.getElementById('cet1UserInput').value = '';
            cet1UploadedFileContent = null;
            cet1CustomScenarioResult = null;
        }

        async function cet1HandleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                cet1UploadedFileContent = e.target.result;
                document.getElementById('cet1UploadedFileDisplay').innerHTML = `
                    <div class="uploaded-file">ðŸ“„ ${file.name} (${(file.size / 1024).toFixed(1)} KB)</div>
                `;
                await cet1SendMessage(`I've uploaded a document about a stress scenario. Here's the content:\n\n${cet1UploadedFileContent.substring(0, 3000)}`);
            };
            reader.readAsText(file);
        }

        function cet1InitializeDefaultSeverities() {
            const defaultSeverities = {};
            const defaultReasons = {};
            CET1_COMPONENTS.forEach(comp => {
                defaultSeverities[comp] = 'severe';
                defaultReasons[comp] = 'Awaiting AI analysis. Chat with the assistant to generate tailored severity assessments.';
            });
            cet1CustomScenarioResult = {
                title: 'Custom Scenario',
                description: 'Custom stress scenario with default severity levels.',
                severity: 'severe',
                componentSeverities: defaultSeverities,
                componentReasons: defaultReasons
            };
            cet1DisplayScenarioResult(cet1CustomScenarioResult);
        }

        function cet1ApplyDefaultScenario() {
            const defaultSeverities = {};
            const defaultReasons = {};
            CET1_COMPONENTS.forEach(comp => {
                defaultSeverities[comp] = 'severe';
                defaultReasons[comp] = 'Default severity applied (AI unavailable). Manually adjust as needed.';
            });
            cet1CustomScenarioResult = {
                title: 'Custom Scenario (Default)',
                description: 'Custom scenario created with default severity levels. All components are set to "Severe" by default.',
                severity: 'severe',
                componentSeverities: defaultSeverities,
                componentReasons: defaultReasons
            };
            cet1DisplayScenarioResult(cet1CustomScenarioResult);
            cet1AddMessageToChat('ai', 'âœ… Default severities applied! All 18 components are set to "Severe". You can now:<br><br>â€¢ Adjust individual component severities using the dropdowns on the left<br>â€¢ Click "Calculate & Apply to Dashboard" when ready');
        }

        function cet1DisplayScenarioResult(scenarioData) {
            const resultContainer = document.getElementById('cet1ScenarioConfigPanel');
            if (!resultContainer) return;

            const componentItems = Object.entries(scenarioData.componentSeverities).map(([comp, sev]) => {
                const reason = (scenarioData.componentRationale && scenarioData.componentRationale[comp]) ||
                    (scenarioData.componentReasons && scenarioData.componentReasons[comp]) || 'AI assessment based on scenario analysis.';
                const compId = comp.replace(/\s+/g, '_');
                return `
                    <div class="severity-item" data-component="${comp}">
                        <div class="severity-reasoning">ðŸ¤– ${reason}</div>
                        <div class="severity-header">
                            <span class="severity-label">${comp}</span>
                            <select class="severity-select" id="cet1sev_${compId}" onchange="cet1UpdateComponentSeverity('${comp}', this.value)">
                                <option value="very_severe" ${sev === 'very_severe' ? 'selected' : ''}>Very Severe</option>
                                <option value="severe" ${sev === 'severe' ? 'selected' : ''}>Severe</option>
                                <option value="moderate" ${sev === 'moderate' ? 'selected' : ''}>Moderate</option>
                                <option value="benchmark" ${sev === 'benchmark' ? 'selected' : ''}>Benchmark</option>
                            </select>
                        </div>
                    </div>`;
            }).join('');

            resultContainer.innerHTML = `
                <div class="scenario-result">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 12px;">
                        <div>
                            <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--text-main);">${scenarioData.title}</h3>
                            <div style="margin-top: 8px;">
                                <span class="severity-badge severity-${scenarioData.severity}">Overall: ${scenarioData.severity.replace('_', ' ')}</span>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 20px;">${scenarioData.description}</p>
                    <h4 style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; margin-bottom: 12px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 8px;">
                        Component Severities <span style="font-weight: 400; color: var(--text-muted);">(hover for AI reasoning)</span>
                    </h4>
                    <div class="severity-list">${componentItems}</div>
                </div>
                <div class="calculate-sticky-footer">
                    <button class="astra-btn astra-btn-primary" onclick="cet1ApplyScenario()" style="width: 100%; padding: 14px 20px; font-size: 14px; font-weight: 600;">
                        ðŸ“Š Calculate & Apply to Dashboard
                    </button>
                </div>`;
        }

        function cet1UpdateComponentSeverity(component, newSeverity) {
            if (!cet1CustomScenarioResult) return;
            cet1CustomScenarioResult.componentSeverities[component] = newSeverity;
            const newOverall = cet1DetermineSeverityFromComponents(cet1CustomScenarioResult.componentSeverities);
            cet1CustomScenarioResult.severity = newOverall;
            const badge = document.querySelector('.severity-badge');
            if (badge) {
                badge.className = badge.className.replace(/severity-[a-z_]+/, '') + ` severity-${newOverall}`;
                badge.textContent = `Overall: ${newOverall.replace('_', ' ')}`;
            }
        }

        function cet1DetermineSeverityFromComponents(componentSeverities) {
            const hybridData = {};
            CET1_COMPONENTS.forEach(comp => {
                const severity = componentSeverities[comp] || 'moderate';
                let key = severity.toLowerCase().replace(' ', '_');
                if (!cet1ScenarioData[key]) key = 'moderate';
                hybridData[comp] = cet1ScenarioData[key][comp];
            });
            const path = cet1CalculatePath(hybridData, 'none', [], false);
            const trough = Math.min(...path);
            const benchmarks = {
                'very_severe': Math.min(...cet1CalculatePath(cet1ScenarioData.very_severe, 'none', [], false)),
                'severe': Math.min(...cet1CalculatePath(cet1ScenarioData.severe, 'none', [], false)),
                'moderate': Math.min(...cet1CalculatePath(cet1ScenarioData.moderate, 'none', [], false)),
                'benchmark': Math.min(...cet1CalculatePath(cet1ScenarioData.benchmark, 'none', [], false))
            };
            let closest = 'moderate', minDiff = Infinity;
            for (const [sev, val] of Object.entries(benchmarks)) {
                const diff = Math.abs(trough - val);
                if (diff < minDiff) { minDiff = diff; closest = sev; }
            }
            return closest;
        }

        function cet1ApplyScenario() {
            if (!cet1CustomScenarioResult) return;

            if (cet1CustomScenarioResult.title) {
                cet1CustomScenarioName = cet1CustomScenarioResult.title;
                document.getElementById('cet1CustomScenarioName').value = cet1CustomScenarioName;
            }

            CET1_COMPONENTS.forEach(comp => {
                const selectId = `cet1Comp_${comp.replace(/\s+/g, '_')}`;
                const selectElement = document.getElementById(selectId);
                if (selectElement && cet1CustomScenarioResult.componentSeverities && cet1CustomScenarioResult.componentSeverities[comp]) {
                    selectElement.value = cet1CustomScenarioResult.componentSeverities[comp];
                }
            });

            cet1UpdateCustomScenario(false);

            // Auto-select Custom scenario for Overrides and Display to ensure visibility
            const overrideSelect = document.getElementById('cet1ScenarioToOverride');
            if (overrideSelect) {
                overrideSelect.value = 'custom';
                cet1SelectScenarioToOverride('custom');
            } else {
                const options = document.getElementById('cet1ScenarioDisplay').options;
                const customOption = Array.from(options).find(opt => opt.value === 'custom');
                if (customOption) customOption.selected = true;

                cet1SelectScenarioForDetails('custom');
                cet1CalculateScenario();
            }
            closeCET1AIModal();

            alert(`âœ… Custom scenario "${cet1CustomScenarioResult.title}" has been applied to the stress test model!`);
        }

        async function cet1RequestFinalization() {
            await cet1SendMessage("Please finalize this scenario and provide the severity assessments for all 18 CET1 components.");
        }
    </script>
    <script>
        /* Executive Report Logic */
        let execCurrentPickType = null;
        /* Ensure execState is global */
        if (!window.execState) {
            window.execState = {
                heatMap: null,
                scenario: null,
                macro: null,
                tempBar: null,
                scenarioBadgeOverride: null
            };
        }

        function showExecutiveReport() {
            // Hide all panels
            ['marketplacePanel', 'savedScenariosPanel', 'heatMapPanel', 'cet1AnalysisPanel', 'basketPanel', 'heatmapBasketPanel', 'playgroundPanel'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            // Show Executive Panel
            const panel = document.getElementById('executiveReportPanel');
            if (panel) panel.style.display = 'block';

            // Update timestamp
            const ts = document.getElementById('execTimestamp');
            if (ts) {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true, timeZoneName: 'short' };
                ts.textContent = now.toLocaleString('en-US', options);
            }

            // Update Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector('.nav-item[title="Executive Report"]')?.classList.add('active');
        }

        function closeExecPicker() {
            document.getElementById('execPickerModal').style.display = 'none';
        }

        function openExecPicker(type) {
            execCurrentPickType = type;
            const list = document.getElementById('execPickerList');
            list.innerHTML = '';

            const savedList = window.savedScenarios || [];

            if (savedList.length === 0) {
                list.innerHTML = '<div style="padding:12px; color:var(--text-muted); text-align: center;">No saved items found in folder.<br>Save a scenario first to populate this list.</div>';
            } else {
                savedList.forEach((sc, idx) => {
                    const name = sc.name || sc.title || 'Untitled Item';
                    const date = new Date(sc.timestamp || sc.savedAt || sc.date || Date.now()).toLocaleDateString();
                    let typeTag = 'Scenario';
                    if (sc.type === 'heatmap') typeTag = 'Heat Map';
                    else if (sc.type === 'calculation') typeTag = 'CET1 Calc';

                    const div = document.createElement('div');
                    div.className = 'exec-picker-item';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <div style="display:flex; flex-direction:column; gap:2px;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <strong>${name}</strong>
                                    <span style="font-size:10px; background:#F1F5F9; color:#64748B; padding:1px 6px; border-radius:10px;">${typeTag}</span>
                                </div>
                                <span style="font-size:11px; color:#94A3B8;">${date}</span>
                            </div>
                            <span style="color:var(--primary); font-size:12px; font-weight:600;">Select</span>
                        </div>`;
                    div.onclick = () => execSelectItem(idx);
                    list.appendChild(div);
                });
            }

            document.getElementById('execPickerModal').style.display = 'flex';
        }

        function openExecPickerNew(type) {
            execCurrentPickType = type;
            const list = document.getElementById('execPickerList');
            list.innerHTML = '';

            let savedList = window.savedScenarios || [];

            // Filter for calculations only when picking waterfall
            if (type === 'waterfall' || type === 'tempBar') {
                savedList = savedList.filter(sc => sc.type === 'calculation' || (sc.id && sc.id.startsWith('cet1_')));
            }

            if (savedList.length === 0) {
                const msg = (type === 'waterfall' || type === 'tempBar')
                    ? 'No CET1 calculations found in folder.<br>Save a calculation from CET1 Analysis first.'
                    : 'No saved items found in folder.<br>Save a scenario first to populate this list.';
                list.innerHTML = `<div style="padding:12px; color:var(--text-muted); text-align: center;">${msg}</div>`;
            } else {
                savedList.forEach((sc, filteredIdx) => {
                    // Find original index in savedScenarios
                    const idx = window.savedScenarios.findIndex(s => s.id === sc.id);

                    const name = sc.name || sc.title || 'Untitled Item';
                    const date = new Date(sc.timestamp || sc.savedAt || sc.date || Date.now()).toLocaleDateString();
                    let typeTag = 'Scenario';
                    if (sc.type === 'heatmap') typeTag = 'Heat Map';
                    else if (sc.type === 'calculation') typeTag = 'CET1 Calc';

                    const div = document.createElement('div');
                    div.className = 'exec-picker-item';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <div style="display:flex; flex-direction:column; gap:2px;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <strong>${name}</strong>
                                    <span style="font-size:10px; background:#F1F5F9; color:#64748B; padding:1px 6px; border-radius:10px;">${typeTag}</span>
                                </div>
                                <span style="font-size:11px; color:#94A3B8;">${date}</span>
                            </div>
                            <span style="color:var(--primary); font-size:12px; font-weight:600;">Select</span>
                        </div>`;
                    div.onclick = () => execSelectItem(idx);
                    list.appendChild(div);
                });
            }
            document.getElementById('execPickerModal').style.display = 'flex';
        }

        function execPickHeatMap() { openExecPickerNew('heatMap'); }
        function execPickScenario() { openExecPickerNew('scenario'); }
        function execPickMacro() { openExecPickerNew('macro'); }
        function execPickTempBar() { openExecPickerNew('tempBar'); }
        function execPickWaterfall() { openExecPickerNew('waterfall'); }

        function execSelectItem(index) {
            const scenario = window.savedScenarios[index];
            execState[execCurrentPickType] = scenario;
            renderExecCard(execCurrentPickType);
            closeExecPicker();
        }

        function renderExecCard(type) {
            const data = execState[type];
            if (!data) return;

            if (type === 'heatMap') renderExecHeatMap(data);
            else if (type === 'scenario') renderExecScenarioDesc(data);
            else if (type === 'macro') renderExecMacro(data);
            else if (type === 'tempBar') renderExecTempBar(data);
            else if (type === 'waterfall') renderExecWaterfall(data);
        }

        function getHeatMapColor(rating) {
            if (rating === 'High' || rating === 'Severe' || rating >= 4) return '#EF4444';
            if (rating === 'Medium' || rating === 'Moderate' || rating === 3) return '#F59E0B';
            return '#3B82F6';
        }

        function renderExecHeatMap(data) {
            const container = document.getElementById('execHeatMapContent');
            container.className = '';
            container.style.cursor = 'default';
            container.style.height = '100%';
            container.style.width = '100%';
            // Reset padding/margin if any
            container.style.padding = '0';

            const drivers = data.drivers || (data.basketItems ? data.basketItems : []);
            const mapData = data.heatMapData || {};

            // DEBUG: Log all driver IDs and heatMapData keys
            console.log('=== EXEC HEATMAP DEBUG ===');
            console.log('Driver IDs:', drivers.map((d, i) => `${i + 1}: ${d.id}`));
            console.log('HeatMapData keys:', Object.keys(mapData));
            drivers.forEach((d, i) => {
                const found = mapData[d.id];
                if (!found) {
                    console.error(`âŒ Driver ${i + 1} (${d.id}) - "${d.title}" - NO DATA IN mapData`);
                } else {
                    console.log(`âœ“ Driver ${i + 1} (${d.id}) - L:${found.likelihood}, M:${found.materiality}, V:${found.velocity}`);
                }
            });
            console.log('=== END DEBUG ===');

            // 1. Render Legend Logic
            const velocityLegend = `
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 13px; font-weight: 700; color: #64748B; text-transform: uppercase; margin-bottom: 8px;">Velocity</div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #334155;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #EF4444;"></div> High (< 2 weeks)
                        </div>
                         <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #334155;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #F59E0B;"></div> Medium (2 wks - 3 mos)
                        </div>
                         <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #334155;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #10B981;"></div> Low (> 3 months)
                        </div>
                    </div>
                </div>
            `;

            const driversList = drivers.map((d, i) => {
                const dData = mapData[d.id] || {};
                const velColor = dData.velocity === 3 ? '#EF4444' : dData.velocity === 2 ? '#F59E0B' : '#10B981';
                return `
                    <div style="display: flex; align-items: flex-start; gap: 10px; font-size: 13px; min-height: 24px; margin-bottom: 8px;" title="${d.title}">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background: ${velColor}; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; margin-top: 0;">${i + 1}</div>
                        <div style="color: #1E293B; line-height: 1.4; word-break: break-word; padding-top: 2px;">${d.title || d.name}</div>
                    </div>
                `;
            }).join('');

            // 2. Detect overlaps and calculate offsets
            const positions = [];
            drivers.forEach((d, i) => {
                const dData = mapData[d.id];
                if (dData && dData.likelihood !== undefined && dData.materiality !== undefined) {
                    const likelihood = Number(dData.likelihood) || 5;
                    const materiality = Number(dData.materiality) || 5;
                    const baseX = 5 + ((likelihood - 1) / 9) * 90;
                    const baseY = 95 - ((materiality - 1) / 9) * 90;

                    // Check for collisions with previously positioned drivers
                    let offsetX = 0;
                    let offsetY = 0;
                    let collisionCount = 0;

                    positions.forEach(pos => {
                        if (Math.abs(pos.x - baseX) < 3 && Math.abs(pos.y - baseY) < 5) {
                            collisionCount++;
                        }
                    });

                    // Apply offset based on collision count (spiral pattern)
                    if (collisionCount > 0) {
                        const angle = collisionCount * (Math.PI / 3); // 60 degree increments
                        const radius = 4; // % offset
                        offsetX = Math.cos(angle) * radius;
                        offsetY = Math.sin(angle) * radius;
                    }

                    positions.push({ x: baseX + offsetX, y: baseY + offsetY, idx: i });
                }
            });

            // 3. Render Bubbles with offsets
            const bubbles = drivers.map((d, i) => {
                // Try to find data by id first, then by index if needed
                let dData = mapData[d.id];

                // If not found by id, try to find by matching title or other identifiers
                if (!dData) {
                    // Try looking up by index in the mapData keys
                    const mapKeys = Object.keys(mapData);
                    if (mapKeys[i]) {
                        dData = mapData[mapKeys[i]];
                    }
                }

                // Use explicit null/undefined checks (0 is a valid value)
                if (!dData || dData.likelihood === undefined || dData.likelihood === null ||
                    dData.materiality === undefined || dData.materiality === null) {
                    console.warn(`Missing heatmap data for driver ${i + 1}: ${d.title}`, { id: d.id, dData });
                    return '';
                }

                // Get pre-calculated position with offset
                const pos = positions.find(p => p.idx === i);
                const xPct = pos ? pos.x : 50;
                const yPct = pos ? pos.y : 50;

                const velColor = dData.velocity === 3 ? '#EF4444' : dData.velocity === 2 ? '#F59E0B' : '#10B981';

                return `
                    <div style="
                        position: absolute; 
                        left: ${xPct}%; 
                        top: ${yPct}%; 
                        width: 28px; 
                        height: 28px; 
                        background: ${velColor}; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        color: white; 
                        font-size: 13px; 
                        font-weight: 700; 
                        transform: translate(-50%, -50%);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                        z-index: ${10 + i};
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='translate(-50%, -50%) scale(1.2)'; this.style.zIndex='100'" onmouseout="this.style.transform='translate(-50%, -50%)'; this.style.zIndex='${10 + i}'" title="${d.title} (L:${dData.likelihood}, I:${dData.materiality})">
                        ${i + 1}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="display: flex; width: 100%; height: 100%; gap: 16px; padding: 4px;">
                    <!-- Chart Area -->
                    <div style="flex: 1; display: flex; flex-direction: column;">
                         <div style="flex: 1; position: relative;">
                            <!-- Y Axis Label -->
                            <div style="position: absolute; left: 0; top: 0; bottom: 16px; width: 40px; display: flex; align-items: center; justify-content: center;">
                                <div style="transform: rotate(-90deg); white-space: nowrap; font-size: 11px; font-weight: 700; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px;">Impact to RBC</div>
                            </div>
                            
                            <!-- Main Grid -->
                            <div style="
                                position: absolute;
                                left: 40px; right: 0; top: 0; bottom: 16px;
                                background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(245, 158, 11, 0.05) 50%, rgba(239, 68, 68, 0.05) 100%);
                                border-radius: 12px;
                                border: 1px solid #E2E8F0;
                            ">
                                <!-- Grid Lines -->
                                <div style="position: absolute; top:0; bottom:0; left:33.3%; border-left: 1px dashed #CBD5E1;"></div>
                                <div style="position: absolute; top:0; bottom:0; left:66.6%; border-left: 1px dashed #CBD5E1;"></div>
                                <div style="position: absolute; left:0; right:0; top:33.3%; border-top: 1px dashed #CBD5E1;"></div>
                                <div style="position: absolute; left:0; right:0; top:66.6%; border-top: 1px dashed #CBD5E1;"></div>

                                <!-- Labels High/Low -->
                                <div style="position: absolute; top: 8px; left: 8px; font-size: 11px; color: #94A3B8; font-weight: 600;">High</div>
                                <div style="position: absolute; bottom: 8px; left: 8px; font-size: 11px; color: #94A3B8; font-weight: 600;">Low</div>
                                <div style="position: absolute; bottom: 8px; right: 8px; font-size: 11px; color: #94A3B8; font-weight: 600;">High</div>
                                
                                ${bubbles}
                            </div>
                            
                            <!-- X Axis Label -->
                            <div style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 700; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; padding-left: 40px;">Likelihood</div>
                        </div>
                    </div>

                    <!-- Legend Sidebar -->
                    <div style="width: 260px; display: flex; flex-direction: column; overflow-y: auto; padding-left: 12px; border-left: 1px solid #E2E8F0;">
                        ${velocityLegend}
                        
                        <div style="font-size: 13px; font-weight: 700; color: #64748B; text-transform: uppercase; margin-bottom: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #E2E8F0;">Drivers</div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${driversList}
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderExecScenarioDesc(data) {
            const container = document.getElementById('execScenarioDescContent');
            container.className = '';
            container.style.cursor = 'default';

            /* Debug: Log data structure */
            console.log("renderExecScenarioDesc called with data:", data);

            /* Handle case where data is undefined or empty */
            if (!data || typeof data !== 'object') {
                console.error("Invalid data passed to renderExecScenarioDesc:", data);
                container.innerHTML = `<div style="padding: 20px; color: #EF4444;">Error: Invalid scenario data</div>`;
                return;
            }

            /* Use name logic consistent with picker - check all possible fields */
            const scenarioName = data.scenarioTitle || data.name || data.title || "Untitled Scenario";
            console.log("Scenario name resolved to:", scenarioName);

            /* Extract global and Canadian conditions from scenario data */
            const globalConditions = data.global || data.globalConditions || '';
            const canadianConditions = data.canadian || data.canadianConditions || '';

            /* Strip HTML tags for cleaner text */
            const stripHtml = (html) => {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || '';
            };

            const globalText = stripHtml(globalConditions).trim();
            const canadianText = stripHtml(canadianConditions).trim();

            /* Build fallback text from global conditions */
            const fallbackText = globalText || "No narrative available for this scenario.";

            /* Show Loading State */
            /* Show Loading State */
            container.innerHTML = `
                <div style="font-size: 14px; line-height: 1.6; color: #334155; height: 100%; display: flex; flex-direction: column;">
                    <div style="font-weight: 700; font-size: 16px; margin-bottom: 12px; color: #003168;">${scenarioName}</div>
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748B; gap: 12px;">
                        <div style="width: 20px; height: 20px; border: 2px solid #E2E8F0; border-top-color: #003168; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="font-size: 12px;">Generating scenario summary...</div>
                    </div>
                </div>
                <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
            `;

            /* Attempt to link to Heatmap Driver */
            let badgeHtml = '';

            console.log("Checking override:", window.execState.scenarioBadgeOverride);
            // 1. Check for Manual Override
            if (window.execState && window.execState.scenarioBadgeOverride) {
                const ov = window.execState.scenarioBadgeOverride;
                const colorMap = { 'high': '#EF4444', 'med': '#F59E0B', 'low': '#10B981' };
                const bg = colorMap[ov.velocity] || '#EF4444';

                badgeHtml = `
                    <div onclick="event.stopPropagation(); openBadgeEditor()" style="
                        display: inline-flex;
                        cursor: pointer;
                        align-items: center;
                        justify-content: center;
                        width: 28px;
                        height: 28px;
                        background: ${bg};
                        color: white;
                        border-radius: 50%;
                        font-size: 14px;
                        font-weight: 700;
                        margin-right: 12px;
                        flex-shrink: 0;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Click to edit">${ov.number}</div>
                `;
            }
            // 2. Fallback to Fuzzy Match
            else if (window.execState && window.execState.heatMap && window.execState.heatMap.drivers) {
                const drivers = window.execState.heatMap.drivers;
                const mapData = window.execState.heatMap.heatMapData || {};

                // Fuzzy match: check if one name includes the other
                // We use aggressive normalization (removing special chars) for better matching
                const normalize = (s) => (s || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                const cleanScenario = normalize(scenarioName);

                const matchIdx = drivers.findIndex(d => {
                    const cleanDriver = normalize(d.title || d.name);
                    return cleanDriver && (cleanDriver.includes(cleanScenario) || cleanScenario.includes(cleanDriver));
                });

                if (matchIdx !== -1) {
                    const d = drivers[matchIdx];
                    const dData = mapData[d.id] || {};
                    const velColor = dData.velocity === 3 ? '#EF4444' : dData.velocity === 2 ? '#F59E0B' : '#10B981';

                    badgeHtml = `
                        <div style="
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            width: 24px;
                            height: 24px;
                            background: ${velColor};
                            color: white;
                            border-radius: 50%;
                            font-size: 14px;
                            font-weight: 700;
                            margin-right: 12px;
                            flex-shrink: 0;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        ">${matchIdx + 1}</div>
                    `;
                }
            }

            // 3. Fallback Empty Token (Click to Add)
            if (!badgeHtml) {
                badgeHtml = `
                    <div onclick="event.stopPropagation(); openBadgeEditor()" style="
                        display: inline-flex;
                        cursor: pointer;
                        align-items: center;
                        justify-content: center;
                        width: 28px;
                        height: 28px;
                        border: 2px dashed #CBD5E1;
                        background: transparent;
                        color: #94A3B8;
                        border-radius: 50%;
                        font-size: 16px;
                        font-weight: 600;
                        margin-right: 12px;
                        flex-shrink: 0;
                        transition: all 0.2s;
                    " onmouseover="this.style.borderColor='#2563EB'; this.style.color='#2563EB';" onmouseout="this.style.borderColor='#CBD5E1'; this.style.color='#94A3B8';" title="Link to Heat Map Driver">+</div>
                `;
            }

            /* If no conditions to work with, just show fallback */
            if (!globalText && !canadianText) {
                renderDescHTML(container, scenarioName, fallbackText, false, badgeHtml);
                return;
            }

            /* Prepare AI Prompt */
            const systemPrompt = `You are a financial risk analyst writing executive summaries for stress testing scenarios.`;

            const userPrompt = `Write a 100-word executive summary for this scenario:

Title: ${scenarioName}

Global Conditions:
${globalText}

Canadian Conditions:
${canadianText}

IMPORTANT: Write ONLY qualitative narrative. Do NOT mention ANY macro variables including GDP, unemployment, inflation, interest rates, exchange rates, house prices, stock indices, or credit spreads. Focus purely on the economic events and risk drivers. Write in professional prose.`;

            try {
                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        // temperature omitted - GPT-5 only supports default value of 1
                        max_tokens: 20000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const aiText = data.choices[0].message.content;

                renderDescHTML(container, scenarioName, aiText, true, badgeHtml);

            } catch (e) {
                console.error("AI Gen Failed:", e);
                /* Fallback: Use global conditions text directly */
                renderDescHTML(container, scenarioName, fallbackText, false, badgeHtml);
            }
        }

        function renderDescHTML(container, title, text, isAI, badgeHtml) {
            // Ensure badgeHtml is a string
            const safeBadge = badgeHtml || '';

            // Store the current text for editing purposes
            window.currentScenarioDescText = text;
            window.currentScenarioDescTitle = title;
            window.currentScenarioDescBadge = safeBadge;

            container.innerHTML = `
                <div style="font-size: 16px; line-height: 1.5; color: #334155; height: 100%; display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        ${safeBadge}
                        <div style="font-weight: 700; font-size: 20px; color: #003168; line-height: 1.2;">
                            ${title}
                        </div>
                    </div>
                    <div class="scenario-desc-wrapper" id="scenarioDescWrapper">
                        <button class="scenario-desc-edit-btn" onclick="event.stopPropagation(); openScenarioDescEditor()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Edit Description
                        </button>
                        <div id="scenarioDescText" style="padding-right: 8px;">
                            ${text}
                        </div>
                    </div>
                </div>
            `;

            // Setup 2-second hover to show edit button
            setupScenarioDescHover();
        }

        // Hover timeout tracker for scenario description
        let scenarioDescHoverTimeout = null;

        function setupScenarioDescHover() {
            const wrapper = document.getElementById('scenarioDescWrapper');
            if (!wrapper) return;

            wrapper.addEventListener('mouseenter', () => {
                // Start 2-second timer to show edit button
                scenarioDescHoverTimeout = setTimeout(() => {
                    wrapper.classList.add('show-edit-btn');
                }, 2000);
            });

            wrapper.addEventListener('mouseleave', () => {
                // Clear timer and hide button
                if (scenarioDescHoverTimeout) {
                    clearTimeout(scenarioDescHoverTimeout);
                    scenarioDescHoverTimeout = null;
                }
                wrapper.classList.remove('show-edit-btn');
            });
        }

        // Open the scenario description editor modal
        function openScenarioDescEditor() {
            const modal = document.getElementById('scenarioDescEditModal');
            const textarea = document.getElementById('scenarioDescEditTextarea');

            if (modal && textarea) {
                // Get current text (strip HTML tags if any)
                const currentText = window.currentScenarioDescText || '';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = currentText;
                textarea.value = tempDiv.textContent || tempDiv.innerText || '';

                modal.classList.add('active');
            }
        }

        // Close the scenario description editor modal
        function closeScenarioDescEditor() {
            const modal = document.getElementById('scenarioDescEditModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Save the edited scenario description
        function saveScenarioDescEdit() {
            const textarea = document.getElementById('scenarioDescEditTextarea');
            const textWrapper = document.getElementById('scenarioDescText');

            if (textarea && textWrapper) {
                const newText = textarea.value.trim();

                // Update the displayed text
                textWrapper.innerHTML = newText;

                // Update the stored text for future edits
                window.currentScenarioDescText = newText;

                // Close the modal
                closeScenarioDescEditor();
            }
        }


        // Track which variables are currently displayed in macro card
        let execMacroSelectedVars = ['canadaGDP', 'unemployment', 'housePrice', 'tsx'];

        // All available macro variables
        const ALL_MACRO_VARS = {
            canadaGDP: { label: 'Canada GDP', key: 'canadaGDP' },
            unemployment: { label: 'Unemployment Rate', key: 'unemployment' },
            housePrice: { label: 'House Price Index (HPI)', key: 'housePrice' },
            tsx: { label: 'Equity (TSX)', key: 'tsx' },
            inflation: { label: 'CPI Inflation', key: 'inflation' },
            usdCad: { label: 'USD/CAD', key: 'usdCad' },
            bocRate: { label: 'BoC Rate', key: 'bocRate' },
            creditSpreads: { label: 'Credit Spreads', key: 'creditSpreads' }
        };

        function execAutoLinkMacro() {
            // Check if scenario is selected in description card first
            if (!execState.scenario) {
                alert('Please select a scenario in the Scenario Description card first. The macro variables will be automatically linked to that scenario.');
                return;
            }
            // Auto-link to the scenario already selected
            execState.macro = execState.scenario;
            renderExecMacro(execState.macro);
        }

        function renderExecMacro(data) {
            const container = document.getElementById('execMacroContent');
            container.className = '';
            container.onclick = null; // Remove click handler once populated

            // Parse macro data from saved scenario
            // The macros are saved as HTML in data.macros field
            const macrosHtml = data.macros || '';
            const parsedMacros = parseMacrosFromHtml(macrosHtml);

            // Store parsed macros for dropdown changes
            window.execCurrentMacroData = parsedMacros;

            renderMacroVariables(container, parsedMacros);
        }

        function parseMacrosFromHtml(html) {
            // Parse the macro projections from the saved HTML
            const macros = {};
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            const cards = tempDiv.querySelectorAll('.macro-card');
            cards.forEach(card => {
                const label = card.querySelector('.macro-label')?.textContent?.trim() || '';
                const value = card.querySelector('.macro-value')?.textContent?.trim() || 'N/A';
                const delta = card.querySelector('.macro-delta')?.textContent?.trim() || '';
                const valueEl = card.querySelector('.macro-value');
                const isNegative = valueEl?.classList.contains('negative');

                // Map label to key
                let key = '';
                if (label.toLowerCase().includes('gdp')) key = 'canadaGDP';
                else if (label.toLowerCase().includes('unemployment')) key = 'unemployment';
                else if (label.toLowerCase().includes('inflation') || label.toLowerCase().includes('cpi')) key = 'inflation';
                else if (label.toLowerCase().includes('usd') || label.toLowerCase().includes('cad')) key = 'usdCad';
                else if (label.toLowerCase().includes('boc') || label.toLowerCase().includes('rate')) key = 'bocRate';
                else if (label.toLowerCase().includes('house') || label.toLowerCase().includes('hpi')) key = 'housePrice';
                else if (label.toLowerCase().includes('tsx') || label.toLowerCase().includes('composite')) key = 'tsx';
                else if (label.toLowerCase().includes('credit') || label.toLowerCase().includes('spread')) key = 'creditSpreads';

                if (key) {
                    macros[key] = { value, delta, isNegative };
                }
            });

            return macros;
        }

        function renderMacroVariables(container, macros) {
            const selectedVars = execMacroSelectedVars;

            // Build dropdown options for each slot
            const buildDropdown = (slotIndex, currentKey) => {
                const options = Object.entries(ALL_MACRO_VARS).map(([key, info]) => {
                    const selected = key === currentKey ? 'selected' : '';
                    const disabled = selectedVars.includes(key) && key !== currentKey ? 'disabled' : '';
                    return `<option value="${key}" ${selected} ${disabled}>${info.label}</option>`;
                }).join('');

                return `
                    <select onchange="updateMacroSlot(${slotIndex}, this.value)" style="
                        font-size: 11px;
                        font-weight: 600;
                        color: #64748B;
                        background: transparent;
                        border: none;
                        cursor: pointer;
                        padding: 0;
                        margin-bottom: 4px;
                        width: 100%;
                        outline: none;
                        appearance: none;
                        -webkit-appearance: none;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    ">
                        ${options}
                    </select>
                `;
            };

            const varsHtml = selectedVars.map((key, idx) => {
                const info = ALL_MACRO_VARS[key];
                const data = macros[key] || { value: 'N/A', isNegative: true };
                const isNegativeOutcome = data.isNegative !== false; // Default to negative styling

                // Determine value color - red for negative outcomes, green for positive
                // Determine value color - Darker red/green for light theme
                const valueColor = isNegativeOutcome ? '#DC2626' : '#16A34A';

                return `
                    <div style="padding: 12px; background: #F8FAFC; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; min-height: 80px; border: 1px solid #E2E8F0;">
                        ${buildDropdown(idx, key)}
                        <div style="font-size: 18px; font-weight: 700; color: ${valueColor};">
                            ${data.value}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; height: 100%;">
                    ${varsHtml}
                </div>
                <div style="text-align: center; margin-top: 8px;">
                    <span style="font-size: 10px; color: rgba(255,255,255,0.5);">Click variable names to change</span>
                </div>
            `;
        }

        function updateMacroSlot(slotIndex, newKey) {
            // Update the selected variable for this slot
            execMacroSelectedVars[slotIndex] = newKey;

            // Re-render with updated selection
            const container = document.getElementById('execMacroContent');
            const macros = window.execCurrentMacroData || {};
            renderMacroVariables(container, macros);
        }

        function execAutoLinkTempBar() {
            // Open picker to select a CET1 calculation from folder
            openExecPickerNew('tempBar');
        }

        function renderExecWaterfall(data) {
            const container = document.getElementById('execWaterfallContent');
            container.className = '';
            container.onclick = null;
            container.style.height = '280px';
            container.style.padding = '0';

            // 1. Attempt to find component data
            let scenarioData = data.components || data.data?.components || null;
            if (!scenarioData && data.scenarioData) scenarioData = data.scenarioData;
            if (!scenarioData && data.data && data.data.scenarioData) scenarioData = data.data.scenarioData;
            if (!scenarioData && (data['PPNR'] || data['PCL'] || data['Net Income'])) {
                scenarioData = data;
            }

            // Check for severities (lightweight save format)
            const severities = data.componentSeverities || data.data?.componentSeverities;

            let isSimulated = false;

            // If we have neither direct data nor severities, check if it's a valid object to simulate
            if (!scenarioData && !severities) {
                if (data.name || data.title || data.id || Object.keys(data).length > 2) {
                    isSimulated = true;
                } else {
                    const keys = Object.keys(data).join(', ');
                    container.innerHTML = `
                        <div style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); text-align:center; padding:20px;">
                            <div style="font-size: 40px; margin-bottom: 12px;">âš ï¸</div>
                            <div style="font-size: 13px;">Calculation data unavailable.</div>
                            <div style="font-size: 10px; margin-top: 8px; color: #EF4444; font-family:monospace; word-break:break-all;">HasKeys: ${keys.substring(0, 100)}...</div>
                        </div>
                    `;
                    return;
                }
            }

            // Calculate waterfall data
            let jumpOff = typeof CET1_JUMP_OFF !== 'undefined' ? CET1_JUMP_OFF : 13.5;
            let troughCET1 = data.minimumRatio || data.troughCET1 || data.data?.minimumRatio || 10.0;

            const mainComps = ['PPNR', 'Dividend', 'Credit Provision', 'Market Risk Losses', 'Operational Risk Losses', 'Other', 'RWA - Credit', 'RWA - Market', 'RWA - Op Risk'];
            let finalImpactsValues = [];

            // Helper to get trough index
            let troughIndex = 9; // Default
            const path = data.calculatedPath || data.data?.calculatedPath;
            if (path && Array.isArray(path)) {
                let min = 999;
                path.forEach((v, i) => { if (v < min) { min = v; troughIndex = i; } });
            }

            if (severities && typeof cet1ScenarioData !== 'undefined' && typeof cet1CalculateAttributedBps !== 'undefined') {
                // METHOD A: Reconstruct Data & Use Official Calculation Engine
                const reconstructedData = {};
                const allKeys = [
                    'PPNR Canada', 'PPNR US', 'PPNR International',
                    'PCL Canada', 'PCL US', 'PCL International',
                    'Dividend', 'Trading PnL', 'AFS Losses', 'Operational Risk Losses',
                    'Currency Translation Adj', 'Shortfall in Allowance', 'Other',
                    'Credit RWA Change Canada', 'Credit RWA Change US', 'Credit RWA Change International',
                    'Market CCR CVA RWA Change', 'Operational Risk RWA Change'
                ];

                allKeys.forEach(k => {
                    const sev = severities[k] || 'benchmark';
                    if (cet1ScenarioData[sev] && cet1ScenarioData[sev][k]) {
                        reconstructedData[k] = cet1ScenarioData[sev][k];
                    } else if (cet1ScenarioData['severe'] && cet1ScenarioData['severe'][k]) {
                        reconstructedData[k] = cet1ScenarioData['severe'][k];
                    } else {
                        reconstructedData[k] = Array(20).fill(0);
                    }
                });

                const computedImpacts = cet1CalculateAttributedBps(reconstructedData, troughIndex);
                const computedSums = {};
                Object.keys(computedImpacts).forEach(k => {
                    computedSums[k] = computedImpacts[k].reduce((a, b) => a + b, 0);
                });

                finalImpactsValues = [
                    computedSums['PPNR'] || 0,
                    computedSums['Dividend'] || 0,
                    (computedSums['PCL'] || 0) + (computedSums['Shortfall in Allowance'] || 0),
                    (computedSums['Trading PnL'] || 0) + (computedSums['AFS Losses'] || 0),
                    computedSums['Operational Risk Losses'] || 0,
                    (computedSums['Other'] || 0) + (computedSums['Currency Translation Adj'] || 0),
                    computedSums['Credit RWA Change'] || 0,
                    computedSums['Market CCR CVA RWA Change'] || 0,
                    computedSums['Operational Risk RWA Change'] || 0
                ];
                isSimulated = false;

            } else if (!isSimulated && scenarioData) {
                // METHOD B: Direct Data Arrays Fallback
                const getSum = (key) => {
                    let val = scenarioData[key];
                    if (val === undefined && key === 'PCL') {
                        val = (scenarioData['PCL Canada'] || []).concat(scenarioData['PCL US'] || []);
                    }
                    if (Array.isArray(val)) return val.reduce((a, b) => a + b, 0);
                    if (typeof val === 'number') return val;
                    return 0;
                };

                const rawValues = [
                    getSum('PPNR'),
                    getSum('Dividend'),
                    getSum('PCL') + getSum('Shortfall in Allowance'),
                    getSum('Trading PnL') + getSum('AFS Losses'),
                    getSum('Operational Risk Losses'),
                    getSum('Other') + getSum('Currency Translation Adj'),
                    -(Math.abs(getSum('Credit RWA Change') || 0)),
                    -(Math.abs(getSum('Market CCR CVA RWA Change') || 0)),
                    -(Math.abs(getSum('Operational Risk RWA Change') || 0))
                ];
                finalImpactsValues = rawValues.map(v => Math.abs(v) > 5000 ? v / 10000 : v);
            } else {
                // METHOD C: Simulation Fallback
                finalImpactsValues = [-80, -35, -120, -50, -25, -5, -200, -20, -10];
            }

            // Prep Chart Values
            const startVal = (jumpOff > 1) ? jumpOff * 100 : jumpOff * 10000;
            const endVal = (troughCET1 > 1) ? troughCET1 * 100 : troughCET1 * 10000;

            let displayJumpOff = jumpOff > 1 ? jumpOff : jumpOff * 100;
            let displayTrough = troughCET1 > 1 ? troughCET1 : troughCET1 * 100;

            // Define bar chart data for waterfall effect
            const x = ['Jump-Off Q4/25'];
            const y = [startVal / 100]; // Convert to percentage
            const base = [0];
            const colors = ['#2563EB'];
            const texts = [displayJumpOff.toFixed(2) + '%'];

            let runningTotal = startVal / 100; // In percentage form

            // Categories mapping to finalImpactsValues indices
            const catLabels = ['PPNR', 'Dividend', 'Credit Provision', 'Market Risk Losses', 'Operational Risk Losses', 'Other', 'RWA', 'RWA', 'RWA'];

            // Calculate RWA Total for single label (convert to %)
            const rwaTotal = ((finalImpactsValues[6] || 0) + (finalImpactsValues[7] || 0) + (finalImpactsValues[8] || 0)) / 100;

            finalImpactsValues.forEach((val, i) => {
                const valPercent = val / 100; // Convert BPS to percentage
                x.push(catLabels[i]);
                y.push(valPercent);
                base.push(runningTotal);
                colors.push(valPercent >= 0 ? '#10B981' : '#EF4444');

                // Text Logic: Hide individual RWA labels, show Total on last RWA segment
                if (i === 6 || i === 7) {
                    texts.push('');
                } else if (i === 8) {
                    texts.push((rwaTotal > 0 ? '+' : '') + rwaTotal.toFixed(2) + '%');
                } else {
                    texts.push((valPercent > 0 ? '+' : '') + valPercent.toFixed(2) + '%');
                }

                // Update running total
                runningTotal += valPercent;
            });

            // Trough
            x.push('Trough');
            y.push(endVal / 100); // Convert to percentage
            base.push(0);
            colors.push('#2563EB');
            texts.push(displayTrough.toFixed(2) + '%');

            const chartId = 'execWaterfallPlotly';
            container.innerHTML = `<div id="${chartId}" style="width: 100%; height: 100%;"></div>`;

            const trace = {
                type: 'bar',
                x: x,
                y: y,
                base: base,
                marker: { color: colors },
                text: texts,
                textposition: 'outside',
                textfont: { size: 11, color: '#64748B' },
                cliponaxis: false
            };

            const layout = {
                barmode: 'overlay', // Crucial for stacking duplicates at same X
                font: { family: 'Inter, sans-serif' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    tickangle: -45,
                    tickfont: { size: 11, color: '#64748B' },
                    fixedrange: true
                },
                yaxis: {
                    title: { text: isSimulated ? 'CET1 Ratio (%) [Simulated]' : 'CET1 Ratio (%)', font: { size: 12 } },
                    gridcolor: '#F1F5F9',
                    zerolinecolor: '#CBD5E1',
                    fixedrange: true,
                    tickfont: { size: 11 },
                    ticksuffix: '%'
                },
                margin: { t: 20, b: 80, l: 50, r: 10 },
                showlegend: false,
                autosize: true
            };

            setTimeout(() => {
                if (typeof Plotly !== 'undefined') {
                    Plotly.newPlot(chartId, [trace], layout, { displayModeBar: false, responsive: true });
                }
            }, 100);
        }

        function renderExecTempBar(data) {
            const container = document.getElementById('execTempBarContent');
            container.className = '';
            container.onclick = null;

            // Reference values
            const jumpOff = typeof CET1_JUMP_OFF !== 'undefined' ? CET1_JUMP_OFF : 13.5;
            const maxScale = 15;

            // Custom scenario - full name
            const customName = data.name || data.title || 'Custom Scenario';
            // Check multiple possible locations for trough value
            const customTrough = data.troughCET1 || data.minimumRatio || data.data?.minimumRatio || 10.5;

            // All scenarios sorted by value
            const scenarios = [
                { name: 'V. Severe', value: data.troughVSevere || 8.3, color: '#DC2626' },
                { name: customName, value: customTrough, color: '#2563EB', isCustom: true },
                { name: 'Severe', value: data.troughSevere || 10.6, color: '#F59E0B' },
                { name: 'Moderate', value: data.troughModerate || 11.9, color: '#22C55E' },
                { name: 'Benchmark', value: data.troughBenchmark || 12.8, color: '#6B7280' },
                { name: 'Jump-Off Q4/25', value: jumpOff, color: '#1E293B' }
            ].sort((a, b) => a.value - b.value);

            const calcPos = (val) => Math.min(100, Math.max(0, (val / maxScale) * 100));

            // Smart staggering: 4 levels (above-high, above-low, below-low, below-high)
            // Track last used position at each level
            // Smart staggering: 6 levels to ensure no overlap
            const levelLastPos = { 0: -100, 1: -100, 2: -100, 3: -100, 4: -100, 5: -100 };
            const minGap = 18; // Reduced to 18 to allow specific pairing (V.Severe+Benchmark)

            // Assign each scenario to a level
            scenarios.forEach(s => {
                s.pos = calcPos(s.value);

                // Try levels in order
                const levelOrder = [0, 1, 2, 3, 4, 5];
                for (const lvl of levelOrder) {
                    if (s.pos - levelLastPos[lvl] >= minGap) {
                        s.level = lvl;
                        levelLastPos[lvl] = s.pos;
                        break;
                    }
                }
                if (s.level === undefined) s.level = 5;
            });

            // Level configurations: [isAbove, lineHeight, labelOffset]
            // Increased offsets significantly to clear larger font labels
            const levelConfig = {
                0: { above: true, lineHeight: 25, labelOffset: 29 },
                1: { above: false, lineHeight: 25, labelOffset: 29 },
                2: { above: true, lineHeight: 60, labelOffset: 64 },  // Clears Level 0 (35px gap)
                3: { above: false, lineHeight: 60, labelOffset: 64 },
                4: { above: true, lineHeight: 95, labelOffset: 99 }, // Clears Level 2 (35px gap)
                5: { above: false, lineHeight: 95, labelOffset: 99 }
            };

            const markersHtml = scenarios.map(s => {
                const cfg = levelConfig[s.level];
                const lineTop = cfg.above ? `bottom: 10px;` : `top: 10px;`;
                const labelPos = cfg.above
                    ? `bottom: ${cfg.labelOffset + 10}px;`
                    : `top: ${cfg.labelOffset + 10}px;`;

                // Build badge HTML for custom scenario if badge override exists
                let badgeCircle = '';
                if (s.isCustom && window.execState && window.execState.scenarioBadgeOverride && window.execState.scenario) {
                    const ov = window.execState.scenarioBadgeOverride;
                    const colorMap = { 'high': '#EF4444', 'med': '#F59E0B', 'low': '#10B981' };
                    const bg = colorMap[ov.velocity] || '#10B981';
                    badgeCircle = `<span style="
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        width: 16px;
                        height: 16px;
                        background: ${bg};
                        color: white;
                        border-radius: 50%;
                        font-size: 10px;
                        font-weight: 700;
                        margin-right: 4px;
                        flex-shrink: 0;
                    ">${ov.number}</span>`;
                }

                return `
                    <!-- Marker line -->
                    <div style="
                        position: absolute;
                        left: ${s.pos}%;
                        ${lineTop}
                        width: 2px;
                        height: ${cfg.lineHeight}px;
                        background: ${s.color};
                        transform: translateX(-50%);
                        z-index: 5;
                    "></div>
                    <!-- Label callout -->
                    <div style="
                        position: absolute;
                        left: ${s.pos}%;
                        ${labelPos}
                        transform: translateX(-50%);
                        background: ${s.color};
                        color: white;
                        padding: 4px 8px;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 700;
                        white-space: nowrap;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.25);
                        z-index: 10;
                        display: flex;
                        align-items: center;
                        ${s.isCustom ? 'border: 2px solid #1E40AF;' : ''}
                    ">
                        ${badgeCircle}${s.name}: ${s.value.toFixed(1)}%
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%; justify-content: center; padding: 0 8px;">
                    <!-- Temperature Bar with markers -->
                    <div style="position: relative; height: 10px; margin: 70px 0 70px 0;">
                        <!-- Gradient Bar -->
                        <div style="
                            position: absolute;
                            left: 0; right: 0;
                            top: 0;
                            height: 10px;
                            background: linear-gradient(to right, #DC2626 0%, #F59E0B 30%, #22C55E 55%, #10B981 75%, #3B82F6 100%);
                            border-radius: 5px;
                            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
                        "></div>
                        
                        ${markersHtml}
                    </div>
                    
                    <!-- Scale Labels -->
                    <div style="display: flex; justify-content: space-between; font-size: 8px; color: #64748B; font-weight: 500;">
                        <span>0% (MIN)</span>
                        <span>4.5% (CCB)</span>
                        <span>8.1% (DSB)</span>
                        <span>11.6%</span>
                        <span>15.0%</span>
                    </div>
                </div>
            `;
        }

        // Export Executive Report as Landscape US Letter PDF
        async function exportExecutiveReportPDF() {
            // Show loading overlay
            const loader = document.getElementById('loaderOverlay');
            const loaderText = document.querySelector('.loader-text');
            if (loader) {
                if (loaderText) loaderText.textContent = 'Generating PDF...';
                loader.style.display = 'flex';
            }

            const exportContainer = document.getElementById('pdfExportContainer');
            const exportGrid = exportContainer.querySelector('.pdf-grid');

            // Handle duplicate IDs by finding the VISIBLE one
            const panels = document.querySelectorAll('#executiveReportPanel');
            let sourcePanel = Array.from(panels).find(p => {
                const style = window.getComputedStyle(p);
                return style.display !== 'none' && style.visibility !== 'hidden';
            });
            // Fallback to last if none visible (unlikely) or first
            if (!sourcePanel) sourcePanel = panels.length > 0 ? panels[panels.length - 1] : document.getElementById('executiveReportPanel');

            const sourceGrid = sourcePanel.querySelector('.exec-grid-container');

            try {
                // 1. CLEAR & POPULATE EXPORT CONTAINER
                exportGrid.innerHTML = ''; // Clear previous

                // Clone all children from source grid
                Array.from(sourceGrid.children).forEach(child => {
                    // Deep clone
                    const clone = child.cloneNode(true);

                    // CRITICAL: Strip all IDs from clones to prevent duplicate ID conflicts
                    clone.removeAttribute('id');
                    clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));

                    // Modifying styles for PDF perfection
                    clone.style.boxShadow = 'none'; // Reduce shadow for flat print look
                    clone.style.background = 'transparent'; // Column bg transparent
                    clone.style.border = 'none'; // No border on column div
                    clone.style.backdropFilter = 'none';
                    clone.style.borderRadius = '0';
                    clone.style.color = '#334155'; // Ensure dark text color
                    clone.style.gap = '24px'; // Ensure gap between cards

                    // Style all cards inside the column
                    clone.querySelectorAll('.exec-card').forEach(card => {
                        card.style.boxShadow = 'none';
                        card.style.background = '#FFFFFF';
                        card.style.border = '1px solid #E2E8F0';
                        card.style.borderRadius = '16px';
                        card.style.overflow = 'hidden'; // Critical: prevents chart overflow
                        card.style.marginBottom = '24px'; // Gap between cards
                    });

                    // Ensure specific text elements are dark
                    clone.querySelectorAll('*').forEach(el => {
                        const computed = window.getComputedStyle(el);
                        // If color is white (from old dark mode styles?), force dark
                        if (computed.color === 'rgb(255, 255, 255)' || computed.color === 'rgba(255, 255, 255, 0.9)') {
                            el.style.color = '#334155';
                        }
                    });

                    // FIX MACRO TITLES: convert select elements to divs for perfect PDF rendering
                    // This fixes the 'cut-off' text issue
                    clone.querySelectorAll('select').forEach(select => {
                        const selectedText = select.options[select.selectedIndex]?.text || '';
                        const div = document.createElement('div');
                        div.textContent = selectedText;
                        div.style.fontSize = '13px'; // slightly larger for readability
                        div.style.fontWeight = '700'; /* Bold for header look */
                        div.style.color = '#003168'; /* Navy text */
                        div.style.marginBottom = '4px';
                        div.style.textTransform = 'uppercase';
                        select.parentNode.replaceChild(div, select);
                    });

                    // REMOVE "See all" buttons for PDF - Strict Check
                    clone.querySelectorAll('.exec-see-all, div').forEach(el => {
                        if (el.classList.contains('exec-see-all') || el.textContent.trim() === 'See all') {
                            el.remove();
                            el.style.setProperty('display', 'none', 'important');
                        }
                    });

                    // Remove legacy footer if caught in grid
                    clone.querySelectorAll('#execFooter').forEach(el => el.remove());

                    // REMOVE "click variable names to change" hint for PDF
                    // Usually this is a small text at bottom of macro card
                    clone.querySelectorAll('div, span, p').forEach(el => {
                        // Check exact text or partial match, ensure we don't hide parents
                        if (el.children.length === 0 && el.textContent.toLowerCase().includes('click variable names to change')) {
                            el.style.display = 'none';
                        }
                    });

                    // FIX SCENARIO TEXT SCALING
                    // Reduce font size in PDF to ensure it fits validly like the web view
                    const descriptionContent = clone.querySelector('#execScenarioDescContent');
                    if (descriptionContent) {
                        // Target the inner text container specifically
                        // The structure is: parent > flex column > header > scrollable content
                        const scrollableDiv = descriptionContent.querySelector('div[style*="overflow-y"]');
                        if (scrollableDiv) {
                            // Adjust the text directly inside
                            scrollableDiv.style.fontSize = '18px';
                            scrollableDiv.style.lineHeight = '1.6';
                        }

                        // General fallback: reduce any 14px text in this card
                        descriptionContent.querySelectorAll('*').forEach(el => {
                            const style = window.getComputedStyle(el);
                            if (style.fontSize === '14px' || style.fontSize === '16px' || style.fontSize === '18px') {
                                el.style.fontSize = '18px';
                                el.style.lineHeight = '1.6';
                            }
                        });
                    }

                    exportGrid.appendChild(clone);
                });

                // 2. APPLY LIGHT GREY-BLUE GRADIENT BACKGROUND
                exportContainer.style.background = `
                    linear-gradient(155deg, transparent 0%, transparent 60%, rgba(200, 215, 230, 0.5) 70%, rgba(220, 230, 240, 0.4) 85%, transparent 100%),
                    linear-gradient(135deg, #E8EDF2 0%, #DCE3EA 30%, #D0DAE4 60%, #E4EAF0 100%)
                `;
                exportContainer.style.backgroundSize = 'cover';
                exportContainer.style.backgroundPosition = 'center';

                // Make it visible to html2canvas (but kept behind other content via z-index)
                exportContainer.style.visibility = 'visible';

                // Update Header for PDF - Robust Selector
                // Update Header for PDF - Robust Selector & Color
                const exportHeader = document.querySelector('#pdfExportContainer .pdf-logo');
                if (exportHeader) {
                    const now = new Date();
                    const titleDate = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                    exportHeader.innerHTML = `Astra | Capital Pulse Brief <span style="font-size: 20px; font-weight: 400; color: #64748B; margin-left: 16px;">${titleDate}</span>`;
                    exportHeader.style.color = '#003168'; // Force RBC Navy
                    exportHeader.style.textShadow = 'none';
                    exportHeader.style.display = 'flex';
                    exportHeader.style.alignItems = 'center';
                }

                // Inject Dynamic Footer into the Container (Inside the "box")
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

                const footerDiv = document.createElement('div');
                footerDiv.id = 'pdfExportFooter'; // Unique ID for cleanup
                footerDiv.textContent = `Produced by CEST Analytics | Generated on ${dateStr} at ${timeStr}`;
                footerDiv.style.position = 'absolute';
                footerDiv.style.bottom = '16px';
                footerDiv.style.right = '40px';
                footerDiv.style.color = '#64748B'; // Slate Grey
                footerDiv.style.fontSize = '14px'; // Larger font
                footerDiv.style.fontWeight = '500';
                footerDiv.style.zIndex = '100';

                // Store original position and temporarily change
                const originalPosition = exportContainer.style.position;
                exportContainer.style.position = 'relative'; // Ensure context for absolute footer
                exportContainer.appendChild(footerDiv);

                // Wait for content layout
                await new Promise(r => setTimeout(r, 500));

                // 3. CAPTURE - Fix height calculation
                // Temporarily set overflow visible to get accurate height
                const originalOverflow = exportContainer.style.overflow;
                exportContainer.style.overflow = 'visible';

                // Calculate actual content height from grid + header + footer padding
                // Use explicit sum to avoid stale scrollHeight issues and reduce bottom gap
                const headerHeight = exportContainer.querySelector('.pdf-header')?.offsetHeight || 80;
                const gridHeight = exportGrid.scrollHeight;
                const totalHeight = headerHeight + gridHeight + 60;

                // CRITICAL: Set explicit height on container so gradient background extends fully
                const originalHeight = exportContainer.style.minHeight;
                exportContainer.style.minHeight = totalHeight + 'px';
                exportContainer.style.height = totalHeight + 'px';

                // Wait for layout recalc
                await new Promise(r => setTimeout(r, 100));

                const canvas = await html2canvas(exportContainer, {
                    scale: 1.5,
                    useCORS: false,
                    allowTaint: false,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0,
                    width: 1600,
                    height: totalHeight,
                    backgroundColor: '#FFFFFF' // White background for corners
                });

                // Restore overflow and height
                exportContainer.style.overflow = originalOverflow || 'hidden';
                exportContainer.style.minHeight = originalHeight || '';
                exportContainer.style.height = '';

                // 4. GENERATE PDF - Custom size to match content exactly (no whitespace)
                const { jsPDF } = window.jspdf;

                // Convert pixels to mm for PDF sizing (1px = 0.264583mm approx)
                const pxToMm = 0.264583;
                const imgWidthMm = canvas.width * pxToMm;
                const imgHeightMm = canvas.height * pxToMm;

                // Add margins to page (10mm on each side)
                const margin = 10;
                const pageWidthMm = imgWidthMm + (margin * 2);
                const pageHeightMm = imgHeightMm + (margin * 2);

                const pdf = new jsPDF({
                    orientation: pageWidthMm > pageHeightMm ? 'landscape' : 'portrait',
                    unit: 'mm',
                    format: [pageWidthMm, pageHeightMm]
                });

                // Use JPEG with 0.8 quality for much smaller file size
                const imgData = canvas.toDataURL('image/jpeg', 0.8);

                // PDF Background White
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidthMm, pageHeightMm, 'F');

                // Footer added via HTML injection above

                // Add image centered with margin
                pdf.addImage(imgData, 'JPEG', margin, margin, imgWidthMm, imgHeightMm);

                const fileName = `Astra_Executive_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

            } catch (error) {
                console.error('PDF Export Error:', error);
                alert('Export failed: ' + error.message);
            } finally {
                // CLEANUP - Restore state and clear DOM
                if (loader) loader.style.display = 'none';

                // Restore original container position
                exportContainer.style.position = 'fixed';
                exportContainer.style.visibility = 'hidden';

                // Remove injected footer
                const injectedFooter = document.getElementById('pdfExportFooter');
                if (injectedFooter) injectedFooter.remove();

                // Clear cloned content
                exportGrid.innerHTML = '';
            }
        }
    </script>
    <!-- Dedicated PDF Export Container (Hidden/Off-screen usually) -->
    <div id="pdfExportContainer" class="pdf-export-container"
        style="position: fixed; top: 0; left: 0; width: 1600px; border-radius: 24px; overflow: hidden; z-index: -9999; visibility: hidden;">
        <!-- Header -->
        <div class="pdf-header"
            style="padding: 40px 40px 20px 64px; display: flex; justify-content: space-between; align-items: center;">
            <div class="pdf-logo" style="font-size: 32px; font-weight: 700; color: #003168; letter-spacing: -0.02em;">
                Astra | Capital Pulse Brief</div>
        </div>

        <!-- Grid -->
        <div class="pdf-grid" style="display: flex; align-items: stretch; gap: 24px; padding: 0 40px 40px 40px;">
            <!-- Content will be cloned here -->
        </div>
    </div>

    <!-- Executive Report Panel -->
    <div id="executiveReportPanel" class="report-panel exec-glass-bg"
        style="display: none; height: 100vh; overflow-y: auto;">
        <!-- Header for Logo -->
        <div class="exec-logo">Astra | Capital Pulse Brief</div>

        <div class="exec-grid-container">
            <!-- Left Column -->
            <div style="flex: 2.1; display: flex; flex-direction: column; gap: 24px;">
                <!-- Heat Map -->
                <div class="exec-card" style="min-height: 500px;" onclick="if(!execState.heatMap) execPickHeatMap()">
                    <div class="exec-card-header">
                        <div class="exec-card-title">Heat Map</div>

                    </div>
                    <div id="execHeatMapContent" class="exec-content-area">
                        <div class="exec-empty-state">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">ðŸ“Š</div>
                                <div>Select Heat Map</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Minimum Pre-MA CET1 Ratio -->
                <div class="exec-card" style="height: 380px;" onclick="if(!execState.tempBar) execPickTempBar()">
                    <div class="exec-card-header">
                        <div class="exec-card-title">Minimum Pre-MA CET1 Ratio</div>
                    </div>
                    <div id="execTempBarContent" class="exec-content-area">
                        <div class="exec-empty-state">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">ðŸŒ¡ï¸</div>
                                <div>Select Calculation</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div style="flex: 0.9; display: flex; flex-direction: column; gap: 24px;">
                <!-- Scenario Description & Macro Variables -->
                <div class="exec-card" style="min-height: 580px;" onclick="if(!execState.scenario) execPickScenario()">
                    <div class="exec-card-header">
                        <div class="exec-card-title">Scenario Description</div>
                    </div>
                    <div id="execScenarioDescContent" class="exec-content-area"
                        style="flex: 1; margin-bottom: 24px; min-height: 200px;">
                        <div class="exec-empty-state">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">ðŸ“</div>
                                <div>Select Scenario</div>
                            </div>
                        </div>
                    </div>

                    <!-- Moved Macro Projections -->
                    <div style="border-top: 1px solid #F1F5F9; padding-top: 20px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: #003168; margin-bottom: 16px;">Major
                            Macro
                            Variable Projections</h4>
                        <div id="execMacroContent" class="exec-content-area">
                            <div class="exec-empty-state" style="min-height: 120px;"
                                onclick="if(execState.scenario && !execState.macro) execAutoLinkMacro()">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">ðŸ“ˆ</div>
                                    <div>Auto-linked to Scenario</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sector Analysis (Future Content) -->
                <div class="exec-card" style="height: 250px;">
                    <div class="exec-card-header">
                        <div class="exec-card-title">Sector Analysis (future content)</div>
                    </div>
                    <div class="exec-content-area">
                        <div class="exec-empty-state">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">âœ¨</div>
                                <div>Coming Soon</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <!-- Footer Removed -->

            <!-- Floating PDF Button -->
            <button class="astra-btn astra-btn-primary"
                style="position: fixed; bottom: 30px; right: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 100;"
                onclick="exportExecutiveReportPDF()">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export PDF
                </div>
            </button>
        </div>
    </div>

    <!-- Exec Picker Modal -->
    <div class="exec-picker-modal" id="execPickerModal">
        <div class="exec-picker-content">
            <h3 style="margin-bottom: 16px;">Select Item from Folder</h3>
            <div id="execPickerList" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Items injected here -->
            </div>
            <div style="margin-top: 16px; text-align: right;">
                <button class="astra-btn astra-btn-secondary" onclick="closeExecPicker()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Badge Editor Modal -->
    <div class="exec-picker-modal" id="execBadgeModal" style="z-index: 10001;">
        <div class="exec-picker-content" style="width: 400px;">
            <h3 style="margin-bottom: 20px;">Link to Heat Map Driver</h3>

            <div style="margin-bottom: 20px;">
                <label
                    style="display: block; font-size: 13px; font-weight: 600; color: #64748B; margin-bottom: 8px;">Driver
                    Number</label>
                <input type="number" id="badgeNumberInput" placeholder="e.g. 5" min="1" max="99" style="
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid #E2E8F0;
                    border-radius: 8px;
                    font-size: 14px;
                    outline: none;
                ">
            </div>

            <div style="margin-bottom: 24px;">
                <!-- Velocity removed - auto-detected -->

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="astra-btn astra-btn-secondary" onclick="clearBadgeOverride()"
                        style="color: #DC2626;">Clear Link</button>
                    <div style="display: flex; gap: 8px;">
                        <button class="astra-btn astra-btn-secondary" onclick="closeBadgeModal()">Cancel</button>
                        <button class="astra-btn astra-btn-primary" onclick="saveBadgeOverride()">Save Link</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.onload = function () {
            // Initialize data
            if (!window.savedScenarios) window.savedScenarios = [];

            // Render initial view (Marketplace)
            if (typeof renderMarketplace === 'function') {
                renderMarketplace();
            } else {
                console.error("renderMarketplace not found");
            }

            // Update UI
            if (typeof updateBasketCount === 'function') updateBasketCount();

            // Reset Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find Marketplace nav - usually the first one or by title
            const marketNav = Array.from(document.querySelectorAll('.nav-item')).find(el => el.textContent.includes('Marketplace') || el.title === 'Risk Driver Marketplace');
            if (marketNav) marketNav.classList.add('active');
        };

        // --- BADGE EDITOR LOGIC ---

        function openBadgeEditor() {
            document.getElementById('execBadgeModal').style.display = 'flex';

            // Pre-fill if override exists
            if (window.execState && window.execState.scenarioBadgeOverride) {
                document.getElementById('badgeNumberInput').value = window.execState.scenarioBadgeOverride.number;
            } else {
                document.getElementById('badgeNumberInput').value = '';
            }
        }

        function closeBadgeModal() {
            document.getElementById('execBadgeModal').style.display = 'none';
        }

        function saveBadgeOverride() {
            try {
                const numVal = document.getElementById('badgeNumberInput').value;
                const num = parseInt(numVal, 10);

                if (!num || isNaN(num)) return alert('Please enter a valid driver number');

                // Auto-detect velocity from Heat Map ('high' if driver not found)
                let velocity = 'high';

                // Check both casing variants
                const hm = window.execState.heatMap || window.execState.heatmap;
                console.log("Heatmap data:", hm);

                if (hm && hm.drivers) {
                    const drivers = hm.drivers;
                    // Use heatMapData (matching renderExecHeatMap) not mapData
                    const mapData = hm.heatMapData || {};
                    console.log("Drivers:", drivers);
                    console.log("HeatMapData:", mapData);

                    // Driver number matches index+1
                    const driverIndex = num - 1;
                    console.log("Looking for driver index:", driverIndex, "for number:", num);

                    if (driverIndex >= 0 && driverIndex < drivers.length) {
                        const d = drivers[driverIndex];
                        console.log("Driver found:", d);

                        const dData = mapData[d.id] || {}; // Default to empty object like renderer
                        console.log("Driver data:", dData);

                        // Match logic from renderExecHeatMap exactly:
                        // velColor = dData.velocity === 3 ? '#EF4444' : dData.velocity === 2 ? '#F59E0B' : '#10B981'
                        // Use == for type coercion (velocity might be string or number)
                        const vel = dData.velocity;
                        console.log("Velocity value:", vel, "type:", typeof vel);

                        // Use Number() to ensure consistent comparison
                        const velNum = Number(vel);
                        if (velNum === 3) velocity = 'high';
                        else if (velNum === 2) velocity = 'med';
                        else velocity = 'low'; // Default to low/green, matching renderer

                        console.log("Determined velocity:", velocity);
                    } else {
                        console.warn("Driver index out of range");
                    }
                } else {
                    console.warn("No heatmap data available. execState:", window.execState);
                }

                if (!window.execState) window.execState = {};

                // Save to state
                window.execState.scenarioBadgeOverride = {
                    number: num,
                    velocity: velocity
                };

                // Just update the badge visually without regenerating content
                updateScenarioBadgeDisplay();
                closeBadgeModal();
            } catch (e) {
                console.error("Error saving badge:", e);
                alert("An error occurred: " + e.message);
            }
        }

        function updateScenarioBadgeDisplay() {
            // Update badge in scenario description card
            const scenarioContainer = document.getElementById('execScenarioDescContent');
            if (scenarioContainer && window.execState.scenarioBadgeOverride) {
                const ov = window.execState.scenarioBadgeOverride;
                const colorMap = { 'high': '#EF4444', 'med': '#F59E0B', 'low': '#10B981' };
                const bg = colorMap[ov.velocity] || '#EF4444';

                const badgeHtml = `<div onclick="event.stopPropagation(); openBadgeEditor()" style="
                    display: inline-flex;
                    cursor: pointer;
                    align-items: center;
                    justify-content: center;
                    width: 28px;
                    height: 28px;
                    background: ${bg};
                    color: white;
                    border-radius: 50%;
                    font-size: 14px;
                    font-weight: 700;
                    margin-right: 12px;
                    flex-shrink: 0;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Click to edit">${ov.number}</div>`;

                // Find and update just the badge element
                const titleDiv = scenarioContainer.querySelector('div[style*="display: flex"]');
                if (titleDiv) {
                    const existingBadge = titleDiv.querySelector('div[onclick*="openBadgeEditor"]');
                    if (existingBadge) {
                        existingBadge.outerHTML = badgeHtml;
                    } else {
                        titleDiv.insertAdjacentHTML('afterbegin', badgeHtml);
                    }
                }
            }

            // Update badge in temperature bar if needed
            if (window.execState.tempBar) {
                renderExecTempBar(window.execState.tempBar);
            }
        }

        function clearBadgeOverride() {
            try {
                if (window.execState.scenarioBadgeOverride) {
                    delete window.execState.scenarioBadgeOverride;
                    // Just update the badge display without regenerating content
                    updateScenarioBadgeDisplay();
                }
                closeBadgeModal();
            } catch (e) {
                console.error("Error clearing badge:", e);
            }
        }

        function saveExecutiveReport() {
            try {
                // Check if report has content
                if (!window.execState || (!window.execState.scenario && !window.execState.heatMap && !window.execState.tempBar)) {
                    alert('Please add content to the executive report before saving.');
                    return;
                }

                // Get report name from scenario or prompt user
                let reportName = window.execState.scenario?.title || window.execState.scenario?.name || 'Executive Report';

                const customName = prompt('Enter a name for this executive report:', reportName);
                if (!customName) return; // User cancelled

                const timestamp = Date.now();
                const dateStr = new Date().toLocaleDateString();

                // Create report data object with SANITIZED state
                const reportData = {
                    id: 'exec_' + timestamp,
                    type: 'executive_report',
                    title: customName,
                    date: dateStr,
                    timestamp: timestamp,
                    execState: sanitizeExecState(window.execState)
                };

                // Add to savedScenarios
                if (typeof savedScenarios === 'undefined') savedScenarios = [];

                // Check if updating existing report
                const existingIdx = savedScenarios.findIndex(s => s.id === reportData.id || (s.title === customName && s.type === 'executive_report'));
                if (existingIdx > -1) {
                    savedScenarios[existingIdx] = reportData;
                } else {
                    savedScenarios.push(reportData);
                }

                // Save using the robust function
                saveScenariosToStorage();

                // Update folder UI
                if (typeof renderSavedScenarios === 'function') {
                    renderSavedScenarios();
                }

                alert(`âœ… Executive report "${customName}" saved to folder!`);
            } catch (e) {
                console.error('Error saving executive report:', e);
                alert('Failed to save executive report: ' + e.message);
            }
        }


        // ========================================
        // PLAYGROUND FUNCTIONS //
        // ========================================

        let currentPlaygroundDrivers = [];

        function showPlayground() {
            // Hide other specific panels used in other views
            const panels = [
                'marketplacePanel', 'savedScenariosPanel', 'heatMapPanel',
                'cet1AnalysisPanel', 'executiveReportPanel', 'execPickerModal',
                'basketPanel', 'heatmapBasketPanel'
            ];
            panels.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Show Playground
            const playground = document.getElementById('playgroundPanel');
            if (playground) playground.style.display = 'flex';

            // Update nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navItem = document.querySelector('.nav-item[title="Playground"]');
            if (navItem) navItem.classList.add('active');
        }

        async function handlePlaygroundEnter(e) {
            if (e.key === 'Enter') submitPlaygroundChat();
        }

        async function submitPlaygroundChat() {
            const input = document.getElementById('playgroundChatInput');
            const val = input.value.trim();
            if (!val) return;

            const loader = document.getElementById('playgroundLoader');
            loader.style.display = 'flex';
            input.disabled = true;

            // Context: Existing drivers on board
            const existingContext = currentPlaygroundDrivers.map(d => `${d.title}: ${d.description}`).join('\n');

            const prompt = `User Request: "${val}"
            
            Current Canvas Ideas:
            ${existingContext}
            
            Task:
            1. If the user is asking to create new ideas, generate 1 to 4 CREATIVE, FORWARD-LOOKING risk driver concepts (Style: Mixboard/Brainstorming).
            2. If the user is asking to refine, update the existing ideas based on the request.

            Return a JSON object:
            {
               "newDrivers": [ { "category": "Macroeconomic | Geopolitical | Cyber | Financial | Environmental | Social", "title": "Concise Title", "description": "Brief description..." } ],
               "updatedDrivers": [ { "originalTitle": "Exact Title of existing driver", "newTitle": "Optional new title", "newDescription": "Optional new description" } ]
            }
            
            Output ONLY JSON.
            `;

            try {
                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 3000
                    })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const content = data.choices[0].message.content;

                let result = {};
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) result = JSON.parse(jsonMatch[0]);
                } catch (e) { console.error(e); }

                // Handle New Drivers
                if (result.newDrivers && Array.isArray(result.newDrivers)) {
                    document.getElementById('playgroundPlaceholder').style.display = 'none';
                    result.newDrivers.forEach(d => {
                        d.id = 'pg_' + Date.now() + Math.random().toString(36).substr(2, 5);
                        currentPlaygroundDrivers.push(d);
                    });
                }

                // Handle Updates
                if (result.updatedDrivers) {
                    result.updatedDrivers.forEach(u => {
                        const match = currentPlaygroundDrivers.find(d => d.title === u.originalTitle || d.title === u.title);
                        if (match) {
                            if (u.newTitle) match.title = u.newTitle;
                            if (u.newDescription) match.description = u.newDescription;
                        }
                    });
                }

                renderPlaygroundCards();
                input.value = '';

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                loader.style.display = 'none';
                input.disabled = false;
                input.focus();
            }
        }

        function renderPlaygroundCards() {
            const container = document.getElementById('playgroundCanvas');
            container.innerHTML = '';

            if (currentPlaygroundDrivers.length === 0) {
                container.innerHTML = `
                     <div id="playgroundPlaceholder" style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; text-align: center; opacity: 0.6;">
                         <div style="font-size: 48px; margin-bottom: 20px;">âœ¨</div>
                         <h2 style="font-size: 24px; color: #1f2937; margin-bottom: 12px; font-weight: 600;">Explore your ideas</h2>
                         <p style="color: #6b7280; max-width: 400px; line-height: 1.5;">
                            Describe a risk scenario or upload a document to brainstorm creative risk drivers.
                         </p>
                     </div>`;
                return;
            }

            currentPlaygroundDrivers.forEach(d => {
                const card = document.createElement('div');
                Object.assign(card.style, {
                    background: 'white', border: '1px solid #e5e7eb', borderRadius: '16px', padding: '24px',
                    boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', display: 'flex', flexDirection: 'column', gap: '16px',
                    transition: 'all 0.2s', position: 'relative'
                });

                // Build source info if from news
                let sourceHtml = '';
                if (d.sourceArticle || d.sourceUrl) {
                    sourceHtml = `
                            <div style="font-size: 11px; color: #94A3B8; margin-top: -8px; display: flex; align-items: center; gap: 6px;">
                                ðŸ“° Source: ${d.sourceUrl ? `<a href="${d.sourceUrl}" target="_blank" style="color: #2563EB; text-decoration: none;">${d.sourceArticle || 'Axios Article'}</a>` : (d.sourceArticle || 'News')}
                            </div>
                        `;
                }

                card.innerHTML = `
                    <div style="font-size: 12px; font-weight: 700; color: #2563EB; letter-spacing: 0.05em; text-transform: uppercase;">${d.category || 'Idea'}</div>
                    <h3 style="font-size: 18px; font-weight: 700; color: #111827; margin: 0; line-height: 1.4;">${d.title}</h3>
                    ${sourceHtml}
                    <p style="font-size: 14px; color: #4b5563; line-height: 1.6; flex: 1;">${d.description}</p>
                    <div style="padding-top: 16px; border-top: 1px solid #f3f4f6; display: flex; align-items: center; justify-content: space-between;">
                         <button onclick="exportPlaygroundDriver('${d.id}')" 
                            style="background: #F3F4F6; color: #374151; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                            Export
                        </button>
                        <div style="font-size: 20px; opacity: 0.5;">${d.sourceUrl ? 'ðŸ“°' : 'âœ¨'}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function exportPlaygroundDriver(id) {
            const d = currentPlaygroundDrivers.find(driver => driver.id === id);
            if (!d) return;

            const newId = 'cust_' + Date.now();
            INITIAL_DRIVERS.push({
                id: newId,
                cat: 'Customized',
                title: d.title,
                desc: d.description,
                tagColor: '#CFFAFE',
                textColor: '#0E7490',
                chatHistory: [{ role: 'ai', text: 'Imported from Playground.' }]
            });
            saveCustomDrivers();
            alert('Driver exported to Risk Drivers view!');
            showMarketplace();
            setTimeout(() => openDriverDetails(newId), 500);
        }

        // =============================================
        // NEWS SCANNER FUNCTIONS
        // =============================================
        const NEWS_FEEDS = {
            politics: 'https://www.axios.com/politics-policy/rss',
            world: 'https://www.axios.com/world/rss',
            business: 'https://www.axios.com/business/rss',
            economy: 'https://www.axios.com/economy/rss',
            technology: 'https://www.axios.com/technology/rss',
            main: 'https://www.axios.com/feeds/feed.rss'
        };

        let currentNewsArticles = [];
        let selectedNewsArticle = null;

        function openNewsModal() {
            document.getElementById('newsModal').style.display = 'flex';
            // Auto-load politics feed
            selectNewsFeed('politics');
        }

        function closeNewsModal() {
            document.getElementById('newsModal').style.display = 'none';
            selectedNewsArticle = null;
            document.getElementById('newsPreview').style.display = 'none';
        }

        async function selectNewsFeed(feedKey) {
            // Update tab styling
            document.querySelectorAll('.news-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.feed === feedKey) tab.classList.add('active');
            });

            const feedUrl = NEWS_FEEDS[feedKey];
            const loading = document.getElementById('newsLoading');
            const list = document.getElementById('newsList');

            loading.style.display = 'block';
            list.innerHTML = '';
            selectedNewsArticle = null;
            document.getElementById('newsPreview').style.display = 'none';

            try {
                // Use a CORS proxy to fetch RSS
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(feedUrl)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();

                if (!data.contents) throw new Error('Failed to fetch feed');

                // Parse RSS XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data.contents, 'text/xml');
                const items = xmlDoc.querySelectorAll('item');

                currentNewsArticles = [];
                items.forEach((item, index) => {
                    const title = item.querySelector('title')?.textContent || 'No title';
                    const description = item.querySelector('description')?.textContent || '';
                    const link = item.querySelector('link')?.textContent || '';
                    const pubDate = item.querySelector('pubDate')?.textContent || '';

                    // Clean HTML from description
                    const cleanDesc = description.replace(/<[^>]*>/g, '').substring(0, 200);

                    currentNewsArticles.push({
                        id: index,
                        title: title,
                        description: cleanDesc,
                        link: link,
                        pubDate: pubDate,
                        category: feedKey
                    });
                });

                renderNewsArticles();
            } catch (error) {
                console.error('Error fetching news:', error);
                list.innerHTML = `
                        <div style="text-align: center; color: #EF4444; padding: 40px;">
                            <div style="font-size: 32px; margin-bottom: 12px;">âš ï¸</div>
                            <div>Failed to load news feed. Please try again.</div>
                            <div style="font-size: 12px; margin-top: 8px; color: #94A3B8;">${error.message}</div>
                        </div>
                    `;
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderNewsArticles() {
            const list = document.getElementById('newsList');

            if (currentNewsArticles.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #64748B; padding: 40px;">No articles found.</div>';
                return;
            }

            list.innerHTML = currentNewsArticles.map(article => `
                    <div class="news-item ${selectedNewsArticle?.id === article.id ? 'selected' : ''}" 
                         onclick="selectNewsArticle(${article.id})">
                        <div class="news-item-title">${article.title}</div>
                        <div class="news-item-desc">${article.description}</div>
                        <div class="news-item-meta">
                            <span>ðŸ“… ${formatNewsDate(article.pubDate)}</span>
                            <span>ðŸ”— <a href="${article.link}" target="_blank" onclick="event.stopPropagation()" style="color: #2563EB;">Read full article</a></span>
                        </div>
                    </div>
                `).join('');
        }

        function formatNewsDate(dateStr) {
            if (!dateStr) return 'Unknown date';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }

        function selectNewsArticle(id) {
            selectedNewsArticle = currentNewsArticles.find(a => a.id === id);
            if (!selectedNewsArticle) return;

            // Update UI
            document.querySelectorAll('.news-item').forEach(item => item.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // Show preview
            document.getElementById('newsPreviewTitle').textContent = selectedNewsArticle.title;
            document.getElementById('newsPreview').style.display = 'block';
        }

        async function generateRiskFromNews() {
            if (!selectedNewsArticle) {
                alert('Please select a news article first.');
                return;
            }

            closeNewsModal();

            // Show playground and loading
            showPlayground();
            const loader = document.getElementById('playgroundLoader');
            loader.style.display = 'flex';
            loader.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite;"></span> Generating risk analysis from news...';

            const prompt = `Analyze this news article and generate a risk driver concept for a bank's stress testing and risk management:

Article Title: "${selectedNewsArticle.title}"
Article Summary: "${selectedNewsArticle.description}"
Category: ${selectedNewsArticle.category}
Source: Axios

Task: Create 1 risk driver that captures the potential financial/operational risk implications of this news for a major bank (RBC). Be specific about how this news could impact capital, credit risk, market risk, or operational risk.

Return a JSON object:
{
   "newDrivers": [ { 
       "category": "Macroeconomic | Geopolitical | Cyber | Financial | Environmental | Social | Regulatory", 
       "title": "Concise Risk Title", 
       "description": "2-3 sentence description of the risk and its potential impact on the bank...",
       "sourceArticle": "${selectedNewsArticle.title}"
   } ]
}

Output ONLY JSON.`;

            try {
                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-5-2025-08-07-eastus-dz',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1500
                    })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const content = data.choices[0].message.content;

                let result = {};
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) result = JSON.parse(jsonMatch[0]);
                } catch (e) { console.error(e); }

                if (result.newDrivers && Array.isArray(result.newDrivers)) {
                    document.getElementById('playgroundPlaceholder').style.display = 'none';
                    result.newDrivers.forEach(d => {
                        d.id = 'news_' + Date.now() + Math.random().toString(36).substr(2, 5);
                        d.sourceUrl = selectedNewsArticle.link;
                        currentPlaygroundDrivers.push(d);
                    });
                }

                renderPlaygroundCards();

            } catch (error) {
                alert('Error generating risk card: ' + error.message);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Make news functions globally accessible
        window.openNewsModal = openNewsModal;
        window.closeNewsModal = closeNewsModal;
        window.selectNewsFeed = selectNewsFeed;
        window.selectNewsArticle = selectNewsArticle;
        window.generateRiskFromNews = generateRiskFromNews;

        async function extractTextFromPDF(file) {
            try {
                // Configure PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';

                // Extract text from all pages (limit to first 10 pages for performance)
                const numPages = Math.min(pdf.numPages, 10);
                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                return fullText;
            } catch (error) {
                console.error('PDF extraction error:', error);
                throw new Error('Failed to extract text from PDF. The file may be corrupted or password-protected.');
            }
        }

        async function handlePlaygroundFile(input) {
            const file = input.files[0];
            if (!file) return;

            const loader = document.getElementById('playgroundLoader');
            loader.style.display = 'flex';
            loader.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite;"></span> Reading file...';

            try {
                let text = '';

                // Check if file is PDF
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    loader.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite;"></span> Extracting text from PDF...';
                    text = await extractTextFromPDF(file);
                } else {
                    // Read as text file
                    text = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('Error reading file. Please make sure it is a valid text file.'));
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsText(file);
                    });
                }

                // Validate that we got readable text content
                if (!text || text.trim().length === 0) {
                    throw new Error('Could not extract any text from the file. Please ensure the file contains readable content.');
                }

                loader.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite;"></span> AI is analyzing...';

                const prompt = `Analyze this document and generate 1-4 risk drivers: \n\n ${text.substring(0, 5000)}`;

                // Populate input and submit via fetch directly to avoid UI confusion
                const response = await fetch(AZURE_OPENAI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-4o-2024-11-20',
                        messages: [{ role: 'user', content: prompt + "\n Return JSON { newDrivers: [{category, title, description}] }" }],
                        max_completion_tokens: 3000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid API response format');
                }

                const content = data.choices[0].message.content;
                let result = {};
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) result = JSON.parse(jsonMatch[0]);
                } catch (e) {
                    console.error('Failed to parse JSON from response:', e);
                }

                if (result.newDrivers && Array.isArray(result.newDrivers) && result.newDrivers.length > 0) {
                    document.getElementById('playgroundPlaceholder').style.display = 'none';
                    result.newDrivers.forEach(d => {
                        d.id = 'pg_' + Date.now() + Math.random().toString(36).substr(2, 5);
                        currentPlaygroundDrivers.push(d);
                    });
                    renderPlaygroundCards();
                } else {
                    alert('No risk drivers could be generated from this document. Please try a different file or check the content.');
                }

            } catch (err) {
                console.error('Error processing file:', err);
                alert(`Error: ${err.message || 'Failed to process file. Please try again.'}`);
            } finally {
                loader.style.display = 'none';
                loader.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: #2563EB; border-radius: 50%; animation: spin 1s linear infinite;"></span> AI is brainstorming...';
                input.value = '';
            }
        }
    </script>
</body>

</html>